// CampoTech Database Schema
// Field Service Management for Argentina

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ═══════════════════════════════════════════════════════════════════════════════
// ORGANIZATIONS & USERS
// ═══════════════════════════════════════════════════════════════════════════════

model Organization {
  id        String   @id @default(cuid())
  name      String
  phone     String?
  email     String?
  logo      String?
  settings  Json     @default("{}")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users            User[]
  customers        Customer[]
  jobs             Job[]
  invoices         Invoice[]
  payments         Payment[]
  scheduledReports ScheduledReport[]
  reports          Report[]
  reportHistory    ReportHistory[]
  reviews          Review[]

  @@map("organizations")
}

model User {
  id             String          @id @default(cuid())
  email          String?
  phone          String          @unique
  name           String
  passwordHash   String?
  role           UserRole        @default(TECHNICIAN)
  specialty      String?         // Trade specialty (PLOMERO, ELECTRICISTA, etc.)
  skillLevel     String?         // Skill level (AYUDANTE, MEDIO_OFICIAL, OFICIAL, OFICIAL_ESPECIALIZADO)
  avatar         String?
  isActive       Boolean         @default(true)
  organizationId String
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  organization         Organization      @relation(fields: [organizationId], references: [id])
  assignedJobs         Job[]             @relation("TechnicianJobs")
  createdJobs          Job[]             @relation("CreatorJobs")
  createdScheduledReports ScheduledReport[] @relation("ScheduledReportCreator")
  createdReports       Report[]          @relation("ReportCreator")
  generatedReports     ReportHistory[]   @relation("ReportHistoryGenerator")
  technicianReviews    Review[]          @relation("TechnicianReviews")

  @@unique([email, organizationId])
  @@index([organizationId])
  @@map("users")
}

enum UserRole {
  OWNER
  ADMIN
  DISPATCHER
  TECHNICIAN
  VIEWER
}

// Valid values for specialty: PLOMERO, ELECTRICISTA, GASISTA, CALEFACCIONISTA, REFRIGERACION, ALBANIL, PINTOR, CARPINTERO, TECHISTA, HERRERO, SOLDADOR, OTRO
// Valid values for skillLevel: AYUDANTE, MEDIO_OFICIAL, OFICIAL, OFICIAL_ESPECIALIZADO

// ═══════════════════════════════════════════════════════════════════════════════
// CUSTOMERS
// ═══════════════════════════════════════════════════════════════════════════════

model Customer {
  id             String   @id @default(cuid())
  name           String
  phone          String
  email          String?
  address        Json     // { street, number, floor, apartment, city, postalCode, coordinates }
  notes          String?
  organizationId String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
  jobs         Job[]
  invoices     Invoice[]
  reviews      Review[]

  @@index([phone])
  @@index([organizationId])
  @@map("customers")
}

// ═══════════════════════════════════════════════════════════════════════════════
// JOBS
// ═══════════════════════════════════════════════════════════════════════════════

model Job {
  id                String      @id @default(cuid())
  jobNumber         String      @unique
  serviceType       ServiceType
  description       String
  status            JobStatus   @default(PENDING)
  urgency           Urgency     @default(NORMAL)
  scheduledDate     DateTime?
  scheduledTimeSlot Json?       // { start: "09:00", end: "11:00" }
  startedAt         DateTime?
  completedAt       DateTime?
  resolution        String?
  materialsUsed     Json?       // [{ name, quantity, unitPrice }]
  photos            String[]
  customerSignature String?
  estimatedDuration Int?        // minutes
  actualDuration    Int?        // minutes

  customerId     String
  technicianId   String?
  createdById    String
  organizationId String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  customer     Customer     @relation(fields: [customerId], references: [id])
  technician   User?        @relation("TechnicianJobs", fields: [technicianId], references: [id])
  createdBy    User         @relation("CreatorJobs", fields: [createdById], references: [id])
  organization Organization @relation(fields: [organizationId], references: [id])
  invoice      Invoice?
  review       Review?

  @@index([status])
  @@index([scheduledDate])
  @@index([technicianId])
  @@index([organizationId])
  @@map("jobs")
}

enum ServiceType {
  INSTALACION_SPLIT
  REPARACION_SPLIT
  MANTENIMIENTO_SPLIT
  INSTALACION_CALEFACTOR
  REPARACION_CALEFACTOR
  MANTENIMIENTO_CALEFACTOR
  OTRO
}

enum JobStatus {
  PENDING
  ASSIGNED
  EN_ROUTE
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum Urgency {
  NORMAL
  URGENTE
}

// ═══════════════════════════════════════════════════════════════════════════════
// INVOICES & PAYMENTS
// ═══════════════════════════════════════════════════════════════════════════════

model Invoice {
  id              String        @id @default(cuid())
  invoiceNumber   String        @unique
  type            InvoiceType   @default(FACTURA_C)
  status          InvoiceStatus @default(DRAFT)
  subtotal        Decimal       @db.Decimal(10, 2)
  taxAmount       Decimal       @db.Decimal(10, 2)
  total           Decimal       @db.Decimal(10, 2)
  items           Json          // [{ description, quantity, unitPrice, total }]
  afipCae         String?
  afipCaeExpiry   DateTime?
  afipQrCode      String?
  issuedAt        DateTime?
  dueDate         DateTime?

  jobId          String?  @unique
  customerId     String
  organizationId String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  job          Job?         @relation(fields: [jobId], references: [id])
  customer     Customer     @relation(fields: [customerId], references: [id])
  organization Organization @relation(fields: [organizationId], references: [id])
  payments     Payment[]

  @@index([status])
  @@index([organizationId])
  @@map("invoices")
}

enum InvoiceType {
  FACTURA_A
  FACTURA_B
  FACTURA_C
}

enum InvoiceStatus {
  DRAFT
  PENDING
  SENT
  PAID
  OVERDUE
  CANCELLED
}

model Payment {
  id             String        @id @default(cuid())
  amount         Decimal       @db.Decimal(10, 2)
  method         PaymentMethod
  status         PaymentStatus @default(PENDING)
  reference      String?       // External payment reference (MP, transfer, etc.)
  paidAt         DateTime?

  invoiceId      String
  organizationId String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  invoice      Invoice      @relation(fields: [invoiceId], references: [id])
  organization Organization @relation(fields: [organizationId], references: [id])

  @@index([invoiceId])
  @@map("payments")
}

enum PaymentMethod {
  CASH
  TRANSFER
  CARD
  MERCADOPAGO
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

// ═══════════════════════════════════════════════════════════════════════════════
// WHATSAPP & VOICE
// ═══════════════════════════════════════════════════════════════════════════════

model WhatsAppMessage {
  id             String              @id @default(cuid())
  waMessageId    String              @unique
  direction      MessageDirection
  type           MessageType
  content        String?
  mediaUrl       String?
  status         MessageDeliveryStatus @default(SENT)
  phone          String
  organizationId String
  createdAt      DateTime            @default(now())

  @@index([phone])
  @@index([organizationId])
  @@map("whatsapp_messages")
}

enum MessageDirection {
  INBOUND
  OUTBOUND
}

enum MessageType {
  TEXT
  IMAGE
  AUDIO
  DOCUMENT
  TEMPLATE
}

enum MessageDeliveryStatus {
  SENT
  DELIVERED
  READ
  FAILED
}

model VoiceMessage {
  id              String            @id @default(cuid())
  phone           String
  audioUrl        String
  duration        Int               // seconds
  transcription   String?
  extractedData   Json?             // { customerName, address, serviceType, etc. }
  confidence      Float?
  status          VoiceMessageStatus @default(PENDING)
  reviewedBy      String?
  reviewedAt      DateTime?
  rejectionReason String?
  organizationId  String
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@index([status])
  @@index([organizationId])
  @@map("voice_messages")
}

enum VoiceMessageStatus {
  PENDING
  PROCESSING
  NEEDS_REVIEW
  APPROVED
  REJECTED
}

// ═══════════════════════════════════════════════════════════════════════════════
// AUTHENTICATION - OTP CODES
// ═══════════════════════════════════════════════════════════════════════════════

model OtpCode {
  id        String   @id @default(cuid())
  phone     String
  codeHash  String   // SHA-256 hash of the OTP code
  expiresAt DateTime
  attempts  Int      @default(0)
  verified  Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([phone])
  @@index([expiresAt])
  @@map("otp_codes")
}

// ═══════════════════════════════════════════════════════════════════════════════
// PENDING REGISTRATIONS
// ═══════════════════════════════════════════════════════════════════════════════

model PendingRegistration {
  id           String   @id @default(cuid())
  phone        String   @unique
  cuit         String   // Stored as digits only (11 chars)
  businessName String
  adminName    String
  email        String?
  expiresAt    DateTime
  createdAt    DateTime @default(now())

  @@index([phone])
  @@index([cuit])
  @@index([expiresAt])
  @@map("pending_registrations")
}

// ═══════════════════════════════════════════════════════════════════════════════
// PHASE 9.6: SCHEDULED REMINDERS
// ═══════════════════════════════════════════════════════════════════════════════

model ScheduledReminder {
  id             String   @id @default(cuid())
  organizationId String
  jobId          String
  userId         String
  reminderType   String   // 24h, 1h, 30min
  scheduledFor   DateTime
  status         String   @default("pending") // pending, sent, cancelled
  sentAt         DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([organizationId])
  @@index([status, scheduledFor])
  @@map("scheduled_reminders")
}

// ═══════════════════════════════════════════════════════════════════════════════
// PHASE 9.7: AUDIO MESSAGES & AUTO-RESPONDER
// ═══════════════════════════════════════════════════════════════════════════════

model AudioMessage {
  id             String    @id @default(cuid())
  organizationId String
  waMessageId    String
  senderPhone    String
  senderName     String?
  mediaId        String
  mimeType       String    @default("audio/ogg")
  mediaUrl       String?
  isVoice        Boolean   @default(true)
  duration       Int?
  transcription  String?
  status         String    @default("received") // received, downloading, downloaded, transcribing, transcribed, failed
  reviewed       Boolean   @default(false)
  reviewedAt     DateTime?
  reviewedById   String?
  transcribedAt  DateTime?
  receivedAt     DateTime  @default(now())
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([organizationId])
  @@index([status])
  @@index([senderPhone])
  @@map("audio_messages")
}

model AutoResponseLog {
  id             String   @id @default(cuid())
  organizationId String
  recipientPhone String
  responseType   String   // after_hours, audio_confirmation, message_received
  message        String
  sentAt         DateTime @default(now())
  createdAt      DateTime @default(now())

  @@index([organizationId])
  @@index([recipientPhone])
  @@map("auto_response_logs")
}

// ═══════════════════════════════════════════════════════════════════════════════
// PHASE 9.8: MESSAGE AGGREGATION CONTEXT
// ═══════════════════════════════════════════════════════════════════════════════

model ConversationContext {
  id               String    @id @default(cuid())
  organizationId   String
  customerPhone    String
  customerId       String?
  customerName     String?
  messageHistory   Json      @default("[]")
  previousRequests String[]  @default([])
  activeJobId      String?
  lastMessageAt    DateTime  @default(now())
  expiresAt        DateTime
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  @@unique([organizationId, customerPhone])
  @@index([expiresAt])
  @@map("conversation_contexts")
}

model MessageBufferStats {
  id                      String   @id @default(cuid())
  organizationId          String
  date                    DateTime @db.Date
  totalBuffersCreated     Int      @default(0)
  totalMessagesAggregated Int      @default(0)
  totalImmediateTriggers  Int      @default(0)
  totalTimeoutTriggers    Int      @default(0)
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  @@unique([organizationId, date])
  @@map("message_buffer_stats")
}

model MessageAggregationEvent {
  id               String   @id @default(cuid())
  organizationId   String
  customerPhone    String
  combinedContent  String
  messageCount     Int
  triggerReason    String   // voice_message, long_message, question, request_verb, urgency, address, schedule, price_inquiry, max_buffer, timeout, immediate
  processedAt      DateTime @default(now())
  createdAt        DateTime @default(now())

  @@index([organizationId])
  @@index([triggerReason])
  @@index([createdAt])
  @@map("message_aggregation_events")
}

// ═══════════════════════════════════════════════════════════════════════════════
// PHASE 10: ANALYTICS & REPORTING
// ═══════════════════════════════════════════════════════════════════════════════

model ScheduledReport {
  id             String    @id @default(cuid())
  organizationId String
  reportId       String?
  name           String
  frequency      String    // 'daily', 'weekly', 'monthly'
  dayOfWeek      Int?      // 0-6 (Sunday-Saturday) for weekly reports
  dayOfMonth     Int?      // 1-31 for monthly reports
  time           String    // 'HH:mm' format
  format         String    // 'pdf', 'excel', 'csv'
  recipients     Json      // Array of email addresses
  enabled        Boolean   @default(true)
  status         String    @default("active") // 'active', 'paused', 'error'
  lastRunAt      DateTime?
  nextRunAt      DateTime?
  createdById    String
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdBy    User         @relation("ScheduledReportCreator", fields: [createdById], references: [id])
  report       Report?      @relation(fields: [reportId], references: [id], onDelete: SetNull)
  executions   ReportExecution[]

  @@index([organizationId])
  @@index([enabled])
  @@index([nextRunAt])
  @@map("scheduled_reports")
}

model Report {
  id             String   @id @default(cuid())
  organizationId String
  name           String
  templateId     String   // Reference to report template ID
  description    String?
  parameters     Json?    // Default parameters for the report
  createdById    String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization     Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdBy        User              @relation("ReportCreator", fields: [createdById], references: [id])
  scheduledReports ScheduledReport[]
  history          ReportHistory[]

  @@index([organizationId])
  @@index([templateId])
  @@map("reports")
}

model ReportExecution {
  id                String    @id @default(cuid())
  scheduledReportId String
  organizationId    String
  status            String    @default("pending") // 'pending', 'processing', 'completed', 'failed'
  format            String
  fileUrl           String?
  fileSize          Int?
  generationTimeMs  Int?
  error             String?
  recipientResults  Json?     // Array of delivery results per recipient
  startedAt         DateTime?
  completedAt       DateTime?
  createdAt         DateTime  @default(now())

  scheduledReport ScheduledReport @relation(fields: [scheduledReportId], references: [id], onDelete: Cascade)

  @@index([scheduledReportId])
  @@index([organizationId])
  @@index([status])
  @@map("report_executions")
}

model ReportHistory {
  id             String    @id @default(cuid())
  organizationId String
  reportId       String?
  name           String
  reportType     String    // Template ID or custom report type
  format         String    // 'pdf', 'excel', 'csv'
  status         String    @default("completed") // 'completed', 'failed'
  parameters     Json?     // Parameters used for generation
  fileUrl        String?
  fileSize       Int?
  generationTimeMs Int?
  errorMessage   String?
  downloadUrl    String?
  generatedById  String
  generatedAt    DateTime  @default(now())
  createdAt      DateTime  @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  generatedBy  User         @relation("ReportHistoryGenerator", fields: [generatedById], references: [id])
  report       Report?      @relation(fields: [reportId], references: [id], onDelete: SetNull)

  @@index([organizationId])
  @@index([reportType])
  @@index([status])
  @@index([generatedAt])
  @@map("report_history")
}

model Review {
  id             String   @id @default(cuid())
  organizationId String
  jobId          String?  @unique
  customerId     String?
  technicianId   String?
  rating         Int?     // 1-5 star rating
  comment        String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  job          Job?         @relation(fields: [jobId], references: [id], onDelete: SetNull)
  customer     Customer?    @relation(fields: [customerId], references: [id], onDelete: SetNull)
  technician   User?        @relation("TechnicianReviews", fields: [technicianId], references: [id], onDelete: SetNull)

  @@index([organizationId])
  @@index([technicianId])
  @@index([rating])
  @@map("reviews")
}
