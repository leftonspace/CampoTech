// CampoTech Database Schema
// Field Service Management for Argentina

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ═══════════════════════════════════════════════════════════════════════════════
// ORGANIZATIONS & USERS
// ═══════════════════════════════════════════════════════════════════════════════

model Organization {
  id        String   @id @default(cuid())
  name      String
  phone     String?
  email     String?
  logo      String?
  settings  Json     @default("{}")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users            User[]
  customers        Customer[]
  jobs             Job[]
  invoices         Invoice[]
  payments         Payment[]
  scheduledReports ScheduledReport[]
  reports          Report[]
  reportHistory    ReportHistory[]
  reviews          Review[]
  locations        Location[]
  // Inventory Management
  productCategories ProductCategory[]
  products         Product[]
  warehouses       Warehouse[]
  suppliers        Supplier[]
  purchaseOrders   PurchaseOrder[]
  inventoryCounts  InventoryCount[]
  // System Tables
  failedJobs       FailedJob[]      @relation("FailedJobOrg")
  idempotencyKeys  IdempotencyKey[] @relation("IdempotencyOrg")
  // Employee Tracking & Fleet Management
  trackingSessions     TrackingSession[]      @relation("OrgTrackingSessions")
  vehicles             Vehicle[]              @relation("OrgVehicles")
  inventoryItems       InventoryItem[]        @relation("OrgInventoryItems")
  inventoryLocations   InventoryLocation[]    @relation("OrgInventoryLocations")
  inventoryTransactions InventoryTransaction[] @relation("OrgInventoryTransactions")
  dashboardAlerts      DashboardAlert[]       @relation("OrgDashboardAlerts")
  priceItems           PriceItem[]            @relation("OrgPriceItems")
  serviceTypeConfigs   ServiceTypeConfig[]
  // WhatsApp Integration
  whatsappPhoneNumberId       String?
  whatsappBusinessAccountId   String?
  whatsappAccessToken         String?  // Encrypted
  whatsappWebhookVerifyToken  String?
  whatsappAppSecret           String?  // Encrypted
  whatsappBusinessAccount     WhatsAppBusinessAccount?
  waConversations             WaConversation[]
  waMessages                  WaMessage[]
  waTemplates                 WaTemplate[]
  waOutboundQueue             WaOutboundQueue[]
  waWebhookLogs               WaWebhookLog[]
  // New models
  auditLogs                   AuditLog[]
  notificationPreferences     NotificationPreferences[]
  notificationLogs            NotificationLogs[]
  events                      Event[]
  onboardingProgress          OnboardingProgress[]
  panicModes                  PanicMode[]
  fallbackPayments            FallbackPayment[]
  employeeVerificationTokens  EmployeeVerificationToken[]
  chargebacks                 Chargeback[]
  supportTickets              SupportTicket[]
  smsOutboundQueue            SmsOutboundQueue[]

  @@map("organizations")
}

model User {
  id             String          @id @default(cuid())
  email          String?
  phone          String          @unique
  name           String
  passwordHash   String?
  role           UserRole        @default(TECHNICIAN)
  specialty      String?         // Trade specialty (PLOMERO, ELECTRICISTA, etc.)
  skillLevel     String?         // Skill level (AYUDANTE, MEDIO_OFICIAL, OFICIAL, OFICIAL_ESPECIALIZADO)
  avatar         String?
  isActive       Boolean         @default(true)
  organizationId String
  homeLocationId String?         // Technician's home/primary location
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  organization         Organization      @relation(fields: [organizationId], references: [id])
  homeLocation         Location?         @relation("TechnicianHomeLocation", fields: [homeLocationId], references: [id], onDelete: SetNull)
  assignedJobs         Job[]             @relation("TechnicianJobs")
  createdJobs          Job[]             @relation("CreatorJobs")
  createdScheduledReports ScheduledReport[] @relation("ScheduledReportCreator")
  createdReports       Report[]          @relation("ReportCreator")
  generatedReports     ReportHistory[]   @relation("ReportHistoryGenerator")
  technicianReviews    Review[]          @relation("TechnicianReviews")
  managedLocations     Location[]        @relation("LocationManager")
  requestedTransfers   InterLocationTransfer[] @relation("TransferRequester")
  approvedTransfers    InterLocationTransfer[] @relation("TransferApprover")
  vehicleStocks        VehicleStock[]
  uploadedPhotos       JobPhoto[]        @relation("PhotoUploader")
  reviewedTranscripts  VoiceTranscript[] @relation("TranscriptReviewer")
  // Employee Tracking & Fleet Management
  currentLocation      TechnicianLocation?    @relation("TechnicianCurrentLocation")
  trackingSessions     TrackingSession[]      @relation("TechnicianTrackingSessions")
  uploadedVehicleDocs  VehicleDocument[]      @relation("UploadedVehicleDocuments")
  vehicleAssignments   VehicleAssignment[]    @relation("UserVehicleAssignments")
  createdMaintenance   VehicleMaintenance[]   @relation("CreatedMaintenanceLogs")
  inventoryTransactions InventoryTransaction[] @relation("PerformedTransactions")
  // Job Assignments (many-to-many)
  jobAssignments       JobAssignment[]        @relation("TechnicianAssignments")
  // WhatsApp
  assignedWaConversations WaConversation[]     @relation("WaConversationAssignee")
  sentWaMessages          WaMessage[]          @relation("WaMessageSender")
  // New models
  notifications           Notification[]
  notificationPreferences NotificationPreferences?
  onboardingProgress      OnboardingProgress?
  employeeVerificationTokens EmployeeVerificationToken[]

  @@unique([email, organizationId])
  @@index([organizationId])
  @@index([homeLocationId])
  @@map("users")
}

enum UserRole {
  OWNER
  ADMIN
  DISPATCHER
  TECHNICIAN
  ACCOUNTANT
  VIEWER
}

// Valid values for specialty: PLOMERO, ELECTRICISTA, GASISTA, CALEFACCIONISTA, REFRIGERACION, ALBANIL, PINTOR, CARPINTERO, TECHISTA, HERRERO, SOLDADOR, OTRO
// Valid values for skillLevel: AYUDANTE, MEDIO_OFICIAL, OFICIAL, OFICIAL_ESPECIALIZADO

// ═══════════════════════════════════════════════════════════════════════════════
// CUSTOMERS
// ═══════════════════════════════════════════════════════════════════════════════

model Customer {
  id             String   @id @default(cuid())
  name           String
  phone          String
  email          String?
  address        Json     // { street, number, floor, apartment, city, postalCode, coordinates }
  notes          String?
  organizationId String
  locationId     String?  // Primary service location for this customer
  zoneId         String?  // Service zone within the location
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
  location     Location?    @relation("CustomerLocation", fields: [locationId], references: [id], onDelete: SetNull)
  zone         Zone?        @relation("CustomerZone", fields: [zoneId], references: [id], onDelete: SetNull)
  jobs         Job[]
  invoices     Invoice[]
  reviews         Review[]
  waConversations WaConversation[]

  @@index([phone])
  @@index([organizationId])
  @@index([locationId])
  @@index([zoneId])
  @@map("customers")
}

// ═══════════════════════════════════════════════════════════════════════════════
// JOBS
// ═══════════════════════════════════════════════════════════════════════════════

model Job {
  id                String      @id @default(cuid())
  jobNumber         String      @unique
  serviceType       ServiceType
  description       String
  status            JobStatus   @default(PENDING)
  urgency           Urgency     @default(NORMAL)
  scheduledDate     DateTime?
  scheduledTimeSlot Json?       // { start: "09:00", end: "11:00" }
  startedAt         DateTime?
  completedAt       DateTime?
  resolution        String?
  materialsUsed     Json?       // [{ name, quantity, unitPrice }]
  photos            String[]
  customerSignature String?
  estimatedDuration Int?        // minutes
  actualDuration    Int?        // minutes

  customerId     String
  technicianId   String?
  createdById    String
  organizationId String
  locationId     String?  // Service location for this job
  zoneId         String?  // Service zone within the location
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  customer     Customer     @relation(fields: [customerId], references: [id])
  technician   User?        @relation("TechnicianJobs", fields: [technicianId], references: [id])
  createdBy    User         @relation("CreatorJobs", fields: [createdById], references: [id])
  organization Organization @relation(fields: [organizationId], references: [id])
  location     Location?    @relation("JobLocation", fields: [locationId], references: [id], onDelete: SetNull)
  zone         Zone?        @relation("JobZone", fields: [zoneId], references: [id], onDelete: SetNull)
  invoice      Invoice?
  review       Review?
  stockMovements StockMovement[]
  materials      JobMaterial[]
  reservations   StockReservation[]
  jobPhotos      JobPhoto[]   @relation("JobPhotos")
  trackingSessions TrackingSession[] @relation("JobTrackingSessions")
  assignments    JobAssignment[] @relation("JobAssignments")

  @@index([status])
  @@index([scheduledDate])
  @@index([technicianId])
  @@index([organizationId])
  @@index([locationId])
  @@index([zoneId])
  @@map("jobs")
}

// ────────────────────────────────────────────────────────────────────────────────
// SERVICE TYPE CONFIGURATION - Configurable service types per organization
// ────────────────────────────────────────────────────────────────────────────────

model ServiceTypeConfig {
  id             String   @id @default(cuid())
  code           String   // Internal code (e.g., "INSTALACION_SPLIT")
  name           String   // Display name (e.g., "Instalación Split")
  description    String?  // Optional description
  color          String?  // Optional color for UI (hex code)
  icon           String?  // Optional icon name
  isActive       Boolean  @default(true)
  sortOrder      Int      @default(0)
  organizationId String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, code])
  @@index([organizationId])
  @@map("service_type_configs")
}

// Legacy enum kept for backward compatibility - will be deprecated
enum ServiceType {
  INSTALACION_SPLIT
  REPARACION_SPLIT
  MANTENIMIENTO_SPLIT
  INSTALACION_CALEFACTOR
  REPARACION_CALEFACTOR
  MANTENIMIENTO_CALEFACTOR
  OTRO
}

enum JobStatus {
  PENDING
  ASSIGNED
  EN_ROUTE
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum Urgency {
  NORMAL
  URGENTE
}

// ────────────────────────────────────────────────────────────────────────────────
// JOB ASSIGNMENTS - Many-to-many relationship for multiple technicians per job
// ────────────────────────────────────────────────────────────────────────────────

model JobAssignment {
  id           String   @id @default(cuid())
  jobId        String
  technicianId String
  assignedAt   DateTime @default(now())
  notes        String?

  job        Job  @relation("JobAssignments", fields: [jobId], references: [id], onDelete: Cascade)
  technician User @relation("TechnicianAssignments", fields: [technicianId], references: [id], onDelete: Cascade)

  @@unique([jobId, technicianId])
  @@index([jobId])
  @@index([technicianId])
  @@map("job_assignments")
}

// ═══════════════════════════════════════════════════════════════════════════════
// INVOICES & PAYMENTS
// ═══════════════════════════════════════════════════════════════════════════════

model Invoice {
  id              String        @id @default(cuid())
  invoiceNumber   String        @unique
  type            InvoiceType   @default(FACTURA_C)
  status          InvoiceStatus @default(DRAFT)
  subtotal        Decimal       @db.Decimal(10, 2)
  taxAmount       Decimal       @db.Decimal(10, 2)
  total           Decimal       @db.Decimal(10, 2)
  items           Json          // [{ description, quantity, unitPrice, total }]
  afipCae         String?
  afipCaeExpiry   DateTime?
  afipQrCode      String?
  issuedAt        DateTime?
  dueDate         DateTime?

  jobId          String?  @unique
  customerId     String
  organizationId String
  locationId     String?  // Location that issued this invoice (for AFIP punto de venta)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  job          Job?         @relation(fields: [jobId], references: [id])
  customer     Customer     @relation(fields: [customerId], references: [id])
  organization Organization @relation(fields: [organizationId], references: [id])
  location     Location?    @relation("InvoiceLocation", fields: [locationId], references: [id], onDelete: SetNull)
  payments         Payment[]
  lineItems        InvoiceItem[] @relation("InvoiceLineItems")
  fallbackPayments FallbackPayment[]
  chargebacks      Chargeback[]

  @@index([status])
  @@index([organizationId])
  @@index([locationId])
  @@map("invoices")
}

enum InvoiceType {
  FACTURA_A
  FACTURA_B
  FACTURA_C
}

enum InvoiceStatus {
  DRAFT
  PENDING
  SENT
  PAID
  OVERDUE
  CANCELLED
}

model Payment {
  id             String        @id @default(cuid())
  amount         Decimal       @db.Decimal(10, 2)
  method         PaymentMethod
  status         PaymentStatus @default(PENDING)
  reference      String?       // External payment reference (MP, transfer, etc.)
  paidAt         DateTime?

  invoiceId      String
  organizationId String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  invoice      Invoice      @relation(fields: [invoiceId], references: [id])
  organization Organization @relation(fields: [organizationId], references: [id])
  disputes     PaymentDispute[] @relation("PaymentDisputes")
  chargebacks  Chargeback[]

  @@index([invoiceId])
  @@map("payments")
}

enum PaymentMethod {
  CASH
  TRANSFER
  CARD
  MERCADOPAGO
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

// ═══════════════════════════════════════════════════════════════════════════════
// WHATSAPP & VOICE
// ═══════════════════════════════════════════════════════════════════════════════

model WhatsAppMessage {
  id             String              @id @default(cuid())
  waMessageId    String              @unique
  direction      MessageDirection
  type           MessageType
  content        String?
  mediaUrl       String?
  status         MessageDeliveryStatus @default(SENT)
  phone          String
  organizationId String
  createdAt      DateTime            @default(now())

  transcript     VoiceTranscript?    @relation("MessageTranscript")

  @@index([phone])
  @@index([organizationId])
  @@map("whatsapp_messages")
}

enum MessageDirection {
  INBOUND
  OUTBOUND
}

enum MessageType {
  TEXT
  IMAGE
  AUDIO
  DOCUMENT
  TEMPLATE
}

enum MessageDeliveryStatus {
  SENT
  DELIVERED
  READ
  FAILED
}

model VoiceMessage {
  id              String            @id @default(cuid())
  phone           String
  audioUrl        String
  duration        Int               // seconds
  transcription   String?
  extractedData   Json?             // { customerName, address, serviceType, etc. }
  confidence      Float?
  status          VoiceMessageStatus @default(PENDING)
  reviewedBy      String?
  reviewedAt      DateTime?
  rejectionReason String?
  organizationId  String
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@index([status])
  @@index([organizationId])
  @@map("voice_messages")
}

enum VoiceMessageStatus {
  PENDING
  PROCESSING
  NEEDS_REVIEW
  APPROVED
  REJECTED
}

// ═══════════════════════════════════════════════════════════════════════════════
// AUTHENTICATION - OTP CODES
// ═══════════════════════════════════════════════════════════════════════════════

model OtpCode {
  id        String   @id @default(cuid())
  phone     String
  codeHash  String   // SHA-256 hash of the OTP code
  expiresAt DateTime
  attempts  Int      @default(0)
  verified  Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([phone])
  @@index([expiresAt])
  @@map("otp_codes")
}

// ═══════════════════════════════════════════════════════════════════════════════
// PENDING REGISTRATIONS
// ═══════════════════════════════════════════════════════════════════════════════

model PendingRegistration {
  id           String   @id @default(cuid())
  phone        String   @unique
  cuit         String   // Stored as digits only (11 chars)
  businessName String
  adminName    String
  email        String?
  expiresAt    DateTime
  createdAt    DateTime @default(now())

  @@index([phone])
  @@index([cuit])
  @@index([expiresAt])
  @@map("pending_registrations")
}

// ═══════════════════════════════════════════════════════════════════════════════
// PHASE 9.6: SCHEDULED REMINDERS
// ═══════════════════════════════════════════════════════════════════════════════

model ScheduledReminder {
  id             String   @id @default(cuid())
  organizationId String
  jobId          String
  userId         String
  reminderType   String   // 24h, 1h, 30min
  scheduledFor   DateTime
  status         String   @default("pending") // pending, sent, cancelled
  sentAt         DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([organizationId])
  @@index([status, scheduledFor])
  @@map("scheduled_reminders")
}

// ═══════════════════════════════════════════════════════════════════════════════
// PHASE 9.7: AUDIO MESSAGES & AUTO-RESPONDER
// ═══════════════════════════════════════════════════════════════════════════════

model AudioMessage {
  id             String    @id @default(cuid())
  organizationId String
  waMessageId    String
  senderPhone    String
  senderName     String?
  mediaId        String
  mimeType       String    @default("audio/ogg")
  mediaUrl       String?
  isVoice        Boolean   @default(true)
  duration       Int?
  transcription  String?
  status         String    @default("received") // received, downloading, downloaded, transcribing, transcribed, failed
  reviewed       Boolean   @default(false)
  reviewedAt     DateTime?
  reviewedById   String?
  transcribedAt  DateTime?
  receivedAt     DateTime  @default(now())
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([organizationId])
  @@index([status])
  @@index([senderPhone])
  @@map("audio_messages")
}

model AutoResponseLog {
  id             String   @id @default(cuid())
  organizationId String
  recipientPhone String
  responseType   String   // after_hours, audio_confirmation, message_received
  message        String
  sentAt         DateTime @default(now())
  createdAt      DateTime @default(now())

  @@index([organizationId])
  @@index([recipientPhone])
  @@map("auto_response_logs")
}

// ═══════════════════════════════════════════════════════════════════════════════
// PHASE 9.8: MESSAGE AGGREGATION CONTEXT
// ═══════════════════════════════════════════════════════════════════════════════

model ConversationContext {
  id               String    @id @default(cuid())
  organizationId   String
  customerPhone    String
  customerId       String?
  customerName     String?
  messageHistory   Json      @default("[]")
  previousRequests String[]  @default([])
  activeJobId      String?
  lastMessageAt    DateTime  @default(now())
  expiresAt        DateTime
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  @@unique([organizationId, customerPhone])
  @@index([expiresAt])
  @@map("conversation_contexts")
}

model MessageBufferStats {
  id                      String   @id @default(cuid())
  organizationId          String
  date                    DateTime @db.Date
  totalBuffersCreated     Int      @default(0)
  totalMessagesAggregated Int      @default(0)
  totalImmediateTriggers  Int      @default(0)
  totalTimeoutTriggers    Int      @default(0)
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  @@unique([organizationId, date])
  @@map("message_buffer_stats")
}

model MessageAggregationEvent {
  id               String   @id @default(cuid())
  organizationId   String
  customerPhone    String
  combinedContent  String
  messageCount     Int
  triggerReason    String   // voice_message, long_message, question, request_verb, urgency, address, schedule, price_inquiry, max_buffer, timeout, immediate
  processedAt      DateTime @default(now())
  createdAt        DateTime @default(now())

  @@index([organizationId])
  @@index([triggerReason])
  @@index([createdAt])
  @@map("message_aggregation_events")
}

// ═══════════════════════════════════════════════════════════════════════════════
// PHASE 10: ANALYTICS & REPORTING
// ═══════════════════════════════════════════════════════════════════════════════

model ScheduledReport {
  id             String    @id @default(cuid())
  organizationId String
  reportId       String?
  name           String
  frequency      String    // 'daily', 'weekly', 'monthly'
  dayOfWeek      Int?      // 0-6 (Sunday-Saturday) for weekly reports
  dayOfMonth     Int?      // 1-31 for monthly reports
  time           String    // 'HH:mm' format
  format         String    // 'pdf', 'excel', 'csv'
  recipients     Json      // Array of email addresses
  enabled        Boolean   @default(true)
  status         String    @default("active") // 'active', 'paused', 'error'
  lastRunAt      DateTime?
  nextRunAt      DateTime?
  createdById    String
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdBy    User         @relation("ScheduledReportCreator", fields: [createdById], references: [id])
  report       Report?      @relation(fields: [reportId], references: [id], onDelete: SetNull)
  executions   ReportExecution[]

  @@index([organizationId])
  @@index([enabled])
  @@index([nextRunAt])
  @@map("scheduled_reports")
}

model Report {
  id             String   @id @default(cuid())
  organizationId String
  name           String
  templateId     String   // Reference to report template ID
  description    String?
  parameters     Json?    // Default parameters for the report
  createdById    String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization     Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdBy        User              @relation("ReportCreator", fields: [createdById], references: [id])
  scheduledReports ScheduledReport[]
  history          ReportHistory[]

  @@index([organizationId])
  @@index([templateId])
  @@map("reports")
}

model ReportExecution {
  id                String    @id @default(cuid())
  scheduledReportId String
  organizationId    String
  status            String    @default("pending") // 'pending', 'processing', 'completed', 'failed'
  format            String
  fileUrl           String?
  fileSize          Int?
  generationTimeMs  Int?
  error             String?
  recipientResults  Json?     // Array of delivery results per recipient
  startedAt         DateTime?
  completedAt       DateTime?
  createdAt         DateTime  @default(now())

  scheduledReport ScheduledReport @relation(fields: [scheduledReportId], references: [id], onDelete: Cascade)

  @@index([scheduledReportId])
  @@index([organizationId])
  @@index([status])
  @@map("report_executions")
}

model ReportHistory {
  id             String    @id @default(cuid())
  organizationId String
  reportId       String?
  name           String
  reportType     String    // Template ID or custom report type
  format         String    // 'pdf', 'excel', 'csv'
  status         String    @default("completed") // 'completed', 'failed'
  parameters     Json?     // Parameters used for generation
  fileUrl        String?
  fileSize       Int?
  generationTimeMs Int?
  errorMessage   String?
  downloadUrl    String?
  generatedById  String
  generatedAt    DateTime  @default(now())
  createdAt      DateTime  @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  generatedBy  User         @relation("ReportHistoryGenerator", fields: [generatedById], references: [id])
  report       Report?      @relation(fields: [reportId], references: [id], onDelete: SetNull)

  @@index([organizationId])
  @@index([reportType])
  @@index([status])
  @@index([generatedAt])
  @@map("report_history")
}

model Review {
  id             String   @id @default(cuid())
  organizationId String
  jobId          String?  @unique
  customerId     String?
  technicianId   String?
  rating         Int?     // 1-5 star rating
  comment        String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  job          Job?         @relation(fields: [jobId], references: [id], onDelete: SetNull)
  customer     Customer?    @relation(fields: [customerId], references: [id], onDelete: SetNull)
  technician   User?        @relation("TechnicianReviews", fields: [technicianId], references: [id], onDelete: SetNull)

  @@index([organizationId])
  @@index([technicianId])
  @@index([rating])
  @@map("reviews")
}

// ═══════════════════════════════════════════════════════════════════════════════
// PHASE 11: MULTI-LOCATION SUPPORT
// ═══════════════════════════════════════════════════════════════════════════════

model Location {
  id             String   @id @default(cuid())
  organizationId String
  code           String   // Short code for the location (e.g., "CABA", "GBA-N", "MDZ")
  name           String
  type           LocationType @default(BRANCH)
  address        Json     // { street, number, city, province, postalCode, country }
  coordinates    Json?    // { lat, lng }
  timezone       String   @default("America/Argentina/Buenos_Aires")
  phone          String?
  email          String?
  managerId      String?  // User who manages this location
  isHeadquarters Boolean  @default(false)
  isActive       Boolean  @default(true)
  coverageRadius Int?     // Service coverage radius in km (if circular)
  coverageArea   Json?    // GeoJSON polygon for service coverage area
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  manager      User?             @relation("LocationManager", fields: [managerId], references: [id], onDelete: SetNull)
  settings     LocationSettings?
  afipConfig   LocationAfipConfig?
  zones        Zone[]
  jobs         Job[]             @relation("JobLocation")
  customers    Customer[]        @relation("CustomerLocation")
  invoices     Invoice[]         @relation("InvoiceLocation")
  technicians  User[]            @relation("TechnicianHomeLocation")
  transfersFrom InterLocationTransfer[] @relation("TransferFromLocation")
  transfersTo   InterLocationTransfer[] @relation("TransferToLocation")
  warehouses   Warehouse[]

  @@unique([organizationId, code])
  @@index([organizationId])
  @@index([isActive])
  @@index([type])
  @@map("locations")
}

enum LocationType {
  HEADQUARTERS  // Main office / Casa central
  BRANCH        // Branch office / Sucursal
  WAREHOUSE     // Storage only / Depósito
  SERVICE_POINT // Service point without office / Punto de servicio
}

model Zone {
  id          String   @id @default(cuid())
  locationId  String
  code        String   // Short code (e.g., "Z1", "NORTE", "CENTRO")
  name        String
  description String?
  boundary    Json?    // GeoJSON polygon defining the zone boundary
  color       String?  // Hex color for map display (e.g., "#FF5733")
  priority    Int      @default(0) // Higher priority zones are preferred for assignment
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  location  Location   @relation(fields: [locationId], references: [id], onDelete: Cascade)
  jobs      Job[]      @relation("JobZone")
  customers Customer[] @relation("CustomerZone")

  @@unique([locationId, code])
  @@index([locationId])
  @@index([isActive])
  @@map("zones")
}

model LocationSettings {
  id             String   @id @default(cuid())
  locationId     String   @unique

  // Operating Hours
  operatingHours Json     @default("{}") // { monday: { open: '08:00', close: '18:00' }, ... }
  holidays       Json     @default("[]") // Array of holiday dates

  // Service Settings
  serviceRadius        Int?     // Default service radius in km
  maxJobsPerDay        Int?     // Maximum jobs that can be scheduled per day
  defaultJobDuration   Int?     // Default job duration in minutes
  allowEmergencyJobs   Boolean  @default(true)
  emergencyFeePercent  Decimal? @db.Decimal(5, 2) // Extra fee % for emergency jobs

  // Pricing Variations
  pricingMultiplier    Decimal  @default(1.0) @db.Decimal(5, 3) // Price multiplier for this location
  travelFeePerKm       Decimal? @db.Decimal(10, 2) // Travel fee per km
  minimumTravelFee     Decimal? @db.Decimal(10, 2) // Minimum travel fee

  // Notification Settings
  notifyOnNewJob       Boolean  @default(true)
  notifyOnJobComplete  Boolean  @default(true)
  notificationEmails   String[] @default([])

  // WhatsApp Settings
  whatsappNumber       String?  // Location-specific WhatsApp number
  whatsappBusinessId   String?  // WhatsApp Business Account ID

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  location Location @relation(fields: [locationId], references: [id], onDelete: Cascade)

  @@map("location_settings")
}

model LocationAfipConfig {
  id             String   @id @default(cuid())
  locationId     String   @unique

  // AFIP Configuration
  puntoDeVenta       Int      // Punto de venta number for this location
  tiposPuntoDeVenta  String   @default("CAJA") // CAJA, EXPORT, etc.
  cuit               String?  // CUIT if different from organization (for franchises)
  razonSocial        String?  // Business name if different from organization
  domicilioFiscal    Json?    // { calle, numero, piso, depto, localidad, provincia, cp }
  condicionIva       String   @default("RESPONSABLE_INSCRIPTO") // RESPONSABLE_INSCRIPTO, MONOTRIBUTISTA, EXENTO

  // Invoice Numbering
  facturaALastNumber Int      @default(0)
  facturaBLastNumber Int      @default(0)
  facturaCLastNumber Int      @default(0)
  notaCreditoALastNumber Int  @default(0)
  notaCreditoBLastNumber Int  @default(0)
  notaCreditoCLastNumber Int  @default(0)

  // Certificate
  certificatePath    String?  // Path to AFIP certificate
  certificateExpiry  DateTime?
  privateKeyPath     String?

  // API Credentials
  wsaaToken          String?  // Current WSAA token
  wsaaTokenExpiry    DateTime?

  isActive           Boolean  @default(true)
  lastSyncAt         DateTime?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  location Location @relation(fields: [locationId], references: [id], onDelete: Cascade)

  @@index([puntoDeVenta])
  @@map("location_afip_configs")
}

model InterLocationTransfer {
  id               String   @id @default(cuid())
  organizationId   String
  fromLocationId   String
  toLocationId     String

  // Transfer Details
  transferType     TransferType
  referenceId      String?  // ID of the related entity (job, technician assignment, etc.)
  reason           String?
  notes            String?

  // Financial (if applicable)
  amount           Decimal? @db.Decimal(10, 2) // Transfer amount for inter-location charges

  // Status Tracking
  status           TransferStatus @default(PENDING)
  requestedById    String
  approvedById     String?
  requestedAt      DateTime @default(now())
  approvedAt       DateTime?
  completedAt      DateTime?

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  fromLocation Location @relation("TransferFromLocation", fields: [fromLocationId], references: [id])
  toLocation   Location @relation("TransferToLocation", fields: [toLocationId], references: [id])
  requestedBy  User     @relation("TransferRequester", fields: [requestedById], references: [id])
  approvedBy   User?    @relation("TransferApprover", fields: [approvedById], references: [id])

  @@index([organizationId])
  @@index([fromLocationId])
  @@index([toLocationId])
  @@index([status])
  @@index([transferType])
  @@map("inter_location_transfers")
}

enum TransferType {
  JOB_ASSIGNMENT    // Job transferred to another location
  TECHNICIAN_LOAN   // Technician temporarily assigned to another location
  CUSTOMER_REFERRAL // Customer referred to another location
  RESOURCE_SHARE    // Sharing of equipment/inventory
  FINANCIAL         // Financial transfer between locations
}

enum TransferStatus {
  PENDING
  APPROVED
  IN_PROGRESS
  COMPLETED
  REJECTED
  CANCELLED
}

// ═══════════════════════════════════════════════════════════════════════════════
// PHASE 12: INVENTORY MANAGEMENT
// ═══════════════════════════════════════════════════════════════════════════════

// ────────────────────────────────────────────────────────────────────────────────
// PRODUCT CATALOG
// ────────────────────────────────────────────────────────────────────────────────

model ProductCategory {
  id             String   @id @default(cuid())
  organizationId String
  parentId       String?
  code           String   // Category code (e.g., "REFR", "ELEC")
  name           String
  description    String?
  sortOrder      Int      @default(0)
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  parent       ProductCategory?  @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children     ProductCategory[] @relation("CategoryHierarchy")
  products     Product[]

  @@unique([organizationId, code])
  @@index([organizationId])
  @@index([parentId])
  @@map("product_categories")
}

model Product {
  id             String   @id @default(cuid())
  organizationId String
  categoryId     String?

  // Identification
  sku            String   // Stock Keeping Unit
  barcode        String?  // EAN-13 or internal barcode
  name           String
  description    String?
  brand          String?
  model          String?

  // Classification
  productType    ProductType @default(PART)
  unitOfMeasure  String      @default("UNIDAD") // UNIDAD, METRO, LITRO, KG

  // Pricing
  costPrice      Decimal  @db.Decimal(12, 2) // Purchase/cost price
  salePrice      Decimal  @db.Decimal(12, 2) // Sale price to customer
  marginPercent  Decimal? @db.Decimal(5, 2)  // Profit margin %
  taxRate        Decimal  @default(21.0) @db.Decimal(5, 2) // IVA rate

  // Inventory Settings
  trackInventory Boolean  @default(true)
  minStockLevel  Int      @default(0)    // Minimum stock (reorder point)
  maxStockLevel  Int?                    // Maximum stock level
  reorderQty     Int?                    // Quantity to reorder

  // Physical
  weight         Decimal? @db.Decimal(10, 3) // Weight in kg
  dimensions     Json?    // { length, width, height } in cm

  // Media
  imageUrl       String?
  images         String[] @default([])

  // Status
  isActive       Boolean  @default(true)
  isSerialTracked Boolean @default(false) // Track individual serial numbers
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization       Organization           @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  category           ProductCategory?       @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  variants           ProductVariant[]
  inventoryLevels    InventoryLevel[]
  stockMovements     StockMovement[]
  purchaseOrderItems PurchaseOrderItem[]
  jobMaterials       JobMaterial[]
  supplierProducts   SupplierProduct[]
  vehicleStocks      VehicleStock[]
  stockReservations  StockReservation[]

  @@unique([organizationId, sku])
  @@index([organizationId])
  @@index([categoryId])
  @@index([barcode])
  @@index([name])
  @@map("products")
}

enum ProductType {
  PART           // Repuesto
  CONSUMABLE     // Consumible
  EQUIPMENT      // Equipo/Herramienta
  SERVICE        // Servicio (no físico)
}

model ProductVariant {
  id          String  @id @default(cuid())
  productId   String
  sku         String  // Variant-specific SKU
  name        String  // Variant name (e.g., "Rojo - XL")
  attributes  Json    // { color: "Rojo", size: "XL" }
  costPrice   Decimal @db.Decimal(12, 2)
  salePrice   Decimal @db.Decimal(12, 2)
  barcode     String?
  isActive    Boolean @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  product         Product          @relation(fields: [productId], references: [id], onDelete: Cascade)
  inventoryLevels InventoryLevel[]
  stockMovements  StockMovement[]

  @@unique([productId, sku])
  @@index([productId])
  @@map("product_variants")
}

// ────────────────────────────────────────────────────────────────────────────────
// WAREHOUSES & STORAGE
// ────────────────────────────────────────────────────────────────────────────────

model Warehouse {
  id             String   @id @default(cuid())
  organizationId String
  locationId     String?  // Link to Location model (branch location)
  vehicleId      String?  @unique // Link to Vehicle (for VEHICLE type warehouses)

  code           String   // Warehouse code (e.g., "DEP-001", "ALM-CABA", "VEH-ABC123")
  name           String
  type           WarehouseType @default(MAIN)
  address        Json?    // { street, city, postalCode }
  contactName    String?
  contactPhone   String?
  contactEmail   String?

  // Settings
  isDefault      Boolean  @default(false) // Default warehouse for the org/location
  allowNegative  Boolean  @default(false) // Allow negative stock
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization     Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  location         Location?         @relation(fields: [locationId], references: [id], onDelete: SetNull)
  vehicle          Vehicle?          @relation("VehicleWarehouse", fields: [vehicleId], references: [id], onDelete: SetNull)
  storageLocations StorageLocation[]
  inventoryLevels  InventoryLevel[]
  stockMovementsFrom StockMovement[] @relation("MovementFromWarehouse")
  stockMovementsTo   StockMovement[] @relation("MovementToWarehouse")
  purchaseOrders   PurchaseOrder[]
  inventoryCounts  InventoryCount[]
  stockReservations StockReservation[]

  @@unique([organizationId, code])
  @@index([organizationId])
  @@index([locationId])
  @@index([vehicleId])
  @@map("warehouses")
}

enum WarehouseType {
  MAIN       // Main warehouse / Depósito principal
  SECONDARY  // Secondary storage / Depósito secundario
  TRANSIT    // In-transit / En tránsito
  VEHICLE    // Vehicle stock / Stock en vehículo
}

model StorageLocation {
  id          String  @id @default(cuid())
  warehouseId String
  code        String  // Location code (e.g., "A-01-03" for Aisle A, Rack 1, Shelf 3)
  name        String?
  description String?
  sortOrder   Int     @default(0)
  isActive    Boolean @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  warehouse       Warehouse        @relation(fields: [warehouseId], references: [id], onDelete: Cascade)
  inventoryLevels InventoryLevel[]

  @@unique([warehouseId, code])
  @@index([warehouseId])
  @@map("storage_locations")
}

// ────────────────────────────────────────────────────────────────────────────────
// INVENTORY LEVELS & TRACKING
// ────────────────────────────────────────────────────────────────────────────────

model InventoryLevel {
  id                String  @id @default(cuid())
  organizationId    String
  productId         String
  variantId         String?
  warehouseId       String
  storageLocationId String?

  // Quantities
  quantityOnHand    Int     @default(0)  // Current physical stock
  quantityReserved  Int     @default(0)  // Reserved for jobs
  quantityOnOrder   Int     @default(0)  // On purchase orders
  quantityAvailable Int     @default(0)  // OnHand - Reserved

  // Lot/Batch Tracking
  lotNumber         String?
  expiryDate        DateTime?

  // Cost Tracking (for FIFO/LIFO)
  unitCost          Decimal @db.Decimal(12, 2)
  totalCost         Decimal @db.Decimal(14, 2)

  // Timestamps
  lastCountedAt     DateTime?
  lastMovementAt    DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  product         Product          @relation(fields: [productId], references: [id], onDelete: Cascade)
  variant         ProductVariant?  @relation(fields: [variantId], references: [id], onDelete: Cascade)
  warehouse       Warehouse        @relation(fields: [warehouseId], references: [id], onDelete: Cascade)
  storageLocation StorageLocation? @relation(fields: [storageLocationId], references: [id], onDelete: SetNull)

  @@unique([productId, variantId, warehouseId, storageLocationId, lotNumber])
  @@index([organizationId])
  @@index([productId])
  @@index([warehouseId])
  @@index([quantityOnHand])
  @@map("inventory_levels")
}

model StockMovement {
  id             String   @id @default(cuid())
  organizationId String
  productId      String
  variantId      String?
  movementNumber String   @unique // Auto-generated movement number

  // Movement Details
  movementType   MovementType
  quantity       Int               // Always positive
  direction      MovementDirection // IN or OUT

  // Source/Destination
  fromWarehouseId String?
  toWarehouseId   String?

  // Related Entities
  jobId          String?   // If related to a job
  purchaseOrderId String?  // If from purchase order
  inventoryCountId String? // If from inventory count
  transferId     String?   // If inter-warehouse transfer

  // Cost Information
  unitCost       Decimal   @db.Decimal(12, 2)
  totalCost      Decimal   @db.Decimal(14, 2)

  // Additional Info
  reference      String?   // External reference
  notes          String?
  performedById  String?   // User who performed the movement
  performedAt    DateTime  @default(now())
  createdAt      DateTime  @default(now())

  product       Product         @relation(fields: [productId], references: [id], onDelete: Restrict)
  variant       ProductVariant? @relation(fields: [variantId], references: [id], onDelete: Restrict)
  fromWarehouse Warehouse?      @relation("MovementFromWarehouse", fields: [fromWarehouseId], references: [id])
  toWarehouse   Warehouse?      @relation("MovementToWarehouse", fields: [toWarehouseId], references: [id])
  job            Job?            @relation(fields: [jobId], references: [id], onDelete: SetNull)
  purchaseOrder  PurchaseOrder?  @relation(fields: [purchaseOrderId], references: [id], onDelete: SetNull)
  inventoryCount InventoryCount? @relation(fields: [inventoryCountId], references: [id], onDelete: SetNull)

  @@index([organizationId])
  @@index([productId])
  @@index([movementType])
  @@index([performedAt])
  @@index([jobId])
  @@index([purchaseOrderId])
  @@map("stock_movements")
}

enum MovementType {
  PURCHASE_RECEIPT  // Recepción de compra
  SALE              // Venta/Uso en trabajo
  ADJUSTMENT_IN     // Ajuste positivo
  ADJUSTMENT_OUT    // Ajuste negativo
  TRANSFER          // Transferencia entre depósitos
  RETURN_IN         // Devolución de cliente
  RETURN_OUT        // Devolución a proveedor
  INITIAL_STOCK     // Stock inicial
  COUNT_ADJUSTMENT  // Ajuste por conteo
  SCRAP             // Descarte/Merma
  VEHICLE_LOAD      // Carga a vehículo
  VEHICLE_RETURN    // Devolución de vehículo
}

enum MovementDirection {
  IN
  OUT
}

model StockReservation {
  id             String   @id @default(cuid())
  organizationId String
  productId      String
  warehouseId    String
  jobId          String

  quantity       Int
  status         ReservationStatus @default(PENDING)
  reservedAt     DateTime @default(now())
  fulfilledAt    DateTime?
  cancelledAt    DateTime?
  expiresAt      DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  product   Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  warehouse Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Cascade)
  job       Job       @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([productId])
  @@index([jobId])
  @@index([status])
  @@map("stock_reservations")
}

enum ReservationStatus {
  PENDING    // Reserved but not yet used
  FULFILLED  // Used/consumed
  CANCELLED  // Reservation cancelled
  EXPIRED    // Reservation expired
}

// ────────────────────────────────────────────────────────────────────────────────
// SUPPLIERS & PURCHASING
// ────────────────────────────────────────────────────────────────────────────────

model Supplier {
  id             String   @id @default(cuid())
  organizationId String

  // Identification
  code           String   // Supplier code
  name           String
  legalName      String?  // Razón social
  cuit           String?  // CUIT (11 digits)
  taxCondition   String?  // Condición frente al IVA

  // Contact
  contactName    String?
  email          String?
  phone          String?
  website        String?

  // Address
  address        Json?    // { street, city, province, postalCode }

  // Payment Terms
  paymentTermDays Int     @default(30)
  creditLimit    Decimal? @db.Decimal(14, 2)
  currency       String   @default("ARS")

  // Bank Info
  bankInfo       Json?    // { bankName, accountNumber, cbu, alias }

  // Status
  isActive       Boolean  @default(true)
  rating         Int?     // 1-5 supplier rating
  notes          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization     Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  purchaseOrders   PurchaseOrder[]
  supplierProducts SupplierProduct[]

  @@unique([organizationId, code])
  @@index([organizationId])
  @@index([name])
  @@map("suppliers")
}

model SupplierProduct {
  id          String  @id @default(cuid())
  supplierId  String
  productId   String

  supplierSku     String?  // Supplier's product code
  supplierName    String?  // Supplier's product name
  purchasePrice   Decimal  @db.Decimal(12, 2)
  minOrderQty     Int      @default(1)
  leadTimeDays    Int?     // Expected delivery days
  isPreferred     Boolean  @default(false) // Preferred supplier for this product
  lastPurchaseAt  DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  supplier  Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([supplierId, productId])
  @@index([supplierId])
  @@index([productId])
  @@map("supplier_products")
}

model PurchaseOrder {
  id             String   @id @default(cuid())
  organizationId String
  supplierId     String
  warehouseId    String   // Destination warehouse

  // Order Details
  orderNumber    String   @unique
  status         POStatus @default(DRAFT)
  orderDate      DateTime @default(now())
  expectedDate   DateTime?
  receivedDate   DateTime?

  // Financial
  subtotal       Decimal  @db.Decimal(14, 2)
  taxAmount      Decimal  @db.Decimal(14, 2)
  total          Decimal  @db.Decimal(14, 2)
  currency       String   @default("ARS")

  // Shipping
  shippingMethod String?
  shippingCost   Decimal? @db.Decimal(10, 2)
  trackingNumber String?

  // Additional
  notes          String?
  internalNotes  String?
  createdById    String?
  approvedById   String?
  approvedAt     DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization   Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  supplier       Supplier            @relation(fields: [supplierId], references: [id])
  warehouse      Warehouse           @relation(fields: [warehouseId], references: [id])
  items          PurchaseOrderItem[]
  stockMovements StockMovement[]
  receivings     PurchaseReceiving[]

  @@index([organizationId])
  @@index([supplierId])
  @@index([status])
  @@index([orderDate])
  @@map("purchase_orders")
}

enum POStatus {
  DRAFT        // Borrador
  PENDING      // Pendiente de aprobación
  APPROVED     // Aprobada
  SENT         // Enviada al proveedor
  PARTIAL      // Parcialmente recibida
  RECEIVED     // Recibida completa
  CANCELLED    // Cancelada
}

model PurchaseOrderItem {
  id              String  @id @default(cuid())
  purchaseOrderId String
  productId       String

  quantity        Int
  quantityReceived Int    @default(0)
  unitPrice       Decimal @db.Decimal(12, 2)
  discount        Decimal @default(0) @db.Decimal(5, 2) // Discount %
  taxRate         Decimal @default(21.0) @db.Decimal(5, 2)
  lineTotal       Decimal @db.Decimal(14, 2)
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  purchaseOrder PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  product       Product       @relation(fields: [productId], references: [id])

  @@index([purchaseOrderId])
  @@index([productId])
  @@map("purchase_order_items")
}

model PurchaseReceiving {
  id              String   @id @default(cuid())
  purchaseOrderId String
  receivingNumber String   @unique
  receivedById    String?
  receivedAt      DateTime @default(now())
  notes           String?

  items           Json     // [{ productId, quantityExpected, quantityReceived, notes }]
  hasVariance     Boolean  @default(false)
  createdAt       DateTime @default(now())

  purchaseOrder PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)

  @@index([purchaseOrderId])
  @@map("purchase_receivings")
}

// ────────────────────────────────────────────────────────────────────────────────
// INVENTORY COUNTS & AUDITING
// ────────────────────────────────────────────────────────────────────────────────

model InventoryCount {
  id             String   @id @default(cuid())
  organizationId String
  warehouseId    String

  countNumber    String   @unique
  countType      CountType @default(FULL)
  status         CountStatus @default(DRAFT)

  // Timing
  scheduledAt    DateTime?
  startedAt      DateTime?
  completedAt    DateTime?

  // Results
  totalItems     Int?
  matchedItems   Int?
  varianceItems  Int?
  totalVariance  Decimal? @db.Decimal(14, 2) // Total variance value

  // Personnel
  assignedToId   String?
  completedById  String?
  approvedById   String?
  approvedAt     DateTime?

  notes          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization   Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  warehouse      Warehouse           @relation(fields: [warehouseId], references: [id])
  items          InventoryCountItem[]
  stockMovements StockMovement[]

  @@index([organizationId])
  @@index([warehouseId])
  @@index([status])
  @@map("inventory_counts")
}

enum CountType {
  FULL       // Full inventory count
  CYCLE      // Cycle count (subset)
  SPOT       // Spot check
  ANNUAL     // Annual count
}

enum CountStatus {
  DRAFT      // Not started
  IN_PROGRESS // Counting in progress
  PENDING_REVIEW // Awaiting review
  APPROVED   // Approved, adjustments made
  CANCELLED  // Cancelled
}

model InventoryCountItem {
  id              String  @id @default(cuid())
  inventoryCountId String
  productId       String

  expectedQty     Int     // System quantity
  countedQty      Int?    // Physical count
  variance        Int?    // Difference
  varianceValue   Decimal? @db.Decimal(12, 2)
  notes           String?
  countedAt       DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  inventoryCount InventoryCount @relation(fields: [inventoryCountId], references: [id], onDelete: Cascade)

  @@index([inventoryCountId])
  @@index([productId])
  @@map("inventory_count_items")
}

// ────────────────────────────────────────────────────────────────────────────────
// VEHICLE/TECHNICIAN INVENTORY
// ────────────────────────────────────────────────────────────────────────────────

model VehicleStock {
  id             String   @id @default(cuid())
  organizationId String
  technicianId   String   // User with TECHNICIAN role
  productId      String

  quantity       Int      @default(0)
  minLevel       Int      @default(0)  // Min stock for this vehicle
  maxLevel       Int?                   // Max stock for this vehicle
  lastRefilledAt DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  technician User    @relation(fields: [technicianId], references: [id], onDelete: Cascade)
  product    Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([technicianId, productId])
  @@index([organizationId])
  @@index([technicianId])
  @@index([productId])
  @@map("vehicle_stocks")
}

model ReplenishmentRequest {
  id             String   @id @default(cuid())
  organizationId String
  technicianId   String
  warehouseId    String?

  requestNumber  String   @unique
  status         ReplenishmentStatus @default(PENDING)
  requestedAt    DateTime @default(now())
  processedAt    DateTime?
  processedById  String?
  notes          String?

  items          Json     // [{ productId, quantity, notes }]
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([organizationId])
  @@index([technicianId])
  @@index([status])
  @@map("replenishment_requests")
}

enum ReplenishmentStatus {
  PENDING    // Awaiting processing
  APPROVED   // Approved, ready for pickup
  IN_TRANSIT // Being delivered
  COMPLETED  // Received by technician
  REJECTED   // Request rejected
  CANCELLED  // Cancelled by technician
}

// ────────────────────────────────────────────────────────────────────────────────
// JOB-INVENTORY INTEGRATION
// ────────────────────────────────────────────────────────────────────────────────

model JobMaterial {
  id             String   @id @default(cuid())
  jobId          String
  productId      String

  // Quantities
  estimatedQty   Int      @default(0) // Estimated at job creation
  usedQty        Int      @default(0) // Actually used
  returnedQty    Int      @default(0) // Returned unused

  // Pricing
  unitPrice      Decimal  @db.Decimal(12, 2) // Sale price
  unitCost       Decimal  @db.Decimal(12, 2) // Cost price
  discount       Decimal  @default(0) @db.Decimal(5, 2)
  lineTotal      Decimal  @db.Decimal(14, 2)

  // Source
  sourceType     MaterialSource @default(WAREHOUSE)
  sourceId       String?  // warehouseId or technicianId (vehicle)

  // Status
  isInvoiced     Boolean  @default(false)
  notes          String?
  addedAt        DateTime @default(now())
  usedAt         DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  job     Job     @relation(fields: [jobId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@index([jobId])
  @@index([productId])
  @@map("job_materials")
}

enum MaterialSource {
  WAREHOUSE  // From warehouse stock
  VEHICLE    // From technician's vehicle
  CUSTOMER   // Provided by customer
  PURCHASE   // Direct purchase for job
}

// ═══════════════════════════════════════════════════════════════════════════════
// PHASE: DATABASE NORMALIZATION - New Tables (Migrations 055-060)
// ═══════════════════════════════════════════════════════════════════════════════

// ────────────────────────────────────────────────────────────────────────────────
// JOB PHOTOS - Normalized from jobs.photos TEXT[]
// ────────────────────────────────────────────────────────────────────────────────

model JobPhoto {
  id           String     @id @default(cuid())
  jobId        String
  uploadedById String?

  // Photo Details
  photoUrl     String
  thumbnailUrl String?
  photoType    PhotoType  @default(AFTER)

  // Metadata
  fileSize     Int?       // Bytes
  width        Int?
  height       Int?
  mimeType     String?

  // Mobile Sync
  localId      String?    // Client-generated ID for offline
  syncStatus   SyncStatus @default(SYNCED)

  // Timestamps
  takenAt      DateTime?  // When photo was taken
  createdAt    DateTime   @default(now())

  job          Job        @relation("JobPhotos", fields: [jobId], references: [id], onDelete: Cascade)
  uploadedBy   User?      @relation("PhotoUploader", fields: [uploadedById], references: [id], onDelete: SetNull)

  @@index([jobId])
  @@index([syncStatus])
  @@map("job_photos")
}

enum PhotoType {
  BEFORE
  DURING
  AFTER
  SIGNATURE
  DOCUMENT
}

enum SyncStatus {
  PENDING
  SYNCING
  SYNCED
  CONFLICT
  FAILED
}

// ────────────────────────────────────────────────────────────────────────────────
// INVOICE ITEMS - Normalized from invoices.items JSONB
// ────────────────────────────────────────────────────────────────────────────────

model InvoiceItem {
  id           String   @id @default(cuid())
  invoiceId    String
  priceBookId  String?

  // Item Info
  description  String
  quantity     Decimal  @default(1) @db.Decimal(10, 3)
  unit         String   @default("unidad")

  // Pricing
  unitPrice    Decimal  @db.Decimal(12, 2)
  taxRate      Decimal  @default(21.00) @db.Decimal(5, 2)
  subtotal     Decimal  @db.Decimal(12, 2)
  taxAmount    Decimal  @db.Decimal(12, 2)
  total        Decimal  @db.Decimal(12, 2)

  // AFIP Codes
  afipProductCode String?
  afipUnitCode    String?  @default("7")

  // Sort Order
  sortOrder    Int      @default(0)

  // Timestamps
  createdAt    DateTime @default(now())

  invoice      Invoice  @relation("InvoiceLineItems", fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@map("invoice_items")
}

// ────────────────────────────────────────────────────────────────────────────────
// PAYMENT DISPUTES - Normalized from payments inline columns
// ────────────────────────────────────────────────────────────────────────────────

model PaymentDispute {
  id                  String        @id @default(cuid())
  paymentId           String

  // Mercado Pago Reference
  mpDisputeId         String?

  // Dispute Info
  disputeType         DisputeType
  reason              String?
  description         String?

  // Status
  status              DisputeStatus @default(PENDING_RESPONSE)

  // Deadline
  responseDeadline    DateTime?
  daysToRespond       Int?

  // Evidence
  evidenceSubmittedAt DateTime?
  evidenceUrls        String[]      @default([])
  evidenceNotes       String?
  evidenceDocuments   Json?

  // Resolution
  resolvedAt          DateTime?
  resolutionNotes     String?
  resolutionType      String?

  // Amounts
  disputedAmount      Decimal       @db.Decimal(12, 2)
  recoveredAmount     Decimal?      @db.Decimal(12, 2)

  // Communication
  lastCommunicationAt DateTime?
  communicationLog    Json          @default("[]")

  // Timestamps
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt

  payment             Payment       @relation("PaymentDisputes", fields: [paymentId], references: [id], onDelete: Cascade)

  @@index([paymentId])
  @@index([status])
  @@map("payment_disputes")
}

enum DisputeType {
  CHARGEBACK
  FRAUD_CLAIM
  SERVICE_NOT_RECEIVED
  DUPLICATE_CHARGE
  PRODUCT_NOT_AS_DESCRIBED
  CANCELLED_TRANSACTION
  OTHER
}

enum DisputeStatus {
  PENDING_RESPONSE
  EVIDENCE_SUBMITTED
  UNDER_REVIEW
  ESCALATED
  WON
  LOST
  WITHDRAWN
}

// ────────────────────────────────────────────────────────────────────────────────
// VOICE TRANSCRIPTS - Normalized from whatsapp_messages inline columns
// ────────────────────────────────────────────────────────────────────────────────

model VoiceTranscript {
  id                      String              @id @default(cuid())
  messageId               String              @unique
  reviewedById            String?
  createdJobId            String?

  // Audio Info
  audioUrl                String
  audioDuration           Int?                // Seconds
  audioQuality            String?             // 'clean', 'noisy', 'poor'
  audioLanguage           String?             @default("es")

  // Transcription (AI)
  transcription           String?
  transcriptionModel      String?
  transcriptionConfidence Decimal?            @db.Decimal(3, 2)
  transcriptionSegments   Json?

  // Extraction (AI)
  extractionData          Json?
  extractionModel         String?
  overallConfidence       Decimal?            @db.Decimal(3, 2)

  // Human Review
  humanTranscription      String?
  humanExtraction         Json?
  reviewedAt              DateTime?
  reviewNotes             String?

  // Status
  status                  VoiceTranscriptStatus @default(PENDING)
  errorMessage            String?
  errorCode               String?

  // Processing
  processingStartedAt     DateTime?
  processingCompletedAt   DateTime?
  processingDurationMs    Int?
  retryCount              Int                 @default(0)

  // Job Creation
  autoCreated             Boolean             @default(false)

  // Timestamps
  createdAt               DateTime            @default(now())
  updatedAt               DateTime            @updatedAt

  message                 WhatsAppMessage     @relation("MessageTranscript", fields: [messageId], references: [id], onDelete: Cascade)
  reviewedBy              User?               @relation("TranscriptReviewer", fields: [reviewedById], references: [id], onDelete: SetNull)

  @@index([status])
  @@map("voice_transcripts")
}

enum VoiceTranscriptStatus {
  PENDING
  TRANSCRIBING
  EXTRACTING
  COMPLETED
  NEEDS_REVIEW
  REVIEWED
  FAILED
}

// ────────────────────────────────────────────────────────────────────────────────
// FAILED JOBS - Dead Letter Queue for BullMQ
// ────────────────────────────────────────────────────────────────────────────────

model FailedJob {
  id                 String    @id @default(cuid())

  // Queue Info
  queueName          String
  jobId              String
  jobName            String?

  // Job Data
  jobData            Json

  // Error
  errorMessage       String
  errorStack         String?
  errorCode          String?
  errorType          String?

  // Attempts
  attempts           Int       @default(1)
  maxAttempts        Int
  lastAttemptAt      DateTime  @default(now())

  // Context
  organizationId     String?
  userId             String?
  relatedEntityType  String?
  relatedEntityId    String?

  // Status
  status             String    @default("pending") // pending, retrying, retried, discarded, resolved
  priority           Int       @default(0)
  resolvedById       String?
  resolvedAt         DateTime?
  resolutionNotes    String?
  resolutionType     String?

  // Retry
  retryJobId         String?
  retriedAt          DateTime?
  retryCount         Int       @default(0)

  // Tags
  tags               String[]  @default([])

  // Timestamps
  failedAt           DateTime  @default(now())
  createdAt          DateTime  @default(now())

  organization       Organization? @relation("FailedJobOrg", fields: [organizationId], references: [id], onDelete: SetNull)

  @@index([queueName, status])
  @@index([organizationId])
  @@index([status])
  @@map("failed_jobs")
}

// ────────────────────────────────────────────────────────────────────────────────
// IDEMPOTENCY KEYS - Request deduplication
// ────────────────────────────────────────────────────────────────────────────────

model IdempotencyKey {
  id             String    @id @default(cuid())

  // Key
  key            String    @unique

  // Result
  result         Json?
  status         String    @default("processing") // processing, completed, failed
  statusCode     Int?

  // Context
  organizationId String?
  userId         String?
  operationType  String?

  // Request Info
  requestPath    String?
  requestMethod  String?
  requestHash    String?

  // Expiration
  expiresAt      DateTime

  // Timestamps
  createdAt      DateTime  @default(now())
  completedAt    DateTime?

  organization   Organization? @relation("IdempotencyOrg", fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([expiresAt])
  @@index([organizationId])
  @@map("idempotency_keys")
}

// ═══════════════════════════════════════════════════════════════════════════════
// EMPLOYEE TRACKING SYSTEM
// ═══════════════════════════════════════════════════════════════════════════════

model TechnicianLocation {
  id          String   @id @default(cuid())
  userId      String   @unique
  latitude    Decimal  @db.Decimal(10, 8)
  longitude   Decimal  @db.Decimal(11, 8)
  accuracy    Decimal? @db.Decimal(6, 2)
  heading     Decimal? @db.Decimal(5, 2)
  speed       Decimal? @db.Decimal(6, 2)
  altitude    Decimal? @db.Decimal(10, 2)
  isOnline    Boolean  @default(true)
  lastSeen    DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation("TechnicianCurrentLocation", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isOnline])
  @@index([lastSeen])
  @@map("technician_locations")
}

model TechnicianLocationHistory {
  id          String   @id @default(cuid())
  userId      String
  jobId       String?
  sessionId   String?
  latitude    Decimal  @db.Decimal(10, 8)
  longitude   Decimal  @db.Decimal(11, 8)
  accuracy    Decimal? @db.Decimal(6, 2)
  heading     Decimal? @db.Decimal(5, 2)
  speed       Decimal? @db.Decimal(6, 2)
  movementMode String?  // driving, walking, stationary
  recordedAt  DateTime @default(now())

  @@index([userId, recordedAt])
  @@index([jobId])
  @@index([sessionId])
  @@map("technician_location_history")
}

model TrackingSession {
  id                  String   @id @default(cuid())
  jobId               String
  technicianId        String
  organizationId      String
  status              TrackingSessionStatus @default(ACTIVE)
  currentLat          Decimal? @db.Decimal(10, 8)
  currentLng          Decimal? @db.Decimal(11, 8)
  currentSpeed        Decimal? @db.Decimal(6, 2)
  currentHeading      Decimal? @db.Decimal(5, 2)
  destinationLat      Decimal? @db.Decimal(10, 8)
  destinationLng      Decimal? @db.Decimal(11, 8)
  destinationAddress  String?
  etaMinutes          Int?
  etaUpdatedAt        DateTime?
  routePolyline       String?  @db.Text
  movementMode        String   @default("driving")
  positionUpdateCount Int      @default(0)
  lastPositionAt      DateTime?
  startedAt           DateTime @default(now())
  arrivedAt           DateTime?
  completedAt         DateTime?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  job             Job          @relation("JobTrackingSessions", fields: [jobId], references: [id], onDelete: Cascade)
  technician      User         @relation("TechnicianTrackingSessions", fields: [technicianId], references: [id], onDelete: Cascade)
  organization    Organization @relation("OrgTrackingSessions", fields: [organizationId], references: [id], onDelete: Cascade)
  tokens          TrackingToken[]
  locationHistory TrackingLocationHistory[]

  @@index([jobId])
  @@index([technicianId])
  @@index([organizationId])
  @@index([status])
  @@map("tracking_sessions")
}

enum TrackingSessionStatus {
  ACTIVE
  ARRIVED
  COMPLETED
  CANCELLED
}

model TrackingToken {
  id             String   @id @default(cuid())
  token          String   @unique
  jobId          String
  sessionId      String?
  expiresAt      DateTime
  accessCount    Int      @default(0)
  lastAccessedAt DateTime?
  createdAt      DateTime @default(now())

  session TrackingSession? @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([jobId])
  @@index([expiresAt])
  @@map("tracking_tokens")
}

model EtaCache {
  id             String   @id @default(cuid())
  originLat      Decimal  @db.Decimal(10, 8)
  originLng      Decimal  @db.Decimal(11, 8)
  destLat        Decimal  @db.Decimal(10, 8)
  destLng        Decimal  @db.Decimal(11, 8)
  durationMinutes Int
  distanceMeters  Int
  source         String   // google, haversine, cached
  calculatedAt   DateTime @default(now())
  expiresAt      DateTime

  @@index([expiresAt])
  @@map("eta_cache")
}

// ═══════════════════════════════════════════════════════════════════════════════
// FLEET MANAGEMENT
// ═══════════════════════════════════════════════════════════════════════════════

model Vehicle {
  id                   String        @id @default(cuid())
  organizationId       String
  plateNumber          String
  make                 String        // Ford, Chevrolet, etc.
  model                String        // Transit, S10, etc.
  year                 Int
  vin                  String?       // Vehicle Identification Number
  color                String?
  status               VehicleStatus @default(ACTIVE)
  currentMileage       Int?
  fuelType             FuelType      @default(GASOLINE)
  insuranceCompany     String?
  insurancePolicyNumber String?
  insuranceExpiry      DateTime?
  vtvExpiry            DateTime?     // Buenos Aires vehicle inspection
  registrationExpiry   DateTime?
  lastServiceDate      DateTime?
  nextServiceDate      DateTime?
  nextServiceMileage   Int?
  notes                String?
  createdAt            DateTime      @default(now())
  updatedAt            DateTime      @updatedAt

  organization    Organization       @relation("OrgVehicles", fields: [organizationId], references: [id], onDelete: Cascade)
  documents       VehicleDocument[]
  assignments     VehicleAssignment[]
  maintenanceLogs VehicleMaintenance[]
  inventoryLocations InventoryLocation[] @relation("VehicleInventoryLocations")
  warehouse       Warehouse?         @relation("VehicleWarehouse") // Inventory warehouse for this vehicle

  @@unique([organizationId, plateNumber])
  @@index([organizationId])
  @@index([status])
  @@index([insuranceExpiry])
  @@index([vtvExpiry])
  @@map("vehicles")
}

enum VehicleStatus {
  ACTIVE
  MAINTENANCE
  INACTIVE
  RETIRED
}

enum FuelType {
  GASOLINE
  DIESEL
  ELECTRIC
  GNC
  HYBRID
}

model VehicleDocument {
  id           String             @id @default(cuid())
  vehicleId    String
  documentType VehicleDocumentType
  fileName     String
  fileUrl      String
  fileSize     Int?
  mimeType     String?
  expiryDate   DateTime?
  notes        String?
  uploadedById String
  uploadedAt   DateTime           @default(now())
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt

  vehicle    Vehicle @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  uploadedBy User    @relation("UploadedVehicleDocuments", fields: [uploadedById], references: [id])

  @@index([vehicleId])
  @@index([documentType])
  @@index([expiryDate])
  @@map("vehicle_documents")
}

enum VehicleDocumentType {
  INSURANCE
  VTV
  REGISTRATION
  TITLE
  GREEN_CARD
  SERVICE_RECORD
  OTHER
}

model VehicleAssignment {
  id             String    @id @default(cuid())
  vehicleId      String
  userId         String
  assignedFrom   DateTime  @default(now())
  assignedUntil  DateTime?
  isPrimaryDriver Boolean  @default(false)
  notes          String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  vehicle Vehicle @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  user    User    @relation("UserVehicleAssignments", fields: [userId], references: [id], onDelete: Cascade)

  @@index([vehicleId])
  @@index([userId])
  @@index([assignedFrom, assignedUntil])
  @@map("vehicle_assignments")
}

model VehicleMaintenance {
  id              String          @id @default(cuid())
  vehicleId       String
  maintenanceType MaintenanceType
  description     String
  mileageAtService Int?
  cost            Decimal?        @db.Decimal(10, 2)
  vendor          String?
  invoiceNumber   String?
  scheduledDate   DateTime?
  completedDate   DateTime?
  nextServiceDate DateTime?
  nextServiceMileage Int?
  notes           String?
  createdById     String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  vehicle   Vehicle @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  createdBy User?   @relation("CreatedMaintenanceLogs", fields: [createdById], references: [id])

  @@index([vehicleId])
  @@index([maintenanceType])
  @@index([scheduledDate])
  @@map("vehicle_maintenance")
}

enum MaintenanceType {
  OIL_CHANGE
  TIRE_ROTATION
  BRAKE_SERVICE
  INSPECTION
  REPAIR
  SCHEDULED_SERVICE
  OTHER
}

// ═══════════════════════════════════════════════════════════════════════════════
// ENHANCED INVENTORY MANAGEMENT (for Employee Tracking System)
// ═══════════════════════════════════════════════════════════════════════════════

model InventoryItem {
  id              String   @id @default(cuid())
  organizationId  String
  sku             String
  name            String
  description     String?
  category        InventoryCategory @default(PARTS)
  unit            String   @default("pieza")
  minStockLevel   Int      @default(0)
  costPrice       Decimal  @db.Decimal(10, 2)
  salePrice       Decimal  @db.Decimal(10, 2)
  isActive        Boolean  @default(true)
  imageUrl        String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  organization Organization           @relation("OrgInventoryItems", fields: [organizationId], references: [id], onDelete: Cascade)
  stocks       InventoryStock[]
  transactions InventoryTransaction[]

  @@unique([organizationId, sku])
  @@index([organizationId])
  @@index([category])
  @@index([isActive])
  @@map("inventory_items")
}

enum InventoryCategory {
  PARTS
  TOOLS
  CONSUMABLES
  EQUIPMENT
  SAFETY
  OTHER
}

model InventoryLocation {
  id             String   @id @default(cuid())
  organizationId String
  locationType   InventoryLocationType
  name           String
  vehicleId      String?
  address        String?
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation("OrgInventoryLocations", fields: [organizationId], references: [id], onDelete: Cascade)
  vehicle      Vehicle?     @relation("VehicleInventoryLocations", fields: [vehicleId], references: [id], onDelete: SetNull)
  stocks       InventoryStock[]
  transactionsFrom InventoryTransaction[] @relation("TransactionFromLocation")
  transactionsTo   InventoryTransaction[] @relation("TransactionToLocation")

  @@index([organizationId])
  @@index([locationType])
  @@index([vehicleId])
  @@map("inventory_locations")
}

enum InventoryLocationType {
  HUB
  VEHICLE
  WAREHOUSE
}

model InventoryStock {
  id            String   @id @default(cuid())
  itemId        String
  locationId    String
  quantity      Int      @default(0)
  lastCountedAt DateTime?
  updatedAt     DateTime @updatedAt

  item     InventoryItem     @relation(fields: [itemId], references: [id], onDelete: Cascade)
  location InventoryLocation @relation(fields: [locationId], references: [id], onDelete: Cascade)

  @@unique([itemId, locationId])
  @@index([itemId])
  @@index([locationId])
  @@index([quantity])
  @@map("inventory_stock")
}

model InventoryTransaction {
  id              String                  @id @default(cuid())
  organizationId  String
  itemId          String
  fromLocationId  String?
  toLocationId    String?
  quantity        Int
  transactionType InventoryTransactionType
  jobId           String?
  notes           String?
  performedById   String
  performedAt     DateTime                @default(now())
  createdAt       DateTime                @default(now())

  organization Organization      @relation("OrgInventoryTransactions", fields: [organizationId], references: [id], onDelete: Cascade)
  item         InventoryItem     @relation(fields: [itemId], references: [id], onDelete: Restrict)
  fromLocation InventoryLocation? @relation("TransactionFromLocation", fields: [fromLocationId], references: [id])
  toLocation   InventoryLocation? @relation("TransactionToLocation", fields: [toLocationId], references: [id])
  performedBy  User              @relation("PerformedTransactions", fields: [performedById], references: [id])

  @@index([organizationId])
  @@index([itemId])
  @@index([fromLocationId])
  @@index([toLocationId])
  @@index([transactionType])
  @@index([performedAt])
  @@map("inventory_transactions")
}

enum InventoryTransactionType {
  PURCHASE
  TRANSFER
  USE
  ADJUSTMENT
  RETURN
  INITIAL_STOCK
  SCRAP
}

// ═══════════════════════════════════════════════════════════════════════════════
// DASHBOARD ALERTS
// ═══════════════════════════════════════════════════════════════════════════════

model DashboardAlert {
  id             String       @id @default(cuid())
  organizationId String
  alertType      AlertType
  severity       AlertSeverity
  title          String
  message        String
  entityType     String?      // vehicle, inventory_item, job, etc.
  entityId       String?
  isRead         Boolean      @default(false)
  isDismissed    Boolean      @default(false)
  expiresAt      DateTime?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  organization Organization @relation("OrgDashboardAlerts", fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([alertType])
  @@index([severity])
  @@index([isRead])
  @@index([createdAt])
  @@map("dashboard_alerts")
}

enum AlertType {
  VEHICLE_DOCUMENT_EXPIRING
  VEHICLE_DOCUMENT_EXPIRED
  LOW_STOCK
  OUT_OF_STOCK
  VEHICLE_MAINTENANCE_DUE
  JOB_OVERDUE
  TECHNICIAN_OFFLINE
  SYSTEM
}

enum AlertSeverity {
  CRITICAL
  WARNING
  INFO
}

// ═══════════════════════════════════════════════════════════════════════════════
// PRICEBOOK
// ═══════════════════════════════════════════════════════════════════════════════

enum PriceItemType {
  SERVICE
  PRODUCT
}

model PriceItem {
  id             String        @id @default(cuid())
  organizationId String
  name           String
  description    String?
  type           PriceItemType @default(SERVICE)
  price          Decimal       @db.Decimal(12, 2)
  unit           String?       // hora, unidad, metro, etc.
  taxRate        Decimal       @default(21.0) @db.Decimal(5, 2)
  isActive       Boolean       @default(true)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  organization Organization @relation("OrgPriceItems", fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([type])
  @@index([isActive])
  @@map("price_items")
}

// ═══════════════════════════════════════════════════════════════════════════════
// WHATSAPP BUSINESS INTEGRATION
// ═══════════════════════════════════════════════════════════════════════════════

// WhatsApp Business Account (one per organization)
model WhatsAppBusinessAccount {
  id                    String   @id @default(cuid())
  organizationId        String   @unique
  organization          Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Meta Business credentials
  phoneNumberId         String?  // WhatsApp Phone Number ID
  businessAccountId     String?  // WhatsApp Business Account ID
  accessToken           String?  // Encrypted access token
  accessTokenExpiresAt  DateTime?

  // Webhook configuration
  webhookVerifyToken    String   @default(cuid())
  webhookSecret         String?  // For signature verification

  // Status
  status                WaAccountStatus @default(PENDING)
  verifiedAt            DateTime?

  // Metadata
  displayPhoneNumber    String?  // +54 11 1234-5678
  businessName          String?

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([organizationId])
  @@map("whatsapp_business_accounts")
}

enum WaAccountStatus {
  PENDING
  VERIFYING
  ACTIVE
  SUSPENDED
  DISCONNECTED
}

// WhatsApp Conversations (threads with customers)
model WaConversation {
  id                    String   @id @default(cuid())
  organizationId        String
  organization          Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Contact info
  customerPhone         String   // +5491112345678
  customerName          String?
  customerId            String?  // Link to Customer record if exists
  customer              Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)

  // Conversation state
  status                WaConversationStatus @default(OPEN)
  isUnread              Boolean  @default(true)
  unreadCount           Int      @default(0)
  lastMessageAt         DateTime @default(now())
  lastMessagePreview    String?  // First 100 chars of last message
  lastMessageDirection  String?  // 'inbound' | 'outbound'
  lastMessageStatus     String?  // 'sent' | 'delivered' | 'read' | 'failed'

  // 24-hour window tracking
  windowExpiresAt       DateTime? // When the 24h reply window closes
  canSendFreeform       Boolean  @default(false) // Can send without template

  // Assignment
  assignedToId          String?
  assignedTo            User?    @relation("WaConversationAssignee", fields: [assignedToId], references: [id], onDelete: SetNull)

  // Related entities
  activeJobId           String?  // Currently discussed job

  // Active status
  isActive              Boolean  @default(true)

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  messages              WaMessage[]

  @@unique([organizationId, customerPhone])
  @@index([organizationId, status])
  @@index([organizationId, isUnread])
  @@index([organizationId, lastMessageAt])
  @@index([customerId])
  @@map("wa_conversations")
}

enum WaConversationStatus {
  OPEN
  CLOSED
  ARCHIVED
  SPAM
}

// WhatsApp Messages
model WaMessage {
  id                    String   @id @default(cuid())
  organizationId        String
  organization          Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  conversationId        String
  conversation          WaConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  // Customer reference (denormalized for queries)
  customerId            String?

  // WhatsApp message identifiers
  waMessageId           String?  @unique // WhatsApp's message ID

  // Message details
  direction             String   // 'inbound' | 'outbound'
  type                  String   // 'text' | 'image' | 'audio' | 'video' | 'document' | 'template' | 'interactive'
  from                  String   // Sender phone/ID
  to                    String   // Recipient phone/ID
  content               String   // Message text content

  // Media
  mediaId               String?
  mediaUrl              String?
  mediaMimeType         String?
  mediaFilename         String?

  // Template info (for outbound templates)
  templateName          String?
  templateParams        Json?

  // Interactive message metadata
  metadata              Json?

  // Status tracking
  status                String   @default("pending") // 'pending' | 'queued' | 'sent' | 'delivered' | 'read' | 'failed'
  statusUpdatedAt       DateTime?
  errorCode             String?
  errorMessage          String?

  // Sender info (for outbound)
  sentById              String?
  sentBy                User?    @relation("WaMessageSender", fields: [sentById], references: [id], onDelete: SetNull)

  // Reply context
  replyToId             String?  // ID of message being replied to

  createdAt             DateTime @default(now())

  @@index([conversationId, createdAt])
  @@index([organizationId, createdAt])
  @@index([waMessageId])
  @@map("wa_messages")
}

// WhatsApp Message Templates
model WaTemplate {
  id                    String   @id @default(cuid())
  organizationId        String
  organization          Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Meta template info
  waTemplateId          String?  // Meta's template ID
  name                  String   // Template name (lowercase, underscores)
  language              String   @default("es_AR")
  category              WaTemplateCategory @default(UTILITY)

  // Content
  components            Json     // Array of component objects
  headerType            String?  // 'TEXT' | 'IMAGE' | 'VIDEO' | 'DOCUMENT'
  headerContent         String?
  bodyText              String?  // Main message body
  footerText            String?
  buttons               Json?    // Array of button objects

  // Status from Meta
  status                WaTemplateStatus @default(PENDING)
  rejectionReason       String?

  // Usage tracking
  usageCount            Int      @default(0)
  lastUsedAt            DateTime?

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@unique([organizationId, name, language])
  @@index([organizationId, status])
  @@index([organizationId, category])
  @@map("wa_templates")
}

enum WaTemplateCategory {
  UTILITY
  MARKETING
  AUTHENTICATION
}

enum WaTemplateStatus {
  DRAFT
  PENDING
  APPROVED
  REJECTED
  PAUSED
  DISABLED
}

enum WaTemplateHeaderType {
  TEXT
  IMAGE
  VIDEO
  DOCUMENT
  LOCATION
}

// Outbound Message Queue
model WaOutboundQueue {
  id                    String   @id @default(cuid())
  organizationId        String
  organization          Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Message details
  messageId             String?  // Reference to WaMessage
  to                    String   // Recipient phone
  type                  String   // 'text' | 'template' | 'media' | 'interactive'
  payload               Json     // Message payload

  // Processing status
  status                WaQueueStatus @default(PENDING)
  attempts              Int      @default(0)
  maxAttempts           Int      @default(3)
  lastAttemptAt         DateTime?
  nextAttemptAt         DateTime?

  // Result
  waMessageId           String?  // WhatsApp message ID when sent
  errorCode             String?
  errorMessage          String?

  // Priority & ordering
  priority              Int      @default(0)
  scheduledFor          DateTime?

  createdAt             DateTime @default(now())
  processedAt           DateTime?

  @@index([organizationId, status])
  @@index([status, nextAttemptAt])
  @@index([scheduledFor])
  @@map("wa_outbound_queue")
}

enum WaQueueStatus {
  PENDING
  PROCESSING
  SENT
  FAILED
  CANCELLED
}

// Webhook Event Log (for debugging and replay)
model WaWebhookLog {
  id                    String   @id @default(cuid())
  organizationId        String?
  organization          Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)

  // Request info
  eventType             String   // 'messages' | 'message_status' | 'errors'
  payload               Json     // Raw webhook payload
  signature             String?  // x-hub-signature-256

  // Processing
  processed             Boolean  @default(false)
  processedAt           DateTime?
  error                 String?

  receivedAt            DateTime @default(now())

  @@index([organizationId, receivedAt])
  @@index([processed])
  @@map("wa_webhook_logs")
}

// ═══════════════════════════════════════════════════════════════════════════════
// MISSING MODELS - Added for code compatibility
// ═══════════════════════════════════════════════════════════════════════════════

// AuditLog - Security and compliance logging
model AuditLog {
  id             String   @id @default(cuid())
  organizationId String
  userId         String?
  action         String   // MANUAL_VERIFICATION, LOGIN, etc.
  entityType     String   // user, job, invoice, etc.
  entityId       String?
  metadata       Json?
  ipAddress      String?
  userAgent      String?
  createdAt      DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([userId])
  @@index([action])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}

// Notification - User notifications
model Notification {
  id             String   @id @default(cuid())
  userId         String
  type           String   // chargeback, payment_fallback, panic_mode, etc.
  title          String
  body           String
  metadata       Json?
  read           Boolean  @default(false)
  readAt         DateTime?
  createdAt      DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([read])
  @@index([createdAt])
  @@map("notifications")
}

// NotificationPreferences - User notification settings
model NotificationPreferences {
  id                String   @id @default(cuid())
  userId            String   @unique
  organizationId    String
  webEnabled        Boolean  @default(true)
  pushEnabled       Boolean  @default(true)
  emailEnabled      Boolean  @default(false)
  whatsappEnabled   Boolean  @default(true)
  smsEnabled        Boolean  @default(false)
  reminderIntervals Json?    // Array of minutes before appointment
  quietHoursStart   String?  // "22:00"
  quietHoursEnd     String?  // "08:00"
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@map("notification_preferences")
}

// NotificationLogs - Notification delivery tracking
model NotificationLogs {
  id             String   @id @default(cuid())
  organizationId String
  userId         String?
  eventType      String
  channel        String   // web, push, email, whatsapp, sms
  title          String
  body           String
  data           Json?
  status         String   // sent, delivered, failed
  errorMessage   String?
  entityType     String?
  entityId       String?
  sentAt         DateTime?
  deliveredAt    DateTime?
  createdAt      DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("notification_logs")
}

// TrackingLocationHistory - Technician GPS history for sessions
model TrackingLocationHistory {
  id           String   @id @default(cuid())
  sessionId    String
  lat          Decimal  @db.Decimal(10, 8)
  lng          Decimal  @db.Decimal(11, 8)
  speed        Decimal? @db.Decimal(6, 2)
  heading      Decimal? @db.Decimal(5, 2)
  accuracy     Decimal? @db.Decimal(6, 2)
  movementMode String?  // driving, walking, stationary
  recordedAt   DateTime @default(now())

  session TrackingSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([recordedAt])
  @@map("tracking_location_history")
}

// Event - Analytics and system events
model Event {
  id             String   @id @default(cuid())
  organizationId String
  type           String   // panic_mode_triggered, etc.
  source         String   // whatsapp, mercadopago, etc.
  data           Json?
  severity       String?  // info, warning, critical
  createdAt      DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([type])
  @@index([severity])
  @@index([createdAt])
  @@map("events")
}

// OnboardingProgress - User onboarding state tracking
model OnboardingProgress {
  id                 String    @id @default(cuid())
  userId             String    @unique
  organizationId     String
  phoneVerified      Boolean   @default(false)
  phoneVerifiedAt    DateTime?
  termsAccepted      Boolean   @default(false)
  termsAcceptedAt    DateTime?
  profileCompleted   Boolean   @default(false)
  profileCompletedAt DateTime?
  tutorialCompleted  Boolean   @default(false)
  tutorialCompletedAt DateTime?
  tutorialSkipped    Boolean   @default(false)
  completed          Boolean   @default(false)
  completedAt        DateTime?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@map("onboarding_progress")
}

// PanicMode - Emergency mode for integrations
model PanicMode {
  id             String    @id @default(cuid())
  organizationId String
  integration    String    // whatsapp, mercadopago, etc.
  reason         String    // rate_limit, auth_failure, etc.
  metadata       Json?
  active         Boolean   @default(true)
  triggeredAt    DateTime  @default(now())
  autoResolveAt  DateTime?
  resolvedAt     DateTime?
  createdAt      DateTime  @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([integration])
  @@index([active])
  @@map("panic_modes")
}

// FallbackPayment - Backup payment records when automatic fails
model FallbackPayment {
  id              String    @id @default(cuid())
  orgId           String
  invoiceId       String
  customerId      String?
  amount          Decimal   @db.Decimal(10, 2)
  currency        String    @default("ARS")
  reason          String    // card_declined, insufficient_funds, etc.
  originalError   String?
  suggestedMethod String?
  notificationSent Boolean  @default(false)
  resolvedAt      DateTime?
  resolvedBy      String?
  resolvedMethod  String?
  metadata        Json?
  createdAt       DateTime  @default(now())

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  invoice      Invoice      @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([invoiceId])
  @@index([resolvedAt])
  @@map("fallback_payments")
}

// EmployeeVerificationToken - Employee invite/verification tokens
model EmployeeVerificationToken {
  id             String    @id @default(cuid())
  userId         String
  organizationId String
  code           String
  expiresAt      DateTime
  isUsed         Boolean   @default(false)
  attempts       Int       @default(0)
  cooldownUntil  DateTime?
  createdAt      DateTime  @default(now())

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([organizationId])
  @@index([code])
  @@index([expiresAt])
  @@map("employee_verification_tokens")
}

// Chargeback - Payment dispute records from MercadoPago
model Chargeback {
  id                    String    @id @default(cuid())
  orgId                 String
  mpChargebackId        String    @unique
  mpPaymentId           String
  paymentId             String?
  invoiceId             String?
  amount                Decimal   @db.Decimal(10, 2)
  currency              String    @default("ARS")
  reason                String?
  reasonDetail          String?
  status                String    // pending, won, lost
  documentationStatus   String?
  documentationDeadline DateTime?
  covered               Boolean?
  coverageReason        String?
  mpCreatedAt           DateTime?
  mpUpdatedAt           DateTime?
  resolvedAt            DateTime?
  metadata              Json?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  payment      Payment?     @relation(fields: [paymentId], references: [id], onDelete: SetNull)
  invoice      Invoice?     @relation(fields: [invoiceId], references: [id], onDelete: SetNull)

  @@index([orgId])
  @@index([status])
  @@index([createdAt])
  @@map("chargebacks")
}

// SupportTicket - Customer support tickets
model SupportTicket {
  id          String    @id @default(cuid())
  orgId       String
  type        String    // payment_issues, technical, billing, etc.
  priority    String    @default("normal") // low, normal, high, urgent
  subject     String
  description String?   @db.Text
  status      String    @default("open") // open, in_progress, resolved, closed
  assignedTo  String?
  resolvedAt  DateTime?
  closedAt    DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([status])
  @@index([priority])
  @@index([createdAt])
  @@map("support_tickets")
}

// SmsOutboundQueue - SMS message queue (fallback from WhatsApp)
model SmsOutboundQueue {
  id              String    @id @default(cuid())
  organizationId  String
  customerId      String?
  phone           String
  body            String    @db.Text
  status          String    @default("pending") // pending, sent, failed
  source          String?   // whatsapp_fallback, direct, etc.
  sourceMessageId String?
  sentAt          DateTime?
  errorMessage    String?
  createdAt       DateTime  @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([status])
  @@index([createdAt])
  @@map("sms_outbound_queue")
}
