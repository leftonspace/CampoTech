// CampoTech Database Schema
// Field Service Management for Argentina

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ═══════════════════════════════════════════════════════════════════════════════
// ORGANIZATIONS & USERS
// ═══════════════════════════════════════════════════════════════════════════════

model Organization {
  id        String   @id @default(cuid())
  name      String
  phone     String?
  email     String?
  logo      String?
  settings  Json     @default("{}")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users     User[]
  customers Customer[]
  jobs      Job[]
  invoices  Invoice[]
  payments  Payment[]

  @@map("organizations")
}

model User {
  id             String       @id @default(cuid())
  email          String       @unique
  phone          String       @unique
  name           String
  passwordHash   String?
  role           UserRole     @default(TECHNICIAN)
  avatar         String?
  isActive       Boolean      @default(true)
  organizationId String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
  assignedJobs Job[]        @relation("TechnicianJobs")
  createdJobs  Job[]        @relation("CreatorJobs")

  @@map("users")
}

enum UserRole {
  ADMIN
  DISPATCHER
  TECHNICIAN
}

// ═══════════════════════════════════════════════════════════════════════════════
// CUSTOMERS
// ═══════════════════════════════════════════════════════════════════════════════

model Customer {
  id             String   @id @default(cuid())
  name           String
  phone          String
  email          String?
  cuit           String?
  ivaCondition   String   @default("CONSUMIDOR_FINAL") // CONSUMIDOR_FINAL, RESPONSABLE_INSCRIPTO, MONOTRIBUTISTA, EXENTO
  address        Json     // { street, number, floor, apartment, city, postalCode, coordinates }
  notes          String?
  organizationId String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
  jobs         Job[]
  invoices     Invoice[]

  @@index([phone])
  @@index([cuit])
  @@index([organizationId])
  @@map("customers")
}

// ═══════════════════════════════════════════════════════════════════════════════
// JOBS
// ═══════════════════════════════════════════════════════════════════════════════

model Job {
  id                String      @id @default(cuid())
  jobNumber         String      @unique
  serviceType       ServiceType
  description       String
  status            JobStatus   @default(PENDING)
  urgency           Urgency     @default(NORMAL)
  scheduledDate     DateTime?
  scheduledTimeSlot Json?       // { start: "09:00", end: "11:00" }
  startedAt         DateTime?
  completedAt       DateTime?
  resolution        String?
  materialsUsed     Json?       // [{ name, quantity, unitPrice }]
  photos            String[]
  customerSignature String?
  estimatedDuration Int?        // minutes
  actualDuration    Int?        // minutes

  customerId     String
  technicianId   String?
  createdById    String
  organizationId String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  customer     Customer     @relation(fields: [customerId], references: [id])
  technician   User?        @relation("TechnicianJobs", fields: [technicianId], references: [id])
  createdBy    User         @relation("CreatorJobs", fields: [createdById], references: [id])
  organization Organization @relation(fields: [organizationId], references: [id])
  invoice      Invoice?

  @@index([status])
  @@index([scheduledDate])
  @@index([technicianId])
  @@index([organizationId])
  @@map("jobs")
}

enum ServiceType {
  INSTALACION_SPLIT
  REPARACION_SPLIT
  MANTENIMIENTO_SPLIT
  INSTALACION_CALEFACTOR
  REPARACION_CALEFACTOR
  MANTENIMIENTO_CALEFACTOR
  OTRO
}

enum JobStatus {
  PENDING
  ASSIGNED
  EN_ROUTE
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum Urgency {
  NORMAL
  URGENTE
}

// ═══════════════════════════════════════════════════════════════════════════════
// INVOICES & PAYMENTS
// ═══════════════════════════════════════════════════════════════════════════════

model Invoice {
  id              String        @id @default(cuid())
  invoiceNumber   String        @unique
  type            InvoiceType   @default(FACTURA_C)
  status          InvoiceStatus @default(DRAFT)
  subtotal        Decimal       @db.Decimal(10, 2)
  taxAmount       Decimal       @db.Decimal(10, 2)
  total           Decimal       @db.Decimal(10, 2)
  items           Json          // [{ description, quantity, unitPrice, total }]
  afipCae         String?
  afipCaeExpiry   DateTime?
  afipQrCode      String?
  issuedAt        DateTime?
  dueDate         DateTime?

  jobId          String?  @unique
  customerId     String
  organizationId String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  job          Job?         @relation(fields: [jobId], references: [id])
  customer     Customer     @relation(fields: [customerId], references: [id])
  organization Organization @relation(fields: [organizationId], references: [id])
  payments     Payment[]

  @@index([status])
  @@index([organizationId])
  @@map("invoices")
}

enum InvoiceType {
  FACTURA_A
  FACTURA_B
  FACTURA_C
}

enum InvoiceStatus {
  DRAFT
  PENDING
  SENT
  PAID
  OVERDUE
  CANCELLED
}

model Payment {
  id             String        @id @default(cuid())
  amount         Decimal       @db.Decimal(10, 2)
  method         PaymentMethod
  status         PaymentStatus @default(PENDING)
  reference      String?       // External payment reference (MP, transfer, etc.)
  paidAt         DateTime?

  invoiceId      String
  organizationId String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  invoice      Invoice      @relation(fields: [invoiceId], references: [id])
  organization Organization @relation(fields: [organizationId], references: [id])

  @@index([invoiceId])
  @@map("payments")
}

enum PaymentMethod {
  CASH
  TRANSFER
  CARD
  MERCADOPAGO
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

// ═══════════════════════════════════════════════════════════════════════════════
// WHATSAPP & VOICE
// ═══════════════════════════════════════════════════════════════════════════════

model WhatsAppMessage {
  id             String              @id @default(cuid())
  waMessageId    String              @unique
  direction      MessageDirection
  type           MessageType
  content        String?
  mediaUrl       String?
  status         MessageDeliveryStatus @default(SENT)
  phone          String
  organizationId String
  createdAt      DateTime            @default(now())

  @@index([phone])
  @@index([organizationId])
  @@map("whatsapp_messages")
}

enum MessageDirection {
  INBOUND
  OUTBOUND
}

enum MessageType {
  TEXT
  IMAGE
  AUDIO
  DOCUMENT
  TEMPLATE
}

enum MessageDeliveryStatus {
  SENT
  DELIVERED
  READ
  FAILED
}

model VoiceMessage {
  id              String            @id @default(cuid())
  phone           String
  audioUrl        String
  duration        Int               // seconds
  transcription   String?
  extractedData   Json?             // { customerName, address, serviceType, etc. }
  confidence      Float?
  status          VoiceMessageStatus @default(PENDING)
  reviewedBy      String?
  reviewedAt      DateTime?
  rejectionReason String?
  organizationId  String
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@index([status])
  @@index([organizationId])
  @@map("voice_messages")
}

enum VoiceMessageStatus {
  PENDING
  PROCESSING
  NEEDS_REVIEW
  APPROVED
  REJECTED
}

// ═══════════════════════════════════════════════════════════════════════════════
// AUTHENTICATION - OTP CODES
// ═══════════════════════════════════════════════════════════════════════════════

model OtpCode {
  id        String   @id @default(cuid())
  phone     String
  codeHash  String   // SHA-256 hash of the OTP code
  expiresAt DateTime
  attempts  Int      @default(0)
  verified  Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([phone])
  @@index([expiresAt])
  @@map("otp_codes")
}

// ═══════════════════════════════════════════════════════════════════════════════
// PENDING REGISTRATIONS
// ═══════════════════════════════════════════════════════════════════════════════

model PendingRegistration {
  id           String   @id @default(cuid())
  phone        String   @unique
  cuit         String   // Stored as digits only (11 chars)
  businessName String
  adminName    String
  email        String?
  expiresAt    DateTime
  createdAt    DateTime @default(now())

  @@index([phone])
  @@index([cuit])
  @@index([expiresAt])
  @@map("pending_registrations")
}
