// CampoTech Database Schema
// Field Service Management for Argentina

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ═══════════════════════════════════════════════════════════════════════════════
// ORGANIZATIONS & USERS
// ═══════════════════════════════════════════════════════════════════════════════

model Organization {
  id        String   @id @default(cuid())
  name      String
  phone     String?
  email     String?
  logo      String?
  settings  Json     @default("{}")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users            User[]
  customers        Customer[]
  jobs             Job[]
  invoices         Invoice[]
  payments         Payment[]
  scheduledReports ScheduledReport[]
  reports          Report[]
  reportHistory    ReportHistory[]
  reviews          Review[]
  locations        Location[]

  @@map("organizations")
}

model User {
  id             String          @id @default(cuid())
  email          String?
  phone          String          @unique
  name           String
  passwordHash   String?
  role           UserRole        @default(TECHNICIAN)
  specialty      String?         // Trade specialty (PLOMERO, ELECTRICISTA, etc.)
  skillLevel     String?         // Skill level (AYUDANTE, MEDIO_OFICIAL, OFICIAL, OFICIAL_ESPECIALIZADO)
  avatar         String?
  isActive       Boolean         @default(true)
  organizationId String
  homeLocationId String?         // Technician's home/primary location
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  organization         Organization      @relation(fields: [organizationId], references: [id])
  homeLocation         Location?         @relation("TechnicianHomeLocation", fields: [homeLocationId], references: [id], onDelete: SetNull)
  assignedJobs         Job[]             @relation("TechnicianJobs")
  createdJobs          Job[]             @relation("CreatorJobs")
  createdScheduledReports ScheduledReport[] @relation("ScheduledReportCreator")
  createdReports       Report[]          @relation("ReportCreator")
  generatedReports     ReportHistory[]   @relation("ReportHistoryGenerator")
  technicianReviews    Review[]          @relation("TechnicianReviews")
  managedLocations     Location[]        @relation("LocationManager")
  requestedTransfers   InterLocationTransfer[] @relation("TransferRequester")
  approvedTransfers    InterLocationTransfer[] @relation("TransferApprover")

  @@unique([email, organizationId])
  @@index([organizationId])
  @@index([homeLocationId])
  @@map("users")
}

enum UserRole {
  OWNER
  ADMIN
  DISPATCHER
  TECHNICIAN
  VIEWER
}

// Valid values for specialty: PLOMERO, ELECTRICISTA, GASISTA, CALEFACCIONISTA, REFRIGERACION, ALBANIL, PINTOR, CARPINTERO, TECHISTA, HERRERO, SOLDADOR, OTRO
// Valid values for skillLevel: AYUDANTE, MEDIO_OFICIAL, OFICIAL, OFICIAL_ESPECIALIZADO

// ═══════════════════════════════════════════════════════════════════════════════
// CUSTOMERS
// ═══════════════════════════════════════════════════════════════════════════════

model Customer {
  id             String   @id @default(cuid())
  name           String
  phone          String
  email          String?
  address        Json     // { street, number, floor, apartment, city, postalCode, coordinates }
  notes          String?
  organizationId String
  locationId     String?  // Primary service location for this customer
  zoneId         String?  // Service zone within the location
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
  location     Location?    @relation("CustomerLocation", fields: [locationId], references: [id], onDelete: SetNull)
  zone         Zone?        @relation("CustomerZone", fields: [zoneId], references: [id], onDelete: SetNull)
  jobs         Job[]
  invoices     Invoice[]
  reviews      Review[]

  @@index([phone])
  @@index([organizationId])
  @@index([locationId])
  @@index([zoneId])
  @@map("customers")
}

// ═══════════════════════════════════════════════════════════════════════════════
// JOBS
// ═══════════════════════════════════════════════════════════════════════════════

model Job {
  id                String      @id @default(cuid())
  jobNumber         String      @unique
  serviceType       ServiceType
  description       String
  status            JobStatus   @default(PENDING)
  urgency           Urgency     @default(NORMAL)
  scheduledDate     DateTime?
  scheduledTimeSlot Json?       // { start: "09:00", end: "11:00" }
  startedAt         DateTime?
  completedAt       DateTime?
  resolution        String?
  materialsUsed     Json?       // [{ name, quantity, unitPrice }]
  photos            String[]
  customerSignature String?
  estimatedDuration Int?        // minutes
  actualDuration    Int?        // minutes

  customerId     String
  technicianId   String?
  createdById    String
  organizationId String
  locationId     String?  // Service location for this job
  zoneId         String?  // Service zone within the location
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  customer     Customer     @relation(fields: [customerId], references: [id])
  technician   User?        @relation("TechnicianJobs", fields: [technicianId], references: [id])
  createdBy    User         @relation("CreatorJobs", fields: [createdById], references: [id])
  organization Organization @relation(fields: [organizationId], references: [id])
  location     Location?    @relation("JobLocation", fields: [locationId], references: [id], onDelete: SetNull)
  zone         Zone?        @relation("JobZone", fields: [zoneId], references: [id], onDelete: SetNull)
  invoice      Invoice?
  review       Review?

  @@index([status])
  @@index([scheduledDate])
  @@index([technicianId])
  @@index([organizationId])
  @@index([locationId])
  @@index([zoneId])
  @@map("jobs")
}

enum ServiceType {
  INSTALACION_SPLIT
  REPARACION_SPLIT
  MANTENIMIENTO_SPLIT
  INSTALACION_CALEFACTOR
  REPARACION_CALEFACTOR
  MANTENIMIENTO_CALEFACTOR
  OTRO
}

enum JobStatus {
  PENDING
  ASSIGNED
  EN_ROUTE
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum Urgency {
  NORMAL
  URGENTE
}

// ═══════════════════════════════════════════════════════════════════════════════
// INVOICES & PAYMENTS
// ═══════════════════════════════════════════════════════════════════════════════

model Invoice {
  id              String        @id @default(cuid())
  invoiceNumber   String        @unique
  type            InvoiceType   @default(FACTURA_C)
  status          InvoiceStatus @default(DRAFT)
  subtotal        Decimal       @db.Decimal(10, 2)
  taxAmount       Decimal       @db.Decimal(10, 2)
  total           Decimal       @db.Decimal(10, 2)
  items           Json          // [{ description, quantity, unitPrice, total }]
  afipCae         String?
  afipCaeExpiry   DateTime?
  afipQrCode      String?
  issuedAt        DateTime?
  dueDate         DateTime?

  jobId          String?  @unique
  customerId     String
  organizationId String
  locationId     String?  // Location that issued this invoice (for AFIP punto de venta)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  job          Job?         @relation(fields: [jobId], references: [id])
  customer     Customer     @relation(fields: [customerId], references: [id])
  organization Organization @relation(fields: [organizationId], references: [id])
  location     Location?    @relation("InvoiceLocation", fields: [locationId], references: [id], onDelete: SetNull)
  payments     Payment[]

  @@index([status])
  @@index([organizationId])
  @@index([locationId])
  @@map("invoices")
}

enum InvoiceType {
  FACTURA_A
  FACTURA_B
  FACTURA_C
}

enum InvoiceStatus {
  DRAFT
  PENDING
  SENT
  PAID
  OVERDUE
  CANCELLED
}

model Payment {
  id             String        @id @default(cuid())
  amount         Decimal       @db.Decimal(10, 2)
  method         PaymentMethod
  status         PaymentStatus @default(PENDING)
  reference      String?       // External payment reference (MP, transfer, etc.)
  paidAt         DateTime?

  invoiceId      String
  organizationId String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  invoice      Invoice      @relation(fields: [invoiceId], references: [id])
  organization Organization @relation(fields: [organizationId], references: [id])

  @@index([invoiceId])
  @@map("payments")
}

enum PaymentMethod {
  CASH
  TRANSFER
  CARD
  MERCADOPAGO
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

// ═══════════════════════════════════════════════════════════════════════════════
// WHATSAPP & VOICE
// ═══════════════════════════════════════════════════════════════════════════════

model WhatsAppMessage {
  id             String              @id @default(cuid())
  waMessageId    String              @unique
  direction      MessageDirection
  type           MessageType
  content        String?
  mediaUrl       String?
  status         MessageDeliveryStatus @default(SENT)
  phone          String
  organizationId String
  createdAt      DateTime            @default(now())

  @@index([phone])
  @@index([organizationId])
  @@map("whatsapp_messages")
}

enum MessageDirection {
  INBOUND
  OUTBOUND
}

enum MessageType {
  TEXT
  IMAGE
  AUDIO
  DOCUMENT
  TEMPLATE
}

enum MessageDeliveryStatus {
  SENT
  DELIVERED
  READ
  FAILED
}

model VoiceMessage {
  id              String            @id @default(cuid())
  phone           String
  audioUrl        String
  duration        Int               // seconds
  transcription   String?
  extractedData   Json?             // { customerName, address, serviceType, etc. }
  confidence      Float?
  status          VoiceMessageStatus @default(PENDING)
  reviewedBy      String?
  reviewedAt      DateTime?
  rejectionReason String?
  organizationId  String
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@index([status])
  @@index([organizationId])
  @@map("voice_messages")
}

enum VoiceMessageStatus {
  PENDING
  PROCESSING
  NEEDS_REVIEW
  APPROVED
  REJECTED
}

// ═══════════════════════════════════════════════════════════════════════════════
// AUTHENTICATION - OTP CODES
// ═══════════════════════════════════════════════════════════════════════════════

model OtpCode {
  id        String   @id @default(cuid())
  phone     String
  codeHash  String   // SHA-256 hash of the OTP code
  expiresAt DateTime
  attempts  Int      @default(0)
  verified  Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([phone])
  @@index([expiresAt])
  @@map("otp_codes")
}

// ═══════════════════════════════════════════════════════════════════════════════
// PENDING REGISTRATIONS
// ═══════════════════════════════════════════════════════════════════════════════

model PendingRegistration {
  id           String   @id @default(cuid())
  phone        String   @unique
  cuit         String   // Stored as digits only (11 chars)
  businessName String
  adminName    String
  email        String?
  expiresAt    DateTime
  createdAt    DateTime @default(now())

  @@index([phone])
  @@index([cuit])
  @@index([expiresAt])
  @@map("pending_registrations")
}

// ═══════════════════════════════════════════════════════════════════════════════
// PHASE 9.6: SCHEDULED REMINDERS
// ═══════════════════════════════════════════════════════════════════════════════

model ScheduledReminder {
  id             String   @id @default(cuid())
  organizationId String
  jobId          String
  userId         String
  reminderType   String   // 24h, 1h, 30min
  scheduledFor   DateTime
  status         String   @default("pending") // pending, sent, cancelled
  sentAt         DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([organizationId])
  @@index([status, scheduledFor])
  @@map("scheduled_reminders")
}

// ═══════════════════════════════════════════════════════════════════════════════
// PHASE 9.7: AUDIO MESSAGES & AUTO-RESPONDER
// ═══════════════════════════════════════════════════════════════════════════════

model AudioMessage {
  id             String    @id @default(cuid())
  organizationId String
  waMessageId    String
  senderPhone    String
  senderName     String?
  mediaId        String
  mimeType       String    @default("audio/ogg")
  mediaUrl       String?
  isVoice        Boolean   @default(true)
  duration       Int?
  transcription  String?
  status         String    @default("received") // received, downloading, downloaded, transcribing, transcribed, failed
  reviewed       Boolean   @default(false)
  reviewedAt     DateTime?
  reviewedById   String?
  transcribedAt  DateTime?
  receivedAt     DateTime  @default(now())
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([organizationId])
  @@index([status])
  @@index([senderPhone])
  @@map("audio_messages")
}

model AutoResponseLog {
  id             String   @id @default(cuid())
  organizationId String
  recipientPhone String
  responseType   String   // after_hours, audio_confirmation, message_received
  message        String
  sentAt         DateTime @default(now())
  createdAt      DateTime @default(now())

  @@index([organizationId])
  @@index([recipientPhone])
  @@map("auto_response_logs")
}

// ═══════════════════════════════════════════════════════════════════════════════
// PHASE 9.8: MESSAGE AGGREGATION CONTEXT
// ═══════════════════════════════════════════════════════════════════════════════

model ConversationContext {
  id               String    @id @default(cuid())
  organizationId   String
  customerPhone    String
  customerId       String?
  customerName     String?
  messageHistory   Json      @default("[]")
  previousRequests String[]  @default([])
  activeJobId      String?
  lastMessageAt    DateTime  @default(now())
  expiresAt        DateTime
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  @@unique([organizationId, customerPhone])
  @@index([expiresAt])
  @@map("conversation_contexts")
}

model MessageBufferStats {
  id                      String   @id @default(cuid())
  organizationId          String
  date                    DateTime @db.Date
  totalBuffersCreated     Int      @default(0)
  totalMessagesAggregated Int      @default(0)
  totalImmediateTriggers  Int      @default(0)
  totalTimeoutTriggers    Int      @default(0)
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  @@unique([organizationId, date])
  @@map("message_buffer_stats")
}

model MessageAggregationEvent {
  id               String   @id @default(cuid())
  organizationId   String
  customerPhone    String
  combinedContent  String
  messageCount     Int
  triggerReason    String   // voice_message, long_message, question, request_verb, urgency, address, schedule, price_inquiry, max_buffer, timeout, immediate
  processedAt      DateTime @default(now())
  createdAt        DateTime @default(now())

  @@index([organizationId])
  @@index([triggerReason])
  @@index([createdAt])
  @@map("message_aggregation_events")
}

// ═══════════════════════════════════════════════════════════════════════════════
// PHASE 10: ANALYTICS & REPORTING
// ═══════════════════════════════════════════════════════════════════════════════

model ScheduledReport {
  id             String    @id @default(cuid())
  organizationId String
  reportId       String?
  name           String
  frequency      String    // 'daily', 'weekly', 'monthly'
  dayOfWeek      Int?      // 0-6 (Sunday-Saturday) for weekly reports
  dayOfMonth     Int?      // 1-31 for monthly reports
  time           String    // 'HH:mm' format
  format         String    // 'pdf', 'excel', 'csv'
  recipients     Json      // Array of email addresses
  enabled        Boolean   @default(true)
  status         String    @default("active") // 'active', 'paused', 'error'
  lastRunAt      DateTime?
  nextRunAt      DateTime?
  createdById    String
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdBy    User         @relation("ScheduledReportCreator", fields: [createdById], references: [id])
  report       Report?      @relation(fields: [reportId], references: [id], onDelete: SetNull)
  executions   ReportExecution[]

  @@index([organizationId])
  @@index([enabled])
  @@index([nextRunAt])
  @@map("scheduled_reports")
}

model Report {
  id             String   @id @default(cuid())
  organizationId String
  name           String
  templateId     String   // Reference to report template ID
  description    String?
  parameters     Json?    // Default parameters for the report
  createdById    String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization     Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdBy        User              @relation("ReportCreator", fields: [createdById], references: [id])
  scheduledReports ScheduledReport[]
  history          ReportHistory[]

  @@index([organizationId])
  @@index([templateId])
  @@map("reports")
}

model ReportExecution {
  id                String    @id @default(cuid())
  scheduledReportId String
  organizationId    String
  status            String    @default("pending") // 'pending', 'processing', 'completed', 'failed'
  format            String
  fileUrl           String?
  fileSize          Int?
  generationTimeMs  Int?
  error             String?
  recipientResults  Json?     // Array of delivery results per recipient
  startedAt         DateTime?
  completedAt       DateTime?
  createdAt         DateTime  @default(now())

  scheduledReport ScheduledReport @relation(fields: [scheduledReportId], references: [id], onDelete: Cascade)

  @@index([scheduledReportId])
  @@index([organizationId])
  @@index([status])
  @@map("report_executions")
}

model ReportHistory {
  id             String    @id @default(cuid())
  organizationId String
  reportId       String?
  name           String
  reportType     String    // Template ID or custom report type
  format         String    // 'pdf', 'excel', 'csv'
  status         String    @default("completed") // 'completed', 'failed'
  parameters     Json?     // Parameters used for generation
  fileUrl        String?
  fileSize       Int?
  generationTimeMs Int?
  errorMessage   String?
  downloadUrl    String?
  generatedById  String
  generatedAt    DateTime  @default(now())
  createdAt      DateTime  @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  generatedBy  User         @relation("ReportHistoryGenerator", fields: [generatedById], references: [id])
  report       Report?      @relation(fields: [reportId], references: [id], onDelete: SetNull)

  @@index([organizationId])
  @@index([reportType])
  @@index([status])
  @@index([generatedAt])
  @@map("report_history")
}

model Review {
  id             String   @id @default(cuid())
  organizationId String
  jobId          String?  @unique
  customerId     String?
  technicianId   String?
  rating         Int?     // 1-5 star rating
  comment        String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  job          Job?         @relation(fields: [jobId], references: [id], onDelete: SetNull)
  customer     Customer?    @relation(fields: [customerId], references: [id], onDelete: SetNull)
  technician   User?        @relation("TechnicianReviews", fields: [technicianId], references: [id], onDelete: SetNull)

  @@index([organizationId])
  @@index([technicianId])
  @@index([rating])
  @@map("reviews")
}

// ═══════════════════════════════════════════════════════════════════════════════
// PHASE 11: MULTI-LOCATION SUPPORT
// ═══════════════════════════════════════════════════════════════════════════════

model Location {
  id             String   @id @default(cuid())
  organizationId String
  code           String   // Short code for the location (e.g., "CABA", "GBA-N", "MDZ")
  name           String
  type           LocationType @default(BRANCH)
  address        Json     // { street, number, city, province, postalCode, country }
  coordinates    Json?    // { lat, lng }
  timezone       String   @default("America/Argentina/Buenos_Aires")
  phone          String?
  email          String?
  managerId      String?  // User who manages this location
  isHeadquarters Boolean  @default(false)
  isActive       Boolean  @default(true)
  coverageRadius Int?     // Service coverage radius in km (if circular)
  coverageArea   Json?    // GeoJSON polygon for service coverage area
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  manager      User?             @relation("LocationManager", fields: [managerId], references: [id], onDelete: SetNull)
  settings     LocationSettings?
  afipConfig   LocationAfipConfig?
  zones        Zone[]
  jobs         Job[]             @relation("JobLocation")
  customers    Customer[]        @relation("CustomerLocation")
  invoices     Invoice[]         @relation("InvoiceLocation")
  technicians  User[]            @relation("TechnicianHomeLocation")
  transfersFrom InterLocationTransfer[] @relation("TransferFromLocation")
  transfersTo   InterLocationTransfer[] @relation("TransferToLocation")

  @@unique([organizationId, code])
  @@index([organizationId])
  @@index([isActive])
  @@index([type])
  @@map("locations")
}

enum LocationType {
  HEADQUARTERS  // Main office / Casa central
  BRANCH        // Branch office / Sucursal
  WAREHOUSE     // Storage only / Depósito
  SERVICE_POINT // Service point without office / Punto de servicio
}

model Zone {
  id          String   @id @default(cuid())
  locationId  String
  code        String   // Short code (e.g., "Z1", "NORTE", "CENTRO")
  name        String
  description String?
  boundary    Json?    // GeoJSON polygon defining the zone boundary
  color       String?  // Hex color for map display (e.g., "#FF5733")
  priority    Int      @default(0) // Higher priority zones are preferred for assignment
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  location  Location   @relation(fields: [locationId], references: [id], onDelete: Cascade)
  jobs      Job[]      @relation("JobZone")
  customers Customer[] @relation("CustomerZone")

  @@unique([locationId, code])
  @@index([locationId])
  @@index([isActive])
  @@map("zones")
}

model LocationSettings {
  id             String   @id @default(cuid())
  locationId     String   @unique

  // Operating Hours
  operatingHours Json     @default("{}") // { monday: { open: '08:00', close: '18:00' }, ... }
  holidays       Json     @default("[]") // Array of holiday dates

  // Service Settings
  serviceRadius        Int?     // Default service radius in km
  maxJobsPerDay        Int?     // Maximum jobs that can be scheduled per day
  defaultJobDuration   Int?     // Default job duration in minutes
  allowEmergencyJobs   Boolean  @default(true)
  emergencyFeePercent  Decimal? @db.Decimal(5, 2) // Extra fee % for emergency jobs

  // Pricing Variations
  pricingMultiplier    Decimal  @default(1.0) @db.Decimal(5, 3) // Price multiplier for this location
  travelFeePerKm       Decimal? @db.Decimal(10, 2) // Travel fee per km
  minimumTravelFee     Decimal? @db.Decimal(10, 2) // Minimum travel fee

  // Notification Settings
  notifyOnNewJob       Boolean  @default(true)
  notifyOnJobComplete  Boolean  @default(true)
  notificationEmails   String[] @default([])

  // WhatsApp Settings
  whatsappNumber       String?  // Location-specific WhatsApp number
  whatsappBusinessId   String?  // WhatsApp Business Account ID

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  location Location @relation(fields: [locationId], references: [id], onDelete: Cascade)

  @@map("location_settings")
}

model LocationAfipConfig {
  id             String   @id @default(cuid())
  locationId     String   @unique

  // AFIP Configuration
  puntoDeVenta       Int      // Punto de venta number for this location
  tiposPuntoDeVenta  String   @default("CAJA") // CAJA, EXPORT, etc.
  cuit               String?  // CUIT if different from organization (for franchises)
  razonSocial        String?  // Business name if different from organization
  domicilioFiscal    Json?    // { calle, numero, piso, depto, localidad, provincia, cp }
  condicionIva       String   @default("RESPONSABLE_INSCRIPTO") // RESPONSABLE_INSCRIPTO, MONOTRIBUTISTA, EXENTO

  // Invoice Numbering
  facturaALastNumber Int      @default(0)
  facturaBLastNumber Int      @default(0)
  facturaCLastNumber Int      @default(0)
  notaCreditoALastNumber Int  @default(0)
  notaCreditoBLastNumber Int  @default(0)
  notaCreditoCLastNumber Int  @default(0)

  // Certificate
  certificatePath    String?  // Path to AFIP certificate
  certificateExpiry  DateTime?
  privateKeyPath     String?

  // API Credentials
  wsaaToken          String?  // Current WSAA token
  wsaaTokenExpiry    DateTime?

  isActive           Boolean  @default(true)
  lastSyncAt         DateTime?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  location Location @relation(fields: [locationId], references: [id], onDelete: Cascade)

  @@index([puntoDeVenta])
  @@map("location_afip_configs")
}

model InterLocationTransfer {
  id               String   @id @default(cuid())
  organizationId   String
  fromLocationId   String
  toLocationId     String

  // Transfer Details
  transferType     TransferType
  referenceId      String?  // ID of the related entity (job, technician assignment, etc.)
  reason           String?
  notes            String?

  // Financial (if applicable)
  amount           Decimal? @db.Decimal(10, 2) // Transfer amount for inter-location charges

  // Status Tracking
  status           TransferStatus @default(PENDING)
  requestedById    String
  approvedById     String?
  requestedAt      DateTime @default(now())
  approvedAt       DateTime?
  completedAt      DateTime?

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  fromLocation Location @relation("TransferFromLocation", fields: [fromLocationId], references: [id])
  toLocation   Location @relation("TransferToLocation", fields: [toLocationId], references: [id])
  requestedBy  User     @relation("TransferRequester", fields: [requestedById], references: [id])
  approvedBy   User?    @relation("TransferApprover", fields: [approvedById], references: [id])

  @@index([organizationId])
  @@index([fromLocationId])
  @@index([toLocationId])
  @@index([status])
  @@index([transferType])
  @@map("inter_location_transfers")
}

enum TransferType {
  JOB_ASSIGNMENT    // Job transferred to another location
  TECHNICIAN_LOAN   // Technician temporarily assigned to another location
  CUSTOMER_REFERRAL // Customer referred to another location
  RESOURCE_SHARE    // Sharing of equipment/inventory
  FINANCIAL         // Financial transfer between locations
}

enum TransferStatus {
  PENDING
  APPROVED
  IN_PROGRESS
  COMPLETED
  REJECTED
  CANCELLED
}
