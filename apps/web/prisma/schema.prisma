generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Organization {
  id                         String                      @id @default(cuid())
  name                       String
  phone                      String?
  email                      String?
  logo                       String?
  settings                   Json                        @default("{}")
  createdAt                  DateTime                    @default(now())
  updatedAt                  DateTime                    @updatedAt
  whatsappAccessToken        String?
  whatsappAppSecret          String?
  whatsappBusinessAccountId  String?
  whatsappPhoneNumberId      String?
  whatsappWebhookVerifyToken String?
  subscriptionTier           SubscriptionTier            @default(FREE) @map("subscription_tier")
  subscriptionStatus         SubscriptionStatus          @default(none) @map("subscription_status")
  trialEndsAt                DateTime?                   @map("trial_ends_at")
  marketplaceVisible         Boolean                     @default(false) @map("marketplace_visible")
  verificationCompletedAt    DateTime?                   @map("verification_completed_at")
  canReceiveJobs             Boolean                     @default(false) @map("can_receive_jobs")
  complianceScore            Int                         @default(0) @map("compliance_score")
  lastComplianceCheck        DateTime?                   @map("last_compliance_check")
  whatsappPersonalNumber     String?
  whatsappIntegrationType    WhatsAppIntegrationType     @default(NONE)
  verificationStatus         OrgVerificationStatus       @default(pending) @map("verification_status")
  afipCertificateEncrypted   String?                     @map("afip_certificate_encrypted")
  afipConnectedAt            DateTime?                   @map("afip_connected_at")
  afipCuit                   String?                     @map("afip_cuit")
  afipEnvironment            String?                     @map("afip_environment")
  afipPrivateKeyEncrypted    String?                     @map("afip_private_key_encrypted")
  afipPuntoVenta             String?                     @map("afip_punto_venta")
  aiConfiguration            AIConfiguration?
  aiConversationLogs         AIConversationLog[]
  auditLogs                  AuditLog[]
  publicProfile              BusinessPublicProfile?
  chargebacks                Chargeback[]
  complianceAcknowledgments  ComplianceAcknowledgment[]
  complianceBlocks           ComplianceBlock[]
  couponUsages               CouponUsage[]
  customers                  Customer[]
  dashboardAlerts            DashboardAlert[]            @relation("OrgDashboardAlerts")
  employeeSchedules          EmployeeSchedule[]
  employeeVerificationTokens EmployeeVerificationToken[]
  events                     Event[]
  failedJobs                 FailedJob[]                 @relation("FailedJobOrg")
  fallbackPayments           FallbackPayment[]
  idempotencyKeys            IdempotencyKey[]            @relation("IdempotencyOrg")
  inventoryCounts            InventoryCount[]
  inventoryItems             InventoryItem[]             @relation("OrgInventoryItems")
  inventoryLocations         InventoryLocation[]         @relation("OrgInventoryLocations")
  inventoryTransactions      InventoryTransaction[]      @relation("OrgInventoryTransactions")
  invoices                   Invoice[]
  jobs                       Job[]
  locations                  Location[]
  marketplaceClicks          MarketplaceClick[]          @relation("OrgMarketplaceClicks")
  notificationLogs           NotificationLogs[]
  notificationPreferences    NotificationPreferences[]
  onboardingProgress         OnboardingProgress[]
  subscription               OrganizationSubscription?
  panicModes                 PanicMode[]
  payments                   Payment[]
  priceItems                 PriceItem[]                 @relation("OrgPriceItems")
  productCategories          ProductCategory[]
  products                   Product[]
  purchaseOrders             PurchaseOrder[]
  reportHistory              ReportHistory[]
  reports                    Report[]
  reviews                    Review[]
  scheduleExceptions         ScheduleException[]
  scheduledReports           ScheduledReport[]
  serviceTypeConfigs         ServiceTypeConfig[]
  smsOutboundQueue           SmsOutboundQueue[]
  subscriptionEvents         SubscriptionEvent[]
  subscriptionPayments       SubscriptionPayment[]
  suppliers                  Supplier[]
  supportTickets             SupportTicket[]
  technicianRoutes           TechnicianRoute[]
  trackingSessions           TrackingSession[]           @relation("OrgTrackingSessions")
  users                      User[]
  userMemberships            UserOrganization[]          @relation("OrgMemberships")
  vehicleSchedules           VehicleSchedule[]           @relation("OrgVehicleSchedules")
  vehicles                   Vehicle[]                   @relation("OrgVehicles")
  verificationSubmissions    VerificationSubmission[]
  waConversations            WaConversation[]
  waMessages                 WaMessage[]
  waOutboundQueue            WaOutboundQueue[]
  waTemplates                WaTemplate[]
  waWebhookLogs              WaWebhookLog[]
  warehouses                 Warehouse[]
  whatsappBusinessAccount    WhatsAppBusinessAccount?
  assignedWhatsAppNumber     WhatsAppNumberInventory?    @relation("OrgAssignedNumber")
  whatsappCredits            WhatsAppCredits?
  pricingSettings            OrganizationPricingSettings?

  // ═══════════════════════════════════════════════════════════════════════════════
  // PHASE 5: TRANSLATION SETTINGS
  // Organization-level language preferences for AI translation
  // ═══════════════════════════════════════════════════════════════════════════════
  translationEnabled    Boolean   @default(false) @map("translation_enabled")
  languagesSpoken       String[]  @default(["es"]) @map("languages_spoken")  // Languages the team speaks

  // ═══════════════════════════════════════════════════════════════════════════════
  // PHASE 3.4 & 4: EXPORT AND DATA ACCESS REQUESTS
  // ═══════════════════════════════════════════════════════════════════════════════
  exportRequests        ExportRequest[]
  dataAccessRequests    DataAccessRequest[]

  @@index([subscriptionStatus])
  @@index([subscriptionTier])
  @@index([trialEndsAt])
  @@index([marketplaceVisible])
  @@index([verificationStatus])
  @@index([canReceiveJobs])
  @@index([lastComplianceCheck])
  @@map("organizations")
}

model User {
  id                      String                 @id @default(cuid())
  email                   String?
  phone                   String                 @unique
  name                    String
  passwordHash            String?
  role                    UserRole               @default(TECHNICIAN)
  // Legacy single specialty (for backwards compatibility)
  specialty               String?
  skillLevel              String?
  // New multi-specialty support
  specialties             String[]               @default([])
  certifications          Json?                  @map("certifications") // { "GASISTA": { "matricula": "MG-1234", "category": "1RA" }, ... }
  avatar                  String?
  isActive                Boolean                @default(true)
  organizationId          String
  homeLocationId          String?
  createdAt               DateTime               @default(now())
  updatedAt               DateTime               @updatedAt
  verificationCompletedAt DateTime?              @map("verification_completed_at")
  canBeAssignedJobs       Boolean                @default(false) @map("can_be_assigned_jobs")
  identityVerified        Boolean                @default(false) @map("identity_verified")
  verificationStatus      UserVerificationStatus @default(pending) @map("verification_status")

  // ═══════════════════════════════════════════════════════════════════════════════
  // SCHEDULE TYPE & ON-CALL SETTINGS
  // ═══════════════════════════════════════════════════════════════════════════════
  
  scheduleType         String  @default("base") @map("schedule_type") // 'base', 'rotating', 'ondemand', 'custom'
  advanceNoticeHours   Int     @default(0) @map("advance_notice_hours") // Hours of advance notice required for on-call employees

  // ═══════════════════════════════════════════════════════════════════════════════
  // PHASE 4.3: DIGITAL ENTRY BADGE
  // ═══════════════════════════════════════════════════════════════════════════════

  // Badge token for QR code verification (rotates every 30 days)
  badgeToken          String?   @unique @map("badge_token")
  badgeTokenExpiresAt DateTime? @map("badge_token_expires_at")

  // ART (Aseguradora de Riesgos del Trabajo) - Required for entry to gated communities
  artCertificateUrl String?   @map("art_certificate_url")
  artExpiryDate     DateTime? @map("art_expiry_date")
  artProvider       String?   @map("art_provider")
  artPolicyNumber   String?   @map("art_policy_number")

  // Background check verification
  backgroundCheckStatus   String    @default("pending") @map("background_check_status") // 'pending', 'approved', 'rejected', 'expired'
  backgroundCheckDate     DateTime? @map("background_check_date")
  backgroundCheckProvider String?   @map("background_check_provider")

  // ═══════════════════════════════════════════════════════════════════════════════
  // DRIVER'S LICENSE (for vehicle assignment and insurance compliance)
  // ═══════════════════════════════════════════════════════════════════════════════

  driverLicenseNumber   String?   @map("driver_license_number")
  driverLicenseExpiry   DateTime? @map("driver_license_expiry")
  driverLicenseCategory String?   @map("driver_license_category") // e.g., "B1", "B2", "C", "D"

  // Relations
  aiEscalationConfigs        AIConfiguration[]           @relation("AIEscalationUser")
  complianceAcknowledgments  ComplianceAcknowledgment[]
  complianceBlocks           ComplianceBlock[]
  schedules                  EmployeeSchedule[]
  employeeVerificationTokens EmployeeVerificationToken[]
  approvedTransfers          InterLocationTransfer[]     @relation("TransferApprover")
  requestedTransfers         InterLocationTransfer[]     @relation("TransferRequester")
  inventoryTransactions      InventoryTransaction[]      @relation("PerformedTransactions")
  jobAssignments             JobAssignment[]             @relation("TechnicianAssignments")
  uploadedPhotos             JobPhoto[]                  @relation("PhotoUploader")
  jobVisits                  JobVisit[]                  @relation("TechnicianVisits")
  createdJobs                Job[]                       @relation("CreatorJobs")
  assignedJobs               Job[]                       @relation("TechnicianJobs")
  managedLocations           Location[]                  @relation("LocationManager")
  notificationPreferences    NotificationPreferences?
  notifications              Notification[]
  onboardingProgress         OnboardingProgress?
  generatedReports           ReportHistory[]             @relation("ReportHistoryGenerator")
  createdReports             Report[]                    @relation("ReportCreator")
  technicianReviews          Review[]                    @relation("TechnicianReviews")
  scheduleExceptions         ScheduleException[]
  createdScheduledReports    ScheduledReport[]           @relation("ScheduledReportCreator")
  currentLocation            TechnicianLocation?         @relation("TechnicianCurrentLocation")
  technicianRoutes           TechnicianRoute[]
  trackingSessions           TrackingSession[]           @relation("TechnicianTrackingSessions")
  homeLocation               Location?                   @relation("TechnicianHomeLocation", fields: [homeLocationId], references: [id])
  organization               Organization                @relation(fields: [organizationId], references: [id])
  vehicleAssignments         VehicleAssignment[]         @relation("UserVehicleAssignments")
  uploadedVehicleDocs        VehicleDocument[]           @relation("UploadedVehicleDocuments")
  createdMaintenance         VehicleMaintenance[]        @relation("CreatedMaintenanceLogs")
  createdVehicleSchedules    VehicleSchedule[]           @relation("CreatedVehicleSchedules")
  vehicleSchedules           VehicleSchedule[]           @relation("UserVehicleSchedules")
  vehicleStocks              VehicleStock[]
  verificationReminders      VerificationReminder[]
  verificationSubmissions    VerificationSubmission[]
  reviewedTranscripts        VoiceTranscript[]           @relation("TranscriptReviewer")
  assignedWaConversations    WaConversation[]            @relation("WaConversationAssignee")
  sentWaMessages             WaMessage[]                 @relation("WaMessageSender")
  organizationMemberships    UserOrganization[]          @relation("UserMemberships")
  jobVisitDriverAssignments  JobVisitVehicleDriver[]     @relation("DriverVisitAssignments")
  createdLineItems           JobLineItem[]               @relation("LineItemCreator")
  
  // Phase 3.4 & 4
  exportRequests             ExportRequest[]             @relation("ExportRequestedBy")
  assignedDataRequests       DataAccessRequest[]         @relation("DataRequestAssignee")

  @@unique([email, organizationId])
  @@index([organizationId])
  @@index([homeLocationId])
  @@index([verificationStatus])
  @@index([canBeAssignedJobs])
  @@index([identityVerified])
  @@index([organizationId, role])
  @@index([badgeToken])
  @@index([artExpiryDate])
  @@index([backgroundCheckStatus])
  @@map("users")
}

model Customer {
  id              String           @id @default(cuid())
  name            String
  phone           String
  email           String?
  address         Json
  notes           String?
  organizationId  String
  locationId      String?
  zoneId          String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  customerNumber  String?
  isVip           Boolean          @default(false)
  location        Location?        @relation("CustomerLocation", fields: [locationId], references: [id])
  organization    Organization     @relation(fields: [organizationId], references: [id])
  zone            Zone?            @relation("CustomerZone", fields: [zoneId], references: [id])
  invoices        Invoice[]
  jobs            Job[]
  reviews         Review[]
  waConversations WaConversation[]
  dataAccessRequests DataAccessRequest[]  // Phase 4 ARCO

  @@index([phone])
  @@index([organizationId])
  @@index([locationId])
  @@index([zoneId])
  @@map("customers")
}

model Job {
  id                 String             @id @default(cuid())
  jobNumber          String             @unique
  serviceType        ServiceType
  // ═══════════════════════════════════════════════════════════════════════════════
  // MULTI-TRADE SERVICE TYPE (Phase 1.1)
  // For non-HVAC jobs: serviceType = OTRO, serviceTypeCode = actual dynamic code
  // ═══════════════════════════════════════════════════════════════════════════════
  serviceTypeCode    String?            @map("service_type_code")
  description        String
  status             JobStatus          @default(PENDING)
  urgency            Urgency            @default(NORMAL)
  scheduledDate      DateTime?
  scheduledTimeSlot  Json?
  startedAt          DateTime?
  completedAt        DateTime?
  resolution         String?
  materialsUsed      Json?
  photos             String[]
  customerSignature  String?
  estimatedDuration  Int?
  actualDuration     Int?
  customerId         String
  technicianId       String?
  createdById        String
  organizationId     String
  locationId         String?
  zoneId             String?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  durationDays       Int?
  durationType       JobDurationType    @default(SINGLE_VISIT)
  endDate            DateTime?
  flexibleEndDate    DateTime?
  flexibleStartDate  DateTime?
  recurrenceCount    Int?
  recurrenceEndDate  DateTime?
  recurrenceInterval Int?
  recurrencePattern  RecurrencePattern?
  visitCount         Int?
  visitIntervalDays  Int?

  // ═══════════════════════════════════════════════════════════════════════════════
  // VEHICLE & DRIVER AUDIT TRAIL (for insurance claims and compliance)
  // ═══════════════════════════════════════════════════════════════════════════════

  // Vehicle used for this job (optional relation)
  vehicleId         String?
  vehiclePlateAtJob String? @map("vehicle_plate_at_job") // Snapshot: plate number at time of job

  // Driver snapshot (frozen at job completion for audit)
  driverNameAtJob    String? @map("driver_name_at_job")
  driverLicenseAtJob String? @map("driver_license_at_job")

  // Mileage tracking (for insurance and expense tracking)
  vehicleMileageStart Int? @map("vehicle_mileage_start")
  vehicleMileageEnd   Int? @map("vehicle_mileage_end")

  // ═══════════════════════════════════════════════════════════════════════════════
  // MULTI-TRADE PRICING FIELDS (Phase 1.2)
  // Deposit (Seña) tracking, pricing totals, and lock mechanism for invoicing
  // ═══════════════════════════════════════════════════════════════════════════════
  
  // Deposit/Advance Payment (Seña)
  depositAmount          Decimal?   @db.Decimal(12, 2) @map("deposit_amount")
  depositPaidAt          DateTime?  @map("deposit_paid_at")
  depositPaymentMethod   String?    @map("deposit_payment_method")  // CASH, TRANSFER, CARD, MERCADOPAGO
  
  // Pricing Totals
  estimatedTotal         Decimal?   @db.Decimal(12, 2) @map("estimated_total")     // Quote total set by dispatcher
  techProposedTotal      Decimal?   @db.Decimal(12, 2) @map("tech_proposed_total") // Technician's proposed total (may differ)
  finalTotal             Decimal?   @db.Decimal(12, 2) @map("final_total")         // Approved final total for invoice
  
  // Pricing Lock (immutable after invoice generation - AFIP compliance)
  pricingLockedAt        DateTime?  @map("pricing_locked_at")
  pricingLockedById      String?    @map("pricing_locked_by_id")

  invoice          Invoice?
  assignments      JobAssignment[]    @relation("JobAssignments")
  materials        JobMaterial[]
  jobPhotos        JobPhoto[]         @relation("JobPhotos")
  visits           JobVisit[]         @relation("JobVisits")
  createdBy        User               @relation("CreatorJobs", fields: [createdById], references: [id])
  customer         Customer           @relation(fields: [customerId], references: [id])
  location         Location?          @relation("JobLocation", fields: [locationId], references: [id])
  organization     Organization       @relation(fields: [organizationId], references: [id])
  technician       User?              @relation("TechnicianJobs", fields: [technicianId], references: [id])
  vehicle          Vehicle?           @relation("VehicleJobs", fields: [vehicleId], references: [id])
  zone             Zone?              @relation("JobZone", fields: [zoneId], references: [id])
  attribution      MarketplaceClick?  @relation("JobAttribution")
  review           Review?
  stockMovements   StockMovement[]
  reservations     StockReservation[]
  trackingSessions TrackingSession[]  @relation("JobTrackingSessions")
  lineItems        JobLineItem[]      @relation("JobLineItems")

  @@index([status])
  @@index([durationType])
  @@index([scheduledDate])
  @@index([technicianId])
  @@index([organizationId])
  @@index([locationId])
  @@index([zoneId])
  @@index([vehicleId])
  @@index([organizationId, status])
  @@index([organizationId, scheduledDate])
  @@index([technicianId, status])
  @@index([status, completedAt])
  @@map("jobs")
}

model ServiceTypeConfig {
  id             String       @id @default(cuid())
  code           String
  name           String
  description    String?
  color          String?
  icon           String?
  isActive       Boolean      @default(true)
  sortOrder      Int          @default(0)
  organizationId String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, code])
  @@index([organizationId])
  @@map("service_type_configs")
}

model JobAssignment {
  id           String   @id @default(cuid())
  jobId        String
  technicianId String
  assignedAt   DateTime @default(now())
  notes        String?
  job          Job      @relation("JobAssignments", fields: [jobId], references: [id], onDelete: Cascade)
  technician   User     @relation("TechnicianAssignments", fields: [technicianId], references: [id], onDelete: Cascade)

  @@unique([jobId, technicianId])
  @@index([jobId])
  @@index([technicianId])
  @@map("job_assignments")
}

model JobVisit {
  id                String    @id @default(cuid())
  jobId             String
  visitNumber       Int
  scheduledDate     DateTime
  scheduledTimeSlot Json?
  status            JobStatus @default(PENDING)
  startedAt         DateTime?
  completedAt       DateTime?
  notes             String?
  technicianId      String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  visitConfigIndex  Int       @default(1)
  job               Job       @relation("JobVisits", fields: [jobId], references: [id], onDelete: Cascade)
  technician        User?     @relation("TechnicianVisits", fields: [technicianId], references: [id])
  vehicleAssignments JobVisitVehicle[] @relation("VisitVehicleAssignments")

  @@unique([jobId, visitNumber])
  @@index([jobId])
  @@index([scheduledDate])
  @@index([status])
  @@index([visitConfigIndex])
  @@map("job_visits")
}

// ═══════════════════════════════════════════════════════════════════════════════
// PHASE 6: MULTI-VEHICLE PER-VISIT SUPPORT
// ═══════════════════════════════════════════════════════════════════════════════
//
// Supports multiple vehicles with multiple drivers per job visit.
// Implements "Visit-Level Snapshotting" pattern for immutable audit records.

model JobVisitVehicle {
  id          String   @id @default(cuid())
  jobVisitId  String
  vehicleId   String
  createdAt   DateTime @default(now())
  
  jobVisit    JobVisit @relation("VisitVehicleAssignments", fields: [jobVisitId], references: [id], onDelete: Cascade)
  vehicle     Vehicle  @relation("VehicleVisitAssignments", fields: [vehicleId], references: [id])
  drivers     JobVisitVehicleDriver[] @relation("VehicleDriverAssignments")
  
  // Snapshot fields (populated at job completion - "Lock on Complete" pattern)
  vehiclePlateSnapshot    String?  @map("vehicle_plate_snapshot")
  vehicleMakeSnapshot     String?  @map("vehicle_make_snapshot")
  vehicleModelSnapshot    String?  @map("vehicle_model_snapshot")
  
  @@unique([jobVisitId, vehicleId])
  @@index([jobVisitId])
  @@index([vehicleId])
  @@map("job_visit_vehicles")
}

model JobVisitVehicleDriver {
  id                 String   @id @default(cuid())
  jobVisitVehicleId  String
  userId             String
  createdAt          DateTime @default(now())
  
  jobVisitVehicle    JobVisitVehicle @relation("VehicleDriverAssignments", fields: [jobVisitVehicleId], references: [id], onDelete: Cascade)
  user               User            @relation("DriverVisitAssignments", fields: [userId], references: [id])
  
  // Snapshot fields (populated at job completion - "Lock on Complete" pattern)
  driverNameSnapshot     String?  @map("driver_name_snapshot")
  driverLicenseSnapshot  String?  @map("driver_license_snapshot")
  
  @@unique([jobVisitVehicleId, userId])
  @@index([jobVisitVehicleId])
  @@index([userId])
  @@map("job_visit_vehicle_drivers")
}

model Invoice {
  id               String            @id @default(cuid())
  invoiceNumber    String            @unique
  type             InvoiceType       @default(FACTURA_C)
  status           InvoiceStatus     @default(DRAFT)
  subtotal         Decimal           @db.Decimal(10, 2)
  taxAmount        Decimal           @db.Decimal(10, 2)
  total            Decimal           @db.Decimal(10, 2)
  items            Json
  afipCae          String?
  afipCaeExpiry    DateTime?
  afipQrCode       String?
  issuedAt         DateTime?
  dueDate          DateTime?
  jobId            String?           @unique
  customerId       String
  organizationId   String
  locationId       String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  chargebacks      Chargeback[]
  fallbackPayments FallbackPayment[]
  lineItems        InvoiceItem[]     @relation("InvoiceLineItems")
  customer         Customer          @relation(fields: [customerId], references: [id])
  job              Job?              @relation(fields: [jobId], references: [id])
  location         Location?         @relation("InvoiceLocation", fields: [locationId], references: [id])
  organization     Organization      @relation(fields: [organizationId], references: [id])
  payments         Payment[]

  @@index([status])
  @@index([organizationId])
  @@index([locationId])
  @@index([customerId])
  @@index([customerId, status])
  @@map("invoices")
}

model Payment {
  id             String           @id @default(cuid())
  amount         Decimal          @db.Decimal(10, 2)
  method         PaymentMethod
  status         PaymentStatus    @default(PENDING)
  reference      String?
  paidAt         DateTime?
  invoiceId      String
  organizationId String
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  chargebacks    Chargeback[]
  disputes       PaymentDispute[] @relation("PaymentDisputes")
  invoice        Invoice          @relation(fields: [invoiceId], references: [id])
  organization   Organization     @relation(fields: [organizationId], references: [id])

  @@index([invoiceId])
  @@map("payments")
}

model WhatsAppMessage {
  id             String                @id @default(cuid())
  waMessageId    String                @unique
  direction      MessageDirection
  type           MessageType
  content        String?
  mediaUrl       String?
  status         MessageDeliveryStatus @default(SENT)
  phone          String
  organizationId String
  createdAt      DateTime              @default(now())
  transcript     VoiceTranscript?      @relation("MessageTranscript")

  @@index([phone])
  @@index([organizationId])
  @@map("whatsapp_messages")
}

model VoiceMessage {
  id              String             @id @default(cuid())
  phone           String
  audioUrl        String
  duration        Int
  transcription   String?
  extractedData   Json?
  confidence      Float?
  status          VoiceMessageStatus @default(PENDING)
  reviewedBy      String?
  reviewedAt      DateTime?
  rejectionReason String?
  organizationId  String
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  @@index([status])
  @@index([organizationId])
  @@map("voice_messages")
}

model OtpCode {
  id        String   @id @default(cuid())
  phone     String
  codeHash  String
  expiresAt DateTime
  attempts  Int      @default(0)
  verified  Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([phone])
  @@index([expiresAt])
  @@map("otp_codes")
}

model PendingRegistration {
  id           String   @id @default(cuid())
  phone        String   @unique
  cuit         String
  businessName String
  adminName    String
  email        String?
  expiresAt    DateTime
  createdAt    DateTime @default(now())

  @@index([phone])
  @@index([cuit])
  @@index([expiresAt])
  @@map("pending_registrations")
}

model ScheduledReminder {
  id             String    @id @default(cuid())
  organizationId String
  jobId          String
  userId         String
  reminderType   String
  scheduledFor   DateTime
  status         String    @default("pending")
  sentAt         DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([organizationId])
  @@index([status, scheduledFor])
  @@map("scheduled_reminders")
}

model AudioMessage {
  id             String    @id @default(cuid())
  organizationId String
  waMessageId    String
  senderPhone    String
  senderName     String?
  mediaId        String
  mimeType       String    @default("audio/ogg")
  mediaUrl       String?
  isVoice        Boolean   @default(true)
  duration       Int?
  transcription  String?
  status         String    @default("received")
  reviewed       Boolean   @default(false)
  reviewedAt     DateTime?
  reviewedById   String?
  transcribedAt  DateTime?
  receivedAt     DateTime  @default(now())
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([organizationId])
  @@index([status])
  @@index([senderPhone])
  @@map("audio_messages")
}

model AutoResponseLog {
  id             String   @id @default(cuid())
  organizationId String
  recipientPhone String
  responseType   String
  message        String
  sentAt         DateTime @default(now())
  createdAt      DateTime @default(now())

  @@index([organizationId])
  @@index([recipientPhone])
  @@map("auto_response_logs")
}

model ConversationContext {
  id               String   @id @default(cuid())
  organizationId   String
  customerPhone    String
  customerId       String?
  customerName     String?
  messageHistory   Json     @default("[]")
  previousRequests String[] @default([])
  activeJobId      String?
  lastMessageAt    DateTime @default(now())
  expiresAt        DateTime
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@unique([organizationId, customerPhone])
  @@index([expiresAt])
  @@map("conversation_contexts")
}

model MessageBufferStats {
  id                      String   @id @default(cuid())
  organizationId          String
  date                    DateTime @db.Date
  totalBuffersCreated     Int      @default(0)
  totalMessagesAggregated Int      @default(0)
  totalImmediateTriggers  Int      @default(0)
  totalTimeoutTriggers    Int      @default(0)
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  @@unique([organizationId, date])
  @@map("message_buffer_stats")
}

model MessageAggregationEvent {
  id              String   @id @default(cuid())
  organizationId  String
  customerPhone   String
  combinedContent String
  messageCount    Int
  triggerReason   String
  processedAt     DateTime @default(now())
  createdAt       DateTime @default(now())

  @@index([organizationId])
  @@index([triggerReason])
  @@index([createdAt])
  @@map("message_aggregation_events")
}

model ScheduledReport {
  id             String            @id @default(cuid())
  organizationId String
  reportId       String?
  name           String
  frequency      String
  dayOfWeek      Int?
  dayOfMonth     Int?
  time           String
  format         String
  recipients     Json
  enabled        Boolean           @default(true)
  status         String            @default("active")
  lastRunAt      DateTime?
  nextRunAt      DateTime?
  createdById    String
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  executions     ReportExecution[]
  createdBy      User              @relation("ScheduledReportCreator", fields: [createdById], references: [id])
  organization   Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  report         Report?           @relation(fields: [reportId], references: [id])

  @@index([organizationId])
  @@index([enabled])
  @@index([nextRunAt])
  @@map("scheduled_reports")
}

model Report {
  id               String            @id @default(cuid())
  organizationId   String
  name             String
  templateId       String
  description      String?
  parameters       Json?
  createdById      String
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  history          ReportHistory[]
  createdBy        User              @relation("ReportCreator", fields: [createdById], references: [id])
  organization     Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  scheduledReports ScheduledReport[]

  @@index([organizationId])
  @@index([templateId])
  @@map("reports")
}

model ReportExecution {
  id                String          @id @default(cuid())
  scheduledReportId String
  organizationId    String
  status            String          @default("pending")
  format            String
  fileUrl           String?
  fileSize          Int?
  generationTimeMs  Int?
  error             String?
  recipientResults  Json?
  startedAt         DateTime?
  completedAt       DateTime?
  createdAt         DateTime        @default(now())
  scheduledReport   ScheduledReport @relation(fields: [scheduledReportId], references: [id], onDelete: Cascade)

  @@index([scheduledReportId])
  @@index([organizationId])
  @@index([status])
  @@map("report_executions")
}

model ReportHistory {
  id               String       @id @default(cuid())
  organizationId   String
  reportId         String?
  name             String
  reportType       String
  format           String
  status           String       @default("completed")
  parameters       Json?
  fileUrl          String?
  fileSize         Int?
  generationTimeMs Int?
  errorMessage     String?
  downloadUrl      String?
  generatedById    String
  generatedAt      DateTime     @default(now())
  createdAt        DateTime     @default(now())
  generatedBy      User         @relation("ReportHistoryGenerator", fields: [generatedById], references: [id])
  organization     Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  report           Report?      @relation(fields: [reportId], references: [id])

  @@index([organizationId])
  @@index([reportType])
  @@index([status])
  @@index([generatedAt])
  @@map("report_history")
}

model Review {
  id             String       @id @default(cuid())
  organizationId String
  jobId          String?      @unique
  customerId     String?
  technicianId   String?
  rating         Int?
  comment        String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  submittedAt    DateTime?
  token          String?      @unique
  tokenExpiresAt DateTime?
  customer       Customer?    @relation(fields: [customerId], references: [id])
  job            Job?         @relation(fields: [jobId], references: [id])
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  technician     User?        @relation("TechnicianReviews", fields: [technicianId], references: [id])

  @@index([organizationId])
  @@index([technicianId])
  @@index([rating])
  @@index([token])
  @@index([organizationId, rating])
  @@index([customerId])
  @@map("reviews")
}

model Location {
  id             String                  @id @default(cuid())
  organizationId String
  code           String
  name           String
  type           LocationType            @default(BRANCH)
  address        Json
  coordinates    Json?
  timezone       String                  @default("America/Argentina/Buenos_Aires")
  phone          String?
  email          String?
  managerId      String?
  isHeadquarters Boolean                 @default(false)
  isActive       Boolean                 @default(true)
  coverageRadius Int?
  coverageArea   Json?
  createdAt      DateTime                @default(now())
  updatedAt      DateTime                @updatedAt
  customers      Customer[]              @relation("CustomerLocation")
  transfersFrom  InterLocationTransfer[] @relation("TransferFromLocation")
  transfersTo    InterLocationTransfer[] @relation("TransferToLocation")
  invoices       Invoice[]               @relation("InvoiceLocation")
  jobs           Job[]                   @relation("JobLocation")
  afipConfig     LocationAfipConfig?
  settings       LocationSettings?
  manager        User?                   @relation("LocationManager", fields: [managerId], references: [id])
  organization   Organization            @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  technicians    User[]                  @relation("TechnicianHomeLocation")
  warehouses     Warehouse[]
  zones          Zone[]

  @@unique([organizationId, code])
  @@index([organizationId])
  @@index([isActive])
  @@index([type])
  @@map("locations")
}

model Zone {
  id          String     @id @default(cuid())
  locationId  String
  code        String
  name        String
  description String?
  boundary    Json?
  color       String?
  priority    Int        @default(0)
  isActive    Boolean    @default(true)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  customers   Customer[] @relation("CustomerZone")
  jobs        Job[]      @relation("JobZone")
  location    Location   @relation(fields: [locationId], references: [id], onDelete: Cascade)

  @@unique([locationId, code])
  @@index([locationId])
  @@index([isActive])
  @@map("zones")
}

model LocationSettings {
  id                  String   @id @default(cuid())
  locationId          String   @unique
  operatingHours      Json     @default("{}")
  holidays            Json     @default("[]")
  serviceRadius       Int?
  maxJobsPerDay       Int?
  defaultJobDuration  Int?
  allowEmergencyJobs  Boolean  @default(true)
  emergencyFeePercent Decimal? @db.Decimal(5, 2)
  pricingMultiplier   Decimal  @default(1.0) @db.Decimal(5, 3)
  travelFeePerKm      Decimal? @db.Decimal(10, 2)
  minimumTravelFee    Decimal? @db.Decimal(10, 2)
  notifyOnNewJob      Boolean  @default(true)
  notifyOnJobComplete Boolean  @default(true)
  notificationEmails  String[] @default([])
  whatsappNumber      String?
  whatsappBusinessId  String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  location            Location @relation(fields: [locationId], references: [id], onDelete: Cascade)

  @@map("location_settings")
}

model LocationAfipConfig {
  id                     String    @id @default(cuid())
  locationId             String    @unique
  puntoDeVenta           Int
  tiposPuntoDeVenta      String    @default("CAJA")
  cuit                   String?
  razonSocial            String?
  domicilioFiscal        Json?
  condicionIva           String    @default("RESPONSABLE_INSCRIPTO")
  facturaALastNumber     Int       @default(0)
  facturaBLastNumber     Int       @default(0)
  facturaCLastNumber     Int       @default(0)
  notaCreditoALastNumber Int       @default(0)
  notaCreditoBLastNumber Int       @default(0)
  notaCreditoCLastNumber Int       @default(0)
  certificatePath        String?
  certificateExpiry      DateTime?
  privateKeyPath         String?
  wsaaToken              String?
  wsaaTokenExpiry        DateTime?
  isActive               Boolean   @default(true)
  lastSyncAt             DateTime?
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt
  location               Location  @relation(fields: [locationId], references: [id], onDelete: Cascade)

  @@index([puntoDeVenta])
  @@map("location_afip_configs")
}

model InterLocationTransfer {
  id             String         @id @default(cuid())
  organizationId String
  fromLocationId String
  toLocationId   String
  transferType   TransferType
  referenceId    String?
  reason         String?
  notes          String?
  amount         Decimal?       @db.Decimal(10, 2)
  status         TransferStatus @default(PENDING)
  requestedById  String
  approvedById   String?
  requestedAt    DateTime       @default(now())
  approvedAt     DateTime?
  completedAt    DateTime?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  approvedBy     User?          @relation("TransferApprover", fields: [approvedById], references: [id])
  fromLocation   Location       @relation("TransferFromLocation", fields: [fromLocationId], references: [id])
  requestedBy    User           @relation("TransferRequester", fields: [requestedById], references: [id])
  toLocation     Location       @relation("TransferToLocation", fields: [toLocationId], references: [id])

  @@index([organizationId])
  @@index([fromLocationId])
  @@index([toLocationId])
  @@index([status])
  @@index([transferType])
  @@map("inter_location_transfers")
}

model ProductCategory {
  id             String            @id @default(cuid())
  organizationId String
  parentId       String?
  code           String
  name           String
  description    String?
  sortOrder      Int               @default(0)
  isActive       Boolean           @default(true)
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  organization   Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  parent         ProductCategory?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children       ProductCategory[] @relation("CategoryHierarchy")
  products       Product[]

  @@unique([organizationId, code])
  @@index([organizationId])
  @@index([parentId])
  @@map("product_categories")
}

model Product {
  id                 String              @id @default(cuid())
  organizationId     String
  categoryId         String?
  sku                String
  barcode            String?
  name               String
  description        String?
  brand              String?
  model              String?
  productType        ProductType         @default(PART)
  unitOfMeasure      String              @default("UNIDAD")
  costPrice          Decimal             @db.Decimal(12, 2)
  salePrice          Decimal             @db.Decimal(12, 2)
  marginPercent      Decimal?            @db.Decimal(5, 2)
  taxRate            Decimal             @default(21.0) @db.Decimal(5, 2)
  trackInventory     Boolean             @default(true)
  minStockLevel      Int                 @default(0)
  maxStockLevel      Int?
  reorderQty         Int?
  weight             Decimal?            @db.Decimal(10, 3)
  dimensions         Json?
  imageUrl           String?
  images             String[]            @default([])
  isActive           Boolean             @default(true)
  isSerialTracked    Boolean             @default(false)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  inventoryLevels    InventoryLevel[]
  jobMaterials       JobMaterial[]
  variants           ProductVariant[]
  category           ProductCategory?    @relation(fields: [categoryId], references: [id])
  organization       Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  purchaseOrderItems PurchaseOrderItem[]
  stockMovements     StockMovement[]
  stockReservations  StockReservation[]
  supplierProducts   SupplierProduct[]
  vehicleStocks      VehicleStock[]

  @@unique([organizationId, sku])
  @@index([organizationId])
  @@index([categoryId])
  @@index([barcode])
  @@index([name])
  @@map("products")
}

model ProductVariant {
  id              String           @id @default(cuid())
  productId       String
  sku             String
  name            String
  attributes      Json
  costPrice       Decimal          @db.Decimal(12, 2)
  salePrice       Decimal          @db.Decimal(12, 2)
  barcode         String?
  isActive        Boolean          @default(true)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  inventoryLevels InventoryLevel[]
  product         Product          @relation(fields: [productId], references: [id], onDelete: Cascade)
  stockMovements  StockMovement[]

  @@unique([productId, sku])
  @@index([productId])
  @@map("product_variants")
}

model Warehouse {
  id                 String             @id @default(cuid())
  organizationId     String
  locationId         String?
  code               String
  name               String
  type               WarehouseType      @default(MAIN)
  address            Json?
  contactName        String?
  contactPhone       String?
  contactEmail       String?
  isDefault          Boolean            @default(false)
  allowNegative      Boolean            @default(false)
  isActive           Boolean            @default(true)
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  vehicleId          String?            @unique
  inventoryCounts    InventoryCount[]
  inventoryLevels    InventoryLevel[]
  purchaseOrders     PurchaseOrder[]
  stockMovementsFrom StockMovement[]    @relation("MovementFromWarehouse")
  stockMovementsTo   StockMovement[]    @relation("MovementToWarehouse")
  stockReservations  StockReservation[]
  storageLocations   StorageLocation[]
  location           Location?          @relation(fields: [locationId], references: [id])
  organization       Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  vehicle            Vehicle?           @relation("VehicleWarehouse", fields: [vehicleId], references: [id])

  @@unique([organizationId, code])
  @@index([organizationId])
  @@index([locationId])
  @@index([vehicleId])
  @@map("warehouses")
}

model StorageLocation {
  id              String           @id @default(cuid())
  warehouseId     String
  code            String
  name            String?
  description     String?
  sortOrder       Int              @default(0)
  isActive        Boolean          @default(true)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  inventoryLevels InventoryLevel[]
  warehouse       Warehouse        @relation(fields: [warehouseId], references: [id], onDelete: Cascade)

  @@unique([warehouseId, code])
  @@index([warehouseId])
  @@map("storage_locations")
}

model InventoryLevel {
  id                String           @id @default(cuid())
  organizationId    String
  productId         String
  variantId         String?
  warehouseId       String
  storageLocationId String?
  quantityOnHand    Int              @default(0)
  quantityReserved  Int              @default(0)
  quantityOnOrder   Int              @default(0)
  quantityAvailable Int              @default(0)
  lotNumber         String?
  expiryDate        DateTime?
  unitCost          Decimal          @db.Decimal(12, 2)
  totalCost         Decimal          @db.Decimal(14, 2)
  lastCountedAt     DateTime?
  lastMovementAt    DateTime?
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  product           Product          @relation(fields: [productId], references: [id], onDelete: Cascade)
  storageLocation   StorageLocation? @relation(fields: [storageLocationId], references: [id])
  variant           ProductVariant?  @relation(fields: [variantId], references: [id], onDelete: Cascade)
  warehouse         Warehouse        @relation(fields: [warehouseId], references: [id], onDelete: Cascade)

  @@unique([productId, variantId, warehouseId, storageLocationId, lotNumber])
  @@index([organizationId])
  @@index([productId])
  @@index([warehouseId])
  @@index([quantityOnHand])
  @@map("inventory_levels")
}

model StockMovement {
  id               String            @id @default(cuid())
  organizationId   String
  productId        String
  variantId        String?
  movementNumber   String            @unique
  movementType     MovementType
  quantity         Int
  direction        MovementDirection
  fromWarehouseId  String?
  toWarehouseId    String?
  jobId            String?
  purchaseOrderId  String?
  inventoryCountId String?
  transferId       String?
  unitCost         Decimal           @db.Decimal(12, 2)
  totalCost        Decimal           @db.Decimal(14, 2)
  reference        String?
  notes            String?
  performedById    String?
  performedAt      DateTime          @default(now())
  createdAt        DateTime          @default(now())
  fromWarehouse    Warehouse?        @relation("MovementFromWarehouse", fields: [fromWarehouseId], references: [id])
  inventoryCount   InventoryCount?   @relation(fields: [inventoryCountId], references: [id])
  job              Job?              @relation(fields: [jobId], references: [id])
  product          Product           @relation(fields: [productId], references: [id])
  purchaseOrder    PurchaseOrder?    @relation(fields: [purchaseOrderId], references: [id])
  toWarehouse      Warehouse?        @relation("MovementToWarehouse", fields: [toWarehouseId], references: [id])
  variant          ProductVariant?   @relation(fields: [variantId], references: [id], onDelete: Restrict)

  @@index([organizationId])
  @@index([productId])
  @@index([movementType])
  @@index([performedAt])
  @@index([jobId])
  @@index([purchaseOrderId])
  @@map("stock_movements")
}

model StockReservation {
  id             String            @id @default(cuid())
  organizationId String
  productId      String
  warehouseId    String
  jobId          String
  quantity       Int
  status         ReservationStatus @default(PENDING)
  reservedAt     DateTime          @default(now())
  fulfilledAt    DateTime?
  cancelledAt    DateTime?
  expiresAt      DateTime?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  job            Job               @relation(fields: [jobId], references: [id], onDelete: Cascade)
  product        Product           @relation(fields: [productId], references: [id], onDelete: Cascade)
  warehouse      Warehouse         @relation(fields: [warehouseId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([productId])
  @@index([jobId])
  @@index([status])
  @@map("stock_reservations")
}

model Supplier {
  id               String            @id @default(cuid())
  organizationId   String
  code             String
  name             String
  legalName        String?
  cuit             String?
  taxCondition     String?
  contactName      String?
  email            String?
  phone            String?
  website          String?
  address          Json?
  paymentTermDays  Int               @default(30)
  creditLimit      Decimal?          @db.Decimal(14, 2)
  currency         String            @default("ARS")
  bankInfo         Json?
  isActive         Boolean           @default(true)
  rating           Int?
  notes            String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  purchaseOrders   PurchaseOrder[]
  supplierProducts SupplierProduct[]
  organization     Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, code])
  @@index([organizationId])
  @@index([name])
  @@map("suppliers")
}

model SupplierProduct {
  id             String    @id @default(cuid())
  supplierId     String
  productId      String
  supplierSku    String?
  supplierName   String?
  purchasePrice  Decimal   @db.Decimal(12, 2)
  minOrderQty    Int       @default(1)
  leadTimeDays   Int?
  isPreferred    Boolean   @default(false)
  lastPurchaseAt DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  product        Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  supplier       Supplier  @relation(fields: [supplierId], references: [id], onDelete: Cascade)

  @@unique([supplierId, productId])
  @@index([supplierId])
  @@index([productId])
  @@map("supplier_products")
}

model PurchaseOrder {
  id             String              @id @default(cuid())
  organizationId String
  supplierId     String
  warehouseId    String
  orderNumber    String              @unique
  status         POStatus            @default(DRAFT)
  orderDate      DateTime            @default(now())
  expectedDate   DateTime?
  receivedDate   DateTime?
  subtotal       Decimal             @db.Decimal(14, 2)
  taxAmount      Decimal             @db.Decimal(14, 2)
  total          Decimal             @db.Decimal(14, 2)
  currency       String              @default("ARS")
  shippingMethod String?
  shippingCost   Decimal?            @db.Decimal(10, 2)
  trackingNumber String?
  notes          String?
  internalNotes  String?
  createdById    String?
  approvedById   String?
  approvedAt     DateTime?
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  items          PurchaseOrderItem[]
  organization   Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  supplier       Supplier            @relation(fields: [supplierId], references: [id])
  warehouse      Warehouse           @relation(fields: [warehouseId], references: [id])
  receivings     PurchaseReceiving[]
  stockMovements StockMovement[]

  @@index([organizationId])
  @@index([supplierId])
  @@index([status])
  @@index([orderDate])
  @@map("purchase_orders")
}

model PurchaseOrderItem {
  id               String        @id @default(cuid())
  purchaseOrderId  String
  productId        String
  quantity         Int
  quantityReceived Int           @default(0)
  unitPrice        Decimal       @db.Decimal(12, 2)
  discount         Decimal       @default(0) @db.Decimal(5, 2)
  taxRate          Decimal       @default(21.0) @db.Decimal(5, 2)
  lineTotal        Decimal       @db.Decimal(14, 2)
  notes            String?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  product          Product       @relation(fields: [productId], references: [id])
  purchaseOrder    PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)

  @@index([purchaseOrderId])
  @@index([productId])
  @@map("purchase_order_items")
}

model PurchaseReceiving {
  id              String        @id @default(cuid())
  purchaseOrderId String
  receivingNumber String        @unique
  receivedById    String?
  receivedAt      DateTime      @default(now())
  notes           String?
  items           Json
  hasVariance     Boolean       @default(false)
  createdAt       DateTime      @default(now())
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)

  @@index([purchaseOrderId])
  @@map("purchase_receivings")
}

model InventoryCount {
  id             String               @id @default(cuid())
  organizationId String
  warehouseId    String
  countNumber    String               @unique
  countType      CountType            @default(FULL)
  status         CountStatus          @default(DRAFT)
  scheduledAt    DateTime?
  startedAt      DateTime?
  completedAt    DateTime?
  totalItems     Int?
  matchedItems   Int?
  varianceItems  Int?
  totalVariance  Decimal?             @db.Decimal(14, 2)
  assignedToId   String?
  completedById  String?
  approvedById   String?
  approvedAt     DateTime?
  notes          String?
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt
  items          InventoryCountItem[]
  organization   Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  warehouse      Warehouse            @relation(fields: [warehouseId], references: [id])
  stockMovements StockMovement[]

  @@index([organizationId])
  @@index([warehouseId])
  @@index([status])
  @@map("inventory_counts")
}

model InventoryCountItem {
  id               String         @id @default(cuid())
  inventoryCountId String
  productId        String
  expectedQty      Int
  countedQty       Int?
  variance         Int?
  varianceValue    Decimal?       @db.Decimal(12, 2)
  notes            String?
  countedAt        DateTime?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  inventoryCount   InventoryCount @relation(fields: [inventoryCountId], references: [id], onDelete: Cascade)

  @@index([inventoryCountId])
  @@index([productId])
  @@map("inventory_count_items")
}

model VehicleStock {
  id             String    @id @default(cuid())
  organizationId String
  technicianId   String
  productId      String
  quantity       Int       @default(0)
  minLevel       Int       @default(0)
  maxLevel       Int?
  lastRefilledAt DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  product        Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  technician     User      @relation(fields: [technicianId], references: [id], onDelete: Cascade)

  @@unique([technicianId, productId])
  @@index([organizationId])
  @@index([technicianId])
  @@index([productId])
  @@map("vehicle_stocks")
}

model ReplenishmentRequest {
  id             String              @id @default(cuid())
  organizationId String
  technicianId   String
  warehouseId    String?
  requestNumber  String              @unique
  status         ReplenishmentStatus @default(PENDING)
  requestedAt    DateTime            @default(now())
  processedAt    DateTime?
  processedById  String?
  notes          String?
  items          Json
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt

  @@index([organizationId])
  @@index([technicianId])
  @@index([status])
  @@map("replenishment_requests")
}

model JobMaterial {
  id           String         @id @default(cuid())
  jobId        String
  productId    String
  estimatedQty Int            @default(0)
  usedQty      Int            @default(0)
  returnedQty  Int            @default(0)
  unitPrice    Decimal        @db.Decimal(12, 2)
  unitCost     Decimal        @db.Decimal(12, 2)
  discount     Decimal        @default(0) @db.Decimal(5, 2)
  lineTotal    Decimal        @db.Decimal(14, 2)
  sourceType   MaterialSource @default(WAREHOUSE)
  sourceId     String?
  isInvoiced   Boolean        @default(false)
  notes        String?
  addedAt      DateTime       @default(now())
  usedAt       DateTime?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  job          Job            @relation(fields: [jobId], references: [id], onDelete: Cascade)
  product      Product        @relation(fields: [productId], references: [id])

  @@index([jobId])
  @@index([productId])
  @@map("job_materials")
}

model JobPhoto {
  id           String     @id @default(cuid())
  jobId        String
  uploadedById String?
  photoUrl     String
  thumbnailUrl String?
  photoType    PhotoType  @default(AFTER)
  fileSize     Int?
  width        Int?
  height       Int?
  mimeType     String?
  localId      String?
  syncStatus   SyncStatus @default(SYNCED)
  takenAt      DateTime?
  createdAt    DateTime   @default(now())
  job          Job        @relation("JobPhotos", fields: [jobId], references: [id], onDelete: Cascade)
  uploadedBy   User?      @relation("PhotoUploader", fields: [uploadedById], references: [id])

  @@index([jobId])
  @@index([syncStatus])
  @@map("job_photos")
}

model InvoiceItem {
  id              String   @id @default(cuid())
  invoiceId       String
  priceBookId     String?
  description     String
  quantity        Decimal  @default(1) @db.Decimal(10, 3)
  unit            String   @default("unidad")
  unitPrice       Decimal  @db.Decimal(12, 2)
  taxRate         Decimal  @default(21.00) @db.Decimal(5, 2)
  subtotal        Decimal  @db.Decimal(12, 2)
  taxAmount       Decimal  @db.Decimal(12, 2)
  total           Decimal  @db.Decimal(12, 2)
  afipProductCode String?
  afipUnitCode    String?  @default("7")
  sortOrder       Int      @default(0)
  createdAt       DateTime @default(now())
  invoice         Invoice  @relation("InvoiceLineItems", fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@map("invoice_items")
}

model PaymentDispute {
  id                  String        @id @default(cuid())
  paymentId           String
  mpDisputeId         String?
  disputeType         DisputeType
  reason              String?
  description         String?
  status              DisputeStatus @default(PENDING_RESPONSE)
  responseDeadline    DateTime?
  daysToRespond       Int?
  evidenceSubmittedAt DateTime?
  evidenceUrls        String[]      @default([])
  evidenceNotes       String?
  evidenceDocuments   Json?
  resolvedAt          DateTime?
  resolutionNotes     String?
  resolutionType      String?
  disputedAmount      Decimal       @db.Decimal(12, 2)
  recoveredAmount     Decimal?      @db.Decimal(12, 2)
  lastCommunicationAt DateTime?
  communicationLog    Json          @default("[]")
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt
  payment             Payment       @relation("PaymentDisputes", fields: [paymentId], references: [id], onDelete: Cascade)

  @@index([paymentId])
  @@index([status])
  @@map("payment_disputes")
}

model VoiceTranscript {
  id                      String                @id @default(cuid())
  messageId               String                @unique
  reviewedById            String?
  createdJobId            String?
  audioUrl                String
  audioDuration           Int?
  audioQuality            String?
  audioLanguage           String?               @default("es")
  transcription           String?
  transcriptionModel      String?
  transcriptionConfidence Decimal?              @db.Decimal(3, 2)
  transcriptionSegments   Json?
  extractionData          Json?
  extractionModel         String?
  overallConfidence       Decimal?              @db.Decimal(3, 2)
  humanTranscription      String?
  humanExtraction         Json?
  reviewedAt              DateTime?
  reviewNotes             String?
  status                  VoiceTranscriptStatus @default(PENDING)
  errorMessage            String?
  errorCode               String?
  processingStartedAt     DateTime?
  processingCompletedAt   DateTime?
  processingDurationMs    Int?
  retryCount              Int                   @default(0)
  autoCreated             Boolean               @default(false)
  createdAt               DateTime              @default(now())
  updatedAt               DateTime              @updatedAt
  message                 WhatsAppMessage       @relation("MessageTranscript", fields: [messageId], references: [id], onDelete: Cascade)
  reviewedBy              User?                 @relation("TranscriptReviewer", fields: [reviewedById], references: [id])

  @@index([status])
  @@map("voice_transcripts")
}

model FailedJob {
  id                String        @id @default(cuid())
  queueName         String
  jobId             String
  jobName           String?
  jobData           Json
  errorMessage      String
  errorStack        String?
  errorCode         String?
  errorType         String?
  attempts          Int           @default(1)
  maxAttempts       Int
  lastAttemptAt     DateTime      @default(now())
  organizationId    String?
  userId            String?
  relatedEntityType String?
  relatedEntityId   String?
  status            String        @default("pending")
  priority          Int           @default(0)
  resolvedById      String?
  resolvedAt        DateTime?
  resolutionNotes   String?
  resolutionType    String?
  retryJobId        String?
  retriedAt         DateTime?
  retryCount        Int           @default(0)
  tags              String[]      @default([])
  failedAt          DateTime      @default(now())
  createdAt         DateTime      @default(now())
  organization      Organization? @relation("FailedJobOrg", fields: [organizationId], references: [id])

  @@index([queueName, status])
  @@index([organizationId])
  @@index([status])
  @@map("failed_jobs")
}

model IdempotencyKey {
  id             String        @id @default(cuid())
  key            String        @unique
  result         Json?
  status         String        @default("processing")
  statusCode     Int?
  organizationId String?
  userId         String?
  operationType  String?
  requestPath    String?
  requestMethod  String?
  requestHash    String?
  expiresAt      DateTime
  createdAt      DateTime      @default(now())
  completedAt    DateTime?
  organization   Organization? @relation("IdempotencyOrg", fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([expiresAt])
  @@index([organizationId])
  @@map("idempotency_keys")
}

model TechnicianLocation {
  id        String   @id @default(cuid())
  userId    String   @unique
  latitude  Decimal  @db.Decimal(10, 8)
  longitude Decimal  @db.Decimal(11, 8)
  accuracy  Decimal? @db.Decimal(6, 2)
  heading   Decimal? @db.Decimal(5, 2)
  speed     Decimal? @db.Decimal(6, 2)
  altitude  Decimal? @db.Decimal(10, 2)
  isOnline  Boolean  @default(true)
  lastSeen  DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation("TechnicianCurrentLocation", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isOnline])
  @@index([lastSeen])
  @@map("technician_locations")
}

model TechnicianLocationHistory {
  id           String   @id @default(cuid())
  userId       String
  jobId        String?
  sessionId    String?
  latitude     Decimal  @db.Decimal(10, 8)
  longitude    Decimal  @db.Decimal(11, 8)
  accuracy     Decimal? @db.Decimal(6, 2)
  heading      Decimal? @db.Decimal(5, 2)
  speed        Decimal? @db.Decimal(6, 2)
  movementMode String?
  recordedAt   DateTime @default(now())

  @@index([userId, recordedAt])
  @@index([jobId])
  @@index([sessionId])
  @@map("technician_location_history")
}

model TrackingSession {
  id                  String                    @id @default(cuid())
  jobId               String
  technicianId        String
  organizationId      String
  status              TrackingSessionStatus     @default(ACTIVE)
  currentLat          Decimal?                  @db.Decimal(10, 8)
  currentLng          Decimal?                  @db.Decimal(11, 8)
  currentSpeed        Decimal?                  @db.Decimal(6, 2)
  currentHeading      Decimal?                  @db.Decimal(5, 2)
  destinationLat      Decimal?                  @db.Decimal(10, 8)
  destinationLng      Decimal?                  @db.Decimal(11, 8)
  destinationAddress  String?
  etaMinutes          Int?
  etaUpdatedAt        DateTime?
  routePolyline       String?
  movementMode        String                    @default("driving")
  positionUpdateCount Int                       @default(0)
  lastPositionAt      DateTime?
  startedAt           DateTime                  @default(now())
  arrivedAt           DateTime?
  completedAt         DateTime?
  createdAt           DateTime                  @default(now())
  updatedAt           DateTime                  @updatedAt
  locationHistory     TrackingLocationHistory[]
  job                 Job                       @relation("JobTrackingSessions", fields: [jobId], references: [id], onDelete: Cascade)
  organization        Organization              @relation("OrgTrackingSessions", fields: [organizationId], references: [id], onDelete: Cascade)
  technician          User                      @relation("TechnicianTrackingSessions", fields: [technicianId], references: [id], onDelete: Cascade)
  tokens              TrackingToken[]

  @@index([jobId])
  @@index([technicianId])
  @@index([organizationId])
  @@index([status])
  @@map("tracking_sessions")
}

model TrackingToken {
  id             String           @id @default(cuid())
  token          String           @unique
  jobId          String
  sessionId      String?
  expiresAt      DateTime
  accessCount    Int              @default(0)
  lastAccessedAt DateTime?
  createdAt      DateTime         @default(now())
  session        TrackingSession? @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([jobId])
  @@index([expiresAt])
  @@map("tracking_tokens")
}

model EtaCache {
  id              String   @id @default(cuid())
  originLat       Decimal  @db.Decimal(10, 8)
  originLng       Decimal  @db.Decimal(11, 8)
  destLat         Decimal  @db.Decimal(10, 8)
  destLng         Decimal  @db.Decimal(11, 8)
  durationMinutes Int
  distanceMeters  Int
  source          String
  calculatedAt    DateTime @default(now())
  expiresAt       DateTime

  @@index([expiresAt])
  @@map("eta_cache")
}

model Vehicle {
  id                    String               @id @default(cuid())
  organizationId        String
  plateNumber           String
  make                  String
  model                 String
  year                  Int
  vin                   String?
  color                 String?
  status                VehicleStatus        @default(ACTIVE)
  currentMileage        Int?
  fuelType              FuelType             @default(GASOLINE)
  insuranceCompany      String?
  insurancePolicyNumber String?
  insuranceExpiry       DateTime?
  vtvExpiry             DateTime?
  registrationExpiry    DateTime?
  lastServiceDate       DateTime?
  nextServiceDate       DateTime?
  nextServiceMileage    Int?
  notes                 String?
  createdAt             DateTime             @default(now())
  updatedAt             DateTime             @updatedAt
  inventoryLocations    InventoryLocation[]  @relation("VehicleInventoryLocations")
  assignments           VehicleAssignment[]
  documents             VehicleDocument[]
  jobs                  Job[]                @relation("VehicleJobs")
  maintenanceLogs       VehicleMaintenance[]
  schedules             VehicleSchedule[]    @relation("VehicleSchedules")
  organization          Organization         @relation("OrgVehicles", fields: [organizationId], references: [id], onDelete: Cascade)
  warehouse             Warehouse?           @relation("VehicleWarehouse")
  jobVisitAssignments   JobVisitVehicle[]    @relation("VehicleVisitAssignments")

  @@unique([organizationId, plateNumber])
  @@index([organizationId])
  @@index([status])
  @@index([insuranceExpiry])
  @@index([vtvExpiry])
  @@map("vehicles")
}

model VehicleDocument {
  id           String              @id @default(cuid())
  vehicleId    String
  documentType VehicleDocumentType
  fileName     String
  fileUrl      String
  fileSize     Int?
  mimeType     String?
  expiryDate   DateTime?
  notes        String?
  uploadedById String
  uploadedAt   DateTime            @default(now())
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
  uploadedBy   User                @relation("UploadedVehicleDocuments", fields: [uploadedById], references: [id])
  vehicle      Vehicle             @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  @@index([vehicleId])
  @@index([documentType])
  @@index([expiryDate])
  @@map("vehicle_documents")
}

model VehicleAssignment {
  id              String    @id @default(cuid())
  vehicleId       String
  userId          String
  assignedFrom    DateTime  @default(now())
  assignedUntil   DateTime?
  isPrimaryDriver Boolean   @default(false)
  notes           String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  user            User      @relation("UserVehicleAssignments", fields: [userId], references: [id], onDelete: Cascade)
  vehicle         Vehicle   @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  @@index([vehicleId])
  @@index([userId])
  @@index([assignedFrom, assignedUntil])
  @@map("vehicle_assignments")
}

model VehicleSchedule {
  id             String              @id @default(cuid())
  organizationId String
  userId         String
  vehicleId      String
  scheduleType   VehicleScheduleType
  startDate      DateTime?           @db.Date
  endDate        DateTime?           @db.Date
  timeStart      String?
  timeEnd        String?
  daysOfWeek     Int[]               @default([])
  priority       Int                 @default(100)
  createdById    String?
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  createdBy      User?               @relation("CreatedVehicleSchedules", fields: [createdById], references: [id])
  organization   Organization        @relation("OrgVehicleSchedules", fields: [organizationId], references: [id], onDelete: Cascade)
  user           User                @relation("UserVehicleSchedules", fields: [userId], references: [id], onDelete: Cascade)
  vehicle        Vehicle             @relation("VehicleSchedules", fields: [vehicleId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([userId, startDate, endDate])
  @@index([vehicleId, startDate, endDate])
  @@index([scheduleType])
  @@map("vehicle_schedules")
}

model VehicleMaintenance {
  id                 String          @id @default(cuid())
  vehicleId          String
  maintenanceType    MaintenanceType
  description        String
  mileageAtService   Int?
  cost               Decimal?        @db.Decimal(10, 2)
  vendor             String?
  invoiceNumber      String?
  scheduledDate      DateTime?
  completedDate      DateTime?
  nextServiceDate    DateTime?
  nextServiceMileage Int?
  notes              String?
  createdById        String?
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
  createdBy          User?           @relation("CreatedMaintenanceLogs", fields: [createdById], references: [id])
  vehicle            Vehicle         @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  @@index([vehicleId])
  @@index([maintenanceType])
  @@index([scheduledDate])
  @@map("vehicle_maintenance")
}

model InventoryItem {
  id             String                 @id @default(cuid())
  organizationId String
  sku            String
  name           String
  description    String?
  category       InventoryCategory      @default(PARTS)
  unit           String                 @default("pieza")
  minStockLevel  Int                    @default(0)
  costPrice      Decimal                @db.Decimal(10, 2)
  salePrice      Decimal                @db.Decimal(10, 2)
  isActive       Boolean                @default(true)
  imageUrl       String?
  createdAt      DateTime               @default(now())
  updatedAt      DateTime               @updatedAt
  organization   Organization           @relation("OrgInventoryItems", fields: [organizationId], references: [id], onDelete: Cascade)
  stocks         InventoryStock[]
  transactions   InventoryTransaction[]

  @@unique([organizationId, sku])
  @@index([organizationId])
  @@index([category])
  @@index([isActive])
  @@map("inventory_items")
}

model InventoryLocation {
  id               String                 @id @default(cuid())
  organizationId   String
  locationType     InventoryLocationType
  name             String
  vehicleId        String?
  address          String?
  isActive         Boolean                @default(true)
  createdAt        DateTime               @default(now())
  updatedAt        DateTime               @updatedAt
  organization     Organization           @relation("OrgInventoryLocations", fields: [organizationId], references: [id], onDelete: Cascade)
  vehicle          Vehicle?               @relation("VehicleInventoryLocations", fields: [vehicleId], references: [id])
  stocks           InventoryStock[]
  transactionsFrom InventoryTransaction[] @relation("TransactionFromLocation")
  transactionsTo   InventoryTransaction[] @relation("TransactionToLocation")

  @@index([organizationId])
  @@index([locationType])
  @@index([vehicleId])
  @@map("inventory_locations")
}

model InventoryStock {
  id            String            @id @default(cuid())
  itemId        String
  locationId    String
  quantity      Int               @default(0)
  lastCountedAt DateTime?
  updatedAt     DateTime          @updatedAt
  item          InventoryItem     @relation(fields: [itemId], references: [id], onDelete: Cascade)
  location      InventoryLocation @relation(fields: [locationId], references: [id], onDelete: Cascade)

  @@unique([itemId, locationId])
  @@index([itemId])
  @@index([locationId])
  @@index([quantity])
  @@map("inventory_stock")
}

model InventoryTransaction {
  id              String                   @id @default(cuid())
  organizationId  String
  itemId          String
  fromLocationId  String?
  toLocationId    String?
  quantity        Int
  transactionType InventoryTransactionType
  jobId           String?
  notes           String?
  performedById   String
  performedAt     DateTime                 @default(now())
  createdAt       DateTime                 @default(now())
  fromLocation    InventoryLocation?       @relation("TransactionFromLocation", fields: [fromLocationId], references: [id])
  item            InventoryItem            @relation(fields: [itemId], references: [id])
  organization    Organization             @relation("OrgInventoryTransactions", fields: [organizationId], references: [id], onDelete: Cascade)
  performedBy     User                     @relation("PerformedTransactions", fields: [performedById], references: [id])
  toLocation      InventoryLocation?       @relation("TransactionToLocation", fields: [toLocationId], references: [id])

  @@index([organizationId])
  @@index([itemId])
  @@index([fromLocationId])
  @@index([toLocationId])
  @@index([transactionType])
  @@index([performedAt])
  @@map("inventory_transactions")
}

model DashboardAlert {
  id             String        @id @default(cuid())
  organizationId String
  alertType      AlertType
  severity       AlertSeverity
  title          String
  message        String
  entityType     String?
  entityId       String?
  isRead         Boolean       @default(false)
  isDismissed    Boolean       @default(false)
  expiresAt      DateTime?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  organization   Organization  @relation("OrgDashboardAlerts", fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([alertType])
  @@index([severity])
  @@index([isRead])
  @@index([createdAt])
  @@map("dashboard_alerts")
}

model PriceItem {
  id             String        @id @default(cuid())
  organizationId String
  name           String
  description    String?
  type           PriceItemType @default(SERVICE)
  price          Decimal       @db.Decimal(12, 2)
  unit           String?
  taxRate        Decimal       @default(21.0) @db.Decimal(5, 2)
  isActive       Boolean       @default(true)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  
  // ═══════════════════════════════════════════════════════════════════════════════
  // MULTI-TRADE PRICING FIELDS (Phase 1.3)
  // Specialty for trade filtering, pricing model for calculation method
  // ═══════════════════════════════════════════════════════════════════════════════
  specialty      String?                   // PLOMERO, ELECTRICISTA, GASISTA, etc.
  pricingModel   PricingModel?             // FIXED, HOURLY, PER_UNIT, PER_M2, PER_DAY, QUOTE
  
  organization   Organization  @relation("OrgPriceItems", fields: [organizationId], references: [id], onDelete: Cascade)
  jobLineItems   JobLineItem[] @relation("PriceItemLineItems")

  @@index([organizationId])
  @@index([type])
  @@index([isActive])
  @@index([specialty])
  @@map("price_items")
}

// ═══════════════════════════════════════════════════════════════════════════════
// PHASE 1.4: JOB LINE ITEMS
// Detailed pricing breakdown for each job - supports quotes, technician additions,
// and final invoicing. Maintains audit trail of who added/modified each line item.
// ═══════════════════════════════════════════════════════════════════════════════

model JobLineItem {
  id              String          @id @default(cuid())
  jobId           String          @map("job_id")
  priceItemId     String?         @map("price_item_id")  // Optional link to PriceItem for catalog items
  
  // Item Details
  description     String
  quantity        Decimal         @db.Decimal(10, 3)
  unit            String          @default("unidad")     // hora, m², punto, unidad, etc.
  unitPrice       Decimal         @db.Decimal(12, 2)
  total           Decimal         @db.Decimal(12, 2)     // quantity * unitPrice (denormalized for performance)
  
  // Tax Handling
  taxRate         Decimal         @default(21.0) @db.Decimal(5, 2)  // IVA rate
  taxAmount       Decimal?        @db.Decimal(12, 2)     // Calculated tax amount
  
  // Audit Trail
  source          LineItemSource  @default(QUOTE)
  notes           String?                                 // Internal notes (e.g., "Client requested upgrade")
  createdById     String          @map("created_by_id")
  createdAt       DateTime        @default(now())        @map("created_at")
  updatedAt       DateTime        @updatedAt             @map("updated_at")
  
  // Relations
  job             Job             @relation("JobLineItems", fields: [jobId], references: [id], onDelete: Cascade)
  priceItem       PriceItem?      @relation("PriceItemLineItems", fields: [priceItemId], references: [id])
  createdBy       User            @relation("LineItemCreator", fields: [createdById], references: [id])
  
  @@index([jobId])
  @@index([priceItemId])
  @@index([createdById])
  @@index([source])
  @@map("job_line_items")
}

// ═══════════════════════════════════════════════════════════════════════════════
// PHASE 1.5: ORGANIZATION PRICING SETTINGS
// Owner-configurable pricing controls: technician limits, approval workflows,
// deposit requirements, invoice generation modes. "Provide options, let owners customize."
// ═══════════════════════════════════════════════════════════════════════════════

model OrganizationPricingSettings {
  id                        String   @id @default(cuid())
  organizationId            String   @unique @map("organization_id")
  
  // ═══════════════════════════════════════════════════════════════════════════════
  // TECHNICIAN ADJUSTMENT CONTROLS
  // ═══════════════════════════════════════════════════════════════════════════════
  
  // Can technicians modify pricing during jobs?
  techCanModifyPricing      Boolean  @default(true) @map("tech_can_modify_pricing")
  
  // Limits on technician adjustments (null = unlimited)
  techMaxAdjustmentPercent  Decimal? @db.Decimal(5, 2) @map("tech_max_adjustment_percent")   // e.g., 20.00 = max 20% increase
  techMaxAdjustmentAmount   Decimal? @db.Decimal(12, 2) @map("tech_max_adjustment_amount")  // e.g., 50000 = max $50,000 ARS
  
  // Approval required for adjustments over limit?
  requireApprovalOverLimit  Boolean  @default(true) @map("require_approval_over_limit")
  
  // ═══════════════════════════════════════════════════════════════════════════════
  // INVOICE GENERATION CONTROLS
  // ═══════════════════════════════════════════════════════════════════════════════
  
  // When to generate invoice?
  invoiceGeneration         InvoiceGenerationMode @default(MANUAL) @map("invoice_generation")
  
  // Auto-lock pricing when invoice generated? (AFIP compliance - recommended true)
  autoLockOnInvoice         Boolean  @default(true) @map("auto_lock_on_invoice")
  
  // ═══════════════════════════════════════════════════════════════════════════════
  // DEPOSIT (SEÑA) SETTINGS
  // ═══════════════════════════════════════════════════════════════════════════════
  
  // Enable deposit tracking?
  enableDeposits            Boolean  @default(true) @map("enable_deposits")
  
  // Default deposit percentage (null = no default suggestion)
  defaultDepositPercent     Decimal? @db.Decimal(5, 2) @map("default_deposit_percent")      // e.g., 50.00 = 50%
  
  // Require deposit before job start?
  requireDepositToStart     Boolean  @default(false) @map("require_deposit_to_start")
  
  // ═══════════════════════════════════════════════════════════════════════════════
  // PRICE BOOK SETTINGS
  // ═══════════════════════════════════════════════════════════════════════════════
  
  // Use price book for suggestions?
  usePriceBook              Boolean  @default(true) @map("use_price_book")
  
  // Price book is mandatory? (can't enter custom prices)
  priceBookMandatory        Boolean  @default(false) @map("price_book_mandatory")
  
  createdAt                 DateTime @default(now()) @map("created_at")
  updatedAt                 DateTime @updatedAt @map("updated_at")
  
  // Relations
  organization              Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  @@map("organization_pricing_settings")
}

model WhatsAppBusinessAccount {
  id                    String                  @id @default(cuid())
  organizationId        String                  @unique
  phoneNumberId         String?
  businessAccountId     String?
  accessToken           String?
  accessTokenExpiresAt  DateTime?
  webhookVerifyToken    String                  @default(cuid())
  webhookSecret         String?
  status                WaAccountStatus         @default(PENDING)
  verifiedAt            DateTime?
  displayPhoneNumber    String?
  businessName          String?
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt
  bspProvider           WhatsAppBSPProviderType @default(META_DIRECT)
  bspAccountId          String?
  bspPhoneNumberSid     String?
  provisioningStatus    ProvisioningStatus      @default(NOT_STARTED)
  provisionedAt         DateTime?
  verificationCode      String?
  verificationExpiresAt DateTime?
  monthlyMessageCount   Int                     @default(0)
  lastBillingReset      DateTime                @default(now())
  organization          Organization            @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([bspProvider])
  @@index([provisioningStatus])
  @@map("whatsapp_business_accounts")
}

model WaConversation {
  id                   String               @id @default(cuid())
  organizationId       String
  customerPhone        String
  customerName         String?
  customerId           String?
  status               WaConversationStatus @default(OPEN)
  isUnread             Boolean              @default(true)
  unreadCount          Int                  @default(0)
  lastMessageAt        DateTime             @default(now())
  lastMessagePreview   String?
  lastMessageDirection String?
  lastMessageStatus    String?
  windowExpiresAt      DateTime?
  canSendFreeform      Boolean              @default(false)
  assignedToId         String?
  activeJobId          String?
  isActive             Boolean              @default(true)
  
  // ═══════════════════════════════════════════════════════════════════════════════
  // PHASE 5: SESSION LANGUAGE
  // Detected customer language for the conversation session
  // ═══════════════════════════════════════════════════════════════════════════════
  sessionLanguage       String?              @map("session_language")
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt
  assignedTo           User?                @relation("WaConversationAssignee", fields: [assignedToId], references: [id])
  customer             Customer?            @relation(fields: [customerId], references: [id])
  organization         Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  messages             WaMessage[]

  @@unique([organizationId, customerPhone])
  @@index([organizationId, status])
  @@index([organizationId, isUnread])
  @@index([organizationId, lastMessageAt])
  @@index([customerId])
  @@map("wa_conversations")
}

model WaMessage {
  id                    String         @id @default(cuid())
  organizationId        String
  conversationId        String
  customerId            String?
  waMessageId           String?        @unique
  direction             String
  type                  String
  from                  String
  to                    String
  content               String
  mediaId               String?
  mediaUrl              String?
  mediaMimeType         String?
  mediaFilename         String?
  templateName          String?
  templateParams        Json?
  metadata              Json?
  status                String         @default("pending")
  statusUpdatedAt       DateTime?
  errorCode             String?
  errorMessage          String?
  sentById              String?
  replyToId             String?
  createdAt             DateTime       @default(now())
  aiActionMetadata      Json?
  aiActionTaken         String?
  aiConfidence          Int?
  isProactiveSuggestion Boolean        @default(false)
  senderType            String?
  
  // ═══════════════════════════════════════════════════════════════════════════════
  // PHASE 5.1: AI FEEDBACK TRACKING
  // Collect user feedback on AI actions for training data
  // ═══════════════════════════════════════════════════════════════════════════════
  aiFeedback            String?              @map("ai_feedback")           // "positive" | "negative" | null
  aiFeedbackAt          DateTime?            @map("ai_feedback_at")
  aiFeedbackUserId      String?              @map("ai_feedback_user_id")
  
  // ═══════════════════════════════════════════════════════════════════════════════
  // PHASE 5.2: TRANSLATION TRACKING
  // Store original and translated content for multi-language support
  // ═══════════════════════════════════════════════════════════════════════════════
  detectedLanguage      String?              @map("detected_language")     // ISO code: "en", "pt", "fr", etc.
  originalContent       String?              @map("original_content")      // Customer's original message
  translatedContent     String?              @map("translated_content")    // Spanish translation
  languageConfirmed     Boolean              @default(false) @map("language_confirmed")
  conversation          WaConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  organization          Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  sentBy                User?          @relation("WaMessageSender", fields: [sentById], references: [id])

  @@index([conversationId, createdAt])
  @@index([organizationId, createdAt])
  @@index([waMessageId])
  @@map("wa_messages")
}

model WaTemplate {
  id              String             @id @default(cuid())
  organizationId  String
  waTemplateId    String?
  name            String
  language        String             @default("es_AR")
  category        WaTemplateCategory @default(UTILITY)
  components      Json
  headerType      String?
  headerContent   String?
  bodyText        String?
  footerText      String?
  buttons         Json?
  status          WaTemplateStatus   @default(PENDING)
  rejectionReason String?
  usageCount      Int                @default(0)
  lastUsedAt      DateTime?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  organization    Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, name, language])
  @@index([organizationId, status])
  @@index([organizationId, category])
  @@map("wa_templates")
}

model WaOutboundQueue {
  id             String        @id @default(cuid())
  organizationId String
  messageId      String?
  to             String
  type           String
  payload        Json
  status         WaQueueStatus @default(PENDING)
  attempts       Int           @default(0)
  maxAttempts    Int           @default(3)
  lastAttemptAt  DateTime?
  nextAttemptAt  DateTime?
  waMessageId    String?
  errorCode      String?
  errorMessage   String?
  priority       Int           @default(0)
  scheduledFor   DateTime?
  createdAt      DateTime      @default(now())
  processedAt    DateTime?
  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId, status])
  @@index([status, nextAttemptAt])
  @@index([scheduledFor])
  @@map("wa_outbound_queue")
}

model WaWebhookLog {
  id             String        @id @default(cuid())
  organizationId String?
  eventType      String
  payload        Json
  signature      String?
  processed      Boolean       @default(false)
  processedAt    DateTime?
  error          String?
  receivedAt     DateTime      @default(now())
  organization   Organization? @relation(fields: [organizationId], references: [id])

  @@index([organizationId, receivedAt])
  @@index([processed])
  @@map("wa_webhook_logs")
}

model AuditLog {
  id             String       @id @default(cuid())
  organizationId String
  userId         String?
  action         String
  entityType     String
  entityId       String?
  metadata       Json?
  ipAddress      String?
  userAgent      String?
  createdAt      DateTime     @default(now())
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([userId])
  @@index([action])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}

model Notification {
  id        String    @id @default(cuid())
  userId    String
  type      String
  title     String
  body      String
  metadata  Json?
  read      Boolean   @default(false)
  readAt    DateTime?
  createdAt DateTime  @default(now())
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([read])
  @@index([createdAt])
  @@map("notifications")
}

model NotificationPreferences {
  id                 String       @id @default(cuid())
  userId             String       @unique
  organizationId     String
  webEnabled         Boolean      @default(true)
  pushEnabled        Boolean      @default(true)
  emailEnabled       Boolean      @default(false)
  whatsappEnabled    Boolean      @default(true)
  smsEnabled         Boolean      @default(false)
  reminderIntervals  Json?
  quietHoursStart    String?      @default("22:00")
  quietHoursEnd      String?      @default("08:00")
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt
  eventPreferences   Json?
  quietHoursEnabled  Boolean      @default(false)
  quietHoursTimezone String?      @default("America/Argentina/Buenos_Aires")
  organization       Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user               User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@map("notification_preferences")
}

model NotificationLogs {
  id             String       @id @default(cuid())
  organizationId String
  userId         String?
  eventType      String
  channel        String
  title          String
  body           String
  data           Json?
  status         String
  errorMessage   String?
  entityType     String?
  entityId       String?
  sentAt         DateTime?
  deliveredAt    DateTime?
  createdAt      DateTime     @default(now())
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("notification_logs")
}

model TrackingLocationHistory {
  id           String          @id @default(cuid())
  sessionId    String
  lat          Decimal         @db.Decimal(10, 8)
  lng          Decimal         @db.Decimal(11, 8)
  speed        Decimal?        @db.Decimal(6, 2)
  heading      Decimal?        @db.Decimal(5, 2)
  accuracy     Decimal?        @db.Decimal(6, 2)
  movementMode String?
  recordedAt   DateTime        @default(now())
  session      TrackingSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([recordedAt])
  @@map("tracking_location_history")
}

model Event {
  id             String       @id @default(cuid())
  organizationId String
  type           String
  source         String
  data           Json?
  severity       String?
  createdAt      DateTime     @default(now())
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([type])
  @@index([severity])
  @@index([createdAt])
  @@map("events")
}

model OnboardingProgress {
  id                  String       @id @default(cuid())
  userId              String       @unique
  organizationId      String
  phoneVerified       Boolean      @default(false)
  phoneVerifiedAt     DateTime?
  termsAccepted       Boolean      @default(false)
  termsAcceptedAt     DateTime?
  profileCompleted    Boolean      @default(false)
  profileCompletedAt  DateTime?
  tutorialCompleted   Boolean      @default(false)
  tutorialCompletedAt DateTime?
  tutorialSkipped     Boolean      @default(false)
  completed           Boolean      @default(false)
  completedAt         DateTime?
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt
  organization        Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user                User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@map("onboarding_progress")
}

model PanicMode {
  id             String       @id @default(cuid())
  organizationId String
  integration    String
  reason         String
  metadata       Json?
  active         Boolean      @default(true)
  triggeredAt    DateTime     @default(now())
  autoResolveAt  DateTime?
  resolvedAt     DateTime?
  createdAt      DateTime     @default(now())
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([integration])
  @@index([active])
  @@map("panic_modes")
}

model FallbackPayment {
  id               String       @id @default(cuid())
  orgId            String
  invoiceId        String
  customerId       String?
  amount           Decimal      @db.Decimal(10, 2)
  currency         String       @default("ARS")
  reason           String
  originalError    String?
  suggestedMethod  String?
  notificationSent Boolean      @default(false)
  resolvedAt       DateTime?
  resolvedBy       String?
  resolvedMethod   String?
  metadata         Json?
  createdAt        DateTime     @default(now())
  invoice          Invoice      @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  organization     Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([invoiceId])
  @@index([resolvedAt])
  @@map("fallback_payments")
}

model EmployeeVerificationToken {
  id             String       @id @default(cuid())
  userId         String
  organizationId String
  code           String
  expiresAt      DateTime
  isUsed         Boolean      @default(false)
  attempts       Int          @default(0)
  cooldownUntil  DateTime?
  createdAt      DateTime     @default(now())
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([organizationId])
  @@index([code])
  @@index([expiresAt])
  @@map("employee_verification_tokens")
}

model Chargeback {
  id                    String       @id @default(cuid())
  orgId                 String
  mpChargebackId        String       @unique
  mpPaymentId           String
  paymentId             String?
  invoiceId             String?
  amount                Decimal      @db.Decimal(10, 2)
  currency              String       @default("ARS")
  reason                String?
  reasonDetail          String?
  status                String
  documentationStatus   String?
  documentationDeadline DateTime?
  covered               Boolean?
  coverageReason        String?
  mpCreatedAt           DateTime?
  mpUpdatedAt           DateTime?
  resolvedAt            DateTime?
  metadata              Json?
  createdAt             DateTime     @default(now())
  updatedAt             DateTime     @updatedAt
  invoice               Invoice?     @relation(fields: [invoiceId], references: [id])
  organization          Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  payment               Payment?     @relation(fields: [paymentId], references: [id])

  @@index([orgId])
  @@index([status])
  @@index([createdAt])
  @@map("chargebacks")
}

model SupportTicket {
  id           String       @id @default(cuid())
  orgId        String
  type         String
  priority     String       @default("normal")
  subject      String
  description  String?
  status       String       @default("open")
  assignedTo   String?
  resolvedAt   DateTime?
  closedAt     DateTime?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([status])
  @@index([priority])
  @@index([createdAt])
  @@map("support_tickets")
}

model SmsOutboundQueue {
  id              String       @id @default(cuid())
  organizationId  String
  customerId      String?
  phone           String
  body            String
  status          String       @default("pending")
  source          String?
  sourceMessageId String?
  sentAt          DateTime?
  errorMessage    String?
  createdAt       DateTime     @default(now())
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([status])
  @@index([createdAt])
  @@map("sms_outbound_queue")
}

model EmployeeSchedule {
  id             String       @id @default(cuid())
  userId         String
  organizationId String
  dayOfWeek      Int
  startTime      String
  endTime        String
  isAvailable    Boolean      @default(true)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, dayOfWeek])
  @@index([organizationId])
  @@index([userId])
  @@index([organizationId, dayOfWeek])
  @@map("employee_schedules")
}

model ScheduleException {
  id             String       @id @default(cuid())
  userId         String
  organizationId String
  date           DateTime     @db.Date
  isAvailable    Boolean      @default(false)
  reason         String?
  startTime      String?      // Required for partial absences (e.g., "10:00")
  endTime        String?      // Required for partial absences (e.g., "14:00")
  createdAt      DateTime     @default(now())
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Note: Removed unique [userId, date] to allow multiple exceptions per day
  // Overlap validation is handled in the API layer
  @@index([organizationId])
  @@index([userId])
  @@index([date])
  @@index([organizationId, date])
  @@index([userId, date])
  @@map("schedule_exceptions")
}

model BusinessPublicProfile {
  id                  String       @id @default(cuid())
  organizationId      String       @unique
  displayName         String
  description         String?
  logo                String?
  coverPhoto          String?
  categories          String[]
  services            Json         @default("[]")
  serviceArea         Json?
  address             String?
  whatsappNumber      String
  phone               String?
  averageRating       Float        @default(0)
  totalReviews        Int          @default(0)
  totalJobs           Int          @default(0)
  responseRate        Float        @default(0)
  responseTime        Int          @default(0)
  cuitVerified        Boolean      @default(false)
  insuranceVerified   Boolean      @default(false)
  isActive            Boolean      @default(true)
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt
  backgroundCheck     Boolean      @default(false) @map("background_check")
  professionalLicense Boolean      @default(false) @map("professional_license")
  optionalBadges      Json         @default("[]") @map("optional_badges")
  slug                String       @unique
  organization        Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([averageRating])
  @@index([isActive])
  @@index([isActive, averageRating(sort: Desc)])
  @@map("business_public_profiles")
}

model AIConfiguration {
  id                       String       @id @default(cuid())
  organizationId           String       @unique
  isEnabled                Boolean      @default(false)
  autoResponseEnabled      Boolean      @default(true)
  minConfidenceToRespond   Int          @default(70)
  minConfidenceToCreateJob Int          @default(85)
  dataAccessPermissions    Json         @default("{\"faq\": true, \"pricing\": true, \"policies\": true, \"services\": true, \"companyInfo\": true, \"serviceAreas\": true, \"businessHours\": true, \"scheduleSlots\": true, \"technicianNames\": false, \"technicianAvailability\": true}")
  companyName              String?
  companyDescription       String?
  servicesOffered          Json         @default("[]")
  businessHours            Json         @default("{}")
  serviceAreas             String?
  pricingInfo              String?
  cancellationPolicy       String?
  paymentMethods           String?
  warrantyInfo             String?
  faqItems                 Json         @default("[]")
  customInstructions       String?
  aiTone                   String       @default("friendly_professional")
  greetingMessage          String?
  awayMessage              String?
  transferKeywords         Json         @default("[]")
  escalationUserId         String?
  
  // ═══════════════════════════════════════════════════════════════════════════════
  // PHASE 5.5: WORKFLOW PERMISSIONS
  // Owner-configurable AI action permissions and auto-approval settings
  // ═══════════════════════════════════════════════════════════════════════════════
  workflowPermissions      Json         @default("{\"suggestResponses\": true, \"translateMessages\": true, \"suggestActions\": true, \"accessDatabase\": true, \"accessSchedule\": true, \"autoApproveSmallPriceAdjustments\": false, \"autoApproveThresholdPercent\": 5, \"autoAssignTechnicians\": false}")
  
  createdAt                DateTime     @default(now())
  updatedAt                DateTime     @updatedAt
  escalationUser           User?        @relation("AIEscalationUser", fields: [escalationUserId], references: [id])
  organization             Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("ai_configurations")
}

model AIConversationLog {
  id                  String       @id @default(cuid())
  organizationId      String
  conversationId      String
  messageId           String?
  customerMessage     String
  messageType         String
  transcription       String?
  detectedIntent      String?
  extractedEntities   Json?
  confidenceScore     Int
  aiResponse          String?
  responseStatus      String
  jobCreated          Boolean      @default(false)
  jobId               String?
  transferredToUserId String?
  transferReason      String?
  wasHelpful          Boolean?
  correctedResponse   String?
  feedbackNotes       String?
  reviewedAt          DateTime?
  reviewedById        String?
  
  // ═══════════════════════════════════════════════════════════════════════════════
  // PHASE 5.1: GRANULAR FEEDBACK FIELDS
  // More detailed feedback tracking for AI training
  // ═══════════════════════════════════════════════════════════════════════════════
  feedbackType          String?              @map("feedback_type")         // "response" | "action" | "translation"
  userModified          Boolean              @default(false) @map("user_modified")
  modifiedContent       String?              @map("modified_content")
  createdAt           DateTime     @default(now())
  organization        Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([conversationId])
  @@index([createdAt])
  @@index([responseStatus])
  @@index([confidenceScore])
  @@map("ai_conversation_logs")
}

model OrganizationSubscription {
  id                 String                @id @default(cuid())
  organizationId     String                @unique @map("organization_id")
  tier               SubscriptionTier      @default(FREE)
  billingCycle       BillingCycle          @default(MONTHLY) @map("billing_cycle")
  status             SubscriptionStatus    @default(trialing)
  trialEndsAt        DateTime?             @map("trial_ends_at")
  currentPeriodStart DateTime              @map("current_period_start")
  currentPeriodEnd   DateTime              @map("current_period_end")
  mpSubscriptionId   String?               @map("mp_subscription_id")
  mpPayerId          String?               @map("mp_payer_id")
  mpPlanId           String?               @map("mp_plan_id")
  cancelledAt        DateTime?             @map("cancelled_at")
  cancelReason       String?               @map("cancel_reason")
  cancelAtPeriodEnd  Boolean               @default(false) @map("cancel_at_period_end")
  gracePeriodEndsAt  DateTime?             @map("grace_period_ends_at")
  priceUsd           Decimal?              @map("price_usd") @db.Decimal(10, 2)
  createdAt          DateTime              @default(now()) @map("created_at")
  updatedAt          DateTime              @updatedAt @map("updated_at")
  couponUsages       CouponUsage[]
  organization       Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  events             SubscriptionEvent[]
  payments           SubscriptionPayment[]

  @@index([mpSubscriptionId])
  @@index([status])
  @@index([currentPeriodEnd])
  @@index([trialEndsAt])
  @@index([gracePeriodEndsAt])
  @@map("organization_subscriptions")
}

model SubscriptionPayment {
  id                  String                    @id @default(cuid())
  subscriptionId      String                    @map("subscription_id")
  organizationId      String                    @map("organization_id")
  amount              Decimal                   @db.Decimal(12, 2)
  currency            String                    @default("USD") @db.VarChar(3)
  status              SubscriptionPaymentStatus @default(pending)
  paymentType         SubscriptionPaymentType   @default(recurring) @map("payment_type")
  paymentMethod       String?                   @map("payment_method") @db.VarChar(50)
  billingCycle        BillingCycle              @map("billing_cycle")
  periodStart         DateTime                  @map("period_start")
  periodEnd           DateTime                  @map("period_end")
  mpPaymentId         String?                   @map("mp_payment_id")
  mpPreferenceId      String?                   @map("mp_preference_id")
  mpExternalReference String?                   @map("mp_external_reference")
  failureReason       String?                   @map("failure_reason")
  failureCode         String?                   @map("failure_code")
  retryCount          Int                       @default(0) @map("retry_count")
  nextRetryAt         DateTime?                 @map("next_retry_at")
  paidAt              DateTime?                 @map("paid_at")
  receiptUrl          String?                   @map("receipt_url")
  createdAt           DateTime                  @default(now()) @map("created_at")
  updatedAt           DateTime                  @updatedAt @map("updated_at")
  organization        Organization              @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  subscription        OrganizationSubscription  @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([subscriptionId])
  @@index([organizationId])
  @@index([mpPaymentId])
  @@index([status])
  @@index([nextRetryAt])
  @@index([paidAt])
  @@index([createdAt])
  @@map("subscription_payments")
}

model SubscriptionEvent {
  id             String                    @id @default(cuid())
  subscriptionId String?                   @map("subscription_id")
  organizationId String                    @map("organization_id")
  eventType      String                    @map("event_type") @db.VarChar(50)
  eventData      Json                      @default("{}") @map("event_data")
  actorType      String?                   @map("actor_type") @db.VarChar(20)
  actorId        String?                   @map("actor_id")
  ipAddress      String?                   @map("ip_address") @db.VarChar(45)
  userAgent      String?                   @map("user_agent")
  createdAt      DateTime                  @default(now()) @map("created_at")
  organization   Organization              @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  subscription   OrganizationSubscription? @relation(fields: [subscriptionId], references: [id])

  @@index([subscriptionId])
  @@index([organizationId])
  @@index([eventType])
  @@index([createdAt])
  @@index([organizationId, createdAt(sort: Desc)])
  @@map("subscription_events")
}

model GlobalDiscount {
  id                       String             @id @default(cuid())
  name                     String
  description              String?
  discountType             DiscountType       @map("discount_type")
  percentageOff            Decimal?           @map("percentage_off") @db.Decimal(5, 2)
  freeMonths               Int?               @map("free_months")
  fixedAmountOff           Decimal?           @map("fixed_amount_off") @db.Decimal(10, 2)
  combinedFreeMonths       Int?               @map("combined_free_months")
  combinedPercentageOff    Decimal?           @map("combined_percentage_off") @db.Decimal(5, 2)
  combinedPercentageMonths Int?               @map("combined_percentage_months")
  applicableTiers          SubscriptionTier[] @map("applicable_tiers")
  applicableCycles         BillingCycle[]     @map("applicable_cycles")
  isActive                 Boolean            @default(false) @map("is_active")
  validFrom                DateTime           @map("valid_from")
  validUntil               DateTime           @map("valid_until")
  bannerText               String?            @map("banner_text")
  badgeText                String?            @map("badge_text")
  createdBy                String?            @map("created_by")
  createdAt                DateTime           @default(now()) @map("created_at")
  updatedAt                DateTime           @updatedAt @map("updated_at")

  @@index([isActive])
  @@index([validFrom, validUntil])
  @@map("global_discounts")
}

model CouponCode {
  id                       String             @id @default(cuid())
  code                     String             @unique @db.VarChar(50)
  name                     String
  description              String?
  discountType             DiscountType       @map("discount_type")
  percentageOff            Decimal?           @map("percentage_off") @db.Decimal(5, 2)
  freeMonths               Int?               @map("free_months")
  fixedAmountOff           Decimal?           @map("fixed_amount_off") @db.Decimal(10, 2)
  combinedFreeMonths       Int?               @map("combined_free_months")
  combinedPercentageOff    Decimal?           @map("combined_percentage_off") @db.Decimal(5, 2)
  combinedPercentageMonths Int?               @map("combined_percentage_months")
  applicableTiers          SubscriptionTier[] @map("applicable_tiers")
  applicableCycles         BillingCycle[]     @map("applicable_cycles")
  maxTotalUses             Int?               @map("max_total_uses")
  maxUsesPerOrg            Int                @default(1) @map("max_uses_per_org")
  currentUses              Int                @default(0) @map("current_uses")
  validFrom                DateTime           @map("valid_from")
  validUntil               DateTime           @map("valid_until")
  isActive                 Boolean            @default(true) @map("is_active")
  createdBy                String?            @map("created_by")
  createdAt                DateTime           @default(now()) @map("created_at")
  updatedAt                DateTime           @updatedAt @map("updated_at")
  usages                   CouponUsage[]

  @@index([code])
  @@index([isActive])
  @@index([validFrom, validUntil])
  @@map("coupon_codes")
}

model CouponUsage {
  id                      String                    @id @default(cuid())
  couponId                String                    @map("coupon_id")
  organizationId          String                    @map("organization_id")
  subscriptionId          String?                   @map("subscription_id")
  discountApplied         Json                      @map("discount_applied")
  originalPrice           Decimal                   @map("original_price") @db.Decimal(10, 2)
  discountedPrice         Decimal                   @map("discounted_price") @db.Decimal(10, 2)
  amountSaved             Decimal                   @map("amount_saved") @db.Decimal(10, 2)
  freeMonthsApplied       Int?                      @map("free_months_applied")
  freeMonthsRemaining     Int?                      @map("free_months_remaining")
  discountMonthsApplied   Int?                      @map("discount_months_applied")
  discountMonthsRemaining Int?                      @map("discount_months_remaining")
  appliedAt               DateTime                  @default(now()) @map("applied_at")
  coupon                  CouponCode                @relation(fields: [couponId], references: [id], onDelete: Cascade)
  organization            Organization              @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  subscription            OrganizationSubscription? @relation(fields: [subscriptionId], references: [id])

  @@index([couponId])
  @@index([organizationId])
  @@index([subscriptionId])
  @@map("coupon_usages")
}

model PricingSettings {
  id                    String   @id @default(cuid())
  defaultAnnualDiscount Decimal  @default(17) @map("default_annual_discount") @db.Decimal(5, 2)
  showDiscountsPublicly Boolean  @default(true) @map("show_discounts_publicly")
  updatedBy             String?  @map("updated_by")
  updatedAt             DateTime @updatedAt @map("updated_at")

  @@map("pricing_settings")
}

model VerificationRequirement {
  id                 String                   @id @default(cuid())
  code               String                   @unique
  name               String
  description        String?
  category           VerificationCategory
  appliesTo          VerificationAppliesTo    @map("applies_to")
  tier               Int                      @default(2)
  isRequired         Boolean                  @default(true) @map("is_required")
  requiresDocument   Boolean                  @default(false) @map("requires_document")
  requiresExpiration Boolean                  @default(false) @map("requires_expiration")
  autoVerifySource   String?                  @map("auto_verify_source")
  renewalPeriodDays  Int?                     @map("renewal_period_days")
  reminderDaysBefore Int[]                    @default([30, 14, 7, 1]) @map("reminder_days_before")
  gracePeriodDays    Int                      @default(7) @map("grace_period_days")
  badgeIcon          String?                  @map("badge_icon")
  badgeLabel         String?                  @map("badge_label")
  isActive           Boolean                  @default(true) @map("is_active")
  displayOrder       Int                      @default(0) @map("display_order")
  createdAt          DateTime                 @default(now()) @map("created_at")
  submissions        VerificationSubmission[]

  @@index([tier])
  @@index([appliesTo])
  @@index([isActive])
  @@index([displayOrder])
  @@map("verification_requirements")
}

model VerificationSubmission {
  id                  String                       @id @default(cuid())
  organizationId      String                       @map("organization_id")
  userId              String?                      @map("user_id")
  requirementId       String                       @map("requirement_id")
  status              VerificationSubmissionStatus @default(pending)
  submittedValue      String?                      @map("submitted_value")
  documentUrl         String?                      @map("document_url")
  documentType        String?                      @map("document_type")
  documentFilename    String?                      @map("document_filename")
  verifiedAt          DateTime?                    @map("verified_at")
  verifiedBy          VerifiedByType?              @map("verified_by")
  verifiedByUserId    String?                      @map("verified_by_user_id")
  rejectionReason     String?                      @map("rejection_reason")
  rejectionCode       String?                      @map("rejection_code")
  expiresAt           DateTime?                    @map("expires_at") @db.Date
  expiryNotifiedAt    DateTime?                    @map("expiry_notified_at")
  autoVerifyResponse  Json?                        @map("auto_verify_response")
  autoVerifyCheckedAt DateTime?                    @map("auto_verify_checked_at")
  notes               String?
  adminNotes          String?                      @map("admin_notes")
  submittedAt         DateTime                     @default(now()) @map("submitted_at")
  updatedAt           DateTime                     @updatedAt @map("updated_at")
  complianceBlocks    ComplianceBlock[]
  reminders           VerificationReminder[]
  organization        Organization                 @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  requirement         VerificationRequirement      @relation(fields: [requirementId], references: [id])
  user                User?                        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, requirementId, userId])
  @@index([organizationId])
  @@index([userId])
  @@index([requirementId])
  @@index([status])
  @@index([expiresAt])
  @@map("verification_submissions")
}

model VerificationReminder {
  id              String                 @id @default(cuid())
  submissionId    String                 @map("submission_id")
  recipientUserId String                 @map("recipient_user_id")
  reminderType    ReminderType           @map("reminder_type")
  daysUntilExpiry Int?                   @map("days_until_expiry")
  channel         NotificationChannel
  sentAt          DateTime               @default(now()) @map("sent_at")
  readAt          DateTime?              @map("read_at")
  clickedAt       DateTime?              @map("clicked_at")
  messageId       String?                @map("message_id")
  errorMessage    String?                @map("error_message")
  recipientUser   User                   @relation(fields: [recipientUserId], references: [id], onDelete: Cascade)
  submission      VerificationSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  @@index([submissionId])
  @@index([recipientUserId])
  @@index([sentAt])
  @@index([submissionId, reminderType, daysUntilExpiry, channel])
  @@map("verification_reminders")
}

model ComplianceAcknowledgment {
  id                 String             @id @default(cuid())
  userId             String             @map("user_id")
  organizationId     String             @map("organization_id")
  acknowledgmentType AcknowledgmentType @map("acknowledgment_type")
  version            String
  ipAddress          String?            @map("ip_address") @db.VarChar(45)
  userAgent          String?            @map("user_agent")
  deviceInfo         Json?              @map("device_info")
  acknowledgedAt     DateTime           @default(now()) @map("acknowledged_at")
  organization       Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user               User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, acknowledgmentType, version])
  @@index([userId])
  @@index([organizationId])
  @@index([acknowledgmentType])
  @@map("compliance_acknowledgments")
}

model ComplianceBlock {
  id                  String                  @id @default(cuid())
  organizationId      String                  @map("organization_id")
  userId              String?                 @map("user_id")
  blockType           ComplianceBlockType     @map("block_type")
  reason              String
  reasonCode          String?                 @map("reason_code")
  relatedSubmissionId String?                 @map("related_submission_id")
  blockedAt           DateTime                @default(now()) @map("blocked_at")
  unblockedAt         DateTime?               @map("unblocked_at")
  unblockedBy         String?                 @map("unblocked_by")
  unblockReason       String?                 @map("unblock_reason")
  createdBy           String?                 @map("created_by")
  notes               String?
  organization        Organization            @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  relatedSubmission   VerificationSubmission? @relation(fields: [relatedSubmissionId], references: [id])
  user                User?                   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([userId])
  @@index([blockType])
  @@index([organizationId, userId])
  @@map("compliance_blocks")
}

model TechnicianRoute {
  id              String       @id @default(cuid())
  organizationId  String       @map("organization_id")
  technicianId    String       @map("technician_id")
  date            DateTime     @db.Date
  segmentNumber   Int          @map("segment_number")
  jobIds          String[]     @map("job_ids")
  origin          String
  destination     String
  waypoints       String[]
  optimizedOrder  Int[]        @map("optimized_order")
  routeUrl        String       @map("route_url")
  distanceMeters  Int?         @map("distance_meters")
  durationSeconds Int?         @map("duration_seconds")
  isActive        Boolean      @default(true) @map("is_active")
  createdAt       DateTime     @default(now()) @map("created_at")
  updatedAt       DateTime     @updatedAt @map("updated_at")
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  technician      User         @relation(fields: [technicianId], references: [id], onDelete: Cascade)

  @@unique([technicianId, date, segmentNumber])
  @@index([technicianId, date])
  @@index([organizationId])
  @@map("technician_routes")
}

model MarketplaceClick {
  id                  String       @id @default(cuid())
  organizationId      String       @map("organization_id")
  businessSlug        String       @map("business_slug")
  consumerIp          String?      @map("consumer_ip")
  consumerFingerprint String?      @map("consumer_fingerprint")
  consumerUserAgent   String?      @map("consumer_user_agent")
  source              String?
  referrer            String?
  convertedJobId      String?      @unique @map("converted_job_id")
  convertedAt         DateTime?    @map("converted_at")
  clickedAt           DateTime     @default(now()) @map("clicked_at")
  job                 Job?         @relation("JobAttribution", fields: [convertedJobId], references: [id])
  organization        Organization @relation("OrgMarketplaceClicks", fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId, clickedAt(sort: Desc)])
  @@index([businessSlug, clickedAt(sort: Desc)])
  @@index([consumerFingerprint, clickedAt])
  @@index([organizationId, convertedAt])
  @@map("marketplace_clicks")
}

enum UserRole {
  OWNER
  DISPATCHER
  TECHNICIAN
}

enum SubscriptionTier {
  FREE
  INICIAL
  PROFESIONAL
  EMPRESA

  @@map("subscription_tier")
}

enum WhatsAppIntegrationType {
  NONE
  WAME_LINK
  BSP_API
}

/// =============================================================================
/// PHASE 4: PUBLIC SUPPORT QUEUE SYSTEM
/// =============================================================================

/// Status for public support conversations
enum SupportStatus {
  open              // AI handling, not escalated
  pending_response  // Escalated, waiting for admin
  responded         // Admin replied, waiting for visitor
  new_reply         // Visitor replied to admin (needs attention!)
  closed

  @@map("support_status")
}

enum SubscriptionStatus {
  none
  trialing
  active
  past_due
  cancelled
  expired
  paused

  @@map("subscription_status")
}

enum SubscriptionPaymentStatus {
  pending
  processing
  completed
  failed
  refunded

  @@map("subscription_payment_status")
}

enum BillingCycle {
  MONTHLY
  YEARLY

  @@map("billing_cycle")
}

enum SubscriptionPaymentType {
  initial
  recurring
  upgrade
  downgrade
  reactivation

  @@map("subscription_payment_type")
}

enum OrgVerificationStatus {
  pending
  partial
  verified
  suspended

  @@map("org_verification_status")
}

enum UserVerificationStatus {
  pending
  verified
  suspended

  @@map("user_verification_status")
}

enum VerificationCategory {
  identity
  business
  professional
  insurance
  background
  financial

  @@map("verification_category")
}

enum VerificationAppliesTo {
  organization
  owner
  employee

  @@map("verification_applies_to")
}

enum VerificationSubmissionStatus {
  pending
  in_review
  approved
  rejected
  expired

  @@map("verification_submission_status")
}

enum ReminderType {
  expiring_soon
  expired
  action_required
  renewal_due

  @@map("reminder_type")
}

enum NotificationChannel {
  email
  in_app
  sms
  whatsapp

  @@map("notification_channel")
}

enum AcknowledgmentType {
  terms_of_service
  verification_responsibility
  employee_responsibility
  data_accuracy
  update_obligation

  @@map("acknowledgment_type")
}

enum ComplianceBlockType {
  soft_block
  hard_block

  @@map("compliance_block_type")
}

enum VerifiedByType {
  auto
  admin

  @@map("verified_by_type")
}

enum ServiceType {
  INSTALACION_SPLIT
  REPARACION_SPLIT
  MANTENIMIENTO_SPLIT
  INSTALACION_CALEFACTOR
  REPARACION_CALEFACTOR
  MANTENIMIENTO_CALEFACTOR
  OTRO
}

enum JobStatus {
  PENDING
  ASSIGNED
  EN_ROUTE
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum Urgency {
  NORMAL
  URGENTE
}

enum JobDurationType {
  SINGLE_VISIT
  MULTI_DAY
  MULTIPLE_VISITS
  RECURRING
  FLEXIBLE
}

enum RecurrencePattern {
  DAILY
  WEEKLY
  BIWEEKLY
  MONTHLY
  QUARTERLY
  BIANNUAL
  ANNUAL
  CUSTOM
}

enum InvoiceType {
  FACTURA_A
  FACTURA_B
  FACTURA_C
}

enum InvoiceStatus {
  DRAFT
  PENDING
  SENT
  PAID
  OVERDUE
  CANCELLED
}

enum PaymentMethod {
  CASH
  TRANSFER
  CARD
  MERCADOPAGO
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum MessageDirection {
  INBOUND
  OUTBOUND
}

enum MessageType {
  TEXT
  IMAGE
  AUDIO
  DOCUMENT
  TEMPLATE
}

enum MessageDeliveryStatus {
  SENT
  DELIVERED
  READ
  FAILED
}

enum VoiceMessageStatus {
  PENDING
  PROCESSING
  NEEDS_REVIEW
  APPROVED
  REJECTED
}

enum LocationType {
  HEADQUARTERS
  BRANCH
  WAREHOUSE
  SERVICE_POINT
}

enum TransferType {
  JOB_ASSIGNMENT
  TECHNICIAN_LOAN
  CUSTOMER_REFERRAL
  RESOURCE_SHARE
  FINANCIAL
}

enum TransferStatus {
  PENDING
  APPROVED
  IN_PROGRESS
  COMPLETED
  REJECTED
  CANCELLED
}

enum ProductType {
  PART
  CONSUMABLE
  EQUIPMENT
  SERVICE
}

enum WarehouseType {
  MAIN
  SECONDARY
  TRANSIT
  VEHICLE
}

enum MovementType {
  PURCHASE_RECEIPT
  SALE
  ADJUSTMENT_IN
  ADJUSTMENT_OUT
  TRANSFER
  RETURN_IN
  RETURN_OUT
  INITIAL_STOCK
  COUNT_ADJUSTMENT
  SCRAP
  VEHICLE_LOAD
  VEHICLE_RETURN
}

enum MovementDirection {
  IN
  OUT
}

enum ReservationStatus {
  PENDING
  FULFILLED
  CANCELLED
  EXPIRED
}

enum POStatus {
  DRAFT
  PENDING
  APPROVED
  SENT
  PARTIAL
  RECEIVED
  CANCELLED
}

enum CountType {
  FULL
  CYCLE
  SPOT
  ANNUAL
}

enum CountStatus {
  DRAFT
  IN_PROGRESS
  PENDING_REVIEW
  APPROVED
  CANCELLED
}

enum ReplenishmentStatus {
  PENDING
  APPROVED
  IN_TRANSIT
  COMPLETED
  REJECTED
  CANCELLED
}

enum MaterialSource {
  WAREHOUSE
  VEHICLE
  CUSTOMER
  PURCHASE
}

enum PhotoType {
  BEFORE
  DURING
  AFTER
  SIGNATURE
  DOCUMENT
}

enum SyncStatus {
  PENDING
  SYNCING
  SYNCED
  CONFLICT
  FAILED
}

enum DisputeType {
  CHARGEBACK
  FRAUD_CLAIM
  SERVICE_NOT_RECEIVED
  DUPLICATE_CHARGE
  PRODUCT_NOT_AS_DESCRIBED
  CANCELLED_TRANSACTION
  OTHER
}

enum DisputeStatus {
  PENDING_RESPONSE
  EVIDENCE_SUBMITTED
  UNDER_REVIEW
  ESCALATED
  WON
  LOST
  WITHDRAWN
}

enum VoiceTranscriptStatus {
  PENDING
  TRANSCRIBING
  EXTRACTING
  COMPLETED
  NEEDS_REVIEW
  REVIEWED
  FAILED
}

enum TrackingSessionStatus {
  ACTIVE
  ARRIVED
  COMPLETED
  CANCELLED
}

enum VehicleStatus {
  ACTIVE
  MAINTENANCE
  INACTIVE
  RETIRED
}

enum FuelType {
  GASOLINE
  DIESEL
  ELECTRIC
  GNC
  HYBRID
}

enum VehicleDocumentType {
  INSURANCE
  VTV
  REGISTRATION
  TITLE
  GREEN_CARD
  SERVICE_RECORD
  OTHER
}

enum VehicleScheduleType {
  PERMANENT
  DATE_RANGE
  RECURRING
}

enum MaintenanceType {
  OIL_CHANGE
  TIRE_ROTATION
  BRAKE_SERVICE
  INSPECTION
  REPAIR
  SCHEDULED_SERVICE
  OTHER
}

enum InventoryCategory {
  PARTS
  TOOLS
  CONSUMABLES
  EQUIPMENT
  SAFETY
  OTHER
}

enum InventoryLocationType {
  HUB
  VEHICLE
  WAREHOUSE
}

enum InventoryTransactionType {
  PURCHASE
  TRANSFER
  USE
  ADJUSTMENT
  RETURN
  INITIAL_STOCK
  SCRAP
}

enum AlertType {
  VEHICLE_DOCUMENT_EXPIRING
  VEHICLE_DOCUMENT_EXPIRED
  LOW_STOCK
  OUT_OF_STOCK
  VEHICLE_MAINTENANCE_DUE
  JOB_OVERDUE
  TECHNICIAN_OFFLINE
  SYSTEM
}

enum AlertSeverity {
  CRITICAL
  WARNING
  INFO
}

enum PriceItemType {
  SERVICE
  PRODUCT
}

// ═══════════════════════════════════════════════════════════════════════════════
// MULTI-TRADE PRICING MODEL (Phase 1.3)
// All supported pricing calculation methods for service items
// ═══════════════════════════════════════════════════════════════════════════════
enum PricingModel {
  FIXED       // Precio cerrado - one fixed price
  HOURLY      // Por hora
  PER_UNIT    // Por unidad (punto, toma, etc)
  PER_M2      // Por metro cuadrado
  PER_DAY     // Por jornal (day rate)
  QUOTE       // Presupuesto personalizado (custom quote)

  @@map("pricing_model")
}

// ═══════════════════════════════════════════════════════════════════════════════
// PHASE 1.7: LINE ITEM SOURCE (Audit Trail)
// Tracks the origin of each line item for pricing transparency and audit
// ═══════════════════════════════════════════════════════════════════════════════
enum LineItemSource {
  QUOTE           // Created in original quote by dispatcher
  TECH_ADDED      // Added by technician during job
  TECH_ADJUSTED   // Modified by technician (tracks original)
  SYSTEM          // Auto-generated (e.g., mileage charge, minimum service fee)

  @@map("line_item_source")
}

// ═══════════════════════════════════════════════════════════════════════════════
// PHASE 1.5: INVOICE GENERATION MODE
// Controls when invoices are automatically generated based on job lifecycle
// ═══════════════════════════════════════════════════════════════════════════════
enum InvoiceGenerationMode {
  MANUAL              // Dispatcher manually generates invoice
  AUTO_ON_COMPLETION  // Auto-generate when job completed
  AUTO_ON_APPROVAL    // Auto-generate when dispatcher approves technician report

  @@map("invoice_generation_mode")
}

enum WhatsAppBSPProviderType {
  META_DIRECT
  DIALOG_360
  TWILIO
}

enum ProvisioningStatus {
  NOT_STARTED
  NUMBER_SELECTED
  VERIFICATION_PENDING
  VERIFIED
  ACTIVE
  SUSPENDED
  RELEASED
}

enum WaAccountStatus {
  PENDING
  VERIFYING
  ACTIVE
  SUSPENDED
  DISCONNECTED
}

enum WaConversationStatus {
  OPEN
  CLOSED
  ARCHIVED
  SPAM
}

enum WaTemplateCategory {
  UTILITY
  MARKETING
  AUTHENTICATION
}

enum WaTemplateStatus {
  DRAFT
  PENDING
  APPROVED
  REJECTED
  PAUSED
  DISABLED
}

enum WaTemplateHeaderType {
  TEXT
  IMAGE
  VIDEO
  DOCUMENT
  LOCATION
}

enum WaQueueStatus {
  PENDING
  PROCESSING
  SENT
  FAILED
  CANCELLED
}

enum DiscountType {
  PERCENTAGE
  FREE_MONTHS
  FIXED_AMOUNT
  COMBINED

  @@map("discount_type")
}

// ═══════════════════════════════════════════════════════════════════════════════
// PHASE 4.4: GROWTH ENGINE - UNCLAIMED PROFILES
// ═══════════════════════════════════════════════════════════════════════════════
// Pre-populated "ghost" profiles from scraped registry data (ERSEP, CACAAV, etc.)
// Professionals can claim these profiles to instantly activate their business presence.

model UnclaimedProfile {
  id String @id @default(cuid())

  // Source Information
  source    UnclaimedProfileSource
  sourceId  String?                @map("source_id") // ID in source registry
  sourceUrl String?                @map("source_url") // Link to original registry page
  scrapedAt DateTime               @default(now()) @map("scraped_at")

  // Professional Identity
  fullName  String   @map("full_name")
  phone     String? // Primary phone for WhatsApp outreach
  phones    String[] @default([]) // All phone numbers (for multiple)
  email     String? // Email for outreach
  cuit      String? // CUIT if available
  matricula String? // Professional license number

  // Location
  province   String?
  city       String?
  address    String? // Full address (DOMICILIO)
  postalCode String? @map("postal_code") // CP (Código Postal)

  // Professional Details
  profession    String? // GASISTA, ELECTRICISTA, etc.
  specialty     String? // Sub-specialty if available
  category      String? // License category: M1, M2, M3
  categoryDesc  String?   @map("category_desc") // Description: "1ra Categoría - Industrial"
  licenseExpiry DateTime? @map("license_expiry") // VIGENCIA - when license expires

  // Outreach Status
  outreachStatus  OutreachStatus @default(not_contacted) @map("outreach_status")
  lastContactedAt DateTime?      @map("last_contacted_at")
  contactAttempts Int            @default(0) @map("contact_attempts")

  // Email Outreach
  emailSentAt         DateTime? @map("email_sent_at")
  emailDeliveredAt    DateTime? @map("email_delivered_at")
  emailOpenedAt       DateTime? @map("email_opened_at")
  emailClickedAt      DateTime? @map("email_clicked_at")
  emailBouncedAt      DateTime? @map("email_bounced_at")
  emailUnsubscribedAt DateTime? @map("email_unsubscribed_at")

  // WhatsApp Outreach
  whatsappSentAt        DateTime? @map("whatsapp_sent_at")
  whatsappDeliveredAt   DateTime? @map("whatsapp_delivered_at")
  whatsappReadAt        DateTime? @map("whatsapp_read_at")
  whatsappRepliedAt     DateTime? @map("whatsapp_replied_at")
  whatsappFailedAt      DateTime? @map("whatsapp_failed_at")
  whatsappFailureReason String?   @map("whatsapp_failure_reason")

  // WhatsApp Verification (populated after first contact attempt or API check)
  whatsappStatus  WhatsAppStatus @default(unknown) @map("whatsapp_status")
  phoneType       PhoneType?     @map("phone_type") // mobile, landline, unknown
  whatsappId      String?        @map("whatsapp_id") // wa_id returned by WhatsApp API
  phoneVerifiedAt DateTime?      @map("phone_verified_at")

  // Claim Status
  claimToken       String?   @unique @map("claim_token") // Secure token for claim URL
  claimTokenExpiry DateTime? @map("claim_token_expiry")
  claimedAt        DateTime? @map("claimed_at")
  claimedByUserId  String?   @map("claimed_by_user_id")
  claimedOrgId     String?   @map("claimed_org_id")

  // Data Quality
  dataQuality    DataQuality @default(raw) @map("data_quality")
  lastVerifiedAt DateTime?   @map("last_verified_at")
  isActive       Boolean     @default(true) @map("is_active")

  // Campaign Tracking
  campaignId String?           @map("campaign_id")
  campaign   OutreachCampaign? @relation(fields: [campaignId], references: [id])

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([source, matricula])
  @@index([phone])
  @@index([email])
  @@index([outreachStatus])
  @@index([whatsappStatus])
  @@index([source, province])
  @@index([profession])
  @@index([claimToken])
  @@index([campaignId])
  @@index([createdAt(sort: Desc)])
  @@map("unclaimed_profiles")
}

// ═══════════════════════════════════════════════════════════════════════════════
// SCRAPER JOB TRACKING
// ═══════════════════════════════════════════════════════════════════════════════
// Tracks progress of long-running scraper jobs so they can be paused/resumed

model ScraperJob {
  id String @id @default(cuid())

  // Source & Status
  source String // CACAAV, ERSEP, GASNOR, etc.
  status ScraperJobStatus @default(pending)

  // Progress Tracking
  totalProvinces     Int      @default(0) @map("total_provinces")
  completedProvinces String[] @default([]) @map("completed_provinces")
  currentProvince    String?  @map("current_province")
  currentPage        Int      @default(0) @map("current_page")
  totalRecords       Int      @default(0) @map("total_records")

  // Errors
  errors String[] @default([])

  // Timestamps
  startedAt   DateTime  @default(now()) @map("started_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  completedAt DateTime? @map("completed_at")

  @@index([source])
  @@index([status])
  @@index([startedAt(sort: Desc)])
  @@map("scraper_jobs")
}

model OutreachCampaign {
  id             String  @id @default(cuid())
  organizationId String  @map("organization_id") // Which org owns this campaign (CampoTech admin org)
  name           String // "ERSEP Initial Outreach Jan 2026"
  description    String?

  // 🔒 LAUNCH GATE - Campaign status
  status     CampaignStatus @default(draft)
  approvedAt DateTime?      @map("approved_at") // When owner approved
  approvedBy String?        @map("approved_by") // User ID who approved

  // Channel Configuration
  channel OutreachChannel @default(email)

  // Template (for WhatsApp campaigns)
  templateName    String?                @map("template_name") // "profile_claim_product_first"
  templateStatus  TemplateApprovalStatus @default(not_submitted) @map("template_status")
  templateContent String?                @map("template_content") // Template message content

  // Email Configuration
  emailSubject  String? @map("email_subject")
  emailFromName String? @map("email_from_name")
  emailReplyTo  String? @map("email_reply_to")

  // Targeting
  source           UnclaimedProfileSource? // Filter by source
  targetProvince   String?                 @map("target_province") // Optional province filter
  targetProfession String?                 @map("target_profession") // Optional profession filter
  targetCount      Int                     @default(0) @map("target_count") // Profiles matching criteria

  // Progress Metrics
  sentCount         Int @default(0) @map("sent_count")
  deliveredCount    Int @default(0) @map("delivered_count")
  openedCount       Int @default(0) @map("opened_count")
  clickedCount      Int @default(0) @map("clicked_count")
  repliedCount      Int @default(0) @map("replied_count")
  claimedCount      Int @default(0) @map("claimed_count")
  errorCount        Int @default(0) @map("error_count")
  unsubscribedCount Int @default(0) @map("unsubscribed_count")

  // Rate Limiting
  dailyLimit   Int @default(1000) @map("daily_limit")
  batchSize    Int @default(50) @map("batch_size")
  batchDelayMs Int @default(60000) @map("batch_delay_ms")

  // Timestamps
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  launchedAt  DateTime? @map("launched_at")
  completedAt DateTime? @map("completed_at")

  // Relations
  profiles UnclaimedProfile[]

  @@index([organizationId])
  @@index([status])
  @@index([source])
  @@index([channel])
  @@map("outreach_campaigns")
}

// ═══════════════════════════════════════════════════════════════════════════════
// PHASE 4.8: WHATSAPP AI CREDITS SYSTEM
// ═══════════════════════════════════════════════════════════════════════════════
// Credit-based monetization for WhatsApp AI conversations
// ⚠️ ONE-TIME GRACE: When balance hits 0, 50 free credits activate ONCE EVER

model WhatsAppCredits {
  id             String @id @default(cuid())
  organizationId String @unique @map("organization_id")

  // Credit Balance
  balance         Int @default(0) // Current credit balance
  lifetimeCredits Int @default(0) @map("lifetime_credits") // Total credits ever purchased
  lifetimeUsed    Int @default(0) @map("lifetime_used") // Total credits ever used

  // ⚠️ ONE-TIME GRACE PERIOD (Anti-abuse)
  graceCredits       Int       @default(50) @map("grace_credits") // One-time 50 emergency credits
  graceUsed          Int       @default(0) @map("grace_used") // How many grace credits used
  graceActivatedAt   DateTime? @map("grace_activated_at") // When grace was triggered
  graceEverActivated Boolean   @default(false) @map("grace_ever_activated") // TRUE = never again eligible
  graceForfeited     Boolean   @default(false) @map("grace_forfeited") // TRUE = paid without using

  // Service Status
  status          CreditServiceStatus @default(inactive)
  statusChangedAt DateTime?           @map("status_changed_at")

  // Alert Tracking (reset each purchase)
  lowBalanceThreshold Int       @default(50) @map("low_balance_threshold")
  lastLowBalanceAlert DateTime? @map("last_low_balance_alert")
  alert75SentAt       DateTime? @map("alert_75_sent_at")
  alert90SentAt       DateTime? @map("alert_90_sent_at")
  alert100SentAt      DateTime? @map("alert_100_sent_at")

  // BSP Integration
  bspPhoneNumber String?               @map("bsp_phone_number") // Provisioned WhatsApp number
  bspNumberId    String?               @map("bsp_number_id") // Meta's phone number ID
  bspWabaId      String?               @map("bsp_waba_id") // WhatsApp Business Account ID
  bspStatus      BSPProvisioningStatus @default(not_provisioned) @map("bsp_status")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  organization Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  purchases    CreditPurchase[]
  usageLogs    CreditUsageLog[]

  @@index([status])
  @@index([bspStatus])
  @@index([balance])
  @@map("whatsapp_credits")
}

model CreditPurchase {
  id               String          @id @default(cuid())
  creditsAccountId String          @map("credits_account_id")
  creditsAccount   WhatsAppCredits @relation(fields: [creditsAccountId], references: [id], onDelete: Cascade)

  // Purchase Details
  credits        Int // Credits purchased
  amountPaid     Decimal @map("amount_paid") @db.Decimal(10, 2)
  currency       String  @default("USD")
  pricePerCredit Decimal @map("price_per_credit") @db.Decimal(6, 4)

  // Package Info (if purchased as package)
  packageName  String? @map("package_name") // "Starter", "Pro", "Business"
  bonusCredits Int     @default(0) @map("bonus_credits") // Bonus credits from package

  // Payment Status
  status CreditPaymentStatus @default(pending)

  // MercadoPago Integration
  mpPaymentId    String? @map("mp_payment_id")
  mpPreferenceId String? @map("mp_preference_id")

  // Timestamps
  createdAt   DateTime  @default(now()) @map("created_at")
  completedAt DateTime? @map("completed_at")

  @@index([creditsAccountId])
  @@index([status])
  @@index([createdAt])
  @@map("credit_purchases")
}

model CreditUsageLog {
  id               String          @id @default(cuid())
  creditsAccountId String          @map("credits_account_id")
  creditsAccount   WhatsAppCredits @relation(fields: [creditsAccountId], references: [id], onDelete: Cascade)

  // Usage Details
  creditsUsed Int             @map("credits_used")
  usageType   CreditUsageType @map("usage_type")
  description String?

  // Related Entities
  conversationId String? @map("conversation_id")
  messageId      String? @map("message_id")

  // Balance Tracking
  balanceBefore  Int     @map("balance_before")
  balanceAfter   Int     @map("balance_after")
  wasGraceCredit Boolean @default(false) @map("was_grace_credit")

  // Timestamp
  usedAt DateTime @default(now()) @map("used_at")

  @@index([creditsAccountId])
  @@index([usageType])
  @@index([usedAt])
  @@map("credit_usage_logs")
}

// ═══════════════════════════════════════════════════════════════════════════════
// BSP PROVISIONING ENUM (new for Phase 4.8)
// ═══════════════════════════════════════════════════════════════════════════════

enum BSPProvisioningStatus {
  not_provisioned // No number assigned
  pending // Number requested, awaiting Meta approval
  active // Number provisioned and working
  suspended // Number suspended (payment issues)

  @@map("bsp_provisioning_status")
}

// ═══════════════════════════════════════════════════════════════════════════════
// PHASE 6: ADVANCED BSP INFRASTRUCTURE 
// Note: WhatsAppNumberInventory model moved to end of file with comprehensive implementation
// ═══════════════════════════════════════════════════════════════════════════════

// ═══════════════════════════════════════════════════════════════════════════════
// GROWTH ENGINE ENUMS
// ═══════════════════════════════════════════════════════════════════════════════

enum UnclaimedProfileSource {
  ERSEP // Ente Regulador de Servicios Públicos (Córdoba) - Electricistas
  CACAAV // Cámara Argentina de Calefacción, Aire y Refrigeración - HVAC
  GASNOR // Gas del Norte - Gasistas (Salta, Jujuy, Tucumán)
  GASNEA // Gas del NEA - Gasistas (Corrientes, Chaco, Formosa)
  ENARGAS // Ente Nacional Regulador del Gas
  MANUAL // Manually imported

  @@map("unclaimed_profile_source")
}

enum OutreachStatus {
  not_contacted // Fresh profile, never contacted
  verification_sent // OTP/verification sent, awaiting response
  contacted // Message sent
  engaged // Replied or clicked
  claimed // Successfully claimed profile
  unsubscribed // Opted out of communications
  invalid // Invalid contact info

  @@map("outreach_status")
}

enum DataQuality {
  raw // Just scraped, unverified
  cleaned // Data cleaned/normalized
  verified // Contact info verified (email valid, phone reachable)
  enriched // Enriched with additional data

  @@map("data_quality")
}

enum WhatsAppStatus {
  unknown // Not yet checked
  valid // Confirmed has WhatsApp (message delivered or API confirmed)
  invalid // Confirmed NO WhatsApp (API error or delivery failed)
  blocked // User blocked us or reported spam
  opted_out // User requested no WhatsApp contact

  @@map("whatsapp_status")
}

enum PhoneType {
  mobile // Mobile phone (likely has WhatsApp)
  landline // Landline (cannot have WhatsApp)
  unknown // Cannot determine

  @@map("phone_type")
}

enum CampaignStatus {
  draft // Being configured
  ready // All config done, awaiting approval
  approved // 🔒 Owner approved, ready to launch
  launching // Currently sending
  paused // Temporarily stopped
  completed // All messages sent
  cancelled // Cancelled before completion

  @@map("campaign_status")
}

enum ScraperJobStatus {
  pending // Job created, not yet started
  running // Currently scraping
  completed // All done
  paused // Paused, can be resumed
  failed // Failed with error

  @@map("scraper_job_status")
}

enum OutreachChannel {
  email // Email outreach
  whatsapp // WhatsApp template messages
  sms // SMS (fallback)

  @@map("outreach_channel")
}

enum TemplateApprovalStatus {
  not_submitted // Template not yet sent to Meta
  pending // Waiting for Meta review
  approved // Ready to use
  rejected // Need to revise

  @@map("template_approval_status")
}

enum CreditServiceStatus {
  inactive // No credits purchased yet
  active // Credits available, AI enabled
  grace // Out of credits, using ONE-TIME grace credits
  exhausted // Grace used OR forfeited, wa.me fallback active

  @@map("credit_service_status")
}

enum CreditPaymentStatus {
  pending // Awaiting payment
  processing // Payment in progress
  completed // Payment successful, credits added
  failed // Payment failed
  refunded // Credits removed, payment refunded

  @@map("credit_payment_status")
}

enum CreditUsageType {
  ai_conversation // AI handled a conversation (1 credit)
  ai_followup // AI sent follow-up message
  template_message // Outbound template message

  @@map("credit_usage_type")
}

// ═══════════════════════════════════════════════════════════════════════════════
// PHASE 6.1: WHATSAPP NUMBER INVENTORY MANAGEMENT
// Pre-purchased WhatsApp numbers for instant provisioning to clients
// ═══════════════════════════════════════════════════════════════════════════════

model WhatsAppNumberInventory {
  id                   String  @id @default(cuid())
  phoneNumber          String  @unique @map("phone_number")
  phoneNumberFormatted String? @map("phone_number_formatted") // Display format: +54 351 555-1234
  countryCode          String  @default("AR") @map("country_code")

  // BSP/Meta identifiers
  bspNumberId String? @map("bsp_number_id") // Meta/BSP ID from provider
  bspProvider String  @default("twilio") @map("bsp_provider") // twilio, dialog360, meta_direct
  wabaId      String? @map("waba_id") // WhatsApp Business Account ID

  // Status and assignment
  status               NumberInventoryStatus @default(available)
  assignedToOrgId      String?               @unique @map("assigned_to_org_id")
  assignedAt           DateTime?             @map("assigned_at")
  reservedAt           DateTime?             @map("reserved_at") // When reservation started
  reservationExpiresAt DateTime?             @map("reservation_expires_at") // Reservation timeout

  // Activity tracking for auto-release
  lastActivityAt    DateTime? @map("last_activity_at")
  messageCountTotal Int       @default(0) @map("message_count_total")
  messageCountMonth Int       @default(0) @map("message_count_month")
  lastMessageAt     DateTime? @map("last_message_at")

  // Cost tracking
  monthlyRentalCostUsd Float     @default(5.0) @map("monthly_rental_cost_usd")
  purchasedAt          DateTime? @map("purchased_at")
  lastBilledAt         DateTime? @map("last_billed_at")
  totalCostUsd         Float     @default(0) @map("total_cost_usd")

  // Release handling
  releasedAt    DateTime? @map("released_at")
  releaseReason String?   @map("release_reason") // inactivity, cancellation, suspension, manual
  previousOrgId String?   @map("previous_org_id") // Last org that used this number
  recycleCount  Int       @default(0) @map("recycle_count") // How many times reassigned
  cooldownUntil DateTime? @map("cooldown_until") // Don't reassign until this date

  // Notes and metadata
  notes    String?
  metadata Json    @default("{}")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  assignedOrg  Organization?       @relation("OrgAssignedNumber", fields: [assignedToOrgId], references: [id])
  activityLogs NumberActivityLog[]

  @@index([status])
  @@index([bspProvider])
  @@index([countryCode])
  @@index([lastActivityAt])
  @@index([status, countryCode])
  @@map("whatsapp_number_inventory")
}

model NumberActivityLog {
  id             String             @id @default(cuid())
  numberId       String             @map("number_id")
  activityType   NumberActivityType @map("activity_type")
  organizationId String?            @map("organization_id")
  details        Json               @default("{}")
  createdAt      DateTime           @default(now()) @map("created_at")

  number WhatsAppNumberInventory @relation(fields: [numberId], references: [id], onDelete: Cascade)

  @@index([numberId])
  @@index([activityType])
  @@index([organizationId])
  @@index([createdAt])
  @@map("number_activity_logs")
}

enum NumberActivityType {
  provisioned // Number added to inventory
  reserved // Reserved for an org (pending assignment)
  assigned // Assigned to an org
  message_sent // Message sent through this number
  message_received // Message received on this number
  suspended // Number suspended
  unsuspended // Number unsuspended
  released // Released from org
  recycled // Reassigned to new org
  billed // Monthly billing event

  @@map("number_activity_type")
}

enum NumberInventoryStatus {
  available // Ready to be assigned
  reserved // Reserved for a specific org (provisioning in progress)
  assigned // Assigned to an org
  suspended // Temporarily suspended
  released // Released from org, being recycled

  @@map("number_inventory_status")
}

// ═══════════════════════════════════════════════════════════════════════════════
// Phase 7.5: Multi-Organization Membership
// ═══════════════════════════════════════════════════════════════════════════════
// Enables users to belong to multiple organizations with different roles.
// Use case: A technician at Company A wants to start their own business.

enum MembershipStatus {
  INVITED // Pending invitation acceptance
  ACTIVE // Active member
  SUSPENDED // Temporarily suspended
  LEFT // User left the org

  @@map("membership_status")
}

model UserOrganization {
  id             String           @id @default(cuid())
  userId         String
  organizationId String
  role           UserRole         @default(TECHNICIAN)
  isDefault      Boolean          @default(false) // Only one per user should be default
  joinedAt       DateTime         @default(now())
  invitedBy      String?
  status         MembershipStatus @default(ACTIVE)
  notes          String? // Why they joined, admin notes

  user         User         @relation("UserMemberships", fields: [userId], references: [id], onDelete: Cascade)
  organization Organization @relation("OrgMemberships", fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId])
  @@index([userId])
  @@index([organizationId])
  @@index([status])
  @@map("user_organizations")
}

// ═══════════════════════════════════════════════════════════════════════════════
// PHASE 7: CUSTOMER SUPPORT INFRASTRUCTURE
// ═══════════════════════════════════════════════════════════════════════════════

/// Support reports from users (bug reports, suggestions, questions)
model SupportReport {
  id          String @id @default(cuid())
  type        String // 'bug', 'suggestion', 'question'
  description String
  status      String @default("new") // 'new', 'in_progress', 'resolved', 'closed'
  priority    String @default("medium") // 'low', 'medium', 'high', 'critical'

  // Optional user context
  userId         String?
  organizationId String?

  // Metadata (auto-collected context, screenshot URL, etc.)
  metadata Json @default("{}")

  // Resolution
  resolution String?
  resolvedAt DateTime?
  resolvedBy String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([type])
  @@index([status])
  @@index([userId])
  @@index([organizationId])
  @@index([createdAt])
  @@map("support_reports")
}

/// Status page incidents
model StatusIncident {
  id       String   @id @default(cuid())
  title    String
  status   String   @default("investigating") // 'investigating', 'identified', 'monitoring', 'resolved'
  severity String   @default("minor") // 'minor', 'major', 'critical'
  services String[] // Array of affected service IDs

  startedAt  DateTime  @default(now())
  resolvedAt DateTime?

  // Updates stored as JSON array
  updates Json @default("[]")

  createdBy String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([startedAt])
  @@map("status_incidents")
}

/// =============================================================================
/// PHASE 4: PUBLIC SUPPORT QUEUE MODELS
/// =============================================================================

/// Support conversation for public visitors (anonymous)
model PublicSupportConversation {
  id             String   @id @default(cuid())
  sessionId      String   @unique @map("session_id")  // Browser session ID
  
  // Contact info (collected before escalation)
  visitorName    String?  @map("visitor_name")
  visitorEmail   String?  @map("visitor_email")
  visitorPhone   String?  @map("visitor_phone")
  
  // Ticket info
  ticketNumber   String   @unique @map("ticket_number")  // #12345
  status         SupportStatus @default(open)
  category       String?  // ventas, soporte, facturacion, etc.
  
  // Control flags
  aiDisabled     Boolean  @default(false) @map("ai_disabled")  // True = human only mode
  escalatedAt    DateTime? @map("escalated_at")  // When AI escalated
  
  // Push notification
  pushSubscription String? @map("push_subscription") @db.Text  // Web push subscription JSON
  
  // Context
  pageUrl        String?  @map("page_url")  // Where the chat was started
  userAgent      String?  @map("user_agent")
  
  // Timestamps
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")
  lastActivityAt DateTime @default(now()) @map("last_activity_at")
  closedAt       DateTime? @map("closed_at")
  
  // Relations
  messages       PublicSupportMessage[]
  
  @@index([sessionId])
  @@index([status])
  @@index([ticketNumber])
  @@index([lastActivityAt])
  @@index([createdAt])
  @@map("public_support_conversations")
}

/// Messages within a public support conversation
model PublicSupportMessage {
  id             String   @id @default(cuid())
  conversationId String   @map("conversation_id")
  
  role           String   // "user" | "assistant" | "admin"
  content        String   @db.Text
  metadata       Json?    // Additional context (AI intents, escalation reason, etc.)
  
  // For admin responses
  respondedBy    String?  @map("responded_by")  // Admin user ID who wrote this
  
  // Notification tracking
  notifiedVia    String[] @map("notified_via")  // ["email", "push", "whatsapp"]
  notifiedAt     DateTime? @map("notified_at")
  
  // Read tracking
  readByAdmin    Boolean  @default(false) @map("read_by_admin")
  readByVisitor  Boolean  @default(false) @map("read_by_visitor")
  
  createdAt      DateTime @default(now()) @map("created_at")
  
  conversation   PublicSupportConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  
  @@index([conversationId])
  @@index([role])
  @@index([createdAt])
  @@index([conversationId, createdAt])
  @@map("public_support_messages")
}

/// =============================================================================
/// PHASE 3.4: ASYNC EXPORT QUEUE
/// =============================================================================

/// Export status enum
enum ExportStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  EXPIRED
}

/// Async export request for large data exports with email delivery
model ExportRequest {
  id             String       @id @default(cuid())
  organizationId String       @map("organization_id")
  
  // What to export
  exportType     String       @map("export_type")  // "customer_folder", "job_report", "whatsapp_history"
  targetId       String       @map("target_id")    // customerId, jobId, etc.
  targetName     String?      @map("target_name")  // Customer name for display
  
  // Options
  options        Json         @default("{}") // { includeJobs, includeInvoices, includePhotos, etc. }
  format         String       @default("pdf") // "pdf", "json", "csv"
  
  // Status
  status         ExportStatus @default(PENDING)
  progress       Int          @default(0)  // 0-100
  errorMessage   String?      @map("error_message")
  
  // Delivery
  deliveryMethod String       @default("download") @map("delivery_method") // "download", "email"
  deliveryEmail  String?      @map("delivery_email")  // Email to send to
  
  // File info (after generation)
  fileUrl        String?      @map("file_url")      // Signed URL for download
  fileSize       Int?         @map("file_size")     // Bytes
  fileName       String?      @map("file_name")
  
  // Security
  downloadToken  String?      @unique @map("download_token")  // Secure token for download link
  downloadCount  Int          @default(0) @map("download_count")
  maxDownloads   Int          @default(5) @map("max_downloads")
  expiresAt      DateTime?    @map("expires_at")
  
  // Tracking
  requestedById  String       @map("requested_by_id")
  startedAt      DateTime?    @map("started_at")
  completedAt    DateTime?    @map("completed_at")
  createdAt      DateTime     @default(now()) @map("created_at")
  
  // Relations
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  requestedBy    User         @relation("ExportRequestedBy", fields: [requestedById], references: [id])
  
  @@index([organizationId])
  @@index([status])
  @@index([downloadToken])
  @@index([expiresAt])
  @@index([createdAt])
  @@map("export_requests")
}

/// =============================================================================
/// PHASE 4: ARCO DATA ACCESS REQUEST (Ley 25.326 Argentina)
/// =============================================================================

/// ARCO request status
enum DataRequestStatus {
  SUBMITTED        // Customer submitted request
  PENDING_VERIFICATION  // Waiting for email/phone verification
  VERIFIED         // Customer verified identity
  IN_PROGRESS      // Data being compiled
  READY            // Data ready for download
  DOWNLOADED       // Customer downloaded data
  EXPIRED          // Link expired
  REJECTED         // Request rejected (invalid identity, etc.)
}

/// ARCO request type
enum DataRequestType {
  ACCESS       // A - Acceso: Get copy of their data
  RECTIFICATION // R - Rectificación: Correct data
  CANCELLATION  // C - Cancelación: Delete data
  OPPOSITION    // O - Oposición: Object to processing
}

/// Customer data access request (ARCO compliance)
model DataAccessRequest {
  id               String            @id @default(cuid())
  organizationId   String            @map("organization_id")
  
  // Request type
  requestType      DataRequestType   @default(ACCESS) @map("request_type")
  
  // Requester identity
  requesterName    String            @map("requester_name")
  requesterEmail   String            @map("requester_email")
  requesterPhone   String?           @map("requester_phone")
  requesterDni     String?           @map("requester_dni")  // Argentine DNI for identity verification
  
  // Linked customer (if found)
  customerId       String?           @map("customer_id")
  
  // Verification
  verificationCode String?           @map("verification_code")  // 6-digit code
  verificationSentAt DateTime?       @map("verification_sent_at")
  verificationAttempts Int           @default(0) @map("verification_attempts")
  verifiedAt       DateTime?         @map("verified_at")
  
  // Request details
  requestReason    String?           @map("request_reason") @db.Text  // Why they need the data
  dataScope        String[]          @map("data_scope")  // ["jobs", "invoices", "whatsapp", "all"]
  
  // Status
  status           DataRequestStatus @default(SUBMITTED)
  statusHistory    Json              @default("[]") @map("status_history")  // Audit trail
  
  // Processing
  assignedToId     String?           @map("assigned_to_id")  // Staff handling the request
  internalNotes    String?           @map("internal_notes") @db.Text
  
  // Delivery (secure download link)
  downloadToken    String?           @unique @map("download_token")
  downloadUrl      String?           @map("download_url")
  expiresAt        DateTime?         @map("expires_at")
  downloadedAt     DateTime?         @map("downloaded_at")
  
  // Legal/Compliance
  legalDeadline    DateTime?         @map("legal_deadline")  // 10 business days per Ley 25.326
  responseDate     DateTime?         @map("response_date")
  rejectionReason  String?           @map("rejection_reason")
  
  // Timestamps
  createdAt        DateTime          @default(now()) @map("created_at")
  updatedAt        DateTime          @updatedAt @map("updated_at")
  
  // Relations
  organization     Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  customer         Customer?         @relation(fields: [customerId], references: [id], onDelete: SetNull)
  assignedTo       User?             @relation("DataRequestAssignee", fields: [assignedToId], references: [id])
  auditLogs        DataRequestAuditLog[]
  
  @@index([organizationId])
  @@index([status])
  @@index([requesterEmail])
  @@index([downloadToken])
  @@index([createdAt])
  @@index([legalDeadline])
  @@map("data_access_requests")
}

/// Audit log for data access requests (compliance requirement)
model DataRequestAuditLog {
  id             String   @id @default(cuid())
  requestId      String   @map("request_id")
  
  action         String   // "created", "verified", "status_changed", "downloaded", "expired"
  previousStatus String?  @map("previous_status")
  newStatus      String?  @map("new_status")
  details        Json     @default("{}")  // Additional context
  
  performedBy    String?  @map("performed_by")  // User ID or "system" or "customer"
  ipAddress      String?  @map("ip_address")
  userAgent      String?  @map("user_agent")
  
  createdAt      DateTime @default(now()) @map("created_at")
  
  request        DataAccessRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)
  
  @@index([requestId])
  @@index([action])
  @@index([createdAt])
  @@map("data_request_audit_logs")
}

