# CampoTech API - OpenAPI 3.1 Specification
# Complete API specification for Field Service Management platform

openapi: 3.1.0

info:
  title: CampoTech API
  description: |
    # CampoTech Field Service Management API
    
    Complete REST API for managing field service operations in Argentina.
    
    ## Features
    - Customer management with CUIT validation
    - Job scheduling and tracking
    - AFIP electronic invoicing (Factura Electrónica)
    - Mercado Pago payment processing
    - WhatsApp communication
    - Voice AI message processing
    
    ## Authentication
    All endpoints require Bearer token authentication except `/auth/*` endpoints.
    
    ## Rate Limits
    - Standard: 100 requests/minute per organization
    - Auth endpoints: 10 requests/minute per IP
    - WhatsApp: 50 messages/minute per organization
    - Voice processing: 20 requests/minute per organization
    
    ## Pagination
    List endpoints support cursor-based pagination with `limit` and `cursor` parameters.
    
    ## Error Handling
    All errors follow RFC 7807 Problem Details format.
    
  version: 1.0.0
  contact:
    name: CampoTech API Support
    email: api@campotech.com
    url: https://docs.campotech.com
  license:
    name: Proprietary
    url: https://campotech.com/terms

servers:
  - url: https://api.campotech.com/v1
    description: Production server
  - url: https://api.staging.campotech.com/v1
    description: Staging server
  - url: http://localhost:3000/v1
    description: Local development

tags:
  - name: Auth
    description: Authentication and session management
  - name: Organization
    description: Organization settings and integrations
  - name: Customers
    description: Customer management
  - name: Jobs
    description: Job scheduling and management
  - name: Invoices
    description: AFIP electronic invoicing
  - name: Payments
    description: Mercado Pago payment processing
  - name: WhatsApp
    description: WhatsApp messaging
  - name: Voice
    description: Voice AI processing
  - name: Admin
    description: Administrative operations

# ============================================================================
# SECURITY SCHEMES
# ============================================================================

security:
  - BearerAuth: []

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        JWT token obtained from `/auth/otp/verify`.
        Token contains: `sub` (user_id), `org_id`, `role`, `exp`.
        Access tokens expire in 15 minutes.
        Use refresh token to obtain new access token.

  # ==========================================================================
  # HEADERS
  # ==========================================================================
  
  headers:
    X-Request-Id:
      description: Unique request identifier for tracing
      schema:
        type: string
        format: uuid
      example: "550e8400-e29b-41d4-a716-446655440000"
    
    X-RateLimit-Limit:
      description: Maximum requests allowed per window
      schema:
        type: integer
      example: 100
    
    X-RateLimit-Remaining:
      description: Remaining requests in current window
      schema:
        type: integer
      example: 95
    
    X-RateLimit-Reset:
      description: Unix timestamp when rate limit resets
      schema:
        type: integer
      example: 1701234567

  # ==========================================================================
  # PARAMETERS
  # ==========================================================================
  
  parameters:
    # Path Parameters
    CustomerId:
      name: customerId
      in: path
      required: true
      description: Customer UUID
      schema:
        type: string
        format: uuid
      example: "550e8400-e29b-41d4-a716-446655440000"
    
    JobId:
      name: jobId
      in: path
      required: true
      description: Job UUID
      schema:
        type: string
        format: uuid
      example: "550e8400-e29b-41d4-a716-446655440000"
    
    InvoiceId:
      name: invoiceId
      in: path
      required: true
      description: Invoice UUID
      schema:
        type: string
        format: uuid
      example: "550e8400-e29b-41d4-a716-446655440000"
    
    PaymentId:
      name: paymentId
      in: path
      required: true
      description: Payment UUID
      schema:
        type: string
        format: uuid
      example: "550e8400-e29b-41d4-a716-446655440000"
    
    MessageId:
      name: messageId
      in: path
      required: true
      description: WhatsApp message UUID
      schema:
        type: string
        format: uuid
      example: "550e8400-e29b-41d4-a716-446655440000"
    
    # Query Parameters - Pagination
    Limit:
      name: limit
      in: query
      description: Maximum number of items to return (1-100)
      schema:
        type: integer
        minimum: 1
        maximum: 100
        default: 20
      example: 20
    
    Cursor:
      name: cursor
      in: query
      description: Pagination cursor from previous response
      schema:
        type: string
      example: "eyJpZCI6IjU1MGU4NDAwLWUyOWItNDFkNC1hNzE2LTQ0NjY1NTQ0MDAwMCJ9"
    
    # Query Parameters - Filtering
    Status:
      name: status
      in: query
      description: Filter by status
      schema:
        type: string
    
    DateFrom:
      name: dateFrom
      in: query
      description: Filter from date (inclusive)
      schema:
        type: string
        format: date
      example: "2025-01-01"
    
    DateTo:
      name: dateTo
      in: query
      description: Filter to date (inclusive)
      schema:
        type: string
        format: date
      example: "2025-12-31"
    
    Search:
      name: search
      in: query
      description: Search query string
      schema:
        type: string
        minLength: 2
        maxLength: 100
      example: "Juan"
    
    # Headers
    IdempotencyKey:
      name: X-Idempotency-Key
      in: header
      description: Unique key to ensure idempotent requests
      schema:
        type: string
        minLength: 16
        maxLength: 64
      example: "req_abc123def456"

  # ==========================================================================
  # SCHEMAS - Common
  # ==========================================================================
  
  schemas:
    # --------------------------------------------------------------------------
    # Common Response Wrappers
    # --------------------------------------------------------------------------
    
    SuccessResponse:
      type: object
      required:
        - success
        - data
      properties:
        success:
          type: boolean
          const: true
        data:
          type: object
        meta:
          $ref: '#/components/schemas/ResponseMeta'
    
    ErrorResponse:
      type: object
      required:
        - success
        - error
      properties:
        success:
          type: boolean
          const: false
        error:
          $ref: '#/components/schemas/Error'
    
    Error:
      type: object
      required:
        - code
        - message
      properties:
        code:
          type: string
          description: Machine-readable error code
          example: "CUSTOMER_001"
        message:
          type: string
          description: Human-readable error message
          example: "Invalid CUIT format"
        details:
          type: object
          description: Additional error details
          additionalProperties: true
        field:
          type: string
          description: Field that caused the error (for validation errors)
          example: "cuit"
    
    ResponseMeta:
      type: object
      properties:
        requestId:
          type: string
          format: uuid
        timestamp:
          type: string
          format: date-time
        duration:
          type: integer
          description: Request duration in milliseconds
    
    PaginationMeta:
      type: object
      required:
        - limit
        - hasMore
      properties:
        limit:
          type: integer
          example: 20
        cursor:
          type: string
          nullable: true
          description: Cursor for next page (null if no more pages)
        hasMore:
          type: boolean
        total:
          type: integer
          description: Total count (only included if countTotal=true)
    
    # --------------------------------------------------------------------------
    # Enums
    # --------------------------------------------------------------------------
    
    IvaCondition:
      type: string
      enum:
        - responsable_inscripto
        - monotributista
        - exento
        - consumidor_final
      description: |
        Argentine IVA tax condition:
        - `responsable_inscripto`: Registered VAT taxpayer
        - `monotributista`: Simplified tax regime
        - `exento`: VAT exempt
        - `consumidor_final`: Final consumer
    
    UserRole:
      type: string
      enum:
        - owner
        - admin
        - dispatcher
        - technician
        - accountant
      description: |
        User role in organization:
        - `owner`: Full access including billing
        - `admin`: Operational access, no billing
        - `dispatcher`: Jobs & customers, no finances
        - `technician`: Own jobs only
        - `accountant`: Invoices & payments only
    
    DocType:
      type: string
      enum:
        - dni
        - cuit
        - cuil
        - pasaporte
      description: Argentine document type
    
    JobStatus:
      type: string
      enum:
        - pending
        - scheduled
        - en_camino
        - working
        - completed
        - cancelled
    
    JobPriority:
      type: string
      enum:
        - low
        - normal
        - high
        - urgent
    
    JobType:
      type: string
      enum:
        - plomeria
        - electricidad
        - aire_acondicionado
        - gas
        - calefaccion
        - general
    
    JobSource:
      type: string
      enum:
        - manual
        - whatsapp
        - voice
        - recurring
    
    InvoiceType:
      type: string
      enum:
        - A
        - B
        - C
      description: |
        AFIP invoice type:
        - `A`: Between registered IVA taxpayers
        - `B`: To final consumers or exempt
        - `C`: From monotributista
    
    InvoiceStatus:
      type: string
      enum:
        - draft
        - pending_cae
        - issued
        - sent
        - paid
        - partial
        - overdue
        - cancelled
        - refunded
    
    PaymentStatus:
      type: string
      enum:
        - pending
        - processing
        - approved
        - rejected
        - cancelled
        - refunded
        - partial_refund
        - in_dispute
        - chargedback
    
    PaymentMethod:
      type: string
      enum:
        - credit_card
        - debit_card
        - account_money
        - cash
        - bank_transfer
        - check
    
    MessageDirection:
      type: string
      enum:
        - inbound
        - outbound
    
    MessageType:
      type: string
      enum:
        - text
        - voice
        - image
        - document
        - template
        - interactive
    
    MessageStatus:
      type: string
      enum:
        - received
        - queued
        - sent
        - delivered
        - read
        - failed
        - fallback_sms
        - undeliverable
    
    VoiceStatus:
      type: string
      enum:
        - pending
        - transcribing
        - extracting
        - completed
        - needs_review
        - reviewed
        - failed
    
    # --------------------------------------------------------------------------
    # Base Entities
    # --------------------------------------------------------------------------
    
    Timestamps:
      type: object
      properties:
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
    
    Address:
      type: object
      properties:
        address:
          type: string
          maxLength: 500
          example: "Av. Corrientes 1234"
        addressExtra:
          type: string
          maxLength: 100
          example: "Piso 5, Depto B"
        neighborhood:
          type: string
          maxLength: 100
          example: "Palermo"
        city:
          type: string
          maxLength: 100
          default: "Buenos Aires"
        province:
          type: string
          maxLength: 100
          default: "CABA"
        postalCode:
          type: string
          maxLength: 10
          example: "C1043"
        lat:
          type: number
          format: double
          minimum: -90
          maximum: 90
          example: -34.603722
        lng:
          type: number
          format: double
          minimum: -180
          maximum: 180
          example: -58.381592

    # --------------------------------------------------------------------------
    # Auth Schemas
    # --------------------------------------------------------------------------
    
    SendOtpRequest:
      type: object
      required:
        - phone
      properties:
        phone:
          type: string
          pattern: '^\+54[0-9]{10,11}$'
          description: Argentine phone number with country code
          example: "+5491112345678"
    
    SendOtpResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            message:
              type: string
              example: "OTP sent successfully"
            expiresIn:
              type: integer
              description: OTP expiration in seconds
              example: 300
            retryAfter:
              type: integer
              description: Seconds before retry allowed
              example: 60
    
    VerifyOtpRequest:
      type: object
      required:
        - phone
        - code
      properties:
        phone:
          type: string
          pattern: '^\+54[0-9]{10,11}$'
          example: "+5491112345678"
        code:
          type: string
          pattern: '^[0-9]{6}$'
          description: 6-digit OTP code
          example: "123456"
    
    VerifyOtpResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          required:
            - accessToken
            - refreshToken
            - user
          properties:
            accessToken:
              type: string
              description: JWT access token (15 min expiry)
            refreshToken:
              type: string
              description: Refresh token (7 day expiry)
            expiresIn:
              type: integer
              description: Access token expiry in seconds
              example: 900
            user:
              $ref: '#/components/schemas/User'
            isNewUser:
              type: boolean
              description: True if this is a new registration
    
    RefreshTokenRequest:
      type: object
      required:
        - refreshToken
      properties:
        refreshToken:
          type: string
    
    RefreshTokenResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            accessToken:
              type: string
            refreshToken:
              type: string
            expiresIn:
              type: integer
    
    # --------------------------------------------------------------------------
    # User Schemas
    # --------------------------------------------------------------------------
    
    User:
      type: object
      required:
        - id
        - orgId
        - role
        - fullName
      properties:
        id:
          type: string
          format: uuid
        orgId:
          type: string
          format: uuid
        role:
          $ref: '#/components/schemas/UserRole'
        fullName:
          type: string
          example: "Juan González"
        phone:
          type: string
          example: "+5491112345678"
        email:
          type: string
          format: email
        avatarUrl:
          type: string
          format: uri
        isActive:
          type: boolean
        lastSeenAt:
          type: string
          format: date-time
        createdAt:
          type: string
          format: date-time
    
    UserMe:
      allOf:
        - $ref: '#/components/schemas/User'
        - type: object
          properties:
            organization:
              $ref: '#/components/schemas/OrganizationSummary'
            permissions:
              type: array
              items:
                type: string
              example: ["jobs.read", "jobs.write", "customers.read"]
    
    # --------------------------------------------------------------------------
    # Organization Schemas
    # --------------------------------------------------------------------------
    
    Organization:
      type: object
      required:
        - id
        - name
        - cuit
        - ivaCondition
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
          example: "Plomería González"
        cuit:
          type: string
          pattern: '^\d{2}-\d{8}-\d$'
          example: "20-12345678-9"
        ivaCondition:
          $ref: '#/components/schemas/IvaCondition'
        email:
          type: string
          format: email
        phone:
          type: string
        address:
          type: string
        city:
          type: string
        province:
          type: string
        afipConfigured:
          type: boolean
          description: Whether AFIP certificate is uploaded
        afipPuntoVenta:
          type: integer
        afipCertExpiry:
          type: string
          format: date
        mpConnected:
          type: boolean
          description: Whether Mercado Pago is connected
        mpConnectedAt:
          type: string
          format: date-time
        whatsappConnected:
          type: boolean
          description: Whether WhatsApp is configured
        whatsappVerified:
          type: boolean
        settings:
          $ref: '#/components/schemas/OrganizationSettings'
        plan:
          type: string
          example: "pro"
        planExpiresAt:
          type: string
          format: date-time
        createdAt:
          type: string
          format: date-time
    
    OrganizationSummary:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        cuit:
          type: string
        afipConfigured:
          type: boolean
        mpConnected:
          type: boolean
        whatsappConnected:
          type: boolean
    
    OrganizationSettings:
      type: object
      properties:
        uiMode:
          type: string
          enum: [simple, advanced]
          default: simple
        autoInvoiceOnComplete:
          type: boolean
          default: true
        autoSendWhatsapp:
          type: boolean
          default: true
        voiceAutoCreateThreshold:
          type: number
          minimum: 0
          maximum: 1
          default: 0.7
        defaultPaymentMethod:
          type: string
          enum: [mercadopago, cash, transfer]
          default: mercadopago
        defaultDueDays:
          type: integer
          minimum: 0
          maximum: 90
          default: 15
        timezone:
          type: string
          default: "America/Argentina/Buenos_Aires"
    
    UpdateOrganizationRequest:
      type: object
      properties:
        name:
          type: string
          minLength: 2
          maxLength: 200
        email:
          type: string
          format: email
        phone:
          type: string
        address:
          type: string
        city:
          type: string
        province:
          type: string
        settings:
          $ref: '#/components/schemas/OrganizationSettings'
    
    UploadAfipCertRequest:
      type: object
      required:
        - certificate
        - privateKey
        - puntoVenta
      properties:
        certificate:
          type: string
          format: byte
          description: Base64 encoded .crt file
        privateKey:
          type: string
          format: byte
          description: Base64 encoded .key file
        passphrase:
          type: string
          description: Private key passphrase (if encrypted)
        puntoVenta:
          type: integer
          minimum: 1
          maximum: 99999
          description: AFIP punto de venta number
    
    AfipStatus:
      type: object
      properties:
        configured:
          type: boolean
        puntoVenta:
          type: integer
        certSubject:
          type: string
        certExpiry:
          type: string
          format: date
        certDaysRemaining:
          type: integer
        homologated:
          type: boolean
        lastInvoiceA:
          type: integer
        lastInvoiceB:
          type: integer
        lastInvoiceC:
          type: integer
        serviceStatus:
          type: string
          enum: [online, degraded, offline]
    
    MpConnectResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            authUrl:
              type: string
              format: uri
              description: URL to redirect user for MP authorization
    
    # --------------------------------------------------------------------------
    # Customer Schemas
    # --------------------------------------------------------------------------
    
    Customer:
      type: object
      required:
        - id
        - orgId
        - name
        - phone
      properties:
        id:
          type: string
          format: uuid
        orgId:
          type: string
          format: uuid
        name:
          type: string
          example: "María López"
        phone:
          type: string
          example: "+5491155555555"
        email:
          type: string
          format: email
        docType:
          $ref: '#/components/schemas/DocType'
        docNumber:
          type: string
          example: "30123456"
        ivaCondition:
          $ref: '#/components/schemas/IvaCondition'
        address:
          type: string
        addressExtra:
          type: string
        neighborhood:
          type: string
        city:
          type: string
        province:
          type: string
        postalCode:
          type: string
        lat:
          type: number
          format: double
        lng:
          type: number
          format: double
        hasWhatsapp:
          type: boolean
        lastMessageAt:
          type: string
          format: date-time
        notes:
          type: string
        tags:
          type: array
          items:
            type: string
        source:
          $ref: '#/components/schemas/JobSource'
        jobCount:
          type: integer
          description: Total jobs for this customer
        totalRevenue:
          type: number
          format: double
          description: Total revenue from this customer
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
    
    CustomerSummary:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        phone:
          type: string
        neighborhood:
          type: string
    
    CreateCustomerRequest:
      type: object
      required:
        - name
        - phone
      properties:
        name:
          type: string
          minLength: 2
          maxLength: 200
        phone:
          type: string
          pattern: '^\+?[0-9]{10,15}$'
        email:
          type: string
          format: email
        docType:
          $ref: '#/components/schemas/DocType'
        docNumber:
          type: string
          maxLength: 20
        ivaCondition:
          $ref: '#/components/schemas/IvaCondition'
        address:
          type: string
          maxLength: 500
        addressExtra:
          type: string
          maxLength: 100
        neighborhood:
          type: string
          maxLength: 100
        city:
          type: string
          maxLength: 100
        province:
          type: string
          maxLength: 100
        postalCode:
          type: string
          maxLength: 10
        lat:
          type: number
          format: double
        lng:
          type: number
          format: double
        notes:
          type: string
          maxLength: 2000
        tags:
          type: array
          items:
            type: string
            maxLength: 50
          maxItems: 20
    
    UpdateCustomerRequest:
      type: object
      properties:
        name:
          type: string
          minLength: 2
          maxLength: 200
        phone:
          type: string
          pattern: '^\+?[0-9]{10,15}$'
        email:
          type: string
          format: email
        docType:
          $ref: '#/components/schemas/DocType'
        docNumber:
          type: string
        ivaCondition:
          $ref: '#/components/schemas/IvaCondition'
        address:
          type: string
        addressExtra:
          type: string
        neighborhood:
          type: string
        city:
          type: string
        province:
          type: string
        postalCode:
          type: string
        lat:
          type: number
          format: double
        lng:
          type: number
          format: double
        notes:
          type: string
        tags:
          type: array
          items:
            type: string
    
    CustomerList:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: array
          items:
            $ref: '#/components/schemas/Customer'
        pagination:
          $ref: '#/components/schemas/PaginationMeta'
    
    ValidateCuitRequest:
      type: object
      required:
        - cuit
      properties:
        cuit:
          type: string
          pattern: '^\d{2}-?\d{8}-?\d$'
          example: "20-12345678-9"
    
    ValidateCuitResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            valid:
              type: boolean
            cuit:
              type: string
              description: Formatted CUIT
            razonSocial:
              type: string
              description: Company name from AFIP
            ivaCondition:
              $ref: '#/components/schemas/IvaCondition'
            domicilioFiscal:
              type: string
            isActive:
              type: boolean
            afipAvailable:
              type: boolean
              description: Whether AFIP padron was reachable

    # --------------------------------------------------------------------------
    # Price Book Schemas
    # --------------------------------------------------------------------------
    
    PriceBookItem:
      type: object
      properties:
        id:
          type: string
          format: uuid
        orgId:
          type: string
          format: uuid
        name:
          type: string
        description:
          type: string
        category:
          type: string
          enum: [mano_de_obra, materiales, consumibles, viatico]
        jobType:
          $ref: '#/components/schemas/JobType'
        basePrice:
          type: number
          format: double
        unit:
          type: string
        taxRate:
          type: number
          format: double
        afipCode:
          type: string
        regionPrices:
          type: object
          additionalProperties:
            type: number
        complexityMultipliers:
          type: object
          properties:
            simple:
              type: number
            standard:
              type: number
            complex:
              type: number
        isActive:
          type: boolean
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
    
    CreatePriceBookItemRequest:
      type: object
      required:
        - name
        - category
        - basePrice
      properties:
        name:
          type: string
          minLength: 2
          maxLength: 200
        description:
          type: string
          maxLength: 1000
        category:
          type: string
          enum: [mano_de_obra, materiales, consumibles, viatico]
        jobType:
          $ref: '#/components/schemas/JobType'
        basePrice:
          type: number
          format: double
          minimum: 0
        unit:
          type: string
          maxLength: 50
          default: "unidad"
        taxRate:
          type: number
          format: double
          minimum: 0
          maximum: 100
          default: 21
        afipCode:
          type: string
          maxLength: 20
        regionPrices:
          type: object
          additionalProperties:
            type: number
        complexityMultipliers:
          type: object
          properties:
            simple:
              type: number
              minimum: 0.1
              maximum: 10
            standard:
              type: number
              minimum: 0.1
              maximum: 10
            complex:
              type: number
              minimum: 0.1
              maximum: 10
    
    UpdatePriceBookItemRequest:
      type: object
      properties:
        name:
          type: string
          minLength: 2
          maxLength: 200
        description:
          type: string
        category:
          type: string
          enum: [mano_de_obra, materiales, consumibles, viatico]
        jobType:
          $ref: '#/components/schemas/JobType'
        basePrice:
          type: number
          format: double
          minimum: 0
        unit:
          type: string
        taxRate:
          type: number
          format: double
        afipCode:
          type: string
        regionPrices:
          type: object
          additionalProperties:
            type: number
        complexityMultipliers:
          type: object
        isActive:
          type: boolean

    # --------------------------------------------------------------------------
    # Job Schemas
    # --------------------------------------------------------------------------
    
    Job:
      type: object
      required:
        - id
        - orgId
        - title
        - status
      properties:
        id:
          type: string
          format: uuid
        orgId:
          type: string
          format: uuid
        customerId:
          type: string
          format: uuid
        customer:
          $ref: '#/components/schemas/CustomerSummary'
        assignedTo:
          type: string
          format: uuid
        assignee:
          $ref: '#/components/schemas/UserSummary'
        invoiceId:
          type: string
          format: uuid
        title:
          type: string
          example: "Pérdida en baño"
        description:
          type: string
        jobType:
          $ref: '#/components/schemas/JobType'
        priority:
          $ref: '#/components/schemas/JobPriority'
        status:
          $ref: '#/components/schemas/JobStatus'
        statusChangedAt:
          type: string
          format: date-time
        scheduledDate:
          type: string
          format: date
        scheduledTimeStart:
          type: string
          format: time
          example: "09:00:00"
        scheduledTimeEnd:
          type: string
          format: time
          example: "11:00:00"
        estimatedDuration:
          type: integer
          description: Estimated duration in minutes
        actualStart:
          type: string
          format: date-time
        actualEnd:
          type: string
          format: date-time
        address:
          type: string
        addressExtra:
          type: string
        neighborhood:
          type: string
        lat:
          type: number
          format: double
        lng:
          type: number
          format: double
        photos:
          type: array
          items:
            $ref: '#/components/schemas/JobPhoto'
        notes:
          type: string
        internalNotes:
          type: string
        signatureUrl:
          type: string
          format: uri
        source:
          $ref: '#/components/schemas/JobSource'
        sourceMessageId:
          type: string
          format: uuid
        syncStatus:
          type: string
          enum: [synced, pending, conflict]
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
    
    JobSummary:
      type: object
      properties:
        id:
          type: string
          format: uuid
        title:
          type: string
        status:
          $ref: '#/components/schemas/JobStatus'
        scheduledDate:
          type: string
          format: date
        customerName:
          type: string
    
    UserSummary:
      type: object
      properties:
        id:
          type: string
          format: uuid
        fullName:
          type: string
        role:
          $ref: '#/components/schemas/UserRole'
    
    JobPhoto:
      type: object
      properties:
        id:
          type: string
          format: uuid
        photoUrl:
          type: string
          format: uri
        thumbnailUrl:
          type: string
          format: uri
        photoType:
          type: string
          enum: [before, during, after, signature, document]
        takenAt:
          type: string
          format: date-time
    
    CreateJobRequest:
      type: object
      required:
        - title
      properties:
        customerId:
          type: string
          format: uuid
        assignedTo:
          type: string
          format: uuid
        title:
          type: string
          minLength: 3
          maxLength: 200
        description:
          type: string
          maxLength: 2000
        jobType:
          $ref: '#/components/schemas/JobType'
        priority:
          $ref: '#/components/schemas/JobPriority'
        scheduledDate:
          type: string
          format: date
        scheduledTimeStart:
          type: string
          format: time
        scheduledTimeEnd:
          type: string
          format: time
        estimatedDuration:
          type: integer
          minimum: 15
          maximum: 1440
        address:
          type: string
          maxLength: 500
        addressExtra:
          type: string
          maxLength: 100
        neighborhood:
          type: string
          maxLength: 100
        lat:
          type: number
          format: double
        lng:
          type: number
          format: double
        notes:
          type: string
          maxLength: 2000
        internalNotes:
          type: string
          maxLength: 2000
    
    UpdateJobRequest:
      type: object
      properties:
        customerId:
          type: string
          format: uuid
        assignedTo:
          type: string
          format: uuid
          nullable: true
        title:
          type: string
          minLength: 3
          maxLength: 200
        description:
          type: string
        jobType:
          $ref: '#/components/schemas/JobType'
        priority:
          $ref: '#/components/schemas/JobPriority'
        scheduledDate:
          type: string
          format: date
        scheduledTimeStart:
          type: string
          format: time
        scheduledTimeEnd:
          type: string
          format: time
        estimatedDuration:
          type: integer
        address:
          type: string
        addressExtra:
          type: string
        neighborhood:
          type: string
        lat:
          type: number
          format: double
        lng:
          type: number
          format: double
        notes:
          type: string
        internalNotes:
          type: string
    
    UpdateJobStatusRequest:
      type: object
      required:
        - status
      properties:
        status:
          $ref: '#/components/schemas/JobStatus'
        notes:
          type: string
          maxLength: 500
        lat:
          type: number
          format: double
          description: Current location latitude
        lng:
          type: number
          format: double
          description: Current location longitude
    
    AssignJobRequest:
      type: object
      required:
        - userId
      properties:
        userId:
          type: string
          format: uuid
          description: User ID to assign (null to unassign)
          nullable: true
    
    CompleteJobRequest:
      type: object
      properties:
        photos:
          type: array
          items:
            type: object
            required:
              - data
              - type
            properties:
              data:
                type: string
                format: byte
                description: Base64 encoded image
              type:
                type: string
                enum: [before, during, after]
              takenAt:
                type: string
                format: date-time
          minItems: 1
          maxItems: 20
        signature:
          type: string
          format: byte
          description: Base64 encoded signature image
        notes:
          type: string
          maxLength: 2000
        createInvoice:
          type: boolean
          default: true
          description: Whether to auto-create invoice
        lineItems:
          type: array
          items:
            $ref: '#/components/schemas/InvoiceLineItemInput'
          description: Line items for invoice (if createInvoice=true)
    
    JobList:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: array
          items:
            $ref: '#/components/schemas/Job'
        pagination:
          $ref: '#/components/schemas/PaginationMeta'
    
    JobCalendarResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: array
          items:
            type: object
            properties:
              date:
                type: string
                format: date
              jobs:
                type: array
                items:
                  $ref: '#/components/schemas/JobSummary'
              totalJobs:
                type: integer
    
    # --------------------------------------------------------------------------
    # Invoice Schemas
    # --------------------------------------------------------------------------
    
    Invoice:
      type: object
      required:
        - id
        - orgId
        - customerId
        - invoiceType
        - puntoVenta
        - status
        - subtotal
        - taxAmount
        - total
      properties:
        id:
          type: string
          format: uuid
        orgId:
          type: string
          format: uuid
        customerId:
          type: string
          format: uuid
        customer:
          $ref: '#/components/schemas/CustomerSummary'
        jobId:
          type: string
          format: uuid
        invoiceNumber:
          type: integer
          description: AFIP invoice number (null for drafts)
        invoiceType:
          $ref: '#/components/schemas/InvoiceType'
        puntoVenta:
          type: integer
        cae:
          type: string
          description: AFIP CAE code
        caeExpiry:
          type: string
          format: date
        qrData:
          type: string
          description: QR code data URL
        subtotal:
          type: number
          format: double
          example: 10000.00
        taxAmount:
          type: number
          format: double
          example: 2100.00
        total:
          type: number
          format: double
          example: 12100.00
        currency:
          type: string
          default: "ARS"
        lineItems:
          type: array
          items:
            $ref: '#/components/schemas/InvoiceLineItem'
        status:
          $ref: '#/components/schemas/InvoiceStatus'
        afipError:
          type: string
          description: Last AFIP error (if any)
        afipAttempts:
          type: integer
        pdfUrl:
          type: string
          format: uri
        issueDate:
          type: string
          format: date
        dueDate:
          type: string
          format: date
        paidAt:
          type: string
          format: date-time
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
    
    InvoiceLineItem:
      type: object
      properties:
        id:
          type: string
          format: uuid
        priceBookId:
          type: string
          format: uuid
        description:
          type: string
        quantity:
          type: number
          format: double
        unit:
          type: string
        unitPrice:
          type: number
          format: double
        taxRate:
          type: number
          format: double
        subtotal:
          type: number
          format: double
        taxAmount:
          type: number
          format: double
        total:
          type: number
          format: double
    
    InvoiceLineItemInput:
      type: object
      required:
        - description
        - quantity
        - unitPrice
      properties:
        priceBookId:
          type: string
          format: uuid
        description:
          type: string
          minLength: 3
          maxLength: 500
        quantity:
          type: number
          format: double
          minimum: 0.001
        unit:
          type: string
          maxLength: 50
          default: "unidad"
        unitPrice:
          type: number
          format: double
          minimum: 0
        taxRate:
          type: number
          format: double
          minimum: 0
          maximum: 100
          default: 21
    
    CreateInvoiceRequest:
      type: object
      required:
        - customerId
        - lineItems
      properties:
        customerId:
          type: string
          format: uuid
        jobId:
          type: string
          format: uuid
        lineItems:
          type: array
          items:
            $ref: '#/components/schemas/InvoiceLineItemInput'
          minItems: 1
          maxItems: 100
        dueDate:
          type: string
          format: date
        notes:
          type: string
          maxLength: 1000
        submitToAfip:
          type: boolean
          default: true
          description: If false, creates as draft
      example:
        customerId: "550e8400-e29b-41d4-a716-446655440000"
        lineItems:
          - description: "Visita técnica"
            quantity: 1
            unitPrice: 5000
            taxRate: 21
          - description: "Reparación canilla"
            quantity: 1
            unitPrice: 8000
            taxRate: 21
        submitToAfip: true
    
    InvoiceList:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: array
          items:
            $ref: '#/components/schemas/Invoice'
        pagination:
          $ref: '#/components/schemas/PaginationMeta'
    
    RequestCaeResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            status:
              type: string
              enum: [success, queued, failed]
            cae:
              type: string
              description: CAE code (if success)
            caeExpiry:
              type: string
              format: date
            invoiceNumber:
              type: integer
            message:
              type: string
              description: Status message
            queuePosition:
              type: integer
              description: Queue position (if queued)
    
    AfipQueueStatus:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            pending:
              type: integer
            processing:
              type: integer
            failed:
              type: integer
            serviceStatus:
              type: string
              enum: [online, degraded, panic]
            estimatedWait:
              type: integer
              description: Estimated wait time in seconds
    
    # --------------------------------------------------------------------------
    # Payment Schemas
    # --------------------------------------------------------------------------
    
    Payment:
      type: object
      required:
        - id
        - orgId
        - invoiceId
        - amount
        - status
      properties:
        id:
          type: string
          format: uuid
        orgId:
          type: string
          format: uuid
        invoiceId:
          type: string
          format: uuid
        invoice:
          $ref: '#/components/schemas/InvoiceSummary'
        mpPaymentId:
          type: string
        mpPreferenceId:
          type: string
        amount:
          type: number
          format: double
        refundedAmount:
          type: number
          format: double
        currency:
          type: string
        installments:
          type: integer
        installmentAmount:
          type: number
          format: double
        financeCharge:
          type: number
          format: double
        tea:
          type: number
          format: double
          description: Tasa Efectiva Anual
        cft:
          type: number
          format: double
          description: Costo Financiero Total
        status:
          $ref: '#/components/schemas/PaymentStatus'
        statusDetail:
          type: string
        paymentMethod:
          $ref: '#/components/schemas/PaymentMethod'
        cardLastFour:
          type: string
        cardBrand:
          type: string
        payerEmail:
          type: string
        approvedAt:
          type: string
          format: date-time
        refundedAt:
          type: string
          format: date-time
        createdAt:
          type: string
          format: date-time
    
    InvoiceSummary:
      type: object
      properties:
        id:
          type: string
          format: uuid
        invoiceNumber:
          type: integer
        total:
          type: number
          format: double
        customerName:
          type: string
    
    CreatePaymentPreferenceRequest:
      type: object
      required:
        - invoiceId
      properties:
        invoiceId:
          type: string
          format: uuid
        maxInstallments:
          type: integer
          minimum: 1
          maximum: 12
          default: 12
        expirationMinutes:
          type: integer
          minimum: 5
          maximum: 10080
          default: 1440
          description: Payment link expiration in minutes
    
    PaymentPreferenceResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            preferenceId:
              type: string
            paymentUrl:
              type: string
              format: uri
              description: URL to send to customer
            qrCode:
              type: string
              description: Base64 encoded QR code image
            expiresAt:
              type: string
              format: date-time
            installmentOptions:
              type: array
              items:
                $ref: '#/components/schemas/InstallmentOption'
    
    InstallmentOption:
      type: object
      properties:
        installments:
          type: integer
        installmentAmount:
          type: number
          format: double
        totalAmount:
          type: number
          format: double
        tea:
          type: number
          format: double
        cft:
          type: number
          format: double
    
    RefundRequest:
      type: object
      properties:
        amount:
          type: number
          format: double
          description: Amount to refund (null for full refund)
        reason:
          type: string
          maxLength: 500
    
    PaymentList:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: array
          items:
            $ref: '#/components/schemas/Payment'
        pagination:
          $ref: '#/components/schemas/PaginationMeta'
    
    MpWebhookPayload:
      type: object
      properties:
        id:
          type: string
        type:
          type: string
          enum: [payment, plan, subscription, chargeback]
        data:
          type: object
          properties:
            id:
              type: string
    
    ReconcileResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            processed:
              type: integer
            created:
              type: integer
            updated:
              type: integer
            errors:
              type: integer
            discrepancies:
              type: array
              items:
                type: object
                properties:
                  paymentId:
                    type: string
                  issue:
                    type: string

    # --------------------------------------------------------------------------
    # WhatsApp Schemas
    # --------------------------------------------------------------------------
    
    WhatsAppMessage:
      type: object
      required:
        - id
        - orgId
        - direction
        - messageType
        - status
      properties:
        id:
          type: string
          format: uuid
        orgId:
          type: string
          format: uuid
        customerId:
          type: string
          format: uuid
        customer:
          $ref: '#/components/schemas/CustomerSummary'
        jobId:
          type: string
          format: uuid
        waMessageId:
          type: string
        waConversationId:
          type: string
        direction:
          $ref: '#/components/schemas/MessageDirection'
        messageType:
          $ref: '#/components/schemas/MessageType'
        content:
          type: string
        mediaUrl:
          type: string
          format: uri
        mediaMimeType:
          type: string
        mediaSize:
          type: integer
        templateName:
          type: string
        templateParams:
          type: object
        voiceDuration:
          type: integer
          description: Voice message duration in seconds
        status:
          $ref: '#/components/schemas/MessageStatus'
        errorCode:
          type: string
        errorMessage:
          type: string
        waTimestamp:
          type: string
          format: date-time
        deliveredAt:
          type: string
          format: date-time
        readAt:
          type: string
          format: date-time
        createdAt:
          type: string
          format: date-time
    
    WhatsAppConversation:
      type: object
      properties:
        customerId:
          type: string
          format: uuid
        customer:
          $ref: '#/components/schemas/CustomerSummary'
        lastMessage:
          $ref: '#/components/schemas/WhatsAppMessage'
        unreadCount:
          type: integer
        lastMessageAt:
          type: string
          format: date-time
    
    SendMessageRequest:
      type: object
      required:
        - customerId
      properties:
        customerId:
          type: string
          format: uuid
        jobId:
          type: string
          format: uuid
        templateName:
          type: string
          description: Template name (required for business-initiated)
        templateParams:
          type: array
          items:
            type: string
          description: Template parameter values
        text:
          type: string
          maxLength: 4096
          description: Free text (only for replies within 24h window)
    
    SendMessageResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            messageId:
              type: string
              format: uuid
            waMessageId:
              type: string
            status:
              $ref: '#/components/schemas/MessageStatus'
    
    WhatsAppTemplate:
      type: object
      properties:
        name:
          type: string
        language:
          type: string
        category:
          type: string
        status:
          type: string
          enum: [APPROVED, PENDING, REJECTED]
        components:
          type: array
          items:
            type: object
        parameterCount:
          type: integer
    
    ConversationList:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: array
          items:
            $ref: '#/components/schemas/WhatsAppConversation'
        pagination:
          $ref: '#/components/schemas/PaginationMeta'
    
    MessageList:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: array
          items:
            $ref: '#/components/schemas/WhatsAppMessage'
        pagination:
          $ref: '#/components/schemas/PaginationMeta'
    
    # --------------------------------------------------------------------------
    # Voice AI Schemas
    # --------------------------------------------------------------------------
    
    VoiceTranscript:
      type: object
      properties:
        id:
          type: string
          format: uuid
        messageId:
          type: string
          format: uuid
        audioUrl:
          type: string
          format: uri
        audioDuration:
          type: integer
        audioQuality:
          type: string
          enum: [clean, noisy, poor]
        transcription:
          type: string
        transcriptionConfidence:
          type: number
          format: double
        extractionData:
          $ref: '#/components/schemas/VoiceExtraction'
        overallConfidence:
          type: number
          format: double
        humanTranscription:
          type: string
        humanExtraction:
          $ref: '#/components/schemas/VoiceExtraction'
        status:
          $ref: '#/components/schemas/VoiceStatus'
        createdJobId:
          type: string
          format: uuid
        autoCreated:
          type: boolean
        reviewedBy:
          type: string
          format: uuid
        reviewedAt:
          type: string
          format: date-time
        processingDurationMs:
          type: integer
        createdAt:
          type: string
          format: date-time
    
    VoiceExtraction:
      type: object
      properties:
        customerName:
          $ref: '#/components/schemas/ExtractedField'
        phone:
          $ref: '#/components/schemas/ExtractedField'
        address:
          $ref: '#/components/schemas/ExtractedField'
        neighborhood:
          $ref: '#/components/schemas/ExtractedField'
        problemDescription:
          $ref: '#/components/schemas/ExtractedField'
        serviceType:
          $ref: '#/components/schemas/ExtractedField'
        urgency:
          $ref: '#/components/schemas/ExtractedField'
        preferredDate:
          $ref: '#/components/schemas/ExtractedField'
        preferredTime:
          $ref: '#/components/schemas/ExtractedField'
    
    ExtractedField:
      type: object
      properties:
        value:
          oneOf:
            - type: string
            - type: number
        confidence:
          type: number
          format: double
          minimum: 0
          maximum: 1
    
    ProcessVoiceRequest:
      type: object
      required:
        - messageId
      properties:
        messageId:
          type: string
          format: uuid
        priority:
          type: string
          enum: [low, normal, high]
          default: normal
    
    ProcessVoiceResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            transcriptId:
              type: string
              format: uuid
            status:
              $ref: '#/components/schemas/VoiceStatus'
            queuePosition:
              type: integer
    
    SubmitReviewRequest:
      type: object
      required:
        - action
      properties:
        action:
          type: string
          enum: [approve, edit, reject]
        humanTranscription:
          type: string
        humanExtraction:
          $ref: '#/components/schemas/VoiceExtraction'
        createJob:
          type: boolean
          default: true
        jobData:
          $ref: '#/components/schemas/CreateJobRequest'
    
    VoiceQueueResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: array
          items:
            $ref: '#/components/schemas/VoiceTranscript'
        pagination:
          $ref: '#/components/schemas/PaginationMeta'
    
    VoiceStatsResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            totalProcessed:
              type: integer
            autoCreated:
              type: integer
            humanReviewed:
              type: integer
            averageConfidence:
              type: number
              format: double
            accuracy:
              type: number
              format: double
            processingTime:
              type: object
              properties:
                avg:
                  type: integer
                p50:
                  type: integer
                p95:
                  type: integer
    
    # --------------------------------------------------------------------------
    # Admin Schemas
    # --------------------------------------------------------------------------
    
    HealthResponse:
      type: object
      properties:
        status:
          type: string
          enum: [healthy, degraded, unhealthy]
        version:
          type: string
        uptime:
          type: integer
        checks:
          type: object
          properties:
            database:
              $ref: '#/components/schemas/HealthCheck'
            redis:
              $ref: '#/components/schemas/HealthCheck'
            afip:
              $ref: '#/components/schemas/HealthCheck'
            mercadopago:
              $ref: '#/components/schemas/HealthCheck'
            whatsapp:
              $ref: '#/components/schemas/HealthCheck'
    
    HealthCheck:
      type: object
      properties:
        status:
          type: string
          enum: [ok, degraded, error]
        latency:
          type: integer
        message:
          type: string
    
    QueueStatusResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: array
          items:
            type: object
            properties:
              name:
                type: string
              pending:
                type: integer
              processing:
                type: integer
              completed:
                type: integer
              failed:
                type: integer
              dlqSize:
                type: integer
    
    DlqItem:
      type: object
      properties:
        id:
          type: string
          format: uuid
        queueName:
          type: string
        jobId:
          type: string
        jobData:
          type: object
        errorMessage:
          type: string
        errorStack:
          type: string
        attempts:
          type: integer
        failedAt:
          type: string
          format: date-time
        status:
          type: string
          enum: [pending, retried, discarded, resolved]
    
    DlqListResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: array
          items:
            $ref: '#/components/schemas/DlqItem'
        pagination:
          $ref: '#/components/schemas/PaginationMeta'
    
    PanicStatusResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            afip:
              $ref: '#/components/schemas/ServicePanicStatus'
            mercadopago:
              $ref: '#/components/schemas/ServicePanicStatus'
            whatsapp:
              $ref: '#/components/schemas/ServicePanicStatus'
            voiceai:
              $ref: '#/components/schemas/ServicePanicStatus'
    
    ServicePanicStatus:
      type: object
      properties:
        status:
          type: string
          enum: [ok, degraded, panic]
        consecutiveFailures:
          type: integer
        consecutiveSuccesses:
          type: integer
        errorRate:
          type: number
          format: double
        p99Latency:
          type: integer
        panicStartedAt:
          type: string
          format: date-time
        manualOverride:
          type: boolean
    
    SetPanicStatusRequest:
      type: object
      required:
        - status
        - reason
      properties:
        status:
          type: string
          enum: [ok, degraded, panic]
        reason:
          type: string
          minLength: 10
          maxLength: 500
    
    MetricsResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            requests:
              type: object
              properties:
                total:
                  type: integer
                successful:
                  type: integer
                failed:
                  type: integer
                avgLatency:
                  type: number
            jobs:
              type: object
              properties:
                created:
                  type: integer
                completed:
                  type: integer
                cancelled:
                  type: integer
            invoices:
              type: object
              properties:
                created:
                  type: integer
                caeSuccess:
                  type: integer
                caeFailed:
                  type: integer
            payments:
              type: object
              properties:
                received:
                  type: integer
                totalAmount:
                  type: number
            voice:
              type: object
              properties:
                processed:
                  type: integer
                autoCreated:
                  type: integer
                humanReviewed:
                  type: integer

# ============================================================================
# PATHS - API ENDPOINTS
# ============================================================================

paths:
  # ==========================================================================
  # AUTH ENDPOINTS
  # ==========================================================================
  
  /auth/otp/send:
    post:
      tags:
        - Auth
      summary: Send OTP code
      description: |
        Sends a 6-digit OTP code to the specified phone number via WhatsApp.
        Rate limited to 10 requests/minute per IP.
        OTP expires in 5 minutes.
      operationId: sendOtp
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SendOtpRequest'
            examples:
              argentina:
                summary: Argentine mobile number
                value:
                  phone: "+5491112345678"
      responses:
        '200':
          description: OTP sent successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SendOtpResponse'
        '400':
          description: Invalid phone number format
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalid_phone:
                  value:
                    success: false
                    error:
                      code: "AUTH_001"
                      message: "Invalid phone number format. Must be Argentine number with country code."
                      field: "phone"
        '429':
          description: Rate limit exceeded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                rate_limited:
                  value:
                    success: false
                    error:
                      code: "AUTH_002"
                      message: "Too many requests. Please wait before requesting another code."
                      details:
                        retryAfter: 60
  
  /auth/otp/verify:
    post:
      tags:
        - Auth
      summary: Verify OTP code
      description: |
        Verifies the OTP code and returns JWT tokens.
        Creates user account if phone not registered.
        Access token expires in 15 minutes, refresh token in 7 days.
      operationId: verifyOtp
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/VerifyOtpRequest'
            examples:
              valid:
                summary: Valid OTP verification
                value:
                  phone: "+5491112345678"
                  code: "123456"
      responses:
        '200':
          description: OTP verified successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VerifyOtpResponse'
              examples:
                existing_user:
                  value:
                    success: true
                    data:
                      accessToken: "eyJhbGciOiJIUzI1NiIs..."
                      refreshToken: "dGhpcyBpcyBhIHJlZnJl..."
                      expiresIn: 900
                      user:
                        id: "550e8400-e29b-41d4-a716-446655440000"
                        orgId: "660e8400-e29b-41d4-a716-446655440000"
                        role: "owner"
                        fullName: "Juan González"
                        phone: "+5491112345678"
                      isNewUser: false
        '400':
          description: Invalid or expired OTP
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalid_code:
                  value:
                    success: false
                    error:
                      code: "AUTH_003"
                      message: "Invalid OTP code"
                expired_code:
                  value:
                    success: false
                    error:
                      code: "AUTH_004"
                      message: "OTP code has expired. Please request a new one."
        '429':
          description: Too many failed attempts
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  
  /auth/refresh:
    post:
      tags:
        - Auth
      summary: Refresh access token
      description: Exchange refresh token for new access and refresh tokens
      operationId: refreshToken
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RefreshTokenRequest'
      responses:
        '200':
          description: Tokens refreshed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RefreshTokenResponse'
        '401':
          description: Invalid or expired refresh token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalid_token:
                  value:
                    success: false
                    error:
                      code: "AUTH_005"
                      message: "Invalid refresh token"
  
  /auth/logout:
    post:
      tags:
        - Auth
      summary: Logout user
      description: Invalidates all tokens for the current session
      operationId: logout
      responses:
        '200':
          description: Logged out successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
        '401':
          $ref: '#/components/responses/Unauthorized'
  
  /auth/me:
    get:
      tags:
        - Auth
      summary: Get current user
      description: Returns the currently authenticated user with organization details
      operationId: getCurrentUser
      responses:
        '200':
          description: Current user details
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/UserMe'
        '401':
          $ref: '#/components/responses/Unauthorized'

  # ==========================================================================
  # ORGANIZATION ENDPOINTS
  # ==========================================================================
  
  /organization:
    get:
      tags:
        - Organization
      summary: Get organization details
      description: Returns the current user's organization with all settings
      operationId: getOrganization
      responses:
        '200':
          description: Organization details
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/Organization'
        '401':
          $ref: '#/components/responses/Unauthorized'
    
    patch:
      tags:
        - Organization
      summary: Update organization
      description: |
        Update organization settings.
        Requires `admin` or `owner` role.
      operationId: updateOrganization
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateOrganizationRequest'
      responses:
        '200':
          description: Organization updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/Organization'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
  
  /organization/afip:
    get:
      tags:
        - Organization
      summary: Get AFIP status
      description: Returns AFIP configuration status and certificate details
      operationId: getAfipStatus
      responses:
        '200':
          description: AFIP status
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/AfipStatus'
        '401':
          $ref: '#/components/responses/Unauthorized'
    
    post:
      tags:
        - Organization
      summary: Upload AFIP certificate
      description: |
        Upload AFIP digital certificate for electronic invoicing.
        Requires `owner` role.
        Certificate and key are encrypted at rest.
      operationId: uploadAfipCert
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UploadAfipCertRequest'
      responses:
        '200':
          description: Certificate uploaded successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/AfipStatus'
        '400':
          description: Invalid certificate
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalid_cert:
                  value:
                    success: false
                    error:
                      code: "AFIP_001"
                      message: "Invalid certificate format or expired"
                wrong_cuit:
                  value:
                    success: false
                    error:
                      code: "AFIP_002"
                      message: "Certificate CUIT does not match organization CUIT"
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
    
    delete:
      tags:
        - Organization
      summary: Remove AFIP certificate
      description: |
        Remove AFIP certificate (disables electronic invoicing).
        Requires `owner` role.
      operationId: removeAfipCert
      responses:
        '200':
          description: Certificate removed
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
  
  /organization/afip/test:
    post:
      tags:
        - Organization
      summary: Test AFIP connection
      description: Tests AFIP connection without creating real invoice
      operationId: testAfipConnection
      responses:
        '200':
          description: AFIP connection test result
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      afipOnline:
                        type: boolean
                      authValid:
                        type: boolean
                      certValid:
                        type: boolean
                      message:
                        type: string
        '401':
          $ref: '#/components/responses/Unauthorized'
  
  /organization/mercadopago/connect:
    get:
      tags:
        - Organization
      summary: Get MP OAuth URL
      description: |
        Returns Mercado Pago OAuth authorization URL.
        Redirect user to this URL to authorize MP integration.
        Requires `owner` role.
      operationId: getMpConnectUrl
      responses:
        '200':
          description: OAuth URL generated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MpConnectResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
  
  /organization/mercadopago/callback:
    get:
      tags:
        - Organization
      summary: MP OAuth callback
      description: |
        Handles OAuth callback from Mercado Pago.
        Exchanges authorization code for access tokens.
        Internal endpoint called by MP redirect.
      operationId: mpOAuthCallback
      parameters:
        - name: code
          in: query
          required: true
          schema:
            type: string
        - name: state
          in: query
          required: true
          schema:
            type: string
      responses:
        '302':
          description: Redirects to success/error page
        '400':
          description: Invalid callback parameters
  
  /organization/mercadopago/disconnect:
    post:
      tags:
        - Organization
      summary: Disconnect Mercado Pago
      description: |
        Removes Mercado Pago integration.
        Requires `owner` role.
      operationId: disconnectMp
      responses:
        '200':
          description: Disconnected successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
  
  /organization/whatsapp:
    get:
      tags:
        - Organization
      summary: Get WhatsApp status
      description: Returns WhatsApp Business API configuration status
      operationId: getWhatsappStatus
      responses:
        '200':
          description: WhatsApp status
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      configured:
                        type: boolean
                      verified:
                        type: boolean
                      phoneNumber:
                        type: string
                      displayName:
                        type: string
                      qualityRating:
                        type: string
                      messagingLimit:
                        type: integer
        '401':
          $ref: '#/components/responses/Unauthorized'
  
  /organization/users:
    get:
      tags:
        - Organization
      summary: List organization users
      description: |
        Returns all users in the organization.
        Requires `admin` or `owner` role.
      operationId: listUsers
      parameters:
        - name: role
          in: query
          schema:
            $ref: '#/components/schemas/UserRole'
        - name: isActive
          in: query
          schema:
            type: boolean
      responses:
        '200':
          description: User list
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/User'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
    
    post:
      tags:
        - Organization
      summary: Invite user
      description: |
        Invite a new user to the organization.
        Sends OTP to user's phone for registration.
        Requires `admin` or `owner` role.
      operationId: inviteUser
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - phone
                - role
                - fullName
              properties:
                phone:
                  type: string
                  pattern: '^\+54[0-9]{10,11}$'
                role:
                  $ref: '#/components/schemas/UserRole'
                fullName:
                  type: string
                  minLength: 2
                  maxLength: 200
                email:
                  type: string
                  format: email
      responses:
        '201':
          description: User invited
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/User'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '409':
          description: User already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  
  /organization/users/{userId}:
    parameters:
      - name: userId
        in: path
        required: true
        schema:
          type: string
          format: uuid
    
    get:
      tags:
        - Organization
      summary: Get user by ID
      operationId: getUser
      responses:
        '200':
          description: User details
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/User'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
    
    patch:
      tags:
        - Organization
      summary: Update user
      description: |
        Update user details or role.
        Requires `admin` or `owner` role.
        Cannot change own role.
      operationId: updateUser
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                fullName:
                  type: string
                email:
                  type: string
                  format: email
                role:
                  $ref: '#/components/schemas/UserRole'
                isActive:
                  type: boolean
      responses:
        '200':
          description: User updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/User'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
    
    delete:
      tags:
        - Organization
      summary: Remove user
      description: |
        Remove user from organization.
        Requires `owner` role.
        Cannot remove self.
      operationId: removeUser
      responses:
        '200':
          description: User removed
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  # ==========================================================================
  # CUSTOMER ENDPOINTS
  # ==========================================================================
  
  /customers:
    get:
      tags:
        - Customers
      summary: List customers
      description: |
        Returns paginated list of customers.
        Supports search by name, phone, or email.
        Filterable by tags, neighborhood, source.
      operationId: listCustomers
      parameters:
        - $ref: '#/components/parameters/Limit'
        - $ref: '#/components/parameters/Cursor'
        - $ref: '#/components/parameters/Search'
        - name: neighborhood
          in: query
          schema:
            type: string
        - name: tag
          in: query
          schema:
            type: string
        - name: source
          in: query
          schema:
            $ref: '#/components/schemas/JobSource'
        - name: hasJobs
          in: query
          schema:
            type: boolean
        - name: sortBy
          in: query
          schema:
            type: string
            enum: [name, createdAt, lastMessageAt, totalRevenue]
            default: createdAt
        - name: sortOrder
          in: query
          schema:
            type: string
            enum: [asc, desc]
            default: desc
      responses:
        '200':
          description: Customer list
          headers:
            X-RateLimit-Limit:
              $ref: '#/components/headers/X-RateLimit-Limit'
            X-RateLimit-Remaining:
              $ref: '#/components/headers/X-RateLimit-Remaining'
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CustomerList'
        '401':
          $ref: '#/components/responses/Unauthorized'
    
    post:
      tags:
        - Customers
      summary: Create customer
      description: Creates a new customer
      operationId: createCustomer
      parameters:
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateCustomerRequest'
            examples:
              consumer:
                summary: Final consumer
                value:
                  name: "María López"
                  phone: "+5491155555555"
                  address: "Av. Corrientes 1234"
                  neighborhood: "Palermo"
                  ivaCondition: "consumidor_final"
              business:
                summary: Business customer
                value:
                  name: "Empresa SRL"
                  phone: "+5491166666666"
                  email: "contacto@empresa.com"
                  docType: "cuit"
                  docNumber: "30-71234567-8"
                  ivaCondition: "responsable_inscripto"
                  address: "Av. Libertador 5000"
                  neighborhood: "Belgrano"
      responses:
        '201':
          description: Customer created
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/Customer'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalid_phone:
                  value:
                    success: false
                    error:
                      code: "CUSTOMER_001"
                      message: "Invalid phone number format"
                      field: "phone"
                invalid_cuit:
                  value:
                    success: false
                    error:
                      code: "CUSTOMER_002"
                      message: "Invalid CUIT format or checksum"
                      field: "docNumber"
        '401':
          $ref: '#/components/responses/Unauthorized'
        '409':
          description: Customer with phone already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                duplicate:
                  value:
                    success: false
                    error:
                      code: "CUSTOMER_003"
                      message: "Customer with this phone number already exists"
                      details:
                        existingCustomerId: "550e8400-e29b-41d4-a716-446655440000"
  
  /customers/validate-cuit:
    post:
      tags:
        - Customers
      summary: Validate CUIT
      description: |
        Validates CUIT format and optionally queries AFIP padron
        to retrieve company information.
      operationId: validateCuit
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ValidateCuitRequest'
      responses:
        '200':
          description: CUIT validation result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidateCuitResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
  
  /customers/{customerId}:
    parameters:
      - $ref: '#/components/parameters/CustomerId'
    
    get:
      tags:
        - Customers
      summary: Get customer
      description: Returns customer details with job history
      operationId: getCustomer
      responses:
        '200':
          description: Customer details
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/Customer'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
    
    patch:
      tags:
        - Customers
      summary: Update customer
      description: Updates customer information
      operationId: updateCustomer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateCustomerRequest'
      responses:
        '200':
          description: Customer updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/Customer'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
    
    delete:
      tags:
        - Customers
      summary: Delete customer
      description: |
        Soft deletes a customer.
        Customer with active jobs cannot be deleted.
      operationId: deleteCustomer
      responses:
        '200':
          description: Customer deleted
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
        '400':
          description: Cannot delete customer with active jobs
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
  
  /customers/{customerId}/jobs:
    parameters:
      - $ref: '#/components/parameters/CustomerId'
    
    get:
      tags:
        - Customers
      summary: Get customer jobs
      description: Returns all jobs for a customer
      operationId: getCustomerJobs
      parameters:
        - $ref: '#/components/parameters/Limit'
        - $ref: '#/components/parameters/Cursor'
        - name: status
          in: query
          schema:
            $ref: '#/components/schemas/JobStatus'
      responses:
        '200':
          description: Customer jobs
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JobList'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
  
  /customers/{customerId}/invoices:
    parameters:
      - $ref: '#/components/parameters/CustomerId'
    
    get:
      tags:
        - Customers
      summary: Get customer invoices
      description: Returns all invoices for a customer
      operationId: getCustomerInvoices
      parameters:
        - $ref: '#/components/parameters/Limit'
        - $ref: '#/components/parameters/Cursor'
        - name: status
          in: query
          schema:
            $ref: '#/components/schemas/InvoiceStatus'
      responses:
        '200':
          description: Customer invoices
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InvoiceList'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
  
  /customers/merge:
    post:
      tags:
        - Customers
      summary: Merge customers
      description: |
        Merges two duplicate customer records.
        All jobs, invoices, and messages are moved to target customer.
        Requires `admin` or `owner` role.
      operationId: mergeCustomers
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - sourceId
                - targetId
              properties:
                sourceId:
                  type: string
                  format: uuid
                  description: Customer to be merged (will be deleted)
                targetId:
                  type: string
                  format: uuid
                  description: Customer to keep
      responses:
        '200':
          description: Customers merged
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/Customer'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  # ==========================================================================
  # JOB ENDPOINTS
  # ==========================================================================
  
  /jobs:
    get:
      tags:
        - Jobs
      summary: List jobs
      description: |
        Returns paginated list of jobs.
        Technicians only see assigned jobs.
        Supports filtering by status, date range, assignee, customer.
      operationId: listJobs
      parameters:
        - $ref: '#/components/parameters/Limit'
        - $ref: '#/components/parameters/Cursor'
        - name: status
          in: query
          schema:
            type: array
            items:
              $ref: '#/components/schemas/JobStatus'
          style: form
          explode: false
          description: Filter by status(es)
        - name: priority
          in: query
          schema:
            $ref: '#/components/schemas/JobPriority'
        - name: jobType
          in: query
          schema:
            $ref: '#/components/schemas/JobType'
        - name: assignedTo
          in: query
          schema:
            type: string
            format: uuid
        - name: customerId
          in: query
          schema:
            type: string
            format: uuid
        - $ref: '#/components/parameters/DateFrom'
        - $ref: '#/components/parameters/DateTo'
        - name: unassigned
          in: query
          schema:
            type: boolean
        - name: sortBy
          in: query
          schema:
            type: string
            enum: [scheduledDate, createdAt, priority]
            default: scheduledDate
        - name: sortOrder
          in: query
          schema:
            type: string
            enum: [asc, desc]
            default: asc
      responses:
        '200':
          description: Job list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JobList'
        '401':
          $ref: '#/components/responses/Unauthorized'
    
    post:
      tags:
        - Jobs
      summary: Create job
      description: Creates a new job
      operationId: createJob
      parameters:
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateJobRequest'
            examples:
              basic:
                summary: Basic job
                value:
                  customerId: "550e8400-e29b-41d4-a716-446655440000"
                  title: "Pérdida en baño"
                  jobType: "plomeria"
                  priority: "normal"
                  scheduledDate: "2025-01-15"
                  scheduledTimeStart: "09:00"
                  scheduledTimeEnd: "11:00"
                  address: "Av. Corrientes 1234"
                  neighborhood: "Palermo"
              urgent:
                summary: Urgent job
                value:
                  customerId: "550e8400-e29b-41d4-a716-446655440000"
                  assignedTo: "660e8400-e29b-41d4-a716-446655440000"
                  title: "Pérdida de gas urgente"
                  description: "Cliente reporta olor a gas en cocina"
                  jobType: "gas"
                  priority: "urgent"
                  scheduledDate: "2025-01-10"
                  scheduledTimeStart: "14:00"
                  scheduledTimeEnd: "15:00"
      responses:
        '201':
          description: Job created
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/Job'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalid_time:
                  value:
                    success: false
                    error:
                      code: "JOB_001"
                      message: "End time must be after start time"
                past_date:
                  value:
                    success: false
                    error:
                      code: "JOB_002"
                      message: "Cannot schedule job in the past"
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          description: Customer or assignee not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  
  /jobs/calendar:
    get:
      tags:
        - Jobs
      summary: Get calendar view
      description: |
        Returns jobs grouped by date for calendar display.
        Optimized for calendar component rendering.
      operationId: getJobCalendar
      parameters:
        - name: startDate
          in: query
          required: true
          schema:
            type: string
            format: date
          description: Start of date range
        - name: endDate
          in: query
          required: true
          schema:
            type: string
            format: date
          description: End of date range
        - name: assignedTo
          in: query
          schema:
            type: string
            format: uuid
          description: Filter by technician
      responses:
        '200':
          description: Calendar data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JobCalendarResponse'
        '400':
          description: Invalid date range
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
  
  /jobs/today:
    get:
      tags:
        - Jobs
      summary: Get today's jobs
      description: |
        Returns jobs scheduled for today.
        For technicians, returns only assigned jobs.
      operationId: getTodayJobs
      parameters:
        - name: assignedTo
          in: query
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Today's jobs
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JobList'
        '401':
          $ref: '#/components/responses/Unauthorized'
  
  /jobs/{jobId}:
    parameters:
      - $ref: '#/components/parameters/JobId'
    
    get:
      tags:
        - Jobs
      summary: Get job
      description: Returns job details with photos and history
      operationId: getJob
      responses:
        '200':
          description: Job details
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/Job'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          description: Technician not assigned to job
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          $ref: '#/components/responses/NotFound'
    
    patch:
      tags:
        - Jobs
      summary: Update job
      description: |
        Updates job details.
        Cannot update completed or cancelled jobs.
      operationId: updateJob
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateJobRequest'
      responses:
        '200':
          description: Job updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/Job'
        '400':
          description: Cannot update completed job
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
    
    delete:
      tags:
        - Jobs
      summary: Delete job
      description: |
        Deletes a job.
        Only pending or scheduled jobs can be deleted.
        Jobs with invoices cannot be deleted.
      operationId: deleteJob
      responses:
        '200':
          description: Job deleted
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
        '400':
          description: Cannot delete job
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                has_invoice:
                  value:
                    success: false
                    error:
                      code: "JOB_003"
                      message: "Cannot delete job with associated invoice"
                wrong_status:
                  value:
                    success: false
                    error:
                      code: "JOB_004"
                      message: "Can only delete pending or scheduled jobs"
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
  
  /jobs/{jobId}/status:
    parameters:
      - $ref: '#/components/parameters/JobId'
    
    patch:
      tags:
        - Jobs
      summary: Update job status
      description: |
        Updates job status with optional location tracking.
        Validates status transitions:
        - pending → scheduled, cancelled
        - scheduled → en_camino, cancelled
        - en_camino → working, cancelled
        - working → completed, cancelled
      operationId: updateJobStatus
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateJobStatusRequest'
            examples:
              en_camino:
                summary: Mark as en camino
                value:
                  status: "en_camino"
                  lat: -34.603722
                  lng: -58.381592
              working:
                summary: Start working
                value:
                  status: "working"
                  notes: "Arrived at location"
      responses:
        '200':
          description: Status updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/Job'
        '400':
          description: Invalid status transition
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalid_transition:
                  value:
                    success: false
                    error:
                      code: "JOB_005"
                      message: "Invalid status transition from 'pending' to 'completed'"
                      details:
                        currentStatus: "pending"
                        requestedStatus: "completed"
                        allowedStatuses: ["scheduled", "cancelled"]
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
  
  /jobs/{jobId}/assign:
    parameters:
      - $ref: '#/components/parameters/JobId'
    
    patch:
      tags:
        - Jobs
      summary: Assign job
      description: |
        Assigns job to a technician.
        Requires `dispatcher`, `admin`, or `owner` role.
        Sends notification to assigned technician.
      operationId: assignJob
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AssignJobRequest'
      responses:
        '200':
          description: Job assigned
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/Job'
        '400':
          description: User cannot be assigned
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
  
  /jobs/{jobId}/complete:
    parameters:
      - $ref: '#/components/parameters/JobId'
    
    post:
      tags:
        - Jobs
      summary: Complete job
      description: |
        Completes a job with photos and signature.
        Optionally creates invoice automatically.
        Sends completion notification to customer.
      operationId: completeJob
      parameters:
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CompleteJobRequest'
          multipart/form-data:
            schema:
              type: object
              properties:
                photos:
                  type: array
                  items:
                    type: string
                    format: binary
                signature:
                  type: string
                  format: binary
                notes:
                  type: string
                createInvoice:
                  type: boolean
                lineItems:
                  type: string
                  description: JSON array of line items
      responses:
        '200':
          description: Job completed
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      job:
                        $ref: '#/components/schemas/Job'
                      invoice:
                        $ref: '#/components/schemas/Invoice'
                        description: Created invoice (if createInvoice=true)
        '400':
          description: Cannot complete job
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
  
  /jobs/{jobId}/photos:
    parameters:
      - $ref: '#/components/parameters/JobId'
    
    get:
      tags:
        - Jobs
      summary: Get job photos
      description: Returns all photos for a job
      operationId: getJobPhotos
      responses:
        '200':
          description: Job photos
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/JobPhoto'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
    
    post:
      tags:
        - Jobs
      summary: Upload job photo
      description: |
        Uploads a photo for a job.
        Supports offline queuing for mobile app.
      operationId: uploadJobPhoto
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - photo
                - photoType
              properties:
                photo:
                  type: string
                  format: binary
                photoType:
                  type: string
                  enum: [before, during, after, signature, document]
                takenAt:
                  type: string
                  format: date-time
                offlineId:
                  type: string
                  description: Client-generated ID for offline sync
      responses:
        '201':
          description: Photo uploaded
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/JobPhoto'
        '400':
          description: Invalid photo
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
  
  /jobs/{jobId}/history:
    parameters:
      - $ref: '#/components/parameters/JobId'
    
    get:
      tags:
        - Jobs
      summary: Get job history
      description: Returns status change history for a job
      operationId: getJobHistory
      responses:
        '200':
          description: Job history
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: string
                          format: uuid
                        fromStatus:
                          $ref: '#/components/schemas/JobStatus'
                        toStatus:
                          $ref: '#/components/schemas/JobStatus'
                        changedBy:
                          $ref: '#/components/schemas/UserSummary'
                        notes:
                          type: string
                        lat:
                          type: number
                        lng:
                          type: number
                        createdAt:
                          type: string
                          format: date-time
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
  
  /jobs/sync:
    post:
      tags:
        - Jobs
      summary: Sync offline jobs
      description: |
        Syncs jobs created or updated offline.
        Handles conflict resolution.
        Mobile app endpoint.
      operationId: syncJobs
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - operations
              properties:
                lastSyncAt:
                  type: string
                  format: date-time
                operations:
                  type: array
                  items:
                    type: object
                    required:
                      - type
                      - data
                      - clientId
                    properties:
                      type:
                        type: string
                        enum: [create, update, status_change, photo_upload]
                      clientId:
                        type: string
                        description: Client-generated operation ID
                      jobId:
                        type: string
                        format: uuid
                      data:
                        type: object
                      timestamp:
                        type: string
                        format: date-time
      responses:
        '200':
          description: Sync result
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      synced:
                        type: integer
                      conflicts:
                        type: array
                        items:
                          type: object
                          properties:
                            clientId:
                              type: string
                            jobId:
                              type: string
                            serverVersion:
                              type: object
                            resolution:
                              type: string
                              enum: [server_wins, client_wins, merged]
                      serverChanges:
                        type: array
                        items:
                          $ref: '#/components/schemas/Job'
        '401':
          $ref: '#/components/responses/Unauthorized'

  # ==========================================================================
  # INVOICE ENDPOINTS
  # ==========================================================================
  
  /invoices:
    get:
      tags:
        - Invoices
      summary: List invoices
      description: |
        Returns paginated list of invoices.
        Requires `accountant`, `admin`, or `owner` role.
      operationId: listInvoices
      parameters:
        - $ref: '#/components/parameters/Limit'
        - $ref: '#/components/parameters/Cursor'
        - name: status
          in: query
          schema:
            type: array
            items:
              $ref: '#/components/schemas/InvoiceStatus'
          style: form
          explode: false
        - name: invoiceType
          in: query
          schema:
            $ref: '#/components/schemas/InvoiceType'
        - name: customerId
          in: query
          schema:
            type: string
            format: uuid
        - $ref: '#/components/parameters/DateFrom'
        - $ref: '#/components/parameters/DateTo'
        - name: minAmount
          in: query
          schema:
            type: number
        - name: maxAmount
          in: query
          schema:
            type: number
        - name: sortBy
          in: query
          schema:
            type: string
            enum: [issueDate, createdAt, total, invoiceNumber]
            default: createdAt
        - name: sortOrder
          in: query
          schema:
            type: string
            enum: [asc, desc]
            default: desc
      responses:
        '200':
          description: Invoice list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InvoiceList'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
    
    post:
      tags:
        - Invoices
      summary: Create invoice
      description: |
        Creates a new invoice.
        If submitToAfip=true, automatically requests CAE.
        Requires `accountant`, `admin`, or `owner` role.
      operationId: createInvoice
      parameters:
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateInvoiceRequest'
      responses:
        '201':
          description: Invoice created
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/Invoice'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                no_items:
                  value:
                    success: false
                    error:
                      code: "INVOICE_001"
                      message: "Invoice must have at least one line item"
                negative_amount:
                  value:
                    success: false
                    error:
                      code: "INVOICE_002"
                      message: "Line item amount must be positive"
                      field: "lineItems[0].unitPrice"
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          description: Customer not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  
  /invoices/{invoiceId}:
    parameters:
      - $ref: '#/components/parameters/InvoiceId'
    
    get:
      tags:
        - Invoices
      summary: Get invoice
      description: Returns invoice details with line items
      operationId: getInvoice
      responses:
        '200':
          description: Invoice details
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/Invoice'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
    
    patch:
      tags:
        - Invoices
      summary: Update draft invoice
      description: |
        Updates a draft invoice.
        Cannot update invoices with CAE.
      operationId: updateInvoice
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                lineItems:
                  type: array
                  items:
                    $ref: '#/components/schemas/InvoiceLineItemInput'
                dueDate:
                  type: string
                  format: date
                notes:
                  type: string
      responses:
        '200':
          description: Invoice updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/Invoice'
        '400':
          description: Cannot update issued invoice
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                already_issued:
                  value:
                    success: false
                    error:
                      code: "INVOICE_003"
                      message: "Cannot modify invoice with CAE"
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
  
  /invoices/{invoiceId}/cae:
    parameters:
      - $ref: '#/components/parameters/InvoiceId'
    
    post:
      tags:
        - Invoices
      summary: Request CAE
      description: |
        Requests CAE from AFIP for draft invoice.
        May be queued if AFIP is slow/degraded.
        Idempotent - safe to retry.
      operationId: requestCae
      parameters:
        - $ref: '#/components/parameters/IdempotencyKey'
      responses:
        '200':
          description: CAE request result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RequestCaeResponse'
              examples:
                success:
                  value:
                    success: true
                    data:
                      status: "success"
                      cae: "71234567890123"
                      caeExpiry: "2025-01-25"
                      invoiceNumber: 1234
                      message: "CAE obtained successfully"
                queued:
                  value:
                    success: true
                    data:
                      status: "queued"
                      message: "AFIP is slow, request queued"
                      queuePosition: 3
        '400':
          description: Invalid invoice for CAE
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                already_has_cae:
                  value:
                    success: false
                    error:
                      code: "INVOICE_004"
                      message: "Invoice already has CAE"
                afip_not_configured:
                  value:
                    success: false
                    error:
                      code: "INVOICE_005"
                      message: "AFIP not configured for organization"
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '503':
          description: AFIP service unavailable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                panic_mode:
                  value:
                    success: false
                    error:
                      code: "AFIP_010"
                      message: "AFIP service in panic mode, invoice queued for later processing"
                      details:
                        queuePosition: 5
                        estimatedWait: 300
  
  /invoices/{invoiceId}/pdf:
    parameters:
      - $ref: '#/components/parameters/InvoiceId'
    
    get:
      tags:
        - Invoices
      summary: Get invoice PDF
      description: |
        Returns signed PDF of the invoice.
        Only available for invoices with CAE.
      operationId: getInvoicePdf
      responses:
        '200':
          description: Invoice PDF
          content:
            application/pdf:
              schema:
                type: string
                format: binary
        '400':
          description: PDF not available
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
  
  /invoices/{invoiceId}/send:
    parameters:
      - $ref: '#/components/parameters/InvoiceId'
    
    post:
      tags:
        - Invoices
      summary: Send invoice to customer
      description: |
        Sends invoice PDF to customer via WhatsApp and/or email.
        Requires invoice to have CAE.
      operationId: sendInvoice
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                channels:
                  type: array
                  items:
                    type: string
                    enum: [whatsapp, email]
                  default: [whatsapp]
                includePaymentLink:
                  type: boolean
                  default: true
      responses:
        '200':
          description: Invoice sent
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      whatsappSent:
                        type: boolean
                      emailSent:
                        type: boolean
                      paymentUrl:
                        type: string
                        format: uri
        '400':
          description: Cannot send invoice
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
  
  /invoices/{invoiceId}/cancel:
    parameters:
      - $ref: '#/components/parameters/InvoiceId'
    
    post:
      tags:
        - Invoices
      summary: Cancel invoice
      description: |
        Cancels an invoice.
        For issued invoices, creates credit note in AFIP.
        Requires `owner` role for issued invoices.
      operationId: cancelInvoice
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - reason
              properties:
                reason:
                  type: string
                  minLength: 10
                  maxLength: 500
      responses:
        '200':
          description: Invoice cancelled
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      invoice:
                        $ref: '#/components/schemas/Invoice'
                      creditNote:
                        $ref: '#/components/schemas/Invoice'
                        description: Credit note (for issued invoices)
        '400':
          description: Cannot cancel invoice
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                already_paid:
                  value:
                    success: false
                    error:
                      code: "INVOICE_006"
                      message: "Cannot cancel paid invoice. Process refund first."
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
  
  /invoices/afip-queue:
    get:
      tags:
        - Invoices
      summary: Get AFIP queue status
      description: Returns current AFIP queue status
      operationId: getAfipQueueStatus
      responses:
        '200':
          description: Queue status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AfipQueueStatus'
        '401':
          $ref: '#/components/responses/Unauthorized'
  
  /invoices/overdue:
    get:
      tags:
        - Invoices
      summary: Get overdue invoices
      description: Returns all overdue invoices
      operationId: getOverdueInvoices
      parameters:
        - $ref: '#/components/parameters/Limit'
        - $ref: '#/components/parameters/Cursor'
        - name: daysOverdue
          in: query
          schema:
            type: integer
            minimum: 1
          description: Minimum days overdue
      responses:
        '200':
          description: Overdue invoices
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InvoiceList'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  # ==========================================================================
  # PAYMENT ENDPOINTS
  # ==========================================================================
  
  /payments:
    get:
      tags:
        - Payments
      summary: List payments
      description: |
        Returns paginated list of payments.
        Requires `accountant`, `admin`, or `owner` role.
      operationId: listPayments
      parameters:
        - $ref: '#/components/parameters/Limit'
        - $ref: '#/components/parameters/Cursor'
        - name: status
          in: query
          schema:
            type: array
            items:
              $ref: '#/components/schemas/PaymentStatus'
          style: form
          explode: false
        - name: paymentMethod
          in: query
          schema:
            $ref: '#/components/schemas/PaymentMethod'
        - name: invoiceId
          in: query
          schema:
            type: string
            format: uuid
        - $ref: '#/components/parameters/DateFrom'
        - $ref: '#/components/parameters/DateTo'
        - name: sortBy
          in: query
          schema:
            type: string
            enum: [createdAt, amount, approvedAt]
            default: createdAt
        - name: sortOrder
          in: query
          schema:
            type: string
            enum: [asc, desc]
            default: desc
      responses:
        '200':
          description: Payment list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaymentList'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
  
  /payments/preference:
    post:
      tags:
        - Payments
      summary: Create payment preference
      description: |
        Creates Mercado Pago payment preference for an invoice.
        Returns payment URL and QR code for customer.
      operationId: createPaymentPreference
      parameters:
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreatePaymentPreferenceRequest'
      responses:
        '201':
          description: Payment preference created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaymentPreferenceResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                already_paid:
                  value:
                    success: false
                    error:
                      code: "PAYMENT_001"
                      message: "Invoice already paid"
                mp_not_connected:
                  value:
                    success: false
                    error:
                      code: "PAYMENT_002"
                      message: "Mercado Pago not connected"
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          description: Invoice not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  
  /payments/{paymentId}:
    parameters:
      - $ref: '#/components/parameters/PaymentId'
    
    get:
      tags:
        - Payments
      summary: Get payment
      description: Returns payment details
      operationId: getPayment
      responses:
        '200':
          description: Payment details
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/Payment'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
  
  /payments/{paymentId}/refund:
    parameters:
      - $ref: '#/components/parameters/PaymentId'
    
    post:
      tags:
        - Payments
      summary: Refund payment
      description: |
        Processes full or partial refund through Mercado Pago.
        Requires `owner` role.
      operationId: refundPayment
      parameters:
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RefundRequest'
            examples:
              full_refund:
                summary: Full refund
                value:
                  reason: "Customer requested cancellation"
              partial_refund:
                summary: Partial refund
                value:
                  amount: 5000.00
                  reason: "Service not fully completed"
      responses:
        '200':
          description: Refund processed
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/Payment'
        '400':
          description: Cannot refund
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                already_refunded:
                  value:
                    success: false
                    error:
                      code: "PAYMENT_003"
                      message: "Payment already fully refunded"
                amount_too_large:
                  value:
                    success: false
                    error:
                      code: "PAYMENT_004"
                      message: "Refund amount exceeds available balance"
                      details:
                        available: 5000.00
                        requested: 10000.00
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
  
  /payments/webhook/mercadopago:
    post:
      tags:
        - Payments
      summary: Mercado Pago webhook
      description: |
        Receives payment notifications from Mercado Pago.
        Validates webhook signature.
        Internal endpoint - called by Mercado Pago.
      operationId: mpWebhook
      security: []
      parameters:
        - name: x-signature
          in: header
          required: true
          schema:
            type: string
          description: MP webhook signature
        - name: x-request-id
          in: header
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MpWebhookPayload'
      responses:
        '200':
          description: Webhook processed
        '400':
          description: Invalid webhook
        '401':
          description: Invalid signature
  
  /payments/reconcile:
    post:
      tags:
        - Payments
      summary: Reconcile payments
      description: |
        Reconciles payments with Mercado Pago.
        Detects and reports discrepancies.
        Requires `owner` role.
      operationId: reconcilePayments
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                dateFrom:
                  type: string
                  format: date
                dateTo:
                  type: string
                  format: date
                autoFix:
                  type: boolean
                  default: false
                  description: Automatically fix discrepancies
      responses:
        '200':
          description: Reconciliation result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReconcileResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
  
  /payments/disputes:
    get:
      tags:
        - Payments
      summary: List payment disputes
      description: Returns all payment disputes/chargebacks
      operationId: listDisputes
      parameters:
        - $ref: '#/components/parameters/Limit'
        - $ref: '#/components/parameters/Cursor'
        - name: status
          in: query
          schema:
            type: string
            enum: [pending_response, evidence_submitted, under_review, won, lost]
      responses:
        '200':
          description: Dispute list
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: string
                          format: uuid
                        paymentId:
                          type: string
                          format: uuid
                        mpDisputeId:
                          type: string
                        disputeType:
                          type: string
                        status:
                          type: string
                        amount:
                          type: number
                        reason:
                          type: string
                        responseDeadline:
                          type: string
                          format: date-time
                        createdAt:
                          type: string
                          format: date-time
                  pagination:
                    $ref: '#/components/schemas/PaginationMeta'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
  
  /payments/disputes/{disputeId}/evidence:
    parameters:
      - name: disputeId
        in: path
        required: true
        schema:
          type: string
          format: uuid
    
    post:
      tags:
        - Payments
      summary: Submit dispute evidence
      description: Submits evidence for a payment dispute
      operationId: submitDisputeEvidence
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - description
              properties:
                description:
                  type: string
                  maxLength: 2000
                documents:
                  type: array
                  items:
                    type: string
                    format: binary
                  maxItems: 10
      responses:
        '200':
          description: Evidence submitted
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      status:
                        type: string
                      evidenceUrls:
                        type: array
                        items:
                          type: string
        '400':
          description: Cannot submit evidence
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
  
  /payments/record-cash:
    post:
      tags:
        - Payments
      summary: Record cash payment
      description: |
        Records a cash or transfer payment for an invoice.
        Does not use Mercado Pago.
      operationId: recordCashPayment
      parameters:
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - invoiceId
                - amount
                - paymentMethod
              properties:
                invoiceId:
                  type: string
                  format: uuid
                amount:
                  type: number
                  format: double
                  minimum: 0.01
                paymentMethod:
                  type: string
                  enum: [cash, bank_transfer, check]
                notes:
                  type: string
                receivedAt:
                  type: string
                  format: date-time
      responses:
        '201':
          description: Payment recorded
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/Payment'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

# ============================================================================
# PATHS - API Endpoints
# ============================================================================

paths:
  # ==========================================================================
  # AUTH ENDPOINTS
  # ==========================================================================
  
  /auth/otp/send:
    post:
      tags:
        - Auth
      summary: Send OTP code
      description: |
        Sends a 6-digit OTP code to the provided phone number via WhatsApp.
        Code expires in 5 minutes. Rate limited to 3 requests per phone per hour.
      operationId: sendOtp
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SendOtpRequest'
      responses:
        '200':
          description: OTP sent successfully
          headers:
            X-Request-Id:
              $ref: '#/components/headers/X-Request-Id'
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SendOtpResponse'
        '400':
          description: Invalid phone number format
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error:
                  code: "AUTH_001"
                  message: "Invalid phone number format. Must be +54 followed by 10-11 digits"
                  field: "phone"
        '429':
          description: Rate limit exceeded
          headers:
            Retry-After:
              schema:
                type: integer
              description: Seconds until retry allowed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error:
                  code: "AUTH_002"
                  message: "Too many OTP requests. Please wait 60 seconds"
                  details:
                    retryAfter: 60
        '503':
          description: WhatsApp service unavailable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error:
                  code: "AUTH_003"
                  message: "Unable to send OTP. SMS fallback attempted."

  /auth/otp/verify:
    post:
      tags:
        - Auth
      summary: Verify OTP and get tokens
      description: |
        Verifies the OTP code and returns JWT tokens.
        Creates a new user and organization if this is the first login for this phone.
      operationId: verifyOtp
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/VerifyOtpRequest'
      responses:
        '200':
          description: OTP verified, tokens returned
          headers:
            X-Request-Id:
              $ref: '#/components/headers/X-Request-Id'
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VerifyOtpResponse'
        '400':
          description: Invalid or expired OTP
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalidCode:
                  summary: Invalid code
                  value:
                    success: false
                    error:
                      code: "AUTH_010"
                      message: "Invalid OTP code"
                      field: "code"
                expiredCode:
                  summary: Expired code
                  value:
                    success: false
                    error:
                      code: "AUTH_011"
                      message: "OTP code has expired. Please request a new one"
        '429':
          description: Too many verification attempts
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/refresh:
    post:
      tags:
        - Auth
      summary: Refresh access token
      description: Exchange refresh token for new access and refresh tokens
      operationId: refreshToken
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RefreshTokenRequest'
      responses:
        '200':
          description: Tokens refreshed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RefreshTokenResponse'
        '401':
          description: Invalid or expired refresh token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error:
                  code: "AUTH_020"
                  message: "Invalid or expired refresh token"

  /auth/logout:
    post:
      tags:
        - Auth
      summary: Logout and invalidate tokens
      description: Invalidates the current refresh token
      operationId: logout
      responses:
        '200':
          description: Logged out successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/me:
    get:
      tags:
        - Auth
      summary: Get current user
      description: Returns the authenticated user's profile and organization
      operationId: getCurrentUser
      responses:
        '200':
          description: Current user profile
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/UserMe'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # ==========================================================================
  # ORGANIZATION ENDPOINTS
  # ==========================================================================

  /organization:
    get:
      tags:
        - Organization
      summary: Get organization details
      description: Returns the authenticated user's organization settings
      operationId: getOrganization
      responses:
        '200':
          description: Organization details
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/Organization'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    patch:
      tags:
        - Organization
      summary: Update organization
      description: |
        Updates organization settings. Only owners and admins can update.
        CUIT and IVA condition cannot be changed after AFIP certificate is uploaded.
      operationId: updateOrganization
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateOrganizationRequest'
      responses:
        '200':
          description: Organization updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/Organization'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Insufficient permissions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error:
                  code: "ORG_001"
                  message: "Only owners and admins can update organization settings"

  /organization/afip:
    get:
      tags:
        - Organization
      summary: Get AFIP status
      description: Returns AFIP configuration status and service health
      operationId: getAfipStatus
      responses:
        '200':
          description: AFIP status
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/AfipStatus'

  /organization/afip/certificate:
    post:
      tags:
        - Organization
      summary: Upload AFIP certificate
      description: |
        Uploads AFIP certificate and private key for electronic invoicing.
        Certificate must be valid and match the organization's CUIT.
        Only owners can upload certificates.
      operationId: uploadAfipCertificate
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UploadAfipCertRequest'
      responses:
        '200':
          description: Certificate uploaded successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/AfipStatus'
        '400':
          description: Invalid certificate
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalidCert:
                  summary: Invalid certificate format
                  value:
                    success: false
                    error:
                      code: "AFIP_001"
                      message: "Invalid certificate format"
                cuitMismatch:
                  summary: CUIT mismatch
                  value:
                    success: false
                    error:
                      code: "AFIP_002"
                      message: "Certificate CUIT does not match organization CUIT"
                expired:
                  summary: Expired certificate
                  value:
                    success: false
                    error:
                      code: "AFIP_003"
                      message: "Certificate has expired"
        '403':
          description: Only owners can upload certificates
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    delete:
      tags:
        - Organization
      summary: Remove AFIP certificate
      description: |
        Removes AFIP certificate. Requires no pending invoices.
        Only owners can remove certificates.
      operationId: removeAfipCertificate
      responses:
        '200':
          description: Certificate removed
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
        '400':
          description: Cannot remove - pending invoices exist
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Only owners can remove certificates
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /organization/afip/test:
    post:
      tags:
        - Organization
      summary: Test AFIP connection
      description: Tests connection to AFIP web services
      operationId: testAfipConnection
      responses:
        '200':
          description: Connection test result
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      connected:
                        type: boolean
                      latency:
                        type: integer
                      serverStatus:
                        type: string
                      lastInvoiceA:
                        type: integer
                      lastInvoiceB:
                        type: integer
                      lastInvoiceC:
                        type: integer

  /organization/mercadopago/connect:
    post:
      tags:
        - Organization
      summary: Start Mercado Pago OAuth
      description: |
        Initiates OAuth flow to connect Mercado Pago account.
        Returns URL to redirect user for authorization.
      operationId: connectMercadoPago
      responses:
        '200':
          description: OAuth URL generated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MpConnectResponse'
        '400':
          description: Already connected
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /organization/mercadopago/callback:
    get:
      tags:
        - Organization
      summary: Mercado Pago OAuth callback
      description: Handles OAuth callback from Mercado Pago
      operationId: mercadoPagoCallback
      parameters:
        - name: code
          in: query
          required: true
          schema:
            type: string
        - name: state
          in: query
          required: true
          schema:
            type: string
      responses:
        '302':
          description: Redirect to app with result
        '400':
          description: Invalid callback
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /organization/mercadopago/disconnect:
    post:
      tags:
        - Organization
      summary: Disconnect Mercado Pago
      description: |
        Revokes Mercado Pago access. Requires no pending payments.
        Only owners can disconnect.
      operationId: disconnectMercadoPago
      responses:
        '200':
          description: Disconnected
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
        '400':
          description: Pending payments exist
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Only owners can disconnect
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /organization/users:
    get:
      tags:
        - Organization
      summary: List organization users
      description: Returns all users in the organization
      operationId: listUsers
      parameters:
        - name: role
          in: query
          schema:
            $ref: '#/components/schemas/UserRole'
        - name: isActive
          in: query
          schema:
            type: boolean
      responses:
        '200':
          description: User list
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/User'

    post:
      tags:
        - Organization
      summary: Invite user
      description: |
        Invites a new user to the organization.
        Sends invitation via WhatsApp.
      operationId: inviteUser
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - phone
                - role
                - fullName
              properties:
                phone:
                  type: string
                  pattern: '^\+54[0-9]{10,11}$'
                role:
                  $ref: '#/components/schemas/UserRole'
                fullName:
                  type: string
                  minLength: 2
                  maxLength: 100
      responses:
        '201':
          description: User invited
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/User'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Cannot invite this role
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: User already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /organization/users/{userId}:
    parameters:
      - name: userId
        in: path
        required: true
        schema:
          type: string
          format: uuid

    patch:
      tags:
        - Organization
      summary: Update user
      description: Update user role or status
      operationId: updateUser
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                role:
                  $ref: '#/components/schemas/UserRole'
                isActive:
                  type: boolean
      responses:
        '200':
          description: User updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/User'
        '403':
          description: Cannot modify this user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    delete:
      tags:
        - Organization
      summary: Remove user
      description: |
        Removes user from organization.
        Reassigns their jobs to unassigned.
      operationId: removeUser
      responses:
        '200':
          description: User removed
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      reassignedJobs:
                        type: integer
        '403':
          description: Cannot remove this user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # ==========================================================================
  # WHATSAPP ENDPOINTS
  # ==========================================================================
  
  /whatsapp/conversations:
    get:
      tags:
        - WhatsApp
      summary: List conversations
      description: |
        Returns list of WhatsApp conversations grouped by customer.
        Sorted by last message time.
      operationId: listConversations
      parameters:
        - $ref: '#/components/parameters/Limit'
        - $ref: '#/components/parameters/Cursor'
        - name: unreadOnly
          in: query
          schema:
            type: boolean
            default: false
      responses:
        '200':
          description: Conversation list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConversationList'
        '401':
          $ref: '#/components/responses/Unauthorized'
  
  /whatsapp/conversations/{customerId}:
    parameters:
      - $ref: '#/components/parameters/CustomerId'
    
    get:
      tags:
        - WhatsApp
      summary: Get conversation messages
      description: Returns messages for a customer conversation
      operationId: getConversationMessages
      parameters:
        - $ref: '#/components/parameters/Limit'
        - $ref: '#/components/parameters/Cursor'
        - name: before
          in: query
          schema:
            type: string
            format: date-time
          description: Get messages before this timestamp
      responses:
        '200':
          description: Message list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageList'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
  
  /whatsapp/conversations/{customerId}/read:
    parameters:
      - $ref: '#/components/parameters/CustomerId'
    
    post:
      tags:
        - WhatsApp
      summary: Mark conversation as read
      description: Marks all messages in conversation as read
      operationId: markConversationRead
      responses:
        '200':
          description: Marked as read
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
  
  /whatsapp/send:
    post:
      tags:
        - WhatsApp
      summary: Send message
      description: |
        Sends a WhatsApp message to a customer.
        Uses templates for business-initiated messages.
        Free text only allowed within 24h reply window.
      operationId: sendWhatsappMessage
      parameters:
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SendMessageRequest'
            examples:
              template:
                summary: Template message
                value:
                  customerId: "550e8400-e29b-41d4-a716-446655440000"
                  jobId: "660e8400-e29b-41d4-a716-446655440000"
                  templateName: "job_scheduled"
                  templateParams:
                    - "María"
                    - "mañana"
                    - "10:00"
              reply:
                summary: Reply within window
                value:
                  customerId: "550e8400-e29b-41d4-a716-446655440000"
                  text: "Sí, confirmado para las 10:00. Gracias!"
      responses:
        '200':
          description: Message sent
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SendMessageResponse'
        '400':
          description: Cannot send message
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                outside_window:
                  value:
                    success: false
                    error:
                      code: "WHATSAPP_001"
                      message: "Cannot send free text outside 24h window. Use template."
                      details:
                        lastMessageAt: "2025-01-08T10:00:00Z"
                        windowExpires: "2025-01-09T10:00:00Z"
                invalid_template:
                  value:
                    success: false
                    error:
                      code: "WHATSAPP_002"
                      message: "Template not found or not approved"
                      field: "templateName"
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '429':
          description: Rate limit exceeded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  
  /whatsapp/templates:
    get:
      tags:
        - WhatsApp
      summary: List templates
      description: Returns available WhatsApp message templates
      operationId: listTemplates
      parameters:
        - name: category
          in: query
          schema:
            type: string
            enum: [MARKETING, UTILITY, AUTHENTICATION]
        - name: status
          in: query
          schema:
            type: string
            enum: [APPROVED, PENDING, REJECTED]
      responses:
        '200':
          description: Template list
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/WhatsAppTemplate'
        '401':
          $ref: '#/components/responses/Unauthorized'
  
  /whatsapp/templates/preview:
    post:
      tags:
        - WhatsApp
      summary: Preview template
      description: Returns rendered template with parameters
      operationId: previewTemplate
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - templateName
              properties:
                templateName:
                  type: string
                params:
                  type: array
                  items:
                    type: string
      responses:
        '200':
          description: Template preview
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      rendered:
                        type: string
                      mediaUrl:
                        type: string
        '400':
          description: Invalid template
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
  
  /whatsapp/webhook:
    post:
      tags:
        - WhatsApp
      summary: WhatsApp webhook
      description: |
        Receives messages and status updates from WhatsApp Business API.
        Validates webhook signature.
        Internal endpoint - called by Meta.
      operationId: whatsappWebhook
      security: []
      parameters:
        - name: hub.mode
          in: query
          schema:
            type: string
        - name: hub.verify_token
          in: query
          schema:
            type: string
        - name: hub.challenge
          in: query
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              type: object
      responses:
        '200':
          description: Webhook processed
        '403':
          description: Invalid signature
    
    get:
      tags:
        - WhatsApp
      summary: WhatsApp webhook verification
      description: Handles webhook verification from Meta
      operationId: verifyWhatsappWebhook
      security: []
      parameters:
        - name: hub.mode
          in: query
          required: true
          schema:
            type: string
        - name: hub.verify_token
          in: query
          required: true
          schema:
            type: string
        - name: hub.challenge
          in: query
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Challenge response
          content:
            text/plain:
              schema:
                type: string
        '403':
          description: Invalid verify token
  
  /whatsapp/messages/{messageId}:
    parameters:
      - $ref: '#/components/parameters/MessageId'
    
    get:
      tags:
        - WhatsApp
      summary: Get message
      description: Returns message details
      operationId: getWhatsappMessage
      responses:
        '200':
          description: Message details
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/WhatsAppMessage'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
  
  /whatsapp/messages/{messageId}/media:
    parameters:
      - $ref: '#/components/parameters/MessageId'
    
    get:
      tags:
        - WhatsApp
      summary: Get message media
      description: Returns media file for image/document messages
      operationId: getMessageMedia
      responses:
        '200':
          description: Media file
          content:
            '*/*':
              schema:
                type: string
                format: binary
        '404':
          $ref: '#/components/responses/NotFound'

  # ==========================================================================
  # CUSTOMER ENDPOINTS
  # ==========================================================================

  /customers:
    get:
      tags:
        - Customers
      summary: List customers
      description: |
        Returns paginated list of customers.
        Supports search, filtering, and sorting.
      operationId: listCustomers
      parameters:
        - $ref: '#/components/parameters/Limit'
        - $ref: '#/components/parameters/Cursor'
        - $ref: '#/components/parameters/Search'
        - name: neighborhood
          in: query
          schema:
            type: string
        - name: hasWhatsapp
          in: query
          schema:
            type: boolean
        - name: tags
          in: query
          schema:
            type: array
            items:
              type: string
          style: form
          explode: false
        - name: sortBy
          in: query
          schema:
            type: string
            enum: [name, createdAt, lastMessageAt, jobCount, totalRevenue]
            default: name
        - name: sortOrder
          in: query
          schema:
            type: string
            enum: [asc, desc]
            default: asc
      responses:
        '200':
          description: Customer list
          headers:
            X-RateLimit-Limit:
              $ref: '#/components/headers/X-RateLimit-Limit'
            X-RateLimit-Remaining:
              $ref: '#/components/headers/X-RateLimit-Remaining'
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CustomerList'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    post:
      tags:
        - Customers
      summary: Create customer
      description: Creates a new customer
      operationId: createCustomer
      parameters:
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateCustomerRequest'
      responses:
        '201':
          description: Customer created
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/Customer'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalidPhone:
                  summary: Invalid phone
                  value:
                    success: false
                    error:
                      code: "CUSTOMER_001"
                      message: "Invalid phone number format"
                      field: "phone"
                invalidCuit:
                  summary: Invalid CUIT
                  value:
                    success: false
                    error:
                      code: "CUSTOMER_002"
                      message: "Invalid CUIT checksum"
                      field: "docNumber"
        '409':
          description: Customer with phone already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error:
                  code: "CUSTOMER_010"
                  message: "Customer with this phone number already exists"
                  details:
                    existingCustomerId: "550e8400-e29b-41d4-a716-446655440000"

  /customers/{customerId}:
    parameters:
      - $ref: '#/components/parameters/CustomerId'

    get:
      tags:
        - Customers
      summary: Get customer
      description: Returns customer details with job history summary
      operationId: getCustomer
      responses:
        '200':
          description: Customer details
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/Customer'
        '404':
          description: Customer not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error:
                  code: "CUSTOMER_404"
                  message: "Customer not found"

    patch:
      tags:
        - Customers
      summary: Update customer
      description: Updates customer details
      operationId: updateCustomer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateCustomerRequest'
      responses:
        '200':
          description: Customer updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/Customer'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Customer not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: Phone number conflict
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    delete:
      tags:
        - Customers
      summary: Delete customer
      description: |
        Soft-deletes customer. Cannot delete if has unpaid invoices.
        Jobs are preserved for historical records.
      operationId: deleteCustomer
      responses:
        '200':
          description: Customer deleted
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
        '400':
          description: Cannot delete - has unpaid invoices
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error:
                  code: "CUSTOMER_020"
                  message: "Cannot delete customer with unpaid invoices"
                  details:
                    unpaidInvoices: 2
                    totalOwed: 25000.00
        '404':
          description: Customer not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /customers/{customerId}/jobs:
    parameters:
      - $ref: '#/components/parameters/CustomerId'

    get:
      tags:
        - Customers
      summary: List customer jobs
      description: Returns all jobs for a customer
      operationId: listCustomerJobs
      parameters:
        - $ref: '#/components/parameters/Limit'
        - $ref: '#/components/parameters/Cursor'
        - name: status
          in: query
          schema:
            $ref: '#/components/schemas/JobStatus'
      responses:
        '200':
          description: Job list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JobList'
        '404':
          description: Customer not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /customers/{customerId}/invoices:
    parameters:
      - $ref: '#/components/parameters/CustomerId'

    get:
      tags:
        - Customers
      summary: List customer invoices
      description: Returns all invoices for a customer
      operationId: listCustomerInvoices
      parameters:
        - $ref: '#/components/parameters/Limit'
        - $ref: '#/components/parameters/Cursor'
        - name: status
          in: query
          schema:
            $ref: '#/components/schemas/InvoiceStatus'
      responses:
        '200':
          description: Invoice list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InvoiceList'
        '404':
          description: Customer not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /customers/validate-cuit:
    post:
      tags:
        - Customers
      summary: Validate CUIT
      description: |
        Validates CUIT format and checks against AFIP padron.
        Returns company name and IVA condition if found.
      operationId: validateCuit
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ValidateCuitRequest'
      responses:
        '200':
          description: Validation result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidateCuitResponse'
        '400':
          description: Invalid format
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /customers/search:
    get:
      tags:
        - Customers
      summary: Search customers
      description: |
        Fast search by name or phone.
        Uses trigram index for fuzzy matching.
      operationId: searchCustomers
      parameters:
        - name: q
          in: query
          required: true
          schema:
            type: string
            minLength: 2
            maxLength: 100
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 20
            default: 10
      responses:
        '200':
          description: Search results
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/CustomerSummary'

  # ==========================================================================
  # VOICE AI ENDPOINTS
  # ==========================================================================
  
  /voice/process:
    post:
      tags:
        - Voice
      summary: Process voice message
      description: |
        Queues a voice message for transcription and extraction.
        Uses Whisper for transcription and GPT-4 for extraction.
      operationId: processVoiceMessage
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProcessVoiceRequest'
      responses:
        '202':
          description: Voice processing queued
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProcessVoiceResponse'
        '400':
          description: Invalid message
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                not_voice:
                  value:
                    success: false
                    error:
                      code: "VOICE_001"
                      message: "Message is not a voice message"
                already_processed:
                  value:
                    success: false
                    error:
                      code: "VOICE_002"
                      message: "Voice message already processed"
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
  
  /voice/transcripts/{transcriptId}:
    parameters:
      - name: transcriptId
        in: path
        required: true
        schema:
          type: string
          format: uuid
    
    get:
      tags:
        - Voice
      summary: Get transcript
      description: Returns voice transcript with extraction data
      operationId: getVoiceTranscript
      responses:
        '200':
          description: Transcript details
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/VoiceTranscript'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
  
  /voice/review-queue:
    get:
      tags:
        - Voice
      summary: Get review queue
      description: |
        Returns voice messages requiring human review.
        Messages below confidence threshold appear here.
      operationId: getVoiceReviewQueue
      parameters:
        - $ref: '#/components/parameters/Limit'
        - $ref: '#/components/parameters/Cursor'
        - name: status
          in: query
          schema:
            type: string
            enum: [needs_review, reviewed]
      responses:
        '200':
          description: Review queue
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VoiceQueueResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
  
  /voice/transcripts/{transcriptId}/review:
    parameters:
      - name: transcriptId
        in: path
        required: true
        schema:
          type: string
          format: uuid
    
    post:
      tags:
        - Voice
      summary: Submit human review
      description: |
        Submits human review for a voice transcript.
        Can approve, edit, or reject the AI extraction.
        Optionally creates job from reviewed data.
      operationId: submitVoiceReview
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SubmitReviewRequest'
            examples:
              approve:
                summary: Approve AI extraction
                value:
                  action: "approve"
                  createJob: true
              edit:
                summary: Edit extraction
                value:
                  action: "edit"
                  humanTranscription: "Corrected transcription text"
                  humanExtraction:
                    customerName:
                      value: "María López"
                      confidence: 1.0
                    phone:
                      value: "+5491155555555"
                      confidence: 1.0
                    address:
                      value: "Av. Corrientes 1234"
                      confidence: 0.95
                    problemDescription:
                      value: "Pérdida de agua en el baño"
                      confidence: 0.9
                  createJob: true
              reject:
                summary: Reject as unusable
                value:
                  action: "reject"
                  createJob: false
      responses:
        '200':
          description: Review submitted
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      transcript:
                        $ref: '#/components/schemas/VoiceTranscript'
                      job:
                        $ref: '#/components/schemas/Job'
                        description: Created job (if createJob=true)
        '400':
          description: Invalid review
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
  
  /voice/transcripts/{transcriptId}/audio:
    parameters:
      - name: transcriptId
        in: path
        required: true
        schema:
          type: string
          format: uuid
    
    get:
      tags:
        - Voice
      summary: Get audio file
      description: Returns original audio file for playback
      operationId: getVoiceAudio
      responses:
        '200':
          description: Audio file
          content:
            audio/ogg:
              schema:
                type: string
                format: binary
            audio/mpeg:
              schema:
                type: string
                format: binary
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
  
  /voice/stats:
    get:
      tags:
        - Voice
      summary: Get voice processing stats
      description: Returns statistics about voice AI processing
      operationId: getVoiceStats
      parameters:
        - $ref: '#/components/parameters/DateFrom'
        - $ref: '#/components/parameters/DateTo'
      responses:
        '200':
          description: Voice stats
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VoiceStatsResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
  
  /voice/settings:
    get:
      tags:
        - Voice
      summary: Get voice settings
      description: Returns voice AI settings for organization
      operationId: getVoiceSettings
      responses:
        '200':
          description: Voice settings
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      autoCreateThreshold:
                        type: number
                        description: Confidence threshold for auto-creating jobs
                      autoProcessEnabled:
                        type: boolean
                      defaultJobType:
                        $ref: '#/components/schemas/JobType'
                      defaultPriority:
                        $ref: '#/components/schemas/JobPriority'
        '401':
          $ref: '#/components/responses/Unauthorized'
    
    patch:
      tags:
        - Voice
      summary: Update voice settings
      description: |
        Updates voice AI settings.
        Requires `admin` or `owner` role.
      operationId: updateVoiceSettings
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                autoCreateThreshold:
                  type: number
                  minimum: 0
                  maximum: 1
                autoProcessEnabled:
                  type: boolean
                defaultJobType:
                  $ref: '#/components/schemas/JobType'
                defaultPriority:
                  $ref: '#/components/schemas/JobPriority'
      responses:
        '200':
          description: Settings updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  # ==========================================================================
  # ADMIN ENDPOINTS
  # ==========================================================================
  
  /admin/health:
    get:
      tags:
        - Admin
      summary: Health check
      description: Returns system health status
      operationId: healthCheck
      security: []
      responses:
        '200':
          description: System healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
        '503':
          description: System unhealthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
  
  /admin/queues:
    get:
      tags:
        - Admin
      summary: Get queue status
      description: |
        Returns status of all background job queues.
        Requires `admin` or `owner` role.
      operationId: getQueueStatus
      responses:
        '200':
          description: Queue status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QueueStatusResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
  
  /admin/dlq:
    get:
      tags:
        - Admin
      summary: Get dead letter queue
      description: |
        Returns items in dead letter queue.
        Requires `admin` or `owner` role.
      operationId: getDlq
      parameters:
        - $ref: '#/components/parameters/Limit'
        - $ref: '#/components/parameters/Cursor'
        - name: queue
          in: query
          schema:
            type: string
          description: Filter by queue name
        - name: status
          in: query
          schema:
            type: string
            enum: [pending, retried, discarded, resolved]
      responses:
        '200':
          description: DLQ items
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DlqListResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
  
  /admin/dlq/{itemId}/retry:
    parameters:
      - name: itemId
        in: path
        required: true
        schema:
          type: string
          format: uuid
    
    post:
      tags:
        - Admin
      summary: Retry DLQ item
      description: |
        Retries a failed job from DLQ.
        Requires `admin` or `owner` role.
      operationId: retryDlqItem
      responses:
        '200':
          description: Item queued for retry
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      status:
                        type: string
                      queuePosition:
                        type: integer
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
  
  /admin/dlq/{itemId}/discard:
    parameters:
      - name: itemId
        in: path
        required: true
        schema:
          type: string
          format: uuid
    
    post:
      tags:
        - Admin
      summary: Discard DLQ item
      description: |
        Marks DLQ item as discarded (won't be retried).
        Requires `admin` or `owner` role.
      operationId: discardDlqItem
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - reason
              properties:
                reason:
                  type: string
                  minLength: 10
      responses:
        '200':
          description: Item discarded
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
  
  /admin/panic:
    get:
      tags:
        - Admin
      summary: Get panic status
      description: |
        Returns current panic mode status for all services.
        Requires `admin` or `owner` role.
      operationId: getPanicStatus
      responses:
        '200':
          description: Panic status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PanicStatusResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
  
  /admin/panic/{service}:
    parameters:
      - name: service
        in: path
        required: true
        schema:
          type: string
          enum: [afip, mercadopago, whatsapp, voiceai]
    
    patch:
      tags:
        - Admin
      summary: Set panic status
      description: |
        Manually sets panic mode for a service.
        Requires `owner` role.
      operationId: setPanicStatus
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SetPanicStatusRequest'
      responses:
        '200':
          description: Panic status updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/ServicePanicStatus'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
  
  /admin/metrics:
    get:
      tags:
        - Admin
      summary: Get metrics
      description: |
        Returns system metrics for dashboard.
        Requires `admin` or `owner` role.
      operationId: getMetrics
      parameters:
        - name: period
          in: query
          schema:
            type: string
            enum: [1h, 24h, 7d, 30d]
            default: 24h
      responses:
        '200':
          description: System metrics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MetricsResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
  
  /admin/audit-log:
    get:
      tags:
        - Admin
      summary: Get audit log
      description: |
        Returns audit log entries.
        Requires `owner` role.
      operationId: getAuditLog
      parameters:
        - $ref: '#/components/parameters/Limit'
        - $ref: '#/components/parameters/Cursor'
        - name: action
          in: query
          schema:
            type: string
          description: Filter by action type
        - name: userId
          in: query
          schema:
            type: string
            format: uuid
          description: Filter by user
        - name: entityType
          in: query
          schema:
            type: string
          description: Filter by entity type
        - name: entityId
          in: query
          schema:
            type: string
            format: uuid
          description: Filter by entity ID
        - $ref: '#/components/parameters/DateFrom'
        - $ref: '#/components/parameters/DateTo'
      responses:
        '200':
          description: Audit log entries
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: string
                          format: uuid
                        action:
                          type: string
                        userId:
                          type: string
                          format: uuid
                        userEmail:
                          type: string
                        entityType:
                          type: string
                        entityId:
                          type: string
                          format: uuid
                        oldData:
                          type: object
                        newData:
                          type: object
                        ipAddress:
                          type: string
                        userAgent:
                          type: string
                        createdAt:
                          type: string
                          format: date-time
                  pagination:
                    $ref: '#/components/schemas/PaginationMeta'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
  
  /admin/price-book:
    get:
      tags:
        - Admin
      summary: List price book
      description: Returns price book items
      operationId: listPriceBook
      parameters:
        - $ref: '#/components/parameters/Limit'
        - $ref: '#/components/parameters/Cursor'
        - name: category
          in: query
          schema:
            type: string
            enum: [mano_de_obra, materiales, consumibles, viatico]
        - name: jobType
          in: query
          schema:
            $ref: '#/components/schemas/JobType'
        - $ref: '#/components/parameters/Search'
      responses:
        '200':
          description: Price book items
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: string
                          format: uuid
                        code:
                          type: string
                        description:
                          type: string
                        category:
                          type: string
                        jobType:
                          $ref: '#/components/schemas/JobType'
                        unit:
                          type: string
                        basePrice:
                          type: number
                        taxRate:
                          type: number
                        regionPrices:
                          type: object
                          additionalProperties:
                            type: number
                        complexityMultipliers:
                          type: object
                        afipCode:
                          type: string
                        isActive:
                          type: boolean
                  pagination:
                    $ref: '#/components/schemas/PaginationMeta'
        '401':
          $ref: '#/components/responses/Unauthorized'
    
    post:
      tags:
        - Admin
      summary: Create price book item
      description: |
        Creates a new price book item.
        Requires `admin` or `owner` role.
      operationId: createPriceBookItem
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - code
                - description
                - basePrice
              properties:
                code:
                  type: string
                  maxLength: 50
                description:
                  type: string
                  maxLength: 500
                category:
                  type: string
                  enum: [mano_de_obra, materiales, consumibles, viatico]
                jobType:
                  $ref: '#/components/schemas/JobType'
                unit:
                  type: string
                  default: unidad
                basePrice:
                  type: number
                  minimum: 0
                taxRate:
                  type: number
                  default: 21
                regionPrices:
                  type: object
                  additionalProperties:
                    type: number
                afipCode:
                  type: string
      responses:
        '201':
          description: Price book item created
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '409':
          description: Code already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  
  /admin/price-book/{itemId}:
    parameters:
      - name: itemId
        in: path
        required: true
        schema:
          type: string
          format: uuid
    
    patch:
      tags:
        - Admin
      summary: Update price book item
      description: |
        Updates a price book item.
        Requires `admin` or `owner` role.
      operationId: updatePriceBookItem
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                description:
                  type: string
                basePrice:
                  type: number
                regionPrices:
                  type: object
                taxRate:
                  type: number
                isActive:
                  type: boolean
      responses:
        '200':
          description: Price book item updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
    
    delete:
      tags:
        - Admin
      summary: Delete price book item
      description: |
        Soft deletes a price book item.
        Requires `owner` role.
      operationId: deletePriceBookItem
      responses:
        '200':
          description: Price book item deleted
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

# ============================================================================
# COMMON RESPONSES
# ============================================================================

  responses:
    Unauthorized:
      description: Authentication required or token invalid
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          examples:
            missing_token:
              value:
                success: false
                error:
                  code: "AUTH_100"
                  message: "Authentication required"
            invalid_token:
              value:
                success: false
                error:
                  code: "AUTH_101"
                  message: "Invalid or expired token"
            token_revoked:
              value:
                success: false
                error:
                  code: "AUTH_102"
                  message: "Token has been revoked"
    
    Forbidden:
      description: Insufficient permissions
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          examples:
            insufficient_role:
              value:
                success: false
                error:
                  code: "AUTH_200"
                  message: "Insufficient permissions for this operation"
                  details:
                    requiredRole: "admin"
                    currentRole: "technician"
    
    BadRequest:
      description: Invalid request parameters
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          examples:
            validation_error:
              value:
                success: false
                error:
                  code: "VALIDATION_001"
                  message: "Invalid request parameters"
                  details:
                    errors:
                      - field: "email"
                        message: "Invalid email format"
                      - field: "phone"
                        message: "Phone number required"
    
    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          examples:
            not_found:
              value:
                success: false
                error:
                  code: "NOT_FOUND"
                  message: "Resource not found"
    
    RateLimited:
      description: Rate limit exceeded
      headers:
        X-RateLimit-Limit:
          $ref: '#/components/headers/X-RateLimit-Limit'
        X-RateLimit-Remaining:
          $ref: '#/components/headers/X-RateLimit-Remaining'
        X-RateLimit-Reset:
          $ref: '#/components/headers/X-RateLimit-Reset'
        Retry-After:
          schema:
            type: integer
          description: Seconds until rate limit resets
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          examples:
            rate_limited:
              value:
                success: false
                error:
                  code: "RATE_LIMIT"
                  message: "Rate limit exceeded"
                  details:
                    limit: 100
                    remaining: 0
                    resetAt: "2025-01-10T10:05:00Z"

  # ==========================================================================
  # JOB ENDPOINTS
  # ==========================================================================

  /jobs:
    get:
      tags:
        - Jobs
      summary: List jobs
      description: |
        Returns paginated list of jobs.
        Technicians only see their assigned jobs.
        Supports filtering by status, date, assignee, and customer.
      operationId: listJobs
      parameters:
        - $ref: '#/components/parameters/Limit'
        - $ref: '#/components/parameters/Cursor'
        - name: status
          in: query
          schema:
            type: array
            items:
              $ref: '#/components/schemas/JobStatus'
          style: form
          explode: false
          description: Filter by status (multiple allowed)
        - name: priority
          in: query
          schema:
            $ref: '#/components/schemas/JobPriority'
        - name: jobType
          in: query
          schema:
            $ref: '#/components/schemas/JobType'
        - name: assignedTo
          in: query
          schema:
            type: string
            format: uuid
        - name: unassigned
          in: query
          schema:
            type: boolean
          description: Filter to unassigned jobs only
        - name: customerId
          in: query
          schema:
            type: string
            format: uuid
        - $ref: '#/components/parameters/DateFrom'
        - $ref: '#/components/parameters/DateTo'
        - name: sortBy
          in: query
          schema:
            type: string
            enum: [scheduledDate, createdAt, priority, status]
            default: scheduledDate
        - name: sortOrder
          in: query
          schema:
            type: string
            enum: [asc, desc]
            default: asc
      responses:
        '200':
          description: Job list
          headers:
            X-RateLimit-Limit:
              $ref: '#/components/headers/X-RateLimit-Limit'
            X-RateLimit-Remaining:
              $ref: '#/components/headers/X-RateLimit-Remaining'
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JobList'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    post:
      tags:
        - Jobs
      summary: Create job
      description: |
        Creates a new job.
        If customerId not provided, creates from embedded customer data.
      operationId: createJob
      parameters:
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateJobRequest'
      responses:
        '201':
          description: Job created
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/Job'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                missingTitle:
                  summary: Missing title
                  value:
                    success: false
                    error:
                      code: "JOB_001"
                      message: "Job title is required"
                      field: "title"
                invalidTimeRange:
                  summary: Invalid time range
                  value:
                    success: false
                    error:
                      code: "JOB_002"
                      message: "End time must be after start time"
                      field: "scheduledTimeEnd"
        '403':
          description: Technicians cannot create jobs
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Customer or assignee not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /jobs/calendar:
    get:
      tags:
        - Jobs
      summary: Get calendar view
      description: |
        Returns jobs grouped by date for calendar display.
        Useful for scheduling UI.
      operationId: getJobCalendar
      parameters:
        - name: startDate
          in: query
          required: true
          schema:
            type: string
            format: date
        - name: endDate
          in: query
          required: true
          schema:
            type: string
            format: date
        - name: assignedTo
          in: query
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Calendar data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JobCalendarResponse'
        '400':
          description: Invalid date range (max 31 days)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /jobs/today:
    get:
      tags:
        - Jobs
      summary: Get today's jobs
      description: |
        Returns all jobs scheduled for today.
        Ordered by scheduled time.
      operationId: getTodayJobs
      parameters:
        - name: assignedTo
          in: query
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Today's jobs
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Job'

  /jobs/{jobId}:
    parameters:
      - $ref: '#/components/parameters/JobId'

    get:
      tags:
        - Jobs
      summary: Get job details
      description: Returns full job details including photos and history
      operationId: getJob
      responses:
        '200':
          description: Job details
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/Job'
        '403':
          description: Technician not assigned to this job
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Job not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error:
                  code: "JOB_404"
                  message: "Job not found"

    patch:
      tags:
        - Jobs
      summary: Update job
      description: |
        Updates job details. Cannot update completed/cancelled jobs.
        Technicians can only update notes on their assigned jobs.
      operationId: updateJob
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateJobRequest'
      responses:
        '200':
          description: Job updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/Job'
        '400':
          description: Validation error or invalid state
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error:
                  code: "JOB_010"
                  message: "Cannot modify completed jobs"
        '403':
          description: Insufficient permissions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Job not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    delete:
      tags:
        - Jobs
      summary: Cancel job
      description: |
        Cancels a job. Cannot cancel completed jobs.
        If job has invoice, invoice is also cancelled.
      operationId: cancelJob
      parameters:
        - name: reason
          in: query
          schema:
            type: string
            maxLength: 500
          description: Cancellation reason
      responses:
        '200':
          description: Job cancelled
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      invoiceCancelled:
                        type: boolean
        '400':
          description: Cannot cancel - already completed or has paid invoice
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Job not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /jobs/{jobId}/status:
    parameters:
      - $ref: '#/components/parameters/JobId'

    patch:
      tags:
        - Jobs
      summary: Update job status
      description: |
        Updates job status with state machine validation.
        Valid transitions:
        - pending → scheduled, cancelled
        - scheduled → en_camino, cancelled
        - en_camino → working
        - working → completed, cancelled
      operationId: updateJobStatus
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateJobStatusRequest'
      responses:
        '200':
          description: Status updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/Job'
        '400':
          description: Invalid status transition
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error:
                  code: "JOB_020"
                  message: "Invalid status transition from 'pending' to 'completed'"
                  details:
                    currentStatus: "pending"
                    requestedStatus: "completed"
                    validTransitions: ["scheduled", "cancelled"]
        '403':
          description: Technician not assigned
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Job not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /jobs/{jobId}/assign:
    parameters:
      - $ref: '#/components/parameters/JobId'

    patch:
      tags:
        - Jobs
      summary: Assign job
      description: Assigns or unassigns a job to a technician
      operationId: assignJob
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AssignJobRequest'
      responses:
        '200':
          description: Job assigned
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/Job'
        '400':
          description: Cannot assign - job in progress or completed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Insufficient permissions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Job or user not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /jobs/{jobId}/complete:
    parameters:
      - $ref: '#/components/parameters/JobId'

    post:
      tags:
        - Jobs
      summary: Complete job
      description: |
        Completes a job with photos and optional signature.
        Can auto-create invoice if organization setting enabled.
      operationId: completeJob
      parameters:
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CompleteJobRequest'
      responses:
        '200':
          description: Job completed
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      job:
                        $ref: '#/components/schemas/Job'
                      invoice:
                        $ref: '#/components/schemas/Invoice'
                        description: Created invoice (if createInvoice=true)
        '400':
          description: Cannot complete - invalid state or missing data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Technician not assigned
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Job not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /jobs/{jobId}/photos:
    parameters:
      - $ref: '#/components/parameters/JobId'

    post:
      tags:
        - Jobs
      summary: Upload job photo
      description: Uploads a photo to the job
      operationId: uploadJobPhoto
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - photo
                - type
              properties:
                photo:
                  type: string
                  format: binary
                type:
                  type: string
                  enum: [before, during, after, document]
                takenAt:
                  type: string
                  format: date-time
      responses:
        '201':
          description: Photo uploaded
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/JobPhoto'
        '400':
          description: Invalid file type or size
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Cannot add photos - not assigned or job completed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Job not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /jobs/{jobId}/history:
    parameters:
      - $ref: '#/components/parameters/JobId'

    get:
      tags:
        - Jobs
      summary: Get job history
      description: Returns status change history for the job
      operationId: getJobHistory
      responses:
        '200':
          description: Job history
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: string
                          format: uuid
                        previousStatus:
                          $ref: '#/components/schemas/JobStatus'
                        newStatus:
                          $ref: '#/components/schemas/JobStatus'
                        changedBy:
                          type: string
                          format: uuid
                        changedByName:
                          type: string
                        notes:
                          type: string
                        lat:
                          type: number
                        lng:
                          type: number
                        createdAt:
                          type: string
                          format: date-time
        '404':
          description: Job not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /jobs/sync:
    post:
      tags:
        - Jobs
      summary: Sync offline jobs
      description: |
        Syncs jobs created/updated offline.
        Uses vector clock for conflict resolution.
      operationId: syncJobs
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - operations
              properties:
                operations:
                  type: array
                  items:
                    type: object
                    required:
                      - operationType
                      - localId
                      - data
                      - clientTimestamp
                    properties:
                      operationType:
                        type: string
                        enum: [create, update, status_change, photo_upload]
                      localId:
                        type: string
                      serverId:
                        type: string
                        format: uuid
                      data:
                        type: object
                      clientTimestamp:
                        type: string
                        format: date-time
                  maxItems: 50
      responses:
        '200':
          description: Sync results
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      processed:
                        type: integer
                      created:
                        type: integer
                      updated:
                        type: integer
                      conflicts:
                        type: array
                        items:
                          type: object
                          properties:
                            localId:
                              type: string
                            serverId:
                              type: string
                            conflictType:
                              type: string
                            serverData:
                              type: object
                      mapping:
                        type: object
                        description: localId → serverId mapping
                        additionalProperties:
                          type: string
                          format: uuid
        '400':
          description: Invalid sync payload
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # ==========================================================================
  # INVOICE ENDPOINTS
  # ==========================================================================

  /invoices:
    get:
      tags:
        - Invoices
      summary: List invoices
      description: |
        Returns paginated list of invoices.
        Accountants and above can access.
      operationId: listInvoices
      parameters:
        - $ref: '#/components/parameters/Limit'
        - $ref: '#/components/parameters/Cursor'
        - name: status
          in: query
          schema:
            type: array
            items:
              $ref: '#/components/schemas/InvoiceStatus'
          style: form
          explode: false
        - name: invoiceType
          in: query
          schema:
            $ref: '#/components/schemas/InvoiceType'
        - name: customerId
          in: query
          schema:
            type: string
            format: uuid
        - $ref: '#/components/parameters/DateFrom'
        - $ref: '#/components/parameters/DateTo'
        - name: sortBy
          in: query
          schema:
            type: string
            enum: [issueDate, dueDate, total, createdAt]
            default: issueDate
        - name: sortOrder
          in: query
          schema:
            type: string
            enum: [asc, desc]
            default: desc
      responses:
        '200':
          description: Invoice list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InvoiceList'
        '403':
          description: Technicians cannot access invoices
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    post:
      tags:
        - Invoices
      summary: Create invoice
      description: |
        Creates an invoice and optionally submits to AFIP for CAE.
        If submitToAfip=false, creates as draft.
      operationId: createInvoice
      parameters:
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateInvoiceRequest'
      responses:
        '201':
          description: Invoice created
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/Invoice'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                noLineItems:
                  summary: No line items
                  value:
                    success: false
                    error:
                      code: "INVOICE_001"
                      message: "At least one line item is required"
                      field: "lineItems"
                invalidCustomer:
                  summary: Invalid customer for invoice type
                  value:
                    success: false
                    error:
                      code: "INVOICE_002"
                      message: "Invoice type A requires customer with CUIT"
        '403':
          description: Insufficient permissions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '503':
          description: AFIP service unavailable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error:
                  code: "AFIP_503"
                  message: "AFIP service unavailable. Invoice queued for later submission."
                  details:
                    queuePosition: 5
                    estimatedDelay: 300

  /invoices/{invoiceId}:
    parameters:
      - $ref: '#/components/parameters/InvoiceId'

    get:
      tags:
        - Invoices
      summary: Get invoice
      description: Returns invoice details with line items
      operationId: getInvoice
      responses:
        '200':
          description: Invoice details
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/Invoice'
        '403':
          description: Insufficient permissions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Invoice not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    delete:
      tags:
        - Invoices
      summary: Cancel invoice
      description: |
        Cancels a draft invoice. Cannot cancel issued invoices.
        For issued invoices, use credit note (nota de crédito).
      operationId: cancelInvoice
      responses:
        '200':
          description: Invoice cancelled
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
        '400':
          description: Cannot cancel issued invoice
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error:
                  code: "INVOICE_010"
                  message: "Cannot cancel issued invoice. Create a credit note instead."
        '404':
          description: Invoice not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /invoices/{invoiceId}/request-cae:
    parameters:
      - $ref: '#/components/parameters/InvoiceId'

    post:
      tags:
        - Invoices
      summary: Request CAE
      description: |
        Submits a draft invoice to AFIP for CAE.
        Can also retry failed submissions.
      operationId: requestCae
      parameters:
        - $ref: '#/components/parameters/IdempotencyKey'
      responses:
        '200':
          description: CAE request result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RequestCaeResponse'
        '400':
          description: Invalid invoice state
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                alreadyIssued:
                  summary: Already has CAE
                  value:
                    success: false
                    error:
                      code: "INVOICE_020"
                      message: "Invoice already has CAE"
                notConfigured:
                  summary: AFIP not configured
                  value:
                    success: false
                    error:
                      code: "INVOICE_021"
                      message: "AFIP certificate not configured"
        '503':
          description: AFIP unavailable - queued
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /invoices/{invoiceId}/pdf:
    parameters:
      - $ref: '#/components/parameters/InvoiceId'

    get:
      tags:
        - Invoices
      summary: Get invoice PDF
      description: Returns the invoice PDF
      operationId: getInvoicePdf
      responses:
        '200':
          description: PDF file
          content:
            application/pdf:
              schema:
                type: string
                format: binary
        '400':
          description: PDF not available (no CAE yet)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Invoice not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /invoices/{invoiceId}/send:
    parameters:
      - $ref: '#/components/parameters/InvoiceId'

    post:
      tags:
        - Invoices
      summary: Send invoice to customer
      description: Sends invoice PDF via WhatsApp and/or email
      operationId: sendInvoice
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                channels:
                  type: array
                  items:
                    type: string
                    enum: [whatsapp, email]
                  default: [whatsapp]
      responses:
        '200':
          description: Invoice sent
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      whatsappSent:
                        type: boolean
                      emailSent:
                        type: boolean
        '400':
          description: Invoice not issued yet
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Invoice not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /invoices/afip-queue:
    get:
      tags:
        - Invoices
      summary: Get AFIP queue status
      description: Returns current AFIP submission queue status
      operationId: getAfipQueue
      responses:
        '200':
          description: Queue status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AfipQueueStatus'

  /invoices/overdue:
    get:
      tags:
        - Invoices
      summary: List overdue invoices
      description: Returns all overdue unpaid invoices
      operationId: listOverdueInvoices
      parameters:
        - $ref: '#/components/parameters/Limit'
        - $ref: '#/components/parameters/Cursor'
      responses:
        '200':
          description: Overdue invoices
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InvoiceList'

# ============================================================================
# ERROR CODES REFERENCE
# ============================================================================
# 
# Authentication Errors (AUTH_xxx)
# --------------------------------
# AUTH_001 - Invalid phone number format
# AUTH_002 - OTP rate limit exceeded
# AUTH_003 - Invalid OTP code
# AUTH_004 - OTP code expired
# AUTH_005 - Invalid refresh token
# AUTH_100 - Authentication required
# AUTH_101 - Invalid or expired token
# AUTH_102 - Token has been revoked
# AUTH_200 - Insufficient permissions
#
# Customer Errors (CUSTOMER_xxx)
# ------------------------------
# CUSTOMER_001 - Invalid phone number format
# CUSTOMER_002 - Invalid CUIT format or checksum
# CUSTOMER_003 - Customer with phone already exists
# CUSTOMER_004 - Cannot delete customer with active jobs
#
# Job Errors (JOB_xxx)
# --------------------
# JOB_001 - End time must be after start time
# JOB_002 - Cannot schedule job in the past
# JOB_003 - Cannot delete job with associated invoice
# JOB_004 - Can only delete pending or scheduled jobs
# JOB_005 - Invalid status transition
# JOB_006 - Job already completed
# JOB_007 - Technician not assigned to job
#
# Invoice Errors (INVOICE_xxx)
# ----------------------------
# INVOICE_001 - Invoice must have at least one line item
# INVOICE_002 - Line item amount must be positive
# INVOICE_003 - Cannot modify invoice with CAE
# INVOICE_004 - Invoice already has CAE
# INVOICE_005 - AFIP not configured for organization
# INVOICE_006 - Cannot cancel paid invoice
# INVOICE_007 - Invoice type mismatch for customer
#
# AFIP Errors (AFIP_xxx)
# ----------------------
# AFIP_001 - Invalid certificate format or expired
# AFIP_002 - Certificate CUIT does not match organization
# AFIP_003 - AFIP authentication failed
# AFIP_004 - CAE request rejected by AFIP
# AFIP_010 - AFIP service in panic mode
#
# Payment Errors (PAYMENT_xxx)
# ----------------------------
# PAYMENT_001 - Invoice already paid
# PAYMENT_002 - Mercado Pago not connected
# PAYMENT_003 - Payment already fully refunded
# PAYMENT_004 - Refund amount exceeds available balance
# PAYMENT_005 - Payment in dispute, cannot refund
#
# WhatsApp Errors (WHATSAPP_xxx)
# ------------------------------
# WHATSAPP_001 - Cannot send free text outside 24h window
# WHATSAPP_002 - Template not found or not approved
# WHATSAPP_003 - WhatsApp not configured
# WHATSAPP_004 - Message delivery failed
# WHATSAPP_005 - Invalid template parameters
#
# Voice Errors (VOICE_xxx)
# ------------------------
# VOICE_001 - Message is not a voice message
# VOICE_002 - Voice message already processed
# VOICE_003 - Transcription failed
# VOICE_004 - Extraction confidence too low
#
# Validation Errors (VALIDATION_xxx)
# ----------------------------------
# VALIDATION_001 - Invalid request parameters
# VALIDATION_002 - Missing required field
# VALIDATION_003 - Field exceeds maximum length
# VALIDATION_004 - Invalid date format
# VALIDATION_005 - Invalid UUID format
#
# Rate Limit Errors
# -----------------
# RATE_LIMIT - Rate limit exceeded
#
# ============================================================================
# RATE LIMITS
# ============================================================================
#
# Endpoint Category          | Limit              | Window  | Scope
# ---------------------------|--------------------|---------|-----------------
# Auth (OTP send/verify)     | 10 requests        | 1 min   | Per IP
# Auth (refresh)             | 30 requests        | 1 min   | Per user
# Standard API               | 100 requests       | 1 min   | Per organization
# Search/List endpoints      | 60 requests        | 1 min   | Per organization
# Write operations           | 30 requests        | 1 min   | Per organization
# File uploads               | 20 requests        | 1 min   | Per organization
# WhatsApp messages          | 50 messages        | 1 min   | Per organization
# Voice processing           | 20 requests        | 1 min   | Per organization
# AFIP CAE requests          | 10 requests        | 1 min   | Per organization
# Webhooks (MP/WA)           | 1000 requests      | 1 min   | Global
#
# Rate limit headers are included in all responses:
# - X-RateLimit-Limit: Maximum requests allowed
# - X-RateLimit-Remaining: Remaining requests in window
# - X-RateLimit-Reset: Unix timestamp when window resets
#
# ============================================================================
# PAGINATION
# ============================================================================
#
# All list endpoints use cursor-based pagination:
#
# Request Parameters:
# - limit: Number of items (1-100, default 20)
# - cursor: Opaque cursor from previous response
#
# Response Format:
# {
#   "success": true,
#   "data": [...],
#   "pagination": {
#     "limit": 20,
#     "cursor": "eyJpZCI6IjU1MGU4NDAwLi4uIn0",
#     "hasMore": true,
#     "total": 150  // Only if countTotal=true
#   }
# }
#
# To get next page, include cursor in subsequent request.
# When hasMore=false or cursor=null, no more pages exist.
#
# ============================================================================
# FILTERING
# ============================================================================
#
# Common filter parameters:
# - status: Filter by status enum (supports multiple: ?status=pending,scheduled)
# - dateFrom/dateTo: Date range filter (ISO date format: YYYY-MM-DD)
# - search: Full-text search on relevant fields
# - sortBy: Sort field (varies by endpoint)
# - sortOrder: asc or desc (default varies)
#
# Date filters are inclusive on both ends.
# All times are in UTC unless timezone specified.
#
# ============================================================================
# WEBHOOKS
# ============================================================================
#
# Mercado Pago Webhooks:
# - Endpoint: POST /payments/webhook/mercadopago
# - Signature: x-signature header (HMAC-SHA256)
# - Retry: 3 attempts with exponential backoff
# - Events: payment, chargeback
#
# WhatsApp Webhooks:
# - Endpoint: POST /whatsapp/webhook
# - Verification: GET /whatsapp/webhook (hub.verify_token)
# - Signature: X-Hub-Signature-256 header
# - Events: messages, statuses
#
# ============================================================================
# IDEMPOTENCY
# ============================================================================
#
# Write operations support idempotency via X-Idempotency-Key header.
# - Key must be unique per operation (16-64 characters)
# - Keys are stored for 24 hours
# - Duplicate requests return cached response
# - Recommended format: {operation}_{uuid} e.g., "create_invoice_abc123"
#
# Endpoints supporting idempotency:
# - POST /customers
# - POST /jobs
# - POST /jobs/{id}/complete
# - POST /invoices
# - POST /invoices/{id}/cae
# - POST /payments/preference
# - POST /payments/{id}/refund
# - POST /whatsapp/send
#

  # ==========================================================================
  # PAYMENT ENDPOINTS
  # ==========================================================================

  /payments:
    get:
      tags:
        - Payments
      summary: List payments
      description: Returns paginated list of payments
      operationId: listPayments
      parameters:
        - $ref: '#/components/parameters/Limit'
        - $ref: '#/components/parameters/Cursor'
        - name: status
          in: query
          schema:
            type: array
            items:
              $ref: '#/components/schemas/PaymentStatus'
          style: form
          explode: false
        - name: paymentMethod
          in: query
          schema:
            $ref: '#/components/schemas/PaymentMethod'
        - name: invoiceId
          in: query
          schema:
            type: string
            format: uuid
        - $ref: '#/components/parameters/DateFrom'
        - $ref: '#/components/parameters/DateTo'
      responses:
        '200':
          description: Payment list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaymentList'
        '403':
          description: Insufficient permissions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /payments/create-preference:
    post:
      tags:
        - Payments
      summary: Create payment preference
      description: |
        Creates a Mercado Pago payment preference.
        Returns payment URL and QR code to share with customer.
      operationId: createPaymentPreference
      parameters:
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreatePaymentPreferenceRequest'
      responses:
        '200':
          description: Preference created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaymentPreferenceResponse'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                notIssued:
                  summary: Invoice not issued
                  value:
                    success: false
                    error:
                      code: "PAYMENT_001"
                      message: "Cannot create payment for draft invoice"
                alreadyPaid:
                  summary: Already paid
                  value:
                    success: false
                    error:
                      code: "PAYMENT_002"
                      message: "Invoice is already paid"
        '503':
          description: Mercado Pago unavailable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /payments/{paymentId}:
    parameters:
      - $ref: '#/components/parameters/PaymentId'

    get:
      tags:
        - Payments
      summary: Get payment
      description: Returns payment details
      operationId: getPayment
      responses:
        '200':
          description: Payment details
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/Payment'
        '404':
          description: Payment not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /payments/{paymentId}/refund:
    parameters:
      - $ref: '#/components/parameters/PaymentId'

    post:
      tags:
        - Payments
      summary: Refund payment
      description: |
        Initiates a full or partial refund through Mercado Pago.
        Only approved payments can be refunded.
      operationId: refundPayment
      parameters:
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RefundRequest'
      responses:
        '200':
          description: Refund initiated
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/Payment'
        '400':
          description: Cannot refund
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                notApproved:
                  summary: Not approved
                  value:
                    success: false
                    error:
                      code: "PAYMENT_010"
                      message: "Can only refund approved payments"
                exceedsAmount:
                  summary: Amount exceeds
                  value:
                    success: false
                    error:
                      code: "PAYMENT_011"
                      message: "Refund amount exceeds available balance"
                      details:
                        available: 10000.00
                        requested: 15000.00
        '403':
          description: Only owners can refund
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Payment not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /payments/webhook:
    post:
      tags:
        - Payments
      summary: Mercado Pago webhook
      description: |
        Receives payment notifications from Mercado Pago.
        Verifies signature and processes payment status updates.
      operationId: mpWebhook
      security: []
      parameters:
        - name: x-signature
          in: header
          required: true
          schema:
            type: string
        - name: x-request-id
          in: header
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MpWebhookPayload'
      responses:
        '200':
          description: Webhook processed
        '400':
          description: Invalid signature
        '404':
          description: Payment not found (logged, returns 200)

  /payments/record-cash:
    post:
      tags:
        - Payments
      summary: Record cash payment
      description: Records a cash or manual payment
      operationId: recordCashPayment
      parameters:
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - invoiceId
                - amount
                - paymentMethod
              properties:
                invoiceId:
                  type: string
                  format: uuid
                amount:
                  type: number
                  format: double
                  minimum: 0.01
                paymentMethod:
                  type: string
                  enum: [cash, bank_transfer, check]
                reference:
                  type: string
                  maxLength: 100
                  description: Reference number or notes
                receivedAt:
                  type: string
                  format: date-time
      responses:
        '201':
          description: Payment recorded
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/Payment'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Insufficient permissions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /payments/reconcile:
    post:
      tags:
        - Payments
      summary: Reconcile with Mercado Pago
      description: |
        Reconciles local payment records with Mercado Pago.
        Fetches recent payments and updates local status.
        Only admins and owners can run reconciliation.
      operationId: reconcilePayments
      parameters:
        - name: fromDate
          in: query
          schema:
            type: string
            format: date
        - name: toDate
          in: query
          schema:
            type: string
            format: date
      responses:
        '200':
          description: Reconciliation results
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReconcileResponse'
        '403':
          description: Insufficient permissions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '503':
          description: Mercado Pago unavailable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /payments/disputes:
    get:
      tags:
        - Payments
      summary: List disputes
      description: Returns all payment disputes and chargebacks
      operationId: listDisputes
      parameters:
        - $ref: '#/components/parameters/Limit'
        - $ref: '#/components/parameters/Cursor'
        - name: status
          in: query
          schema:
            type: string
            enum: [pending_response, evidence_submitted, under_review, won, lost]
      responses:
        '200':
          description: Dispute list
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: string
                          format: uuid
                        paymentId:
                          type: string
                          format: uuid
                        disputeType:
                          type: string
                        amount:
                          type: number
                        status:
                          type: string
                        deadline:
                          type: string
                          format: date-time
                        createdAt:
                          type: string
                          format: date-time
                  pagination:
                    $ref: '#/components/schemas/PaginationMeta'

  # ==========================================================================
  # WHATSAPP ENDPOINTS
  # ==========================================================================

  /whatsapp/conversations:
    get:
      tags:
        - WhatsApp
      summary: List conversations
      description: |
        Returns list of WhatsApp conversations sorted by last message.
        Groups messages by customer.
      operationId: listConversations
      parameters:
        - $ref: '#/components/parameters/Limit'
        - $ref: '#/components/parameters/Cursor'
        - name: unreadOnly
          in: query
          schema:
            type: boolean
          description: Filter to conversations with unread messages
      responses:
        '200':
          description: Conversation list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConversationList'
        '403':
          description: Technicians cannot access conversations
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /whatsapp/conversations/{customerId}:
    parameters:
      - $ref: '#/components/parameters/CustomerId'

    get:
      tags:
        - WhatsApp
      summary: Get conversation messages
      description: Returns messages for a specific customer conversation
      operationId: getConversation
      parameters:
        - $ref: '#/components/parameters/Limit'
        - $ref: '#/components/parameters/Cursor'
      responses:
        '200':
          description: Message list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageList'
        '404':
          description: Customer not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /whatsapp/messages:
    post:
      tags:
        - WhatsApp
      summary: Send message
      description: |
        Sends a WhatsApp message to a customer.
        For business-initiated messages (outside 24h window), 
        must use approved template.
      operationId: sendWhatsAppMessage
      parameters:
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SendMessageRequest'
      responses:
        '200':
          description: Message sent
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SendMessageResponse'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                templateRequired:
                  summary: Template required
                  value:
                    success: false
                    error:
                      code: "WHATSAPP_001"
                      message: "Template required for business-initiated messages"
                invalidTemplate:
                  summary: Invalid template
                  value:
                    success: false
                    error:
                      code: "WHATSAPP_002"
                      message: "Template not found or not approved"
                      field: "templateName"
        '429':
          description: Rate limit exceeded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '503':
          description: WhatsApp unavailable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /whatsapp/messages/{messageId}:
    parameters:
      - $ref: '#/components/parameters/MessageId'

    get:
      tags:
        - WhatsApp
      summary: Get message
      description: Returns message details and delivery status
      operationId: getWhatsAppMessage
      responses:
        '200':
          description: Message details
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/WhatsAppMessage'
        '404':
          description: Message not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /whatsapp/templates:
    get:
      tags:
        - WhatsApp
      summary: List templates
      description: Returns available WhatsApp message templates
      operationId: listTemplates
      responses:
        '200':
          description: Template list
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/WhatsAppTemplate'

  /whatsapp/webhook:
    post:
      tags:
        - WhatsApp
      summary: WhatsApp webhook
      description: Receives WhatsApp message and status webhooks
      operationId: whatsappWebhook
      security: []
      parameters:
        - name: hub.mode
          in: query
          schema:
            type: string
        - name: hub.verify_token
          in: query
          schema:
            type: string
        - name: hub.challenge
          in: query
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              type: object
      responses:
        '200':
          description: Webhook processed

    get:
      tags:
        - WhatsApp
      summary: WhatsApp webhook verification
      description: Verifies webhook endpoint for WhatsApp
      operationId: verifyWhatsappWebhook
      security: []
      parameters:
        - name: hub.mode
          in: query
          required: true
          schema:
            type: string
        - name: hub.verify_token
          in: query
          required: true
          schema:
            type: string
        - name: hub.challenge
          in: query
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Challenge response
          content:
            text/plain:
              schema:
                type: string
        '403':
          description: Invalid verify token

  /whatsapp/send-job-notification:
    post:
      tags:
        - WhatsApp
      summary: Send job notification
      description: Sends a job-related notification to customer
      operationId: sendJobNotification
      parameters:
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - jobId
                - notificationType
              properties:
                jobId:
                  type: string
                  format: uuid
                notificationType:
                  type: string
                  enum: [scheduled, reminder, en_camino, completed]
      responses:
        '200':
          description: Notification sent
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SendMessageResponse'
        '400':
          description: Job not in correct state
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Job not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # ==========================================================================
  # VOICE AI ENDPOINTS
  # ==========================================================================

  /voice/process:
    post:
      tags:
        - Voice
      summary: Process voice message
      description: |
        Queues a voice message for transcription and extraction.
        Uses Whisper for transcription and GPT for data extraction.
      operationId: processVoice
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProcessVoiceRequest'
      responses:
        '200':
          description: Processing started
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProcessVoiceResponse'
        '400':
          description: Invalid message
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error:
                  code: "VOICE_001"
                  message: "Message is not a voice message"
        '404':
          description: Message not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '429':
          description: Rate limit exceeded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /voice/transcripts/{transcriptId}:
    parameters:
      - name: transcriptId
        in: path
        required: true
        schema:
          type: string
          format: uuid

    get:
      tags:
        - Voice
      summary: Get transcript
      description: Returns voice transcript and extraction details
      operationId: getTranscript
      responses:
        '200':
          description: Transcript details
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/VoiceTranscript'
        '404':
          description: Transcript not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /voice/review-queue:
    get:
      tags:
        - Voice
      summary: Get review queue
      description: |
        Returns voice messages requiring human review.
        Low confidence transcriptions are queued for review.
      operationId: getVoiceReviewQueue
      parameters:
        - $ref: '#/components/parameters/Limit'
        - $ref: '#/components/parameters/Cursor'
      responses:
        '200':
          description: Review queue
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VoiceQueueResponse'

  /voice/transcripts/{transcriptId}/review:
    parameters:
      - name: transcriptId
        in: path
        required: true
        schema:
          type: string
          format: uuid

    post:
      tags:
        - Voice
      summary: Submit review
      description: |
        Submits human review for a voice transcript.
        Can approve, edit, or reject the extraction.
        If approved, can auto-create job.
      operationId: submitVoiceReview
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SubmitReviewRequest'
      responses:
        '200':
          description: Review submitted
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      transcript:
                        $ref: '#/components/schemas/VoiceTranscript'
                      job:
                        $ref: '#/components/schemas/Job'
                        description: Created job (if createJob=true)
        '400':
          description: Invalid review action
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Transcript not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /voice/stats:
    get:
      tags:
        - Voice
      summary: Get voice AI stats
      description: Returns voice AI processing statistics
      operationId: getVoiceStats
      parameters:
        - $ref: '#/components/parameters/DateFrom'
        - $ref: '#/components/parameters/DateTo'
      responses:
        '200':
          description: Voice AI statistics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VoiceStatsResponse'

  # ==========================================================================
  # ADMIN ENDPOINTS
  # ==========================================================================

  /admin/health:
    get:
      tags:
        - Admin
      summary: Health check
      description: Returns service health status
      operationId: healthCheck
      security: []
      responses:
        '200':
          description: Service health
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
        '503':
          description: Service unhealthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'

  /admin/queues:
    get:
      tags:
        - Admin
      summary: Get queue status
      description: Returns status of all background job queues
      operationId: getQueueStatus
      responses:
        '200':
          description: Queue status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QueueStatusResponse'
        '403':
          description: Admin only
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /admin/dlq:
    get:
      tags:
        - Admin
      summary: List DLQ items
      description: Returns items in the dead letter queue
      operationId: listDlqItems
      parameters:
        - $ref: '#/components/parameters/Limit'
        - $ref: '#/components/parameters/Cursor'
        - name: queueName
          in: query
          schema:
            type: string
        - name: status
          in: query
          schema:
            type: string
            enum: [pending, retried, discarded, resolved]
      responses:
        '200':
          description: DLQ items
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DlqListResponse'
        '403':
          description: Admin only
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /admin/dlq/{itemId}/retry:
    parameters:
      - name: itemId
        in: path
        required: true
        schema:
          type: string
          format: uuid

    post:
      tags:
        - Admin
      summary: Retry DLQ item
      description: Retries a failed job from the DLQ
      operationId: retryDlqItem
      responses:
        '200':
          description: Retry initiated
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
        '404':
          description: Item not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /admin/dlq/{itemId}/discard:
    parameters:
      - name: itemId
        in: path
        required: true
        schema:
          type: string
          format: uuid

    post:
      tags:
        - Admin
      summary: Discard DLQ item
      description: Marks a DLQ item as discarded
      operationId: discardDlqItem
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required:
                - reason
              properties:
                reason:
                  type: string
                  minLength: 10
                  maxLength: 500
      responses:
        '200':
          description: Item discarded
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
        '404':
          description: Item not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /admin/panic:
    get:
      tags:
        - Admin
      summary: Get panic status
      description: Returns panic mode status for all services
      operationId: getPanicStatus
      responses:
        '200':
          description: Panic status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PanicStatusResponse'
        '403':
          description: Admin only
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /admin/panic/{service}:
    parameters:
      - name: service
        in: path
        required: true
        schema:
          type: string
          enum: [afip, mercadopago, whatsapp, voiceai]

    patch:
      tags:
        - Admin
      summary: Set panic status
      description: |
        Manually sets panic mode for a service.
        Use to force circuit breaker open/closed.
      operationId: setPanicStatus
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SetPanicStatusRequest'
      responses:
        '200':
          description: Panic status updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/ServicePanicStatus'
        '403':
          description: Owner only
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /admin/metrics:
    get:
      tags:
        - Admin
      summary: Get metrics
      description: Returns application metrics
      operationId: getMetrics
      parameters:
        - name: period
          in: query
          schema:
            type: string
            enum: [hour, day, week, month]
            default: day
      responses:
        '200':
          description: Metrics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MetricsResponse'
        '403':
          description: Admin only
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /admin/audit-log:
    get:
      tags:
        - Admin
      summary: Get audit log
      description: Returns audit log entries
      operationId: getAuditLog
      parameters:
        - $ref: '#/components/parameters/Limit'
        - $ref: '#/components/parameters/Cursor'
        - name: action
          in: query
          schema:
            type: string
        - name: userId
          in: query
          schema:
            type: string
            format: uuid
        - name: entityType
          in: query
          schema:
            type: string
        - name: entityId
          in: query
          schema:
            type: string
            format: uuid
        - $ref: '#/components/parameters/DateFrom'
        - $ref: '#/components/parameters/DateTo'
      responses:
        '200':
          description: Audit log entries
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: string
                          format: uuid
                        action:
                          type: string
                        userId:
                          type: string
                          format: uuid
                        userName:
                          type: string
                        entityType:
                          type: string
                        entityId:
                          type: string
                          format: uuid
                        oldData:
                          type: object
                        newData:
                          type: object
                        ipAddress:
                          type: string
                        userAgent:
                          type: string
                        createdAt:
                          type: string
                          format: date-time
                  pagination:
                    $ref: '#/components/schemas/PaginationMeta'
        '403':
          description: Admin only
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # ==========================================================================
  # PRICE BOOK ENDPOINTS
  # ==========================================================================

  /price-book:
    get:
      tags:
        - Organization
      summary: List price book items
      description: Returns all items in the organization's price book
      operationId: listPriceBookItems
      parameters:
        - name: category
          in: query
          schema:
            type: string
            enum: [mano_de_obra, materiales, consumibles, viatico]
        - name: jobType
          in: query
          schema:
            $ref: '#/components/schemas/JobType'
        - name: search
          in: query
          schema:
            type: string
        - name: isActive
          in: query
          schema:
            type: boolean
            default: true
      responses:
        '200':
          description: Price book items
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/PriceBookItem'

    post:
      tags:
        - Organization
      summary: Create price book item
      description: Creates a new price book item
      operationId: createPriceBookItem
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreatePriceBookItemRequest'
      responses:
        '201':
          description: Item created
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/PriceBookItem'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Insufficient permissions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /price-book/{itemId}:
    parameters:
      - name: itemId
        in: path
        required: true
        schema:
          type: string
          format: uuid

    patch:
      tags:
        - Organization
      summary: Update price book item
      description: Updates a price book item
      operationId: updatePriceBookItem
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdatePriceBookItemRequest'
      responses:
        '200':
          description: Item updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/PriceBookItem'
        '404':
          description: Item not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    delete:
      tags:
        - Organization
      summary: Delete price book item
      description: Soft-deletes a price book item
      operationId: deletePriceBookItem
      responses:
        '200':
          description: Item deleted
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
        '404':
          description: Item not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

# Note: PriceBookItem, CreatePriceBookItemRequest, UpdatePriceBookItemRequest 
# schemas are defined in components/schemas section above

# ============================================================================
# ERROR CODES REFERENCE
# ============================================================================
#
# AUTH ERRORS (AUTH_xxx)
# AUTH_001 - Invalid phone number format
# AUTH_002 - Too many OTP requests (rate limited)
# AUTH_003 - WhatsApp/SMS service unavailable
# AUTH_010 - Invalid OTP code
# AUTH_011 - Expired OTP code
# AUTH_020 - Invalid or expired refresh token
#
# ORGANIZATION ERRORS (ORG_xxx)
# ORG_001 - Insufficient permissions to update
# ORG_002 - Cannot change CUIT after AFIP configured
#
# AFIP ERRORS (AFIP_xxx)
# AFIP_001 - Invalid certificate format
# AFIP_002 - CUIT mismatch
# AFIP_003 - Certificate expired
# AFIP_010 - AFIP service unavailable
# AFIP_011 - AFIP rejected invoice
# AFIP_503 - AFIP service temporarily unavailable
#
# CUSTOMER ERRORS (CUSTOMER_xxx)
# CUSTOMER_001 - Invalid phone number
# CUSTOMER_002 - Invalid CUIT checksum
# CUSTOMER_010 - Phone number already exists
# CUSTOMER_020 - Cannot delete with unpaid invoices
# CUSTOMER_404 - Customer not found
#
# JOB ERRORS (JOB_xxx)
# JOB_001 - Missing required field
# JOB_002 - Invalid time range
# JOB_010 - Cannot modify completed job
# JOB_020 - Invalid status transition
# JOB_030 - Sync conflict
# JOB_404 - Job not found
#
# INVOICE ERRORS (INVOICE_xxx)
# INVOICE_001 - No line items
# INVOICE_002 - Invalid customer for invoice type
# INVOICE_010 - Cannot cancel issued invoice
# INVOICE_020 - Already has CAE
# INVOICE_021 - AFIP not configured
# INVOICE_404 - Invoice not found
#
# PAYMENT ERRORS (PAYMENT_xxx)
# PAYMENT_001 - Invoice not issued
# PAYMENT_002 - Already paid
# PAYMENT_010 - Cannot refund unapproved payment
# PAYMENT_011 - Refund exceeds available
# PAYMENT_020 - Invalid webhook signature
# PAYMENT_404 - Payment not found
#
# WHATSAPP ERRORS (WHATSAPP_xxx)
# WHATSAPP_001 - Template required
# WHATSAPP_002 - Invalid template
# WHATSAPP_010 - Service unavailable
# WHATSAPP_020 - Rate limit exceeded
# WHATSAPP_404 - Message not found
#
# VOICE ERRORS (VOICE_xxx)
# VOICE_001 - Not a voice message
# VOICE_002 - Processing failed
# VOICE_010 - Rate limit exceeded
# VOICE_404 - Transcript not found

# ============================================================================
# RATE LIMITS SPECIFICATION
# ============================================================================
#
# Global Limits (per organization):
# - Standard endpoints: 100 requests/minute
# - Burst: 200 requests (within 10 seconds)
#
# Per-Endpoint Limits:
# - /auth/otp/send: 3 requests/hour per phone
# - /auth/otp/verify: 5 attempts per code
# - /auth/refresh: 20 requests/minute
#
# - /customers: 100 requests/minute
# - /jobs: 100 requests/minute
# - /jobs/sync: 10 requests/minute
#
# - /invoices: 100 requests/minute
# - /invoices/*/request-cae: 30 requests/minute
#
# - /payments: 100 requests/minute
# - /payments/create-preference: 30 requests/minute
#
# - /whatsapp/messages: 50 messages/minute
# - /whatsapp/send-job-notification: 100 messages/minute
#
# - /voice/process: 20 requests/minute
#
# Response Headers:
# - X-RateLimit-Limit: Maximum requests per window
# - X-RateLimit-Remaining: Remaining requests
# - X-RateLimit-Reset: Unix timestamp when limit resets
# - Retry-After: Seconds until retry (on 429)
